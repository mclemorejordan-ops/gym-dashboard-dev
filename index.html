<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />

  <!-- iOS Add to Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Gym Dashboard" />

  <title>Gym Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #0b0f17;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --hair: rgba(255,255,255,.10);

      --accent: #7c5cff;
      --good: #37d67a;
      --warn: #ffd166;
      --bad: #ff5c7a;

      --r: 18px;
      --shadow: 0 18px 40px rgba(0,0,0,.45);

      --navH: 78px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.24), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(55,214,122,.14), transparent 55%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    .app{
      min-height: 100%;
      padding: env(safe-area-inset-top) 14px calc(var(--navH) + env(safe-area-inset-bottom)) 14px;
      max-width: 780px;
      margin: 0 auto;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(11,15,23,.88), rgba(11,15,23,.55));
      padding: 14px 0 10px 0;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 4px 2px 6px 2px;
    }

    .brand{ display:flex; flex-direction:column; gap: 2px; }
    .brand .title{ font-weight: 720; letter-spacing: .2px; font-size: 18px; line-height: 1.15; }
    .brand .subtitle{ font-size: 12px; color: var(--muted); }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--hair);
      color: var(--text);
      font-size: 13px;
      user-select:none;
      max-width: 52vw;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    main{ padding-top: 10px; }

    .grid{ display:grid; gap: 12px; }
    @media (min-width: 640px){ .grid.cols2{ grid-template-columns: 1fr 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--hair);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px 0;
      font-size: 14px;
      letter-spacing: .3px;
      color: var(--muted);
      font-weight: 650;
      text-transform: uppercase;
    }

    .btnrow{ display:flex; gap: 10px; flex-wrap: wrap; }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 650;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid var(--hair);
      user-select:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.75));
      border-color: rgba(124,92,255,.35);
    }
    .btn.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }
    .btn:active{ transform: translateY(1px); }

    .muted{ color: var(--muted); }
    .note{ font-size: 12.5px; color: var(--muted); line-height: 1.35; }

    .form{ display:grid; gap: 10px; }
    .row2{ display:grid; gap: 10px; }
    @media (min-width: 640px){ .row2{ grid-template-columns: 1fr 1fr; } }

    label{
      display:flex;
      flex-direction:column;
      gap: 7px;
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 650;
      letter-spacing: .2px;
    }
    input, select{
      appearance:none;
      border-radius: 14px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    input::placeholder{ color: rgba(255,255,255,.35); }
    input:focus, select:focus{
      border-color: rgba(124,92,255,.40);
      box-shadow: 0 0 0 4px rgba(124,92,255,.14);
    }

    .seg{
      display:flex;
      gap: 8px;
      padding: 6px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
    }
    .segbtn{
      flex:1;
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12.5px;
      color: var(--muted);
      background: transparent;
      user-select:none;
    }
    .segbtn.active{
      color: var(--text);
      background: rgba(124,92,255,.16);
      border: 1px solid rgba(124,92,255,.22);
    }

    /* Routine editor */
    .routineRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .routineRow .left{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .routineRow .name{
      font-weight: 820;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 60vw;
    }
    .routineRow .meta{
      color: var(--muted);
      font-size: 12.5px;
    }
    .mini{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12px;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      user-select:none;
    }
    .mini.primary{
      background: rgba(124,92,255,.18);
      border-color: rgba(124,92,255,.28);
    }
    .mini.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }

    .dayCard{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .dayHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .dayHeader .dleft{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .dayHeader .dname{
      font-weight: 840;
      letter-spacing: .15px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 62vw;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      width: fit-content;
    }
    .pill.rest{
      color: rgba(255,255,255,.85);
      background: rgba(255,209,102,.14);
      border-color: rgba(255,209,102,.22);
    }

    .exList{ display:grid; gap: 8px; }
    .exRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .exRow .lname{
      font-weight: 760;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 62vw;
    }
    .exRow .lmeta{
      font-size: 12px;
      color: var(--muted);
    }

    /* Modal */
    .modalHost{
      position: fixed;
      inset: 0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index: 80;
      padding: 0 10px;
    }
    .modalHost.show{ display:flex; }
    .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    .sheet{
      position:relative;
      width: min(780px, 100%);
      max-height: 82vh;
      overflow:auto;
      background: rgba(16,20,30,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px 22px 0 0;
      box-shadow: 0 22px 60px rgba(0,0,0,.65);
      padding: 14px;
      transform: translateY(10px);
    }
    .sheetHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 10px;
    }
    .sheetHeader .h{ font-weight: 760; letter-spacing: .2px; }
    .xbtn{
      appearance:none;
      border:none;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 700;
    }

    /* Bottom nav */
    .nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: calc(var(--navH) + env(safe-area-inset-bottom));
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px;
      display:flex;
      justify-content:center;
      z-index: 50;
      pointer-events:none;
    }
    .navbar{
      width: min(780px, calc(100% - 18px));
      display:flex;
      justify-content:space-between;
      gap: 8px;
      background: rgba(16,20,30,.72);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 8px;
      backdrop-filter: blur(18px);
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      pointer-events:auto;
    }
    .navbtn{
      flex: 1;
      appearance:none;
      border:none;
      background: transparent;
      color: var(--muted);
      padding: 10px 6px;
      border-radius: 16px;
      font-size: 11.5px;
      font-weight: 650;
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .navbtn .dot{
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .navbtn.active{
      color: var(--text);
      background: rgba(124,92,255,.14);
      border: 1px solid rgba(124,92,255,.22);
    }
    .navbtn.active .dot{
      background: rgba(124,92,255,.22);
      border-color: rgba(124,92,255,.30);
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="title" id="appTitle">Gym Dashboard</div>
          <div class="subtitle" id="appSubtitle">Offline • Add to Home Screen • Local data</div>
        </div>
        <div class="chip" id="chipStatus">Not set up</div>
      </div>
    </header>

    <main id="viewRoot"></main>
  </div>

  <div class="nav">
    <div class="navbar" id="navbar"></div>
  </div>

  <div class="modalHost" id="modalHost" aria-hidden="true">
    <div class="backdrop" id="modalBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHeader">
        <div class="h" id="modalTitle">Modal</div>
        <button class="xbtn" id="modalClose">Close</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "gymdash:v1";

    const DefaultState = () => ({
      schemaVersion: 1,
      createdAt: Date.now(),
      profile: null,
      routines: [],
      activeRoutineId: null,
      exerciseLibrary: { weightlifting: [], cardio: [], core: [] },
      logs: { workouts: [], weight: [], protein: [] },
      attendance: []
    });

    const Storage = {
      load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return DefaultState();
          const parsed = JSON.parse(raw);
          if(!parsed || typeof parsed !== "object") return DefaultState();
          if(!("schemaVersion" in parsed)) return DefaultState();
          return parsed;
        }catch(e){
          return DefaultState();
        }
      },
      save(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); },
      reset(){ localStorage.removeItem(STORAGE_KEY); }
    };

    let state = Storage.load();

    const $ = (sel, root=document) => root.querySelector(sel);

    const el = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if(k === "class") n.className = v;
        else if(k === "text") n.textContent = v;
        else if(k === "html") n.innerHTML = v;
        else if(k.startsWith("on") && typeof v === "function"){
          n.addEventListener(k.slice(2).toLowerCase(), v);
        } else n.setAttribute(k, v);
      }
      children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
      return n;
    };

    const uid = (prefix="id") => `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
    const normName = (s) => (s || "").trim().replace(/\s+/g, " ").toLowerCase();
    const titleCase = (s) => (s||"").toString().replace(/_/g," ").replace(/\b\w/g, m => m.toUpperCase());

    /********************
     * Routine templates (from onboarding)
     ********************/
    const RoutineTemplates = [
      { key:"ppl", name:"PPL", desc:"Push / Pull / Legs • 6 days + 1 rest",
        buildDays(){ return [
          { label:"Push", isRest:false },{ label:"Pull", isRest:false },{ label:"Legs", isRest:false },
          { label:"Push", isRest:false },{ label:"Pull", isRest:false },{ label:"Legs", isRest:false },
          { label:"Rest", isRest:true }
        ];}},
      { key:"upper_lower", name:"Upper / Lower", desc:"4 training days • balanced • strength + size",
        buildDays(){ return [
          { label:"Upper", isRest:false },{ label:"Lower", isRest:false },{ label:"Rest", isRest:true },
          { label:"Upper", isRest:false },{ label:"Lower", isRest:false },{ label:"Rest", isRest:true },
          { label:"Rest", isRest:true }
        ];}},
      { key:"full_body_3", name:"Full Body (3-day)", desc:"3 training days • simple and effective",
        buildDays(){ return [
          { label:"Full Body", isRest:false },{ label:"Rest", isRest:true },
          { label:"Full Body", isRest:false },{ label:"Rest", isRest:true },
          { label:"Full Body", isRest:false },{ label:"Rest", isRest:true },{ label:"Rest", isRest:true }
        ];}},
      { key:"body_part_split", name:"Body Part Split", desc:"Chest/Back/Legs/Shoulders/Arms + rest",
        buildDays(){ return [
          { label:"Chest", isRest:false },{ label:"Back", isRest:false },{ label:"Legs", isRest:false },
          { label:"Shoulders", isRest:false },{ label:"Arms", isRest:false },
          { label:"Rest", isRest:true },{ label:"Rest", isRest:true }
        ];}},
      { key:"blank", name:"Blank", desc:"Start from scratch (you’ll edit days + exercises)",
        buildDays(){ return [
          { label:"Day 1", isRest:false },{ label:"Day 2", isRest:false },{ label:"Day 3", isRest:false },
          { label:"Day 4", isRest:false },{ label:"Day 5", isRest:false },{ label:"Day 6", isRest:false },
          { label:"Day 7", isRest:false }
        ];}}
    ];

    function createRoutineFromTemplate(templateKey, routineName){
      const tpl = RoutineTemplates.find(t => t.key === templateKey);
      if(!tpl) throw new Error("Invalid template key");

      const routineId = uid("rt");
      const days = tpl.buildDays().map((d, idx) => ({
        id: uid("day"),
        order: idx,
        label: d.label,
        isRest: !!d.isRest,
        exercises: [] // [{ id, refType, refId, nameSnapshot }]
      }));

      return {
        id: routineId,
        name: routineName || tpl.name,
        templateKey: tpl.key,
        createdAt: Date.now(),
        days
      };
    }

    /********************
     * Exercise Library (from step 3)
     ********************/
    const ExerciseLibrary = {
      typeKeys: ["weightlifting","cardio","core"],
      typeLabel(type){
        if(type === "weightlifting") return "Weightlifting";
        if(type === "cardio") return "Cardio";
        return "Core";
      },
      ensureSeeded(){
        const lib = state.exerciseLibrary || (state.exerciseLibrary = { weightlifting:[], cardio:[], core:[] });
        const empty = (lib.weightlifting?.length||0) === 0 && (lib.cardio?.length||0) === 0 && (lib.core?.length||0) === 0;
        if(!empty) return;

        lib.weightlifting = [
          { id: uid("ex"), type:"weightlifting", name:"Bench Press", equipment:"barbell", primaryMuscle:"chest", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Incline Dumbbell Press", equipment:"dumbbell", primaryMuscle:"chest", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Lat Pulldown", equipment:"cable", primaryMuscle:"back", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Barbell Squat", equipment:"barbell", primaryMuscle:"legs", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Curl", equipment:"dumbbell", primaryMuscle:"biceps", isCompound:false, createdAt:Date.now() }
        ];

        lib.cardio = [
          { id: uid("ex"), type:"cardio", name:"Treadmill Run", modality:"run", supportsIncline:true, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Stationary Bike", modality:"bike", supportsIncline:false, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Rowing Machine", modality:"row", supportsIncline:false, createdAt:Date.now() }
        ];

        lib.core = [
          { id: uid("ex"), type:"core", name:"Plank", equipment:"bodyweight", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Hanging Knee Raise", equipment:"bodyweight", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Cable Crunch", equipment:"cable", createdAt:Date.now() }
        ];

        Storage.save(state);
      },
      list(type){ return (state.exerciseLibrary?.[type] || []); },
      existsByName(type, name, excludeId=null){
        const n = normName(name);
        return this.list(type).some(x => normName(x.name) === n && x.id !== excludeId);
      },
      add(type, data){
        if(this.existsByName(type, data.name)) throw new Error("Exercise already exists in this category.");
        const ex = { id: uid("ex"), type, createdAt: Date.now(), ...data };
        state.exerciseLibrary[type].push(ex);
        Storage.save(state);
        return ex;
      }
    };

    /********************
     * Routine Manager (Step 4)
     ********************/
    const RoutineManager = {
      getAll(){ return state.routines || (state.routines = []); },
      getActive(){
        const all = this.getAll();
        return all.find(r => r.id === state.activeRoutineId) || all[0] || null;
      },
      setActive(id){
        state.activeRoutineId = id;
        Storage.save(state);
      },
      createFromTemplate(templateKey, name){
        const r = createRoutineFromTemplate(templateKey, name);
        this.getAll().push(r);
        state.activeRoutineId = r.id;
        Storage.save(state);
        return r;
      },
      duplicate(routineId){
        const src = this.getAll().find(r => r.id === routineId);
        if(!src) throw new Error("Routine not found.");
        const copy = JSON.parse(JSON.stringify(src));
        copy.id = uid("rt");
        copy.name = `${src.name} (Copy)`;
        copy.createdAt = Date.now();
        copy.days.forEach(d => d.id = uid("day"));
        this.getAll().push(copy);
        state.activeRoutineId = copy.id;
        Storage.save(state);
        return copy;
      },
      rename(routineId, newName){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) throw new Error("Routine not found.");
        r.name = (newName || "").trim() || r.name;
        Storage.save(state);
      },
      remove(routineId){
        const arr = this.getAll();
        const idx = arr.findIndex(r => r.id === routineId);
        if(idx < 0) return;
        arr.splice(idx, 1);
        if(state.activeRoutineId === routineId){
          state.activeRoutineId = arr[0]?.id || null;
        }
        Storage.save(state);
      },
      toggleRest(routineId, dayId){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) return;
        const d = r.days.find(x => x.id === dayId);
        if(!d) return;
        d.isRest = !d.isRest;
        Storage.save(state);
      },
      setDayLabel(routineId, dayId, label){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) return;
        const d = r.days.find(x => x.id === dayId);
        if(!d) return;
        d.label = (label || "").trim() || d.label;
        Storage.save(state);
      },
      addExerciseToDay(routineId, dayId, exerciseType, exerciseId){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) throw new Error("Routine not found.");
        const d = r.days.find(x => x.id === dayId);
        if(!d) throw new Error("Day not found.");

        const ex = ExerciseLibrary.list(exerciseType).find(x => x.id === exerciseId);
        if(!ex) throw new Error("Exercise not found in library.");

        d.exercises.push({
          id: uid("rx"),
          refType: exerciseType,
          refId: ex.id,
          nameSnapshot: ex.name
        });

        Storage.save(state);
      },
      removeExerciseFromDay(routineId, dayId, routineExerciseId){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) return;
        const d = r.days.find(x => x.id === dayId);
        if(!d) return;
        const idx = d.exercises.findIndex(x => x.id === routineExerciseId);
        if(idx < 0) return;
        d.exercises.splice(idx, 1);
        Storage.save(state);
      }
    };

    /********************
     * Modal
     ********************/
    const Modal = {
      open({ title, bodyNode }){
        $("#modalTitle").textContent = title || "Modal";
        const host = $("#modalHost");
        const body = $("#modalBody");
        body.innerHTML = "";
        if(bodyNode) body.appendChild(bodyNode);
        host.classList.add("show");
        host.setAttribute("aria-hidden","false");
      },
      close(){
        const host = $("#modalHost");
        host.classList.remove("show");
        host.setAttribute("aria-hidden","true");
        $("#modalBody").innerHTML = "";
      }
    };
    $("#modalClose").addEventListener("click", Modal.close);
    $("#modalBackdrop").addEventListener("click", Modal.close);

    /********************
     * Router
     ********************/
    const Routes = {
      home: { label: "Home" },
      routine: { label: "Routine" },
      log: { label: "Log" },
      progress: { label: "Progress" },
      more: { label: "More" }
    };
    let currentRoute = "home";

    function setChip(){
      const chip = $("#chipStatus");
      if(state.profile?.name) chip.textContent = `Hi, ${state.profile.name}`;
      else chip.textContent = "Not set up";
    }

    function renderNav(){
      const nav = $("#navbar");
      nav.innerHTML = "";
      const disabled = !state.profile;

      Object.entries(Routes).forEach(([key, r]) => {
        nav.appendChild(el("button", {
          class: "navbtn" + (key === currentRoute ? " active" : ""),
          onClick: () => { if(disabled){ navigate("home"); return; } navigate(key); }
        }, [
          el("div", { class:"dot" }),
          el("div", { text: r.label })
        ]));
      });
    }

    function navigate(routeKey){
      currentRoute = routeKey;
      renderNav();
      renderView();
    }

    function renderView(){
      setChip();
      const root = $("#viewRoot");
      root.innerHTML = "";

      if(!state.profile){
        root.appendChild(Views.Onboarding());
        return;
      }

      if(currentRoute === "home") root.appendChild(Views.Home());
      else if(currentRoute === "routine") root.appendChild(Views.RoutineEditor());
      else if(currentRoute === "log") root.appendChild(Views.Log());
      else if(currentRoute === "progress") root.appendChild(Views.Progress());
      else if(currentRoute === "more") root.appendChild(Views.More());
    }

    /********************
     * Views
     ********************/
    const Views = {
      Onboarding(){
        let hideRestDays = true;
        let selectedTpl = "ppl";
        const errorBox = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

        const switchNode = el("div", { class:"switch on" });
        switchNode.addEventListener("click", () => {
          hideRestDays = !hideRestDays;
          switchNode.classList.toggle("on", hideRestDays);
        });

        const tplCardsHost = el("div", { class:"tplGrid" });
        const renderTplCards = () => {
          tplCardsHost.innerHTML = "";
          RoutineTemplates.forEach(t => {
            tplCardsHost.appendChild(el("div", {
              class: "tpl" + (t.key === selectedTpl ? " selected" : ""),
              onClick: () => { selectedTpl = t.key; renderTplCards(); }
            }, [
              el("div", { class:"name", text: t.name }),
              el("div", { class:"desc", text: t.desc })
            ]));
          });
        };
        renderTplCards();

        const nameInput = el("input", { type:"text", placeholder:"Jordan" });
        const proteinInput = el("input", { type:"number", inputmode:"numeric", placeholder:"180", min:"0" });

        const weekSelect = el("select", {});
        weekSelect.appendChild(el("option", { value:"mon", text:"Monday" }));
        weekSelect.appendChild(el("option", { value:"sun", text:"Sunday" }));
        weekSelect.value = "mon";

        const finish = () => {
          errorBox.style.display = "none";
          errorBox.textContent = "";

          const cleanName = (nameInput.value || "").trim();
          const cleanProtein = Number(proteinInput.value);
          const weekStartsOn = weekSelect.value === "sun" ? "sun" : "mon";

          if(!cleanName){
            errorBox.textContent = "Please enter your name.";
            errorBox.style.display = "block";
            return;
          }
          if(!Number.isFinite(cleanProtein) || cleanProtein <= 0){
            errorBox.textContent = "Please enter a valid daily protein goal (grams).";
            errorBox.style.display = "block";
            return;
          }

          state.profile = {
            name: cleanName,
            proteinGoal: Math.round(cleanProtein),
            weekStartsOn,
            hideRestDays: !!hideRestDays
          };

          const routineName = RoutineTemplates.find(t => t.key === selectedTpl)?.name || "Routine";
          const routine = createRoutineFromTemplate(selectedTpl, routineName);
          state.routines = [routine];
          state.activeRoutineId = routine.id;

          ExerciseLibrary.ensureSeeded();
          Storage.save(state);
          navigate("home");
        };

        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Welcome" }),
            el("div", { class:"note", text:"Create your profile and choose a routine template. You can edit everything later." })
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Create profile" }),
            el("div", { class:"form" }, [
              el("div", { class:"row2" }, [
                el("label", {}, [ el("span", { text:"Name" }), nameInput ]),
                el("label", {}, [ el("span", { text:"Protein goal (grams/day)" }), proteinInput ])
              ]),
              el("div", { class:"row2" }, [
                el("label", {}, [ el("span", { text:"Week starts on" }), weekSelect ]),
                el("div", { class:"toggle" }, [
                  el("div", { class:"ttext" }, [
                    el("div", { class:"a", text:"Hide rest days" }),
                    el("div", { class:"b", text:"Rest days won’t appear on Home (Routine can still show them later)" })
                  ]),
                  switchNode
                ])
              ]),
              errorBox
            ])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Choose a routine template" }),
            tplCardsHost,
            el("div", { style:"height:10px" }),
            el("div", { class:"btnrow" }, [
              el("button", { class:"btn primary", onClick: finish }, ["Finish setup"]),
              el("button", {
                class:"btn danger",
                onClick: () => {
                  Modal.open({
                    title: "Reset local data",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text:"This clears everything saved in this browser for the app." }),
                      el("div", { style:"height:12px" }),
                      el("div", { class:"btnrow" }, [
                        el("button", {
                          class:"btn danger",
                          onClick: () => {
                            Storage.reset();
                            state = Storage.load();
                            Modal.close();
                            navigate("home");
                          }
                        }, ["Reset"]),
                        el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                      ])
                    ])
                  });
                }
              }, ["Reset"])
            ])
          ])
        ]);
      },

      Home(){
        return el("div", { class:"grid cols2" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Today" }),
            el("div", { class:"note", text:"Step 5 will auto-select today’s workout based on day-of-week + your active routine." })
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Protein" }),
            el("div", { class:"note", text:`Goal: ${state.profile?.proteinGoal ?? 0}g/day (ring + meals later)` })
          ])
        ]);
      },

      RoutineEditor(){
        ExerciseLibrary.ensureSeeded();

        // Ensure we have at least 1 routine (in case user imported/edited data later)
        if((state.routines?.length || 0) === 0){
          const r = createRoutineFromTemplate("blank", "Blank");
          state.routines = [r];
          state.activeRoutineId = r.id;
          Storage.save(state);
        }

        const routines = RoutineManager.getAll();
        const active = RoutineManager.getActive();
        if(!active) return el("div", { class:"card" }, [ el("h2", { text:"Routine" }), el("div", { class:"note", text:"No routine found." }) ]);

        const hideRest = !!state.profile?.hideRestDays;

        const routineSelect = el("select", {});
        routines.forEach(r => routineSelect.appendChild(el("option", { value:r.id, text:r.name })));
        routineSelect.value = active.id;
        routineSelect.addEventListener("change", () => {
          RoutineManager.setActive(routineSelect.value);
          renderView();
        });

        const openCreateRoutine = () => {
          let selectedTpl = "ppl";
          const nameInput = el("input", { type:"text", placeholder:"Routine name (optional)" });

          const tplCards = el("div", { class:"tplGrid" });
          const draw = () => {
            tplCards.innerHTML = "";
            RoutineTemplates.forEach(t => {
              tplCards.appendChild(el("div", {
                class:"tpl" + (t.key === selectedTpl ? " selected" : ""),
                onClick: () => { selectedTpl = t.key; draw(); }
              }, [
                el("div", { class:"name", text:t.name }),
                el("div", { class:"desc", text:t.desc })
              ]));
            });
          };
          draw();

          Modal.open({
            title: "Create routine",
            bodyNode: el("div", {}, [
              el("div", { class:"form" }, [
                el("label", {}, [ el("span", { text:"Name" }), nameInput ])
              ]),
              el("div", { style:"height:10px" }),
              tplCards,
              el("div", { style:"height:12px" }),
              el("div", { class:"btnrow" }, [
                el("button", {
                  class:"btn primary",
                  onClick: () => {
                    const nm = (nameInput.value || "").trim();
                    const tplName = RoutineTemplates.find(t => t.key === selectedTpl)?.name || "Routine";
                    RoutineManager.createFromTemplate(selectedTpl, nm || tplName);
                    Modal.close();
                    renderView();
                  }
                }, ["Create"]),
                el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
              ])
            ])
          });
        };

        const openRenameRoutine = () => {
          const nameInput = el("input", { type:"text", value: active.name });
          Modal.open({
            title: "Rename routine",
            bodyNode: el("div", {}, [
              el("div", { class:"form" }, [
                el("label", {}, [ el("span", { text:"Name" }), nameInput ])
              ]),
              el("div", { style:"height:12px" }),
              el("div", { class:"btnrow" }, [
                el("button", {
                  class:"btn primary",
                  onClick: () => {
                    RoutineManager.rename(active.id, nameInput.value);
                    Modal.close();
                    renderView();
                  }
                }, ["Save"]),
                el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
              ])
            ])
          });
        };

        const openLibraryModal = () => {
          Modal.open({ title: "Exercise Library", bodyNode: buildLibraryManagerModal() });
        };

        const openDayEditModal = (day) => {
          const labelInput = el("input", { type:"text", value: day.label });
          Modal.open({
            title: "Edit day",
            bodyNode: el("div", {}, [
              el("div", { class:"form" }, [
                el("label", {}, [ el("span", { text:"Day label" }), labelInput ])
              ]),
              el("div", { style:"height:12px" }),
              el("div", { class:"btnrow" }, [
                el("button", {
                  class:"btn primary",
                  onClick: () => {
                    RoutineManager.setDayLabel(active.id, day.id, labelInput.value);
                    Modal.close();
                    renderView();
                  }
                }, ["Save"]),
                el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
              ])
            ])
          });
        };

        const openAddExercisesModal = (day, multi=false) => {
          Modal.open({
            title: multi ? `Add multiple exercises` : `Add exercise`,
            bodyNode: buildExercisePickerModal({
              onPick: (picked) => {
                // picked can be a single {type,id} or array
                try{
                  if(Array.isArray(picked)){
                    picked.forEach(p => RoutineManager.addExerciseToDay(active.id, day.id, p.type, p.id));
                  } else {
                    RoutineManager.addExerciseToDay(active.id, day.id, picked.type, picked.id);
                  }
                  Modal.close();
                  renderView();
                }catch(e){
                  const box = $("#pickerError");
                  if(box){
                    box.textContent = e.message || "Unable to add.";
                    box.style.display = "block";
                  }
                }
              }
            })
          });
        };

        // Days list
        const daysHost = el("div", { class:"grid" });

        const sortedDays = [...active.days].sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
        const visibleDays = hideRest ? sortedDays.filter(d => !d.isRest) : sortedDays;

        visibleDays.forEach(day => {
          const exHost = el("div", { class:"exList" });

          if(day.isRest){
            exHost.appendChild(el("div", { class:"note", text:"Rest day" }));
          } else if((day.exercises?.length || 0) === 0){
            exHost.appendChild(el("div", { class:"note", text:"No exercises yet. Add from your library." }));
          } else {
            day.exercises.forEach(rx => {
              exHost.appendChild(el("div", { class:"exRow" }, [
                el("div", { style:"display:flex; flex-direction:column; gap:2px; min-width:0;" }, [
                  el("div", { class:"lname", text: rx.nameSnapshot || "Exercise" }),
                  el("div", { class:"lmeta", text: `${titleCase(rx.refType)}` })
                ]),
                el("button", {
                  class:"mini danger",
                  onClick: () => {
                    RoutineManager.removeExerciseFromDay(active.id, day.id, rx.id);
                    renderView();
                  }
                }, ["Remove"])
              ]));
            });
          }

          const dayCard = el("div", { class:"dayCard" }, [
            el("div", { class:"dayHeader" }, [
              el("div", { class:"dleft" }, [
                el("div", { class:"dname", text: day.label }),
                day.isRest ? el("div", { class:"pill rest", text:"Rest Day" }) : el("div", { class:"pill", text:`Exercises: ${day.exercises?.length || 0}` })
              ]),
              el("div", { class:"btnrow" }, [
                el("button", { class:"mini", onClick: () => openDayEditModal(day) }, ["Edit"]),
                el("button", {
                  class:"mini",
                  onClick: () => { RoutineManager.toggleRest(active.id, day.id); renderView(); }
                }, [day.isRest ? "Unrest" : "Rest"]),
                el("button", { class:"mini primary", onClick: () => openAddExercisesModal(day, false) }, ["+1"]),
                el("button", { class:"mini primary", onClick: () => openAddExercisesModal(day, true) }, ["+Multi"])
              ])
            ]),
            exHost
          ]);

          daysHost.appendChild(dayCard);
        });

        // Routine header card
        const headerCard = el("div", { class:"card" }, [
          el("h2", { text:"Routine Editor" }),
          el("div", { class:"row2" }, [
            el("label", {}, [ el("span", { text:"Active routine" }), routineSelect ]),
            el("div", { style:"display:flex; align-items:end; justify-content:flex-end; gap:10px; flex-wrap:wrap;" }, [
              el("button", { class:"btn primary", onClick: openCreateRoutine }, ["Create"]),
              el("button", { class:"btn", onClick: openRenameRoutine }, ["Rename"]),
              el("button", {
                class:"btn",
                onClick: () => { RoutineManager.duplicate(active.id); renderView(); }
              }, ["Duplicate"]),
              el("button", {
                class:"btn danger",
                onClick: () => {
                  Modal.open({
                    title: "Delete routine?",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text:`Delete "${active.name}"? This cannot be undone.` }),
                      el("div", { style:"height:12px" }),
                      el("div", { class:"btnrow" }, [
                        el("button", {
                          class:"btn danger",
                          onClick: () => {
                            RoutineManager.remove(active.id);
                            Modal.close();
                            renderView();
                          }
                        }, ["Delete"]),
                        el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                      ])
                    ])
                  });
                }
              }, ["Delete"])
            ])
          ]),
          el("div", { style:"height:10px" }),
          el("div", { class:"btnrow" }, [
            el("button", { class:"btn", onClick: openLibraryModal }, ["Open Exercise Library"]),
          ]),
          el("div", { style:"height:6px" }),
          el("div", { class:"note", text: hideRest ? "Rest days are hidden (Profile setting). Toggle rest/unrest to adjust." : "Rest days are visible." })
        ]);

        return el("div", { class:"grid" }, [
          headerCard,
          el("div", { class:"card" }, [
            el("h2", { text:"Days" }),
            el("div", { class:"note", text:"Add exercises from your library. Use +Multi to add several at once." }),
            el("div", { style:"height:10px" }),
            daysHost
          ])
        ]);

        /***************
         * Modal builders
         ***************/
        function buildLibraryManagerModal(){
          // Lightweight viewer + add for now
          let tab = "weightlifting";
          let query = "";
          const listHost = el("div", { class:"grid" });
          const searchInput = el("input", { type:"text", placeholder:"Search…" });
          searchInput.addEventListener("input", () => { query = searchInput.value || ""; draw(); });

          const seg = el("div", { class:"seg" });
          const segButtons = {};
          ExerciseLibrary.typeKeys.forEach(t => {
            const b = el("button", {
              class:"segbtn" + (t === tab ? " active" : ""),
              onClick: () => { tab = t; Object.entries(segButtons).forEach(([k,btn])=>btn.classList.toggle("active",k===tab)); draw(); }
            }, [ExerciseLibrary.typeLabel(t)]);
            segButtons[t]=b;
            seg.appendChild(b);
          });

          const openAdd = () => {
            Modal.open({
              title: `Add ${ExerciseLibrary.typeLabel(tab)} exercise`,
              bodyNode: buildAddExerciseForm(tab, () => { Modal.close(); Modal.open({ title:"Exercise Library", bodyNode: buildLibraryManagerModal() }); })
            });
          };

          function getFiltered(){
            const q = normName(query);
            const items = [...ExerciseLibrary.list(tab)].sort((a,b)=>(a.name||"").localeCompare(b.name||""));
            if(!q) return items;
            return items.filter(x => normName(x.name).includes(q));
          }

          function draw(){
            listHost.innerHTML = "";
            const items = getFiltered();
            listHost.appendChild(el("div", { class:"note", text: `${items.length} shown` }));

            items.forEach(x => {
              listHost.appendChild(el("div", { class:"routineRow" }, [
                el("div", { class:"left" }, [
                  el("div", { class:"name", text:x.name }),
                  el("div", { class:"meta", text: x.type === "cardio" ? `Mode: ${titleCase(x.modality||"—")}` :
                                          x.type === "weightlifting" ? `Equipment: ${titleCase(x.equipment||"—")} • Muscle: ${titleCase(x.primaryMuscle||"—")}` :
                                          `Equipment: ${titleCase(x.equipment||"—")}` })
                ])
              ]));
            });

            if(items.length === 0){
              listHost.appendChild(el("div", { class:"note", text:"No matches. Add a new exercise." }));
            }
          }

          draw();

          return el("div", {}, [
            el("div", { class:"note", text:"Manage your library here. Editing/removal will come in the next enhancement (kept stable for now)." }),
            el("div", { style:"height:10px" }),
            seg,
            el("div", { style:"height:10px" }),
            el("div", { class:"row2" }, [
              el("label", {}, [ el("span", { text:"Search" }), searchInput ]),
              el("div", { style:"display:flex; align-items:end;" }, [
                el("button", { class:"btn primary", onClick: openAdd }, ["Add exercise"])
              ])
            ]),
            el("div", { style:"height:10px" }),
            listHost
          ]);
        }

        function buildAddExerciseForm(type, onDone){
          const err = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });
          const nameInput = el("input", { type:"text", placeholder:"Exercise name" });

          const form = el("div", { class:"form" }, [
            el("label", {}, [ el("span", { text:"Name" }), nameInput ])
          ]);

          let payloadGet = null;

          if(type === "weightlifting"){
            const equipment = el("select", {});
            ["dumbbell","barbell","machine","cable","bodyweight","other"].forEach(v => equipment.appendChild(el("option",{value:v,text:titleCase(v)})));
            const muscle = el("select", {});
            ["chest","back","legs","shoulders","biceps","triceps","glutes","hamstrings","quads","calves","full body","other"]
              .forEach(v => muscle.appendChild(el("option",{value:v,text:titleCase(v)})));
            let isCompound = true;
            const sw = el("div", { class:"switch on" });
            sw.addEventListener("click", ()=>{ isCompound=!isCompound; sw.classList.toggle("on", isCompound); });

            form.appendChild(el("div", { class:"row2" }, [
              el("label", {}, [ el("span", { text:"Equipment" }), equipment ]),
              el("label", {}, [ el("span", { text:"Primary muscle" }), muscle ])
            ]));
            form.appendChild(el("div", { class:"toggle" }, [
              el("div", { class:"ttext" }, [
                el("div", { class:"a", text:"Compound lift" }),
                el("div", { class:"b", text:"Used later for volume/PR logic." })
              ]),
              sw
            ]));

            payloadGet = () => ({ name:(nameInput.value||"").trim(), equipment:equipment.value, primaryMuscle:muscle.value, isCompound });
          }

          if(type === "cardio"){
            const modality = el("select", {});
            ["run","bike","row","stairmaster","elliptical","walk","other"].forEach(v => modality.appendChild(el("option",{value:v,text:titleCase(v)})));
            let supportsIncline = false;
            const sw = el("div", { class:"switch" });
            sw.addEventListener("click", ()=>{ supportsIncline=!supportsIncline; sw.classList.toggle("on", supportsIncline); });

            form.appendChild(el("label", {}, [ el("span", { text:"Modality" }), modality ]));
            form.appendChild(el("div", { class:"toggle" }, [
              el("div", { class:"ttext" }, [
                el("div", { class:"a", text:"Supports incline" }),
                el("div", { class:"b", text:"If enabled, cardio logs can include incline." })
              ]),
              sw
            ]));

            payloadGet = () => ({ name:(nameInput.value||"").trim(), modality:modality.value, supportsIncline });
          }

          if(type === "core"){
            const equipment = el("select", {});
            ["bodyweight","weighted","cable","other"].forEach(v => equipment.appendChild(el("option",{value:v,text:titleCase(v)})));
            form.appendChild(el("label", {}, [ el("span", { text:"Equipment" }), equipment ]));
            payloadGet = () => ({ name:(nameInput.value||"").trim(), equipment:equipment.value });
          }

          const save = () => {
            err.style.display = "none";
            const data = payloadGet ? payloadGet() : { name:(nameInput.value||"").trim() };
            if(!data.name){
              err.textContent = "Name is required.";
              err.style.display = "block";
              return;
            }
            try{
              ExerciseLibrary.add(type, data);
              Storage.save(state);
              onDone?.();
            }catch(e){
              err.textContent = e.message || "Unable to add exercise.";
              err.style.display = "block";
            }
          };

          return el("div", {}, [
            form,
            err,
            el("div", { style:"height:12px" }),
            el("div", { class:"btnrow" }, [
              el("button", { class:"btn primary", onClick: save }, ["Add"]),
              el("button", { class:"btn", onClick: onDone || Modal.close }, ["Done"])
            ])
          ]);
        }

        function buildExercisePickerModal({ onPick }){
          let tab = "weightlifting";
          let query = "";
          let multiMode = true; // we will support both by letting caller decide based on which button opened it
          // Caller decides by title; we detect by modal title containing "multiple"
          // (keeps API stable with minimal wiring)
          multiMode = ($("#modalTitle")?.textContent || "").toLowerCase().includes("multiple");

          const selected = new Map(); // key: `${type}:${id}` -> {type,id,name}

          const err = el("div", { id:"pickerError", class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

          const seg = el("div", { class:"seg" });
          const segButtons = {};
          ExerciseLibrary.typeKeys.forEach(t => {
            const b = el("button", {
              class:"segbtn" + (t === tab ? " active" : ""),
              onClick: () => { tab = t; Object.entries(segButtons).forEach(([k,btn])=>btn.classList.toggle("active",k===tab)); draw(); }
            }, [ExerciseLibrary.typeLabel(t)]);
            segButtons[t]=b; seg.appendChild(b);
          });

          const searchInput = el("input", { type:"text", placeholder:"Search library…" });
          searchInput.addEventListener("input", () => { query = searchInput.value || ""; draw(); });

          const listHost = el("div", { class:"grid" });

          const addNewInline = el("button", {
            class:"btn",
            onClick: () => {
              Modal.open({
                title: `Add ${ExerciseLibrary.typeLabel(tab)} exercise`,
                bodyNode: buildAddExerciseForm(tab, () => {
                  // After adding, reopen picker
                  Modal.close();
                  Modal.open({
                    title: multiMode ? "Add multiple exercises" : "Add exercise",
                    bodyNode: buildExercisePickerModal({ onPick })
                  });
                })
              });
            }
          }, ["Add new exercise"]);

          const doneBtn = el("button", {
            class:"btn primary",
            onClick: () => {
              err.style.display = "none";
              if(multiMode){
                const arr = Array.from(selected.values()).map(x => ({ type:x.type, id:x.id }));
                if(arr.length === 0){
                  err.textContent = "Select at least one exercise.";
                  err.style.display = "block";
                  return;
                }
                onPick(arr);
              } else {
                const first = selected.values().next().value;
                if(!first){
                  err.textContent = "Select an exercise.";
                  err.style.display = "block";
                  return;
                }
                onPick({ type:first.type, id:first.id });
              }
            }
          }, [multiMode ? "Add selected" : "Add"]);

          function filtered(){
            const q = normName(query);
            const items = [...ExerciseLibrary.list(tab)].sort((a,b)=>(a.name||"").localeCompare(b.name||""));
            if(!q) return items;
            return items.filter(x => normName(x.name).includes(q));
          }

          function draw(){
            listHost.innerHTML = "";
            const items = filtered();

            listHost.appendChild(el("div", { class:"note", text: `${items.length} shown • ${multiMode ? (selected.size + " selected") : "tap one to select"}` }));

            items.forEach(x => {
              const key = `${tab}:${x.id}`;
              const isSel = selected.has(key);

              const row = el("div", {
                class:"routineRow",
                onClick: () => {
                  err.style.display = "none";
                  if(multiMode){
                    if(isSel) selected.delete(key);
                    else selected.set(key, { type: tab, id: x.id, name: x.name });
                  } else {
                    selected.clear();
                    selected.set(key, { type: tab, id: x.id, name: x.name });
                  }
                  draw();
                }
              }, [
                el("div", { class:"left" }, [
                  el("div", { class:"name", text: x.name }),
                  el("div", { class:"meta", text: tab === "cardio" ? `Mode: ${titleCase(x.modality||"—")}` :
                                          tab === "weightlifting" ? `Equipment: ${titleCase(x.equipment||"—")} • Muscle: ${titleCase(x.primaryMuscle||"—")}` :
                                          `Equipment: ${titleCase(x.equipment||"—")}` })
                ]),
                el("div", { class:"pill" + (isSel ? " rest" : ""), text: isSel ? "Selected" : "Tap" })
              ]);

              listHost.appendChild(row);
            });

            if(items.length === 0){
              listHost.appendChild(el("div", { class:"note", text:"No matches. Add a new exercise." }));
            }
          }

          draw();

          return el("div", {}, [
            seg,
            el("div", { style:"height:10px" }),
            el("div", { class:"row2" }, [
              el("label", {}, [ el("span", { text:"Search" }), searchInput ]),
              el("div", { style:"display:flex; align-items:end; justify-content:flex-end; gap:10px; flex-wrap:wrap;" }, [
                addNewInline
              ])
            ]),
            err,
            el("div", { style:"height:10px" }),
            listHost,
            el("div", { style:"height:12px" }),
            el("div", { class:"btnrow" }, [
              doneBtn,
              el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
            ])
          ]);
        }
      },

      Log(){
        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Log Sets" }),
            el("div", { class:"note", text:"Next step: log sets per exercise type + PR engine." })
          ])
        ]);
      },

      Progress(){
        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Progress" }),
            el("div", { class:"note", text:"Next step: chart + table views." })
          ])
        ]);
      },

      More(){
        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"More" }),
            el("div", { class:"btnrow" }, [
              el("button", {
                class:"btn",
                onClick: () => Modal.open({
                  title: "Current State (JSON)",
                  bodyNode: el("pre", { style:"white-space:pre-wrap; font-size:12px; color: rgba(255,255,255,.85);" }, [
                    JSON.stringify(state, null, 2)
                  ])
                })
              }, ["View state JSON"]),
              el("button", {
                class:"btn danger",
                onClick: () => {
                  Modal.open({
                    title: "Reset local data",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text:"This clears everything saved in this browser for the app." }),
                      el("div", { style:"height:12px" }),
                      el("div", { class:"btnrow" }, [
                        el("button", {
                          class:"btn danger",
                          onClick: () => {
                            Storage.reset();
                            state = Storage.load();
                            Modal.close();
                            navigate("home");
                          }
                        }, ["Reset"]),
                        el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                      ])
                    ])
                  });
                }
              }, ["Reset local data"])
            ])
          ])
        ]);
      }
    };

    /********************
     * Boot
     ********************/
    if(state.profile) ExerciseLibrary.ensureSeeded();
    renderNav();
    renderView();
  </script>
</body>
</html>
