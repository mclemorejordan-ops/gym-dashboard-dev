
<!doctype html>


<html lang="en">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Gym Dashboard</title>
  <style>

 /* ===========================
   FIXED 2-ROW HEADER (NO WRAP)
=========================== */
.appHeader{
  position: sticky;
  top: 0;
  z-index: 60;
  padding: calc(env(safe-area-inset-top) + 14px) 16px 10px;

  background: linear-gradient(
    to bottom,
    rgba(7,7,8,.92),
    rgba(7,7,8,.55),
    rgba(7,7,8,0)
  );
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

/* Row 1: title + version (fixed positions) */
.hdrRow1{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;

  /* IMPORTANT */
  flex-wrap:nowrap;
  min-height: 32px;
}

.hdrRow1 h1{
  margin:0;
  font-size:26px;
  font-weight:800;
  letter-spacing:.2px;
  color: var(--text);

  /* prevent wrap */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.hdrVersion{
  color: var(--muted);
  font-size: 13px;
  white-space:nowrap;
  flex: 0 0 auto;
}

/* Row 2: single line summary, never wraps */
.hdrRow2{
  margin-top: 6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;

  flex-wrap:nowrap;
  min-height: 22px;
}

.hdrLeft{
  display:flex;
  align-items:center;
  gap:8px;

  /* prevent wrap */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  min-width: 0;
}

.hdrDay{
  color: var(--text);
  font-size: 13px;
  font-weight: 700;
  flex: 0 0 auto;
}

.hdrProtein{
  color: var(--muted);
  font-size: 13px;
  flex: 0 0 auto;
}

.hdrSep{
  color: rgba(255,255,255,.18);
  font-size: 13px;
  flex: 0 0 auto;
}

/* Status block has fixed width so the left side never shifts */
.hdrStatus{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:8px;

  width: 170px;       /* key: keeps layout stable */
  flex: 0 0 170px;

  white-space:nowrap;
}

.hdrDot{
  width: 20px;
  text-align:center;
  flex: 0 0 20px;
}

.hdrOnline{
  font-size: 13px;
  font-weight: 700;
}

/* color states */
.hdrStatus.good .hdrOnline{ color: var(--good); }
.hdrStatus.warn .hdrOnline{ color: var(--warn); }
.hdrStatus.bad  .hdrOnline{ color: var(--bad); }

    
  :root{
  --bg0:#070708;
  --bg1:#0b0b0c;

  --card:#121214;
  --card-soft: rgba(18,18,20,.88);

  --text:#f5f6f7;
  --muted:#9aa0a6;

  --line: rgba(255,255,255,.08);

  --accent:#7CFC00;   /* Apple Fitness‚Äìstyle green */
  --danger:#ff6b6b;
  --warn:#ffd166;

  --good: var(--accent);
  --bad:  var(--danger);

  --radius:16px;
  --shadow: 0 14px 40px rgba(0,0,0,.45);
}

/* ===========================
   GLOBAL iOS INPUT ZOOM KILL
=========================== */
input,
select,
textarea{
  font-size: 16px !important;
}

/* Prevent iOS from auto-scaling text */
html{
  -webkit-text-size-adjust: 100%;
}

/* Visual-only: prevent nested scrolling in Exercise Picker */
#exPickModal > div{
  overflow: hidden !important;   /* card does not scroll */
  display:flex;
  flex-direction:column;
}

#exPickList{
  flex:1;                        /* list fills remaining space */
  overflow-y:auto;               /* list scrolls */
  -webkit-overflow-scrolling: touch;
}


/* ---------------------------
   MODAL SCROLL FIX (mobile + desktop)
   - make the MODAL CARD the scroller
   - avoid nested scrolling on iOS
---------------------------- */

/* overlays */
:is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal){
  overflow:hidden;                 /* prevents overlay scroll fighting */
  -webkit-overflow-scrolling:touch;
}

    /* ===========================
   EXERCISE PICKER SIZE FIX
   - keeps modal small
   - list scrolls instead
=========================== */

#exPickModal > div{
  max-height: calc(100dvh - 32px);
  overflow: hidden;
}

#exPickList{
  margin-top: 10px;
  border: 1px solid #202124;
  border-radius: 12px;

  max-height: 320px;      /* adjust if needed */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

    /* ===========================
   iOS PWA INPUT ZOOM FIX
   Prevents auto-zoom on focus
=========================== */

/* Exercise picker inputs */
#exPickModal input,
#exPickModal select,
#exPickModal textarea{
  font-size: 16px !important;
}

/* Batch add modal inputs (just in case) */
#batchAddModal input,
#batchAddModal select{
  font-size: 16px !important;
}
    

:is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal) > div{
  max-height: calc(100dvh - 32px); /* true mobile viewport height */
  overflow-y:auto;                 /* scroll the whole modal */
  -webkit-overflow-scrolling:touch;
  display:flex;
  flex-direction:column;
}

/* ‚úÖ Log Sets list should NOT be its own scrollbar (prevents nested scroll on iOS) */
#logModalSets{
  overflow: visible;
  max-height: none;
}

/* ‚úÖ Routine Editor list should NOT be its own scrollbar */
#rtExList{
  overflow: visible !important;
  max-height: none !important;
}

/* keep action buttons visible in modals */
#rtModal .btnRow,
#logModal .btnRow{
  position: sticky;
  bottom: 0;
  background: linear-gradient(
    to bottom,
    rgba(18,18,20,0),
    rgba(18,18,20,1) 35%
  );
  padding-top: 10px;
}
/* ‚úÖ END MODAL SCROLL FIX */

    /* ---------------------------
   MODAL GLASS + ANIMATION
---------------------------- */

/* overlay fade */
:is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal){
  animation: modalFadeIn .14s ease;
}

/* the modal card */
:is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal) > div{
  animation: modalPopIn .14s ease;
  background: rgba(18,18,20,.92) !important;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  box-shadow: 0 16px 50px rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.10) !important;
}

/* keyframes */
@keyframes modalFadeIn{
  from{ opacity:0; }
  to{ opacity:1; }
}
@keyframes modalPopIn{
  from{ opacity:0; transform: translateY(10px) scale(.98); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}

/* respect reduced motion */
@media (prefers-reduced-motion: reduce){
  :is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal),
  :is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal) > div{
    animation: none !important;
  }
}
    
    *{box-sizing:border-box}
body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
  color: var(--text);

  background:
    radial-gradient(1200px 800px at 50% 140px, rgba(124,252,0,.08), transparent 72%),
    radial-gradient(1200px 900px at 50% 65%, rgba(124,252,0,.03), transparent 70%),
    linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 55%, var(--bg0) 120%);
  background-attachment: fixed; /* ‚úÖ makes it feel like one continuous ‚Äúcanvas‚Äù */
}


    /* ‚úÖ Unified app header (matches mockup) */
header{
  position: sticky;
  top: 0;
  z-index: 60;
  padding: calc(env(safe-area-inset-top) + 14px) 16px 14px;

  background: linear-gradient(
    to bottom,
    rgba(7,7,8,.92),
    rgba(7,7,8,.55),
    rgba(7,7,8,0)
  );

  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-bottom: none;
}
header h1{
  margin:0;
  font-size:26px;
  font-weight:800;
  letter-spacing:.2px;
  color: var(--text);
}

header .sub{
  margin-top:6px;
  font-size:13px;
  color: var(--muted);
}
    main{
      padding:14px 12px 80px;
      display:grid;
      gap:12px;
      max-width:1100px;
      margin:0 auto;
      position: relative; /* ‚úÖ ADD */
    }

main > *{
  position: relative;
  z-index: 1;
}
    .grid2{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid2{grid-template-columns: 1fr 1fr;}
    }
    
    #homeFocus{
  white-space: pre-line;
}
   .card{
  background: rgba(18,18,20,.72);   /* ‚úÖ translucent so the body gradient shows through */
  border: 1px solid rgba(255,255,255,.08);
  border-radius: var(--radius);
  padding:14px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.4px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:11px;
      color:var(--muted);
      min-width: 120px;
      flex:1 1 140px;
    }
    input, select, button, textarea{
      background:#0f0f10;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:38px; resize:vertical;}
    input::placeholder{color:#666}
    button{
      cursor:pointer;
      background:#0f0f10;
      font-weight:600;
    }
    button:hover{border-color:#2a2b2f}
    .btnRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    /* ===========================
   SETTINGS UPDATES (PILLS)
=========================== */
.updatesGroupTitle{
  font-size: 11px;
  color: var(--muted);
  letter-spacing: .6px;
  text-transform: uppercase;
  margin-bottom: 8px;
}

.updatesPills{
  display: grid;
  gap: 8px;
}

.pillRow{
  width: 100%;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 12px;
  border: 1px solid var(--line);
  border-radius: 999px;
  background: rgba(15,15,16,.9);
  color: var(--text);
  font-size: 13px;
}

.updatesActions{
  display: grid;
  gap: 8px;
}

.updatesActions button{
  width: 100%;
  border-radius: 999px;
  padding: 12px 12px;
  font-size: 13px;
}


/* ===========================
   UPDATES DROPDOWN PANELS
=========================== */
.updatesDropPanel{
  margin-top: 10px;
  padding: 12px;
  border: 1px solid var(--line);
  border-radius: 16px;
  background: rgba(18,18,20,.55);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.updatesDropHead{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}
.updatesDropTitle{
  font-weight: 900;
  font-size: 13px;
}

/* ===========================
   UPDATE RESULT POPUP
=========================== */
.uModal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  z-index: 99999;
  padding: 16px;

  /* ‚úÖ Always center the card on screen */
  display: flex;
  align-items: center;
  justify-content: center;
}

.uModalCard{
  width: min(560px, 100%);
  margin: 0;
  background: rgba(18,18,20,.92);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 16px;
  padding: 12px;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  box-shadow: 0 16px 50px rgba(0,0,0,.55);

  /* ‚úÖ If screen is short, card scrolls instead of going off screen */
  max-height: calc(100dvh - 32px);
  overflow: auto;
}


.uModalHead{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.uModalTitle{
  font-weight: 900;
  font-size: 14px;
}

.uModalActions{
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  flex-wrap: wrap;
  margin-top: 12px;
}
    
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--text)}
    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-align:left;
      vertical-align:top;
    }
    th{
      color:var(--muted);
      font-weight:700;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.6px;
      background:#0f0f10;
    }
    tr:last-child td{border-bottom:none}
    .mono{font-variant-numeric: tabular-nums;}
    .good{color:var(--good); font-weight:700;}
    .bad{color:var(--bad); font-weight:700;}
    .warn{color:var(--warn); font-weight:700;}
    .muted{color:var(--muted)}
    .small{font-size:11px}
    .splitTabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      color:var(--muted);
      background:#0f0f10;
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .tab.active{
      color:var(--text);
      border-color:#2a2b2f;
    }
    .exerciseList{
      display:grid;
      gap:8px;
    }
    .exerciseItem{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#0f0f10;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .exerciseItem .left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .exerciseItem .title{
      font-size:13px;
      font-weight:700;
    }
    .exerciseItem .meta{
      font-size:11px;
      color:var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .exerciseItem .right{
      text-align:right;
      min-width:160px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .exerciseItem .right .line2{
      font-size:11px;
      color:var(--muted);
    }

    /* ===========================
   ROUTINE ‚Äî 3D DAY CAROUSEL (mobile-first)
   - replaces #pplTabs UI, but keeps #pplList layout + Log Sets
=========================== */

.r3dStage{
  height: 230px;
  position: relative;
  overflow: hidden;
  border-radius: 16px;
  border: 1px solid var(--line);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.r3dCarousel{
  position:absolute;
  left: 50%;
  top: 110%;               /* your ‚Äúperfect‚Äù position */
  transform-style: preserve-3d;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
  touch-action: pan-y;
  user-select:none;
}

.r3dCard{
  position:absolute;
  left: 50%;
  top: 0;
  transform-style: preserve-3d;

  width: 220px;
  height: 130px;
  margin-left: -110px;

  border-radius: 18px;

  background: linear-gradient(
    180deg,
    #0d0d12 0%,
    #08080c 60%,
    #050508 100%
  );

  border: 1px solid rgba(255,255,255,.05);

  box-shadow:
    0 24px 70px rgba(0,0,0,.75),
    inset 0 1px 0 rgba(255,255,255,.04),
    inset 0 -12px 26px rgba(0,0,0,.55);

  overflow: hidden;

  transition:
    transform 180ms ease,
    box-shadow 220ms ease,
    filter 220ms ease,
    opacity 220ms ease,
    border-color 220ms ease;
}
/* Automatically darken non-active cards */
.r3dCard:not(.isActive){
  filter: brightness(.68) saturate(.95);
  opacity: .80;
}

/* Active card ‚Äì glow + stronger presence */
.r3dCard.isActive{
  filter: none;
  opacity: 1;

  border-color: rgba(124,252,0,.25);

  box-shadow:
    0 28px 80px rgba(0,0,0,.82),
    0 0 0 1px rgba(124,252,0,.08),
    0 0 40px rgba(124,252,0,.18),
    inset 0 1px 0 rgba(255,255,255,.05),
    inset 0 -10px 22px rgba(0,0,0,.50);
}


.r3dCard::after{
  /* subtle inner sheen */
  content:"";
  position:absolute;
  inset:-2px;
  background: radial-gradient(420px 220px at 20% 0%, rgba(124,252,0,.12), transparent 55%);
  opacity:.45;
  pointer-events:none;
}

.r3dCardInner{
  position:relative;
  height: 100%;
  padding: 12px 14px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  gap:8px;
  z-index: 1;
}

.r3dTop{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
}

.r3dDay{
  font-weight: 950;
  letter-spacing:.6px;
  font-size: 14px;
}

.r3dLabel{
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}

.r3dMeta{
  color: var(--muted);
  font-size: 12px;
  margin-top: 6px;
}
    
.r3dBadges{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.r3dBadge{
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 999px;
  padding: 4px 8px;
  font-size: 11px;
  color: var(--text);
  background: rgba(255,255,255,.04);
}

.r3dBadge.rest{
  border-color: rgba(255,255,255,.10);
  color: var(--muted);
}

.r3dHint{
  font-size: 11px;
  color: rgba(255,255,255,.55);
}

/* ===========================
   ROUTINE ‚Äî DAY ROW (under 3D carousel)
=========================== */
#pplTabs{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:8px;
  margin: 10px 0 12px;
}

#pplTabs .dayChip{
  border:1px solid var(--line);
  border-radius: 12px;
  padding:10px 0;
  text-align:center;
  font-size:12px;
  font-weight:800;
  letter-spacing:.6px;
  color: var(--muted);
  background:#0f0f10;
  cursor:pointer;
  user-select:none;
}

#pplTabs .dayChip.active{
  color: var(--text);
  border-color: rgba(124,252,0,.35);
  box-shadow:
    0 0 0 1px rgba(124,252,0,.18),
    0 10px 24px rgba(0,0,0,.35);
}

#pplTabs .dayChip.rest{
  opacity:.45;
}

#pplTabs .dayChip .miniDot{
  display:block;
  width:6px;
  height:6px;
  border-radius:50%;
  margin:6px auto 0;
  background: rgba(255,255,255,.22);
}

#pplTabs .dayChip.active .miniDot{
  background: var(--good);
}


    
    .badge{
      display:inline-block;
      padding:4px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:11px;
      color:var(--text);
      background:#121214;
    }
    .calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      margin-top:10px;
      user-select:none;
    }
    .calHead{
      font-size:10px;
      color:var(--muted);
      text-align:center;
      padding:4px 0;
    }
    .day{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 0;
      text-align:center;
      font-size:12px;
      background:#0f0f10;
      cursor:pointer;
    }
    .day.off{opacity:.35; cursor:default;}
    .day.attended{
      border-color:#2a2b2f;
      outline:2px solid rgba(124,252,0,.25);
    }
    .day.attended .dot{
      display:block;
      margin:6px auto 0;
      width:6px; height:6px;
      border-radius:50%;
      background:var(--good);
    }
    .topRight{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .ghost{
      border-color:transparent;
      color:var(--muted);
    }
    .ghost:hover{border-color:var(--line)}
    .notice{
      border:1px dashed #2a2b2f;
      border-radius:12px;
      padding:10px;
      color:var(--muted);
      font-size:12px;
      background:#0f0f10;
    }
    .clickEx{cursor:pointer; text-decoration:underline; text-decoration-color:#2a2b2f;}
    .clickEx:hover{opacity:.85;}
    .divider{
      height:1px;
      background:var(--line);
      margin:10px 0;
    }
    .miniBtn{
      padding:8px 10px;
      font-size:12px;
    }
    .danger{
      border-color: rgba(255, 107, 107, .35);
      color: var(--bad);
    }
    /* Exercise picker list items */
.exPickItem{
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  cursor:pointer;
}
.exPickItem:last-child{border-bottom:none;}
.exPickItem:hover{opacity:.85;}
.exPickItem.active{
  outline:2px solid rgba(124,252,0,.25);
  background:#0f0f10;
}
    .exPickRow{
  display:flex;
  gap:10px;
  align-items:center;
}
.exPickCheck{
  width:16px;
  height:16px;
  border:1px solid var(--line);
  border-radius:4px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
}
.exPickItem.active .exPickCheck{
  border-color: rgba(124,252,0,.35);
}
    /* ---------------------------
   APP SCREENS (Option A)
---------------------------- */

/* ‚úÖ Screen title row (not a second header) */
.screenTop{
  position: relative;     /* not sticky */
  top: auto;
  z-index: 1;

  display:flex;
  align-items:center;
  gap:10px;

  padding: 6px 2px 12px;  /* small spacing inside page */
  background: transparent;
  backdrop-filter: none;
  border-bottom: none;
}

.homeGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}

.proCircle{
  width:74px;
  height:74px;
  border-radius:999px;
  border:1px solid var(--line);
  display:grid;
  place-items:center;

  position:relative;
  overflow:hidden;            /* keeps everything inside the circle */
  background: transparent;     /* IMPORTANT: remove gradient from here */
}

/* the gradient ring layer */
.proCircle::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background: conic-gradient(var(--good) var(--deg, 0deg), #202124 0deg);
}

/* ensure inner content is above the gradient */
.proCircleInner{
  position:relative;
  z-index:1;
  width:58px;
  height:58px;
  border-radius:999px;
  background:#0f0f10;
  border:1px solid var(--line);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
}
.proCircleInner .big{
  font-size: 13px;
  font-weight: 700;
  line-height: 0.95;
}

.proCircleInner .small{
  font-size: 8px;
  letter-spacing: 0.2px;
  opacity: 0.75;
}

    /* Home ‚Äì Focus This Week layout */
.proCircleWrap{
  display:flex;
  align-items:center;
  gap:14px;
}

.proCircle{
  flex:0 0 auto;   /* prevents shrinking */
}

#homeFocus{
  flex:1;
  line-height:1.3;
}

.homeGrid button{
  padding:18px 12px;
  border-radius:14px;
  text-align:left;
}
.primary{
  background: rgba(124,252,0,.10);
  border-color: rgba(124,252,0,.28);
  color: var(--text);
}
.primary:hover{
  border-color: rgba(124,252,0,.45);
}
/* ===========================
   HOME APP TILES (visual only)
=========================== */

.homeGrid{
  gap:12px; /* slightly more breathing room */
}

/* make each Home button feel like a real app tile */
.homeGrid button{
  background: rgba(18,18,20,.86) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  box-shadow: 0 10px 26px rgba(0,0,0,.35) !important;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);

  /* ‚¨áÔ∏è SLIMMER TILE SETTINGS */
  padding: 10px 12px !important;   /* was 16px 14px */
  gap:6px;                         /* was 10px */
  min-height: 64px;                /* was 92px */

  border-radius: 16px !important;  /* slightly tighter */
  display:flex;
  flex-direction:column;
  justify-content:center;          /* centers icon/text vertically */
  text-align:left;

  position: relative;
  overflow: hidden;
}

/* subtle internal highlight (iOS-style glass) */
.homeGrid button::before{
  content:"";
  position:absolute;
  inset:-2px;
  background: radial-gradient(
    420px 220px at 18% 0%,
    rgba(124,252,0,.12),
    transparent 55%
  );
  opacity: .7;
  pointer-events:none;
}

/* tap / hover feedback */
.homeGrid button:hover{
  border-color: rgba(255,255,255,.16) !important;
  transform: translateY(-1px);
}
.homeGrid button:active{
  transform: scale(.985);
}


  .bullets{
  margin:10px 0 0;
  padding-left:18px;
}
.bullets li{
  margin:6px 0;
  font-size:13px;
}

.homeHeaderCard{
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:flex-end;
}

.homeTitle{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.bigTime{
  font-size:18px;
  font-weight:800;
  letter-spacing:.4px;
}

.smallDate{
  color:var(--muted);
  font-size:12px;
}

.homeStack{
  display:grid;
  gap:12px;
  margin-top:12px;
}

/* ===========================
   WEEK ROW (perfect alignment)
=========================== */
.weekRow,
.weekDots{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 14px;                 /* ONE gap value for both rows */
  justify-items:center;
  align-items:center;
  max-width: 260px;          /* controls how wide the week row is */
  margin: 10px auto 0;
}

.weekRow{
  font-size:12px;
  color:var(--muted);
  margin-top: 10px;
}

.weekDots{
  margin-top: 8px;
}

/* day letters */
.wday{
  opacity:.85;
}
.wday.today{
  opacity: 1;
  color: var(--text);
  text-shadow: 0 0 10px rgba(124,252,0,.25);
}

/* dots */
.wdot{
  width:10px;
  height:10px;
  border-radius:50%;
  border:1px solid var(--line);
  background:transparent;
  opacity:.9;
}

.wdot.on{
  background:var(--good);
  border-color: rgba(124,252,0,.35);
}

.wdot.off{
  opacity:.35;
}

/* subtle premium highlight for TODAY dot */
.wdot.today{
  box-shadow: 0 0 0 2px rgba(124,252,0,.18);
}

/* rest-day marker (greyed) */
.wdot.rest{
  opacity: .18;
  border-style: dashed;
}
.wdot.rest.on{
  opacity: .45; /* if you checked in on a rest day, still show it but muted */
}


.kpiLine{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
  margin-top:10px;
}

.kpiLine .muted{font-size:12px;}

/* ‚úÖ Prevent background scroll while a modal is open (iOS + desktop) */
body.modalOpen{
  overflow: hidden;
  height: 100%;
  touch-action: none;
}

/* ---------------------------
   APP-LIKE UPGRADE (Bottom Nav + Transitions)
---------------------------- */

/* safe area + extra space for bottom nav */
main{
  padding-bottom: calc(110px + env(safe-area-inset-bottom));
}

/* screen transitions */
.screen{
  display:none;
  opacity:0;
  transform: translateY(10px);
  transition: opacity .18s ease, transform .18s ease;
}
.screen.active{
  display:block;
  opacity:1;
  transform: translateY(0);
}

/* Bottom navigation */
.bottomNav{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
  background: rgba(11,11,12,.94);
  backdrop-filter: blur(14px);
  border-top: 1px solid var(--line);
  z-index: 60;
}

.bottomNavInner{
  max-width: 1100px;
  margin: 0 auto;
  display:flex;
  gap:10px;
}

.navBtn{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  padding: 10px 10px;
  border-radius: 14px;
  background: transparent;
  border: 1px solid transparent;
  color: var(--muted);
  font-size: 11px;
  user-select:none;
}

.navBtn .icon{
  font-size: 18px;
  line-height: 1;
}

.navBtn.active{
  color: var(--text);
  background: rgba(124,252,0,.06);
  border-color: rgba(124,252,0,.22);
}

/* optional: reduce header prominence when bottom nav exists */
header{
  position: sticky;
  top: 0;
  z-index: 40;
}

/* little ‚Äútap‚Äù feel */
.navBtn:active{
  transform: translateY(1px);
}
  /* ---------------------------
   Haptic-style tap feedback
---------------------------- */
.tap{
  transition: transform .08s ease, opacity .08s ease;
  will-change: transform, opacity;
}

.tap:active{
  transform: scale(0.97);
  opacity: 0.85;
}

/* optional: reduce motion respect */
@media (prefers-reduced-motion: reduce){
  .tap{
    transition: none;
  }
}
      /* ---------------------------
   Update Banner (Option 1)
---------------------------- */
.updateBanner{
  position: fixed;
  left: 0; right: 0;
  bottom: calc(86px + env(safe-area-inset-bottom)); /* sits above bottom nav */
  padding: 0 12px;
  z-index: 80;
}

.updateBannerInner{
  max-width: 1100px;
  margin: 0 auto;
  background: rgba(18,18,20,.96);
  border: 1px solid rgba(124,252,0,.22);
  border-radius: 14px;
  padding: 10px 12px;
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  backdrop-filter: blur(12px);
}

.updateText{display:flex; flex-direction:column; gap:2px;}
.updateTitle{font-weight:800; font-size:13px;}
.updateSub{font-size:11px; color:var(--muted);}

    /* ===========================
   ROUTINE EDITOR (BIGGEST VISUAL WIN)
   - header + day tabs + add CTA + exercise cards + sticky footer
=========================== */

#rtModal > div{
  padding: 0 !important;              /* remove inline padding look */
  overflow: hidden;                    /* lets sticky footer look clean */
}

 /* ===========================
   ROUTINE EDITOR ‚Äì RESTORE SCROLL
   (visual-only, keeps JS intact)
=========================== */

#rtModal > div{
  display: flex;
  flex-direction: column;
  max-height: calc(100dvh - 32px);
  overflow: hidden !important; /* header + footer stay fixed */
}

/* üëá THIS is the scrollable area */
#rtModal .rtBody{
  flex: 1 1 auto;
  min-height: 0;               /* REQUIRED for flex scroll */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}


/* Header row inside Routine Editor */
#rtModal .rtHead{
  position: sticky;
  top: 0;
  z-index: 5;
  padding: 14px 14px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  background: linear-gradient(to bottom,
    rgba(18,18,20,.98),
    rgba(18,18,20,.80),
    rgba(18,18,20,0)
  );
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

#rtModal .rtHead h2{
  margin:0;
  font-size:15px;
  letter-spacing:.2px;
}

#rtModal .rtHead .rtClose{
  border-radius: 999px;
  padding: 8px 12px;
}

/* Body padding */
#rtModal .rtBody{
  padding: 0 14px 14px;
}

/* Day tabs ‚Äì more ‚ÄúiOS segmented‚Äù feel */
#rtModal #rtDayTabs{
  gap:6px;
}
#rtModal #rtDayTabs .tab{
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(15,15,16,.9);
}
#rtModal #rtDayTabs .tab.active{
  background: rgba(124,252,0,.08);
  border-color: rgba(124,252,0,.25);
}

/* Add Exercise CTA ‚Äì looks like a button tile */
#rtModal .rtAddWrap{
  border: 1px dashed rgba(124,252,0,.25);
  border-radius: 14px;
  padding: 12px;
  background: rgba(124,252,0,.04);
  display:flex;
  gap:10px;
  align-items:flex-end;
  flex-wrap:wrap;
}

#rtModal .rtAddWrap .rtPick{
  flex: 1 1 260px;
  min-width: 240px;
}

#rtModal .rtAddWrap input[readonly]{
  cursor: pointer;
  background: rgba(15,15,16,.9);
  border-color: rgba(255,255,255,.10);
}

#rtModal .rtAddWrap .hint{
  margin-top:6px;
  font-size:11px;
  color: var(--muted);
}

/* Exercise list cards ‚Äì stop using generic .card look */
#rtModal .rtExCard{
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  background: rgba(15,15,16,.92);
  padding: 12px;
  box-shadow: 0 10px 24px rgba(0,0,0,.35);
}

#rtModal .rtExTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

#rtModal .rtExName{
  font-weight: 800;
  font-size: 13px;
}

#rtModal .rtMetaRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
  color: var(--muted);
  font-size: 11px;
}

#rtModal .rtActions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}

#rtModal .rtActions .miniBtn{
  border-radius: 12px;
}

/* Sticky footer actions */
#rtModal .rtFooter{
  position: sticky;
  bottom: 0;
  z-index: 5;
  padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
  background: linear-gradient(
    to bottom,
    rgba(18,18,20,0),
    rgba(18,18,20,.85) 35%,
    rgba(18,18,20,.98)
  );
  border-top: 1px solid rgba(255,255,255,.06);
  display:flex;
  gap:10px;
  justify-content:flex-end;
}

#rtModal #rtSaveBtn{
  background: rgba(124,252,0,.12);
  border-color: rgba(124,252,0,.30);
}
#rtModal #rtSaveBtn:hover{
  border-color: rgba(124,252,0,.45);
}

    .r3dCard.isActive{
  box-shadow:
    0 0 0 2px rgba(124,252,0,.35),
    0 18px 60px rgba(0,0,0,.60);
}

.r3dStage::after{
  content:"";
  position:absolute;
  left:0; right:0; bottom:0;
  height:90px;
  background: linear-gradient(to bottom, transparent, rgba(0,0,0,.65));
  pointer-events:none;
}

    /* ==================================================
   MOBILE ROUTINE ‚Äî UNIFIED DESKTOP MATCH
   (ONLY applies on phones)
================================================== */
@media (max-width: 560px){

  /* Remove harsh separation feel */
  .r3dStage{
    border: none;
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }

  /* Bring cards into desktop-like centered view */
  .r3dCarousel{
    top: 65% !important;
    transform: translate(-50%, -50%) scale(.86) !important;
  }

  /* Slightly tighten card proportions for phone */
  .r3dCard{
    width: 210px;
    height: 125px;
    margin-left: -105px;
  }

  /* Make entire Routine card feel continuous */
 #screen-routine .card{
  background:
    radial-gradient(420px 220px at 20% 0%, rgba(124,252,0,.12), transparent 55%),
    linear-gradient(180deg, #151518, #101012);
  border: 1px solid rgba(255,255,255,.08);
}


  /* Remove hard divider feel under carousel */
  .r3dStage::after{
    display:none;
  }

  /* Log Sets glow */
  .exerciseItem button{
    background: rgba(124,252,0,.12);
    border-color: rgba(124,252,0,.35);
    box-shadow:
      0 0 0 1px rgba(124,252,0,.25),
      0 6px 18px rgba(124,252,0,.18);
  }

  .exerciseItem button:hover{
    border-color: rgba(124,252,0,.55);
  }

  /* Slightly reduce right-side stat text size for balance */
  .exerciseItem .right{
    font-size:11px;
  }

}


    
  </style>
</head>

<body>
<header class="appHeader">
  <!-- Row 1 -->
  <div class="hdrRow1">
    <h1 id="headerTitle">Gym Dashboard</h1>
    <span class="hdrVersion mono" id="hdrVersion">‚Äî</span>
  </div>

  <!-- Row 2 (fixed layout) -->
  <div class="hdrRow2">
    <div class="hdrLeft">
      <span class="hdrDay" id="hdrToday">‚Äî</span>
      <span class="hdrSep">|</span>
      <span class="hdrProtein" id="hdrProteinLine">‚Äî</span>
      <span class="hdrSep">|</span>
    </div>

    <div class="hdrStatus" id="hdrStatus">
      <span class="hdrDot" id="hdrDot">üü¢</span>
      <span class="hdrOnline" id="hdrOnline">‚Äî</span>
    </div>
  </div>
</header>


<main>

  <!-- ONBOARDING: PROFILE -->
<section id="screen-profile" class="screen">
  <div class="screenTop">
    <h2 style="margin:0;">Create Profile</h2>
  </div>

  <section class="card">
    <div class="notice" style="margin-bottom:10px;">
      Let‚Äôs set up your basics. You can change this later.
    </div>

    <div class="row">
      <label>Name
        <input id="obName" placeholder="e.g., Jordan" />
      </label>

      <label>Units
        <select id="obUnits">
          <option value="lbs" selected>lbs</option>
        </select>
      </label>

      <label>Protein Goal (g)
        <input id="obProteinGoal" type="number" min="0" placeholder="240" />
      </label>

      <label>Week Starts On
        <select id="obWeekStart">
          <option value="mon" selected>Monday</option>
          <option value="sun">Sunday</option>
        </select>
      </label>

      <label>Hide Rest Days
        <select id="obHideRest">
          <option value="1" selected>ON</option>
          <option value="0">OFF</option>
        </select>
      </label>
    </div>

    <div class="btnRow">
      <button id="obProfileNextBtn">Next ‚Üí Routine</button>
    </div>
  </section>
</section>

<!-- ONBOARDING: ROUTINE -->
<section id="screen-onboard-routine" class="screen">
  <div class="screenTop">
    <button class="ghost" type="button" id="obRoutineBackBtn">‚Üê Back</button>
    <h2 style="margin:0;">Create Routine</h2>
  </div>

  <section class="card">
    <div class="notice" style="margin-bottom:10px;">
      Create your routine. You can edit it anytime later.
    </div>

    <div class="row">
  <label>Routine Name
    <input id="obRoutineName" placeholder="e.g., PPL, Upper/Lower, 3-day split" />
  </label>

  <label style="min-width:220px; flex:0 0 auto;">
    Start From Template
    <select id="obRoutineTemplate">
      <option value="blank" selected>Blank (build my own)</option>
      <option value="ppl">PPL (6-day)</option>
      <option value="upperlower">Upper / Lower (7-day)</option>
      <option value="fullbody3">Full Body (3-day)</option>
      <option value="bodypart">Body Part Split (7-day)</option>
    </select>
  </label>

  <button id="obRoutineCreateBtn">Create & Edit</button>
</div>

    <div class="notice small muted" style="margin-top:10px;">
      This will open the Routine Editor so you can add exercises.
    </div>
  </section>
</section>

  <!-- HOME SCREEN -->
  <section id="screen-home" class="screen">

  <!-- Quick View -->
  <section class="card">
    <div class="homeHeaderCard">
      <div class="homeTitle">
        <div class="bigTime" id="homeTime">‚Äî</div>
        <div class="smallDate" id="homeDate">‚Äî</div>
      </div>
      <div class="pill">
        <span class="muted">Welcome</span> <strong id="homeName">‚Äî</strong>
      </div>
    </div>
  </section>

  <div class="homeStack">

    <!-- Today workout -->
    <section class="card">
      <div class="topRight">
        <h2 id="homeTodayTitle">TODAY ‚Äî ‚Äî</h2>
        <button class="ghost miniBtn" type="button" data-go="routine">Go to Routine ‚Üí</button>
      </div>
      <ul class="bullets" id="homeTodayList"></ul>
      <div class="notice" id="homeRestNotice" style="margin-top:10px; display:none;">
        Today is marked as a Rest Day.
      </div>
    </section>

    <!-- This week -->
    <section class="card">
      <h2>This Week</h2>

     <div class="weekRow" id="homeWeekRow">
  <span class="wday" data-idx="0">M</span>
  <span class="wday" data-idx="1">T</span>
  <span class="wday" data-idx="2">W</span>
  <span class="wday" data-idx="3">T</span>
  <span class="wday" data-idx="4">F</span>
  <span class="wday" data-idx="5">S</span>
  <span class="wday" data-idx="6">S</span>
</div>


      <div class="weekDots" id="homeWeekDots"></div>

     <div class="kpiLine">
  <div style="display:flex; flex-direction:column; gap:4px;">
  <span class="muted" id="homeWeekCount">‚Äî</span>
  <span class="muted" id="homeStreakLine">‚Äî</span>
</div>


  <div style="display:flex; gap:8px; align-items:center;">
    <button class="miniBtn" type="button" id="homeCheckInBtn">‚úÖ Check In</button>
    <button class="ghost miniBtn" type="button" data-go="attendance">Attendance ‚Üí</button>
  </div>
</div>
    </section>

    <!-- Focus -->
    <section class="card">
  <h2>Focus This Week</h2>

  <div class="proCircleWrap" style="margin-top:10px;">
    <div class="proCircle tap" id="homeProteinCircle" data-go="protein" role="button" tabindex="0" aria-label="Open Protein screen">
      <div class="proCircleInner">
        <div class="big" id="homeProteinLeft">‚Äî</div>
        <div class="small">g left</div>
      </div>
    </div>

    <div class="notice" id="homeFocus" style="flex:1;">‚Äî</div>
  </div>
</section>

    <!-- Navigation tiles -->
    <section class="card">
      <div class="homeGrid">
        <button class="card tap" data-go="weight">üìâ Weight</button>
        <button class="card tap" data-go="attendance">üìÖ Attendance</button>
        <button class="card tap" data-go="protein">üçó Protein</button>
        <button class="card tap" data-go="routine">üóìÔ∏è Routine</button>
        <button class="card tap" data-go="lifts">üìà Progress</button>
        <button class="card tap" data-go="settings">‚öôÔ∏è Settings</button>
      </div>
    </section>

  </div>
</section>


  <!-- WEIGHT SCREEN -->
  <section id="screen-weight" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Weight</h2>
    </div>

    <!-- WEIGHT CARD (your original card restored) -->
    <section class="card">
      <div class="topRight">
  <h2>Weekly Weight Tracker</h2>
  <div class="row" style="gap:6px;">
    <button id="bwViewTableBtn" class="miniBtn">Table</button>
    <button id="bwViewGraphBtn" class="miniBtn ghost">Graph</button>
  </div>
</div>


      <div class="row">
        <label>Date
          <input type="date" id="bwDate" />
        </label>
        <label>Bodyweight (lbs)
          <input type="number" id="bwVal" placeholder="e.g., 198.6" step="0.1" />
        </label>
      <button id="bwAddBtn" class="tap">Add</button>
      </div>

      <div class="btnRow">
        <span class="pill"><span class="muted">Latest:</span> <strong class="mono" id="bwLatest">‚Äî</strong></span>
        <span class="pill"><span class="muted">Last Œî:</span> <strong class="mono" id="bwDelta">‚Äî</strong></span>
        <span class="pill"><span class="muted">7-day avg:</span> <strong class="mono" id="bwAvg">‚Äî</strong></span>
      </div>

  <div id="bwChartWrap" style="margin-top:10px; display:none;">
  <canvas id="bwChart" height="120"></canvas>
</div>

<div id="bwTableWrap" style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>BW (lbs)</th>
              <th>Prev</th>
              <th>Œî</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="bwTable"></tbody>
        </table>
      </div>
    </section>
  </section>

  <!-- ATTENDANCE SCREEN -->
  <section id="screen-attendance" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Attendance</h2>
    </div>

    <section class="card">
      <div class="topRight">
        <h2>Attendance (Tap days you went)</h2>
        <div class="row" style="gap:6px;">
          <button id="prevMonthBtn">‚óÄ</button>
          <span class="pill"><strong id="calTitle">‚Äî</strong></span>
          <button id="nextMonthBtn">‚ñ∂</button>
        </div>
      </div>

      <div class="calendar" id="calGrid"></div>

      <div class="btnRow">
        <span class="pill"><span class="muted">This month:</span> <strong class="mono" id="calCount">0</strong></span>
        <button id="clearMonthBtn">Clear This Month</button>
      </div>

      <div class="notice" style="margin-top:10px;">
        Tap days you trained. This calendar only tracks workout attendance.
      </div>
    </section>
  </section>

  <!-- PROTEIN SCREEN -->
  <section id="screen-protein" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Protein</h2>
    </div>

    <section class="card">
      <h2 id="proteinTitle">Protein Intake</h2>
      <div class="row">
        <label>Date
          <input type="date" id="pDate" />
        </label>
        <label>Morning (g)
          <input type="number" id="pMorning" placeholder="0" />
        </label>
        <label>Lunch (g)
          <input type="number" id="pLunch" placeholder="0" />
        </label>
        <label>Pre-Gym (g)
          <input type="number" id="pPre" placeholder="0" />
        </label>
        <label>Dinner (g)
          <input type="number" id="pDinner" placeholder="0" />
        </label>
        <label>Bedtime (g)
          <input type="number" id="pBed" placeholder="0" />
        </label>
<button id="pSaveBtn" class="primary tap" type="button">Save</button>
      </div>

      <div class="btnRow">
        <span class="pill"><span class="muted">Total:</span> <strong class="mono" id="pTotal">0</strong>g</span>
        <span class="pill"><span class="muted">Remaining:</span> <strong class="mono" id="pRemain">0</strong>g</span>
        <span class="pill"><span class="muted">Status:</span> <strong id="pStatus">‚Äî</strong></span>
      </div>
    </section>
  </section>

  <!-- ROUTINE SCREEN -->
  <section id="screen-routine" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Routine</h2>
    </div>

    <section class="card">
      <div class="topRight">
        <div>
          <h2 style="margin-bottom:6px;">Routine (Mon‚ÄìSun)</h2>
          <div class="small muted" id="activeRoutineMeta">‚Äî</div>
        </div>

        <div class="row" style="gap:6px;">
          <label style="min-width:220px; flex:0 0 auto;">
            Active Routine
            <select id="routineSelect"></select>
          </label>

          <button id="newRoutineBtn" class="miniBtn">New</button>
          <button id="editRoutineBtn" class="miniBtn">Edit</button>
          <button id="dupRoutineBtn" class="miniBtn">Duplicate</button>
          <button id="delRoutineBtn" class="miniBtn danger">Delete</button>

          <button id="startTodayBtn" class="miniBtn">Start Today</button>
        </div>
      </div>

<!-- 3D Carousel (replaces tabs) -->
<div class="r3dStage" id="r3dStage">
  <div class="r3dCarousel" id="r3dCarousel"></div>
</div>

<!-- keep your existing list exactly as-is -->
<div class="splitTabs" id="pplTabs"></div>
      <div class="exerciseList" id="pplList"></div>

      <div class="notice" style="margin-top:10px;">
        Tip: Tap ‚ÄúLog Sets‚Äù on an exercise to record sets/reps/weight. PR is based on your lifetime max for that exercise.
      </div>
    </section>
  </section>

  <!-- LIFTS SCREEN -->
  <section id="screen-lifts" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Progress</h2>
    </div>

    <section class="card">
      <div class="topRight">
        <h2>Lift Progress Log</h2>
        <div class="row" style="gap:6px;">
          <button id="liftViewTableBtn" class="miniBtn">Table</button>
          <button id="liftViewGraphBtn" class="miniBtn ghost">Graph</button>
          <button id="liftDownloadBtn" class="miniBtn ghost" title="Download current graph">Download PNG</button>
        </div>
      </div>

      <div class="row">
        <label>Exercise
          <select id="liftSearch"></select>
        </label>

        <label>Routine
          <select id="liftRoutine"></select>
        </label>

        <label>Date From
          <input type="date" id="liftFrom" />
        </label>

        <label>Date To
          <input type="date" id="liftTo" />
        </label>
      </div>

      <div class="row" style="margin-top:8px;">
        <label>Metric (Graph)
          <select id="liftMetric">
            <option value="top" selected>Top Weight</option>
            <option value="e1rm">Estimated 1RM (Epley)</option>
            <option value="vol">Volume</option>
          </select>
        </label>

        <label>Rows (Table)
          <select id="liftLimit">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="0">All</option>
          </select>
        </label>

        <button id="liftSearchBtn">Search</button>
        <button id="liftClearBtn" class="ghost">Clear</button>
      </div>

      <div id="liftTableWrap" style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Exercise</th>
              <th>Top Set</th>
              <th>Sets</th>
              <th>PR</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="liftTable"></tbody>
        </table>
      </div>

      <div id="liftGraphWrap" style="margin-top:10px; display:none;">
        <canvas id="liftChart" height="140"></canvas>
        <div class="notice" style="margin-top:10px;">
          Weekly separators are shown as vertical lines for easier progress blocks.
        </div>
      </div>

      <div class="notice" style="margin-top:10px;">
        Tap an exercise name in the table to view history.
      </div>
    </section>
  </section>

  <!-- SETTINGS SCREEN -->
<section id="screen-settings" class="screen">
  <div class="screenTop">
    <button class="ghost" type="button" data-home>‚Üê Back</button>
    <h2 style="margin:0;">Settings</h2>
  </div>

  <!-- Profile -->
  <section class="card">
    <h2>Profile</h2>
    <div class="row">
      <label>Name (optional)
        <input id="setName" placeholder="e.g., Jordan" />
      </label>

      <label>Units
        <select id="setUnits">
          <option value="lbs" selected>lbs</option>
        </select>
      </label>

      <label>Protein Goal (g)
        <input id="setProteinGoal" type="number" min="0" placeholder="240" />
      </label>

      <label>Week Starts On
        <select id="setWeekStart">
          <option value="mon" selected>Monday</option>
          <option value="sun">Sunday</option>
        </select>
      </label>

      <label>Hide Rest Days
        <select id="setHideRest">
          <option value="1" selected>ON</option>
          <option value="0">OFF</option>
        </select>
      </label>

      <button id="saveProfileBtn">Save Profile</button>
    </div>
  </section>

  <!-- Import / Backup -->
  <section class="card">
    <h2>Import / Backup</h2>
    <div class="row" style="gap:6px;">
      <button class="miniBtn" id="settingsImportBtn">Import</button>
      <input id="settingsImportFile" type="file" accept="application/json" style="display:none;" />

      <button class="miniBtn" id="backupNowBtn">Backup Now</button>

      <span class="pill">
        <span class="muted">Last Backup:</span>
        <strong class="mono" id="lastBackupText">‚Äî</strong>
      </span>
    </div>

    <div class="notice" style="margin-top:10px;">
      <div><strong>Storage</strong></div>
      <div class="small muted" id="storageInfo">‚Äî</div>
      <div class="small warn" id="storageWarn" style="display:none;">Storage is getting large ‚Äî consider backing up.</div>
    </div>
  </section>

  <!-- Refresh -->
  <section class="card">
    <h2>Refresh</h2>
    <div class="notice">Choose what to refresh (useful after an import or manual edits).</div>

    <div class="row" style="margin-top:10px;">
      <label><span class="muted">Routine</span>
        <select id="rfRoutine"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>
      <label><span class="muted">Progress</span>
        <select id="rfLifts"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>
      <label><span class="muted">Weight</span>
        <select id="rfWeight"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>
      <label><span class="muted">Attendance</span>
        <select id="rfAttendance"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>
      <label><span class="muted">Protein</span>
        <select id="rfProtein"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>

      <button id="runRefreshBtn">Refresh Selected</button>
    </div>
  </section>

    <!-- Updates -->
  <section class="card" id="updatesCard">
    <h2>Updates</h2>

    <div class="updatesGroupTitle">Version</div>
    <div class="updatesPills">
      <div class="pillRow" id="upCurVer">üßæ Current Version: ‚Äî</div>
      <div class="pillRow" id="upPrevVer">üïò Previous Version: ‚Äî</div>
      <div class="pillRow" id="upLatestVer">‚¨ÜÔ∏è Latest Available: ‚Äî</div>
    </div>

    <div class="updatesGroupTitle" style="margin-top:12px;">Status</div>
    <div class="updatesPills">
      <div class="pillRow" id="upConn">üåê Connection: ‚Äî</div>
      <div class="pillRow" id="upStatus">‚úÖ Update Status: ‚Äî</div>
      <div class="pillRow" id="upChecked">üïí Last Checked: ‚Äî</div>
    </div>

    <div class="updatesGroupTitle" style="margin-top:12px;">Build</div>
    <div class="updatesPills">
      <div class="pillRow" id="upBuild">üß± Build: ‚Äî</div>
      <div class="pillRow" id="upSW">üß© Service Worker: ‚Äî</div>
    </div>

    <div class="updatesGroupTitle" style="margin-top:12px;">Actions</div>
    <div class="updatesActions">
      <button id="upCheckNowBtn" class="tap">üîç Check Now</button>
      <button id="upUpdateNowBtn" class="tap">‚ôªÔ∏è Update Now (Full Wipe & Reload)</button>
    </div>

    <div class="updatesGroupTitle" style="margin-top:12px;">Advanced</div>
    <div class="updatesActions">
      <button id="upClearCacheBtn" class="tap ghost">üßπ Clear Cache & Reload</button>
      <button id="upShowResultBtn" class="tap ghost">üìã Show Last Update Result</button>
      <button id="upDiagBtn" class="tap ghost">üìà Update Diagnostics</button>
    </div>
  
    <!-- Inline dropdown panels (instead of popup) -->
    <div id="upResultPanel" class="updatesDropPanel" style="display:none;">
      <div class="updatesDropHead">
        <div class="updatesDropTitle">Update Result</div>
        <button id="upResultHideBtn" class="tap ghost" type="button">Hide</button>
      </div>
      <div class="updatesPills" style="margin-top:8px;">
        <div class="pillRow" id="uResLine1">‚Äî</div>
        <div class="pillRow" id="uResLine2">‚Äî</div>
        <div class="pillRow" id="uResLine3">‚Äî</div>
        <div class="pillRow" id="uResLine4">‚Äî</div>
        <div class="pillRow" id="uResLine5">‚Äî</div>
        <div class="pillRow" id="uResLine6"></div>
      </div>
      <div class="btnRow" style="margin-top:10px; justify-content:flex-end;">
        <button id="uModalTryAgain" class="tap" type="button" style="display:none;">Try Again</button>
      </div>
    </div>

    <div id="upDiagPanel" class="updatesDropPanel" style="display:none;">
      <div class="updatesDropHead">
        <div class="updatesDropTitle">Update Diagnostics</div>
        <button id="upDiagHideBtn" class="tap ghost" type="button">Hide</button>
      </div>
      <div class="updatesPills" style="margin-top:8px;">
        <div class="pillRow" id="uDiag1">‚Äî</div>
        <div class="pillRow" id="uDiag2">‚Äî</div>
        <div class="pillRow" id="uDiag3">‚Äî</div>
        <div class="pillRow" id="uDiag4">‚Äî</div>
        <div class="pillRow" id="uDiag5">‚Äî</div>
      </div>
    </div>

  </section>


      



  <!-- Reset -->
  <section class="card">
    <h2>Reset</h2>
    <div class="notice">
      This clears everything on this device/browser.
      <div class="small muted">Tip: Backup first.</div>
    </div>

    <div class="btnRow">
      <button id="settingsResetBtn" class="danger">Reset ALL Data</button>
    </div>
  </section>
</section>


  <!-- ‚úÖ KEEP YOUR MODALS EXACTLY AS-IS BELOW -->
  <!-- LOG SETS MODAL -->
  <div id="logModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
    <div style="max-width:520px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
      <div class="topRight">
        <div>
          <h2 style="margin:0;">Log Sets</h2>
          <div class="small muted" id="logRoutineLine">‚Äî</div>
        </div>
      </div>

      <div class="notice" style="margin-top:10px;">
        <div><strong id="logModalExercise">‚Äî</strong></div>
        <div class="small muted">Enter what you actually did. Add/remove sets as needed.</div>
      </div>

      <div id="logPrevBox" class="notice" style="margin-top:10px; display:none;">
        <div class="small muted">Last time:</div>
        <div id="logPrevText" class="mono">‚Äî</div>
        <div class="btnRow" style="margin-top:8px;">
          <button id="logCopyLastBtn" type="button">Copy last time</button>
          <button id="logViewHistoryBtn" type="button" class="ghost">View history</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Date
          <input type="date" id="logModalDate" />
        </label>
      </div>

      <div id="logModalSets" style="margin-top:10px; display:grid; gap:8px;"></div>

     <div class="btnRow">
  <button id="logAddSetBtn" class="tap">Add Set</button>
  <button id="logSaveBtn" class="tap">Confirm & Save</button>
  <button id="logModalClose" class="tap ghost" type="button">Close</button>
</div>
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div id="histModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
    <div style="max-width:640px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
      <div class="topRight">
        <h2 style="margin:0;">Exercise History</h2>
        <button id="histCloseBtn">Close</button>
      </div>

      <div class="notice" style="margin-top:10px;">
        <div><strong id="histExercise">‚Äî</strong></div>
        <div class="small muted">Most recent first. Shows your saved set details (if available).</div>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Top Set</th>
              <th>All Sets</th>
              <th>PR</th>
            </tr>
          </thead>
          <tbody id="histTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ROUTINE EDITOR MODAL -->
<div id="rtModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
  <div style="max-width:760px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px;">
    
    <!-- Sticky Header -->
    <div class="rtHead">
      <h2>Routine Editor</h2>
      <button id="rtCloseBtn" class="rtClose ghost" type="button">Close</button>
    </div>

    <div class="rtBody">
      <div class="row" style="margin-top:10px;">
        <label>Routine Name
          <input id="rtName" placeholder="e.g., PPL (6 days)" />
        </label>
      </div>

      <div class="divider"></div>

      <div class="splitTabs" id="rtDayTabs"></div>

      <div class="row" style="margin-top:8px;">
        <label style="min-width:220px; flex:0 0 auto;">Day Label (optional)
          <input id="rtDayLabel" placeholder="e.g., Push / Pull / Legs / Upper" />
        </label>

        <label style="min-width:220px; flex:0 0 auto;">Rest Day?
          <select id="rtRestToggle">
            <option value="0" selected>No</option>
            <option value="1">Yes (hide day)</option>
          </select>
        </label>
      </div>

      <div id="rtDayRestNotice" class="notice" style="margin-top:10px; display:none;">
        This day is marked as a Rest Day. Exercises are kept but hidden on the dashboard.
      </div>

      <div class="divider"></div>

      <!-- Add Exercise CTA tile -->
      <div class="rtAddWrap" style="margin-top:10px;">
        <div class="rtPick">
          <label style="min-width:260px; width:100%;">Add Exercise
            <input id="rtAddExName" list="rtExSuggestions" placeholder="Tap to pick an exercise..." readonly />
            <datalist id="rtExSuggestions"></datalist>
          </label>
          <div class="hint">Tap to choose from your library</div>
        </div>

        <label style="width:110px;">Sets
          <input id="rtAddExSets" type="number" min="1" placeholder="3" />
        </label>

        <label style="width:140px;">Reps
          <input id="rtAddExReps" placeholder="8‚Äì10" />
        </label>

        <button id="rtAddExBtn" class="tap">Add</button>
        <button id="rtAddMultiBtn" class="ghost tap" type="button">Add Multiple</button>
      </div>

      <div id="rtExList" style="margin-top:12px; display:grid; gap:10px;"></div>

      <div class="notice" style="margin-top:10px;">
        Swap replaces an exercise only for this day. Reorder uses Up/Down.
      </div>
    </div>

    <!-- Sticky Footer -->
    <div class="rtFooter">
      <button id="rtCancelBtn" class="ghost tap" type="button">Cancel</button>
      <button id="rtSaveBtn" class="tap" type="button">Save Routine</button>
    </div>

  </div>
</div>

  <!-- EXERCISE PICKER MODAL -->
<div id="exPickModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
  <div style="max-width:520px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
    <div class="topRight">
      <h2 style="margin:0;" id="exPickTitle">Pick Exercise</h2>
      <button id="exPickCloseBtn">Close</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <label style="min-width:220px; flex:1 1 220px;">Search
        <input id="exPickSearch" placeholder="Type to filter..." />
      </label>
    </div>

    <div id="exPickList"></div>

    <div class="btnRow">
      <button id="exPickConfirmBtn">Confirm</button>
      <button id="exPickCancelBtn" class="ghost">Cancel</button>
    </div>
  </div>
</div>

  <!-- BATCH ADD MODAL (Multi-add sets/reps screen) -->
<div id="batchAddModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
  <div style="max-width:640px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
    <div class="topRight">
      <h2 style="margin:0;">Add Multiple Exercises</h2>
      <button id="batchAddCloseBtn" type="button">Close</button>
    </div>

    <div class="notice" style="margin-top:10px;">
      <div class="small muted">Set the Sets + Reps for each exercise, then confirm.</div>
    </div>

    <div id="batchAddList" style="margin-top:10px; display:grid; gap:8px;"></div>

    <div class="btnRow">
      <button id="batchAddConfirmBtn" type="button">Add to Day</button>
      <button id="batchAddCancelBtn" type="button" class="ghost">Cancel</button>
    </div>
  </div>
</div>

</main>
<script>
(function(){
'use strict';

/* ---------------------------
   Storage helpers
---------------------------- */
const LS = {
  get(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    }catch{ return fallback; }
  },
  set(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
};

  /* ---------------------------
   DOM helpers
---------------------------- */
const $  = (id)=>document.getElementById(id);
const $$ = (sel, root=document)=>[...root.querySelectorAll(sel)];

const KEY_BW = "gym_bw_logs_v1";
const KEY_ATT = "gym_attendance_v1";
const KEY_PRO = "gym_protein_v1";
const KEY_LIFTS = "gym_lifts_v1";
const KEY_TARGETS = "gym_targets_v1";

const KEY_ROUTINES = "gym_routines_v1";
const KEY_ACTIVE_ROUTINE = "gym_active_routine_id_v1";
const KEY_PROFILE = "gym_profile_v1";
const KEY_LAST_BACKUP = "gym_last_backup_v1";
const KEY_ONBOARD_DONE = "gym_onboard_done_v1";
const KEY_CUSTOM_EX = "gym_custom_ex_v1";
const KEY_APP_VERSION = "gym_app_version_v1"; // ‚úÖ ADD THIS
const KEY_APP_LAST_RELOAD = "gym_app_last_reload_v1";
const KEY_APP_UPDATE_DISMISSED_UNTIL = "gym_app_update_dismissed_until_v1";

const VERSION_CHECK_INTERVAL_MS = 60 * 1000;   // 1 min
const AUTO_REFRESH_COUNTDOWN_S = 8;            // seconds
const AUTO_REFRESH_COOLDOWN_MS = 30 * 1000;    // prevent reload loops

const hdrVersion = document.getElementById("hdrVersion");
const hdrProteinLine = document.getElementById("hdrProteinLine");
const hdrToday   = document.getElementById("hdrToday");
const hdrOnline  = document.getElementById("hdrOnline");
const hdrStatus  = document.getElementById("hdrStatus");
const hdrDot     = document.getElementById("hdrDot");


let modalDepth = 0;

function lockBodyScroll(){
  if(modalDepth === 0) document.body.classList.add("modalOpen");
  modalDepth++;
}

function unlockBodyScroll(){
  modalDepth = Math.max(0, modalDepth - 1);
  if(modalDepth === 0) document.body.classList.remove("modalOpen");
}

  /* ---------------------------
   Global State (safe defaults)
---------------------------- */
let profile = defaultProfile();
let routines = [];
let activeRoutineId = null;

let bwLogs = [];
let attendance = new Set();
let proteinMap = {};
let lifts = [];

  /* ---------------------------
   SETTINGS bindings
---------------------------- */
const setName = document.getElementById("setName");
const setProteinGoal = document.getElementById("setProteinGoal");
const setWeekStart = document.getElementById("setWeekStart");
const setHideRest = document.getElementById("setHideRest");
const saveProfileBtn = document.getElementById("saveProfileBtn");

const storageInfo = document.getElementById("storageInfo");
const storageWarn = document.getElementById("storageWarn");
const runRefreshBtn = document.getElementById("runRefreshBtn");

function bytesToNice(n){
  if(!isFinite(n)) return "0 B";
  const u = ["B","KB","MB","GB"];
  let i=0, v=n;
  while(v>=1024 && i<u.length-1){ v/=1024; i++; }
  return `${v.toFixed(i===0?0:1)} ${u[i]}`;
}

function renderStorageInfo(){
  if(!storageInfo) return;

  let totalBytes = 0;
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    const v = localStorage.getItem(k) || "";
    totalBytes += (k.length + v.length) * 2; // rough UTF-16 bytes
  }

  storageInfo.textContent = `Approx localStorage size: ${bytesToNice(totalBytes)} ‚Ä¢ Keys: ${localStorage.length}`;

  if(storageWarn){
    storageWarn.style.display = (totalBytes > 3_000_000) ? "block" : "none"; // ~3MB warning
  }
}

function hydrateSettingsUI(){
  if(setName) setName.value = profile.name || "";
  if(setProteinGoal) setProteinGoal.value = String(getProteinGoal());
  if(setWeekStart) setWeekStart.value = profile.weekStart || "mon";
  if(setHideRest) setHideRest.value = profile.hideRestDays ? "1" : "0";
}

saveProfileBtn?.addEventListener("click", ()=>{
  saveProfile({
    name: String(setName?.value || "").trim(),
    proteinGoal: Number(setProteinGoal?.value || 240) || 240,
    weekStart: (setWeekStart?.value === "sun") ? "sun" : "mon",
    hideRestDays: (setHideRest?.value === "0") ? false : true
  });

  // update protein screen title immediately
  const pt = document.getElementById("proteinTitle");
  if(pt) pt.textContent = `Protein Intake (Goal ${getProteinGoal()}g)`;

  hydrateSettingsUI();
  renderStorageInfo();
  alert("Profile saved ‚úÖ");
});

runRefreshBtn?.addEventListener("click", ()=>{
  const rRoutine = document.getElementById("rfRoutine")?.value === "1";
  const rLifts   = document.getElementById("rfLifts")?.value === "1";
  const rWeight  = document.getElementById("rfWeight")?.value === "1";
  const rAtt     = document.getElementById("rfAttendance")?.value === "1";
  const rPro     = document.getElementById("rfProtein")?.value === "1";

  if(rWeight) renderBW();
  if(rAtt) renderCal();
  if(rPro) loadProteinDay(pDate.value || todayISO());

  if(rRoutine){
    renderRoutineDropdown();
    renderPPL();
    buildRoutineExerciseSuggestions();
  }
  if(rLifts){
    renderLiftSearchDropdown();
    renderLiftRoutineDropdown();
    applyLiftFiltersFromUI();
    renderLifts();
  }

  refreshHome();
  renderStorageInfo();
  alert("Refreshed ‚úÖ");
});

const obName = document.getElementById("obName");
const obUnits = document.getElementById("obUnits");
const obProteinGoal = document.getElementById("obProteinGoal");
const obWeekStart = document.getElementById("obWeekStart");
const obHideRest = document.getElementById("obHideRest");
const obProfileNextBtn = document.getElementById("obProfileNextBtn");

const obRoutineBackBtn = document.getElementById("obRoutineBackBtn");
const obRoutineName = document.getElementById("obRoutineName");
const obRoutineCreateBtn = document.getElementById("obRoutineCreateBtn");
const obRoutineTemplate = document.getElementById("obRoutineTemplate");

// Seed onboarding inputs from existing profile (if any)
function hydrateOnboardingInputs(){
  if(!obName) return;
  obName.value = profile.name || "";
  obProteinGoal.value = String(getProteinGoal());
  obWeekStart.value = profile.weekStart || "mon";
  obHideRest.value = profile.hideRestDays ? "1" : "0";
}

obProfileNextBtn?.addEventListener("click", ()=>{
  const nm = String(obName?.value || "").trim();
  if(!nm){
    alert("Please enter a name to continue.");
    return;
  }

  saveProfile({
    name: nm,
    proteinGoal: Number(obProteinGoal?.value || 240) || 240,
    weekStart: (obWeekStart?.value === "sun") ? "sun" : "mon",
    hideRestDays: (obHideRest?.value === "0") ? false : true
  });

  showScreen("onboard-routine");
});

obRoutineBackBtn?.addEventListener("click", ()=>{
  showScreen("profile");
});

obRoutineCreateBtn?.addEventListener("click", ()=>{
  const name = String(obRoutineName?.value || "").trim() || "My Routine";
  const tpl = String(obRoutineTemplate?.value || "blank");

  let base;

  if(tpl === "upperlower"){
    base = makeUpperLowerTemplate();
  } else if(tpl === "fullbody3"){
    base = makeFullBody3Template();
  } else if(tpl === "bodypart"){
    base = makeBodyPartTemplate();
  } else if(tpl === "ppl"){
    base = defaultRoutine();
  } else {
    base = defaultRoutine();
    base.name = "Routine";
    DAY_KEYS.forEach(k=>{
      base.days[k].exercises = [];
      base.days[k].rest = false;
      base.days[k].label = "";
    });
  }

  base.name = name;
  base.source = "onboarding";
  base.id = uid();

  routines.push(base);
  saveRoutines();

  // mark onboarding complete
  if(!isOnboardingDone()) setOnboardingDone();

  // set as active routine
  setActiveRoutine(base.id);

  // ‚úÖ go to routine screen FIRST (ensures routine screen state is initialized)
  showScreen("routine");

  // ensure dropdown + list are correct right away
  renderRoutineDropdown(base.id);
  activeDayIndex = getTodaySplitIndex();
  renderPPL();
  buildRoutineExerciseSuggestions();

  // ‚úÖ THEN open editor
  openRoutineEditor(base.id);
});

  /* ---------------------------
   Profile (Onboarding base)
---------------------------- */
function defaultProfile(){
  return {
    name: "",
    units: "lbs",        // ‚úÖ lbs only
    proteinGoal: 240,
    weekStart: "mon",    // "mon" | "sun"
    hideRestDays: true
  };
}


function loadProfile(){
  const p = LS.get(KEY_PROFILE, null);
  if(!p || typeof p !== "object"){
    const seeded = defaultProfile();
    LS.set(KEY_PROFILE, seeded);
    return seeded;
  }
  // normalize
  return {
  name: String(p.name || ""),
  units: "lbs", // ‚úÖ force lbs only (no kg supported)
  proteinGoal: Number(p.proteinGoal || 240) || 240,
  weekStart: (p.weekStart === "sun") ? "sun" : "mon",
  hideRestDays: (p.hideRestDays === false) ? false : true
};
}


function saveProfile(next){
  profile = {
    ...profile,
    ...next
  };
  LS.set(KEY_PROFILE, profile);
  renderHeaderPills();
  refreshHome();
  hydrateSettingsUI(); // ‚úÖ add this line
}


function getTodayWorkoutLabel(){
  const ar = getActiveRoutine();
  const todayIdx = getTodaySplitIndex();
  const dayKey = DAY_KEYS[todayIdx];
  const day = ar?.days?.[dayKey] || { label:"", rest:false };

  const label = String(day.label || "").trim();
  // You said: ‚Äúuse the Day - Workout Day Label here‚Äù
  // If rest day, show Rest (or label if present)
  if(day.rest) return label || "Rest";
  return label || dayKey; // fallback if no label set
}

function renderHeaderPills(){
  // Version
  const v = localStorage.getItem(KEY_APP_VERSION) || "";
  if(hdrVersion) hdrVersion.textContent = v ? v : "‚Äî";

 // Protein line: "240g / 300g"
const goal = getProteinGoal();
const td = todayISO();
const total = getProteinTotalForDate(td);
if(hdrProteinLine) hdrProteinLine.textContent = `${total}g / ${goal}g`;

  // Today label
  const todayLabel = getTodayWorkoutLabel();
  if(hdrToday) hdrToday.textContent = todayLabel;

  // Online/offline text is set by setOnlineUI()
}





// Replace PRO_GOAL usage with this
function getProteinGoal(){
  return Number(profile.proteinGoal || 240) || 240;
}

  /* ---------------------------
   Focus helpers (Recovery / Stalled / Weekly countdown)
---------------------------- */
function addDaysISO(iso, delta){
  const d = parseISO(iso);
  d.setDate(d.getDate() + delta);
  return localISODate(d);
}

function getProteinTotalForDate(iso){
  const obj = proteinMap?.[iso] || {morning:0,lunch:0,pre:0,dinner:0,bed:0};
  return (Number(obj.morning)||0)+(Number(obj.lunch)||0)+(Number(obj.pre)||0)+(Number(obj.dinner)||0)+(Number(obj.bed)||0);
}

function routineWeeklyTargetDays(routineObj){
  // counts how many days in the routine are NOT rest days
  let n = 0;
  DAY_KEYS.forEach(k=>{
    const day = routineObj?.days?.[k];
    if(day && !day.rest) n++;
  });
  // fallback so it never becomes 0
  return Math.max(1, n);
}

function isStalledExercise(exName, lookback=3){
  const n = normExName(exName);
  const exLifts = lifts
    .filter(x => (x.exNorm || normExName(x.ex)) === n)
    .sort((a,b)=> b.date.localeCompare(a.date))
    .slice(0, lookback);

  // need at least 3 sessions to call it "stalled"
  if(exLifts.length < lookback) return false;

  const weights = exLifts.map(x=>Number(x.weight)||0);
  const maxW = Math.max(...weights);
  const newest = weights[0];

  // stalled = newest is not the best of the last 3
  return newest < maxW || newest === maxW; // (still stalled if it‚Äôs flat)
}

function pickStalledExerciseFromToday(todayExercises){
  for(const ex of (todayExercises || [])){
    if(ex?.name && isStalledExercise(ex.name, 3)){
      return ex.name;
    }
  }
  return "";
}
  
  /* ---------------------------
   HOME screen logic
---------------------------- */
const homeTime = document.getElementById("homeTime");
const homeDate = document.getElementById("homeDate");
const homeName = document.getElementById("homeName");
const homeTodayTitle = document.getElementById("homeTodayTitle");
const homeTodayList = document.getElementById("homeTodayList");
const homeRestNotice = document.getElementById("homeRestNotice");
const homeWeekDots = document.getElementById("homeWeekDots");
const homeWeekCount = document.getElementById("homeWeekCount");
const homeFocus = document.getElementById("homeFocus");
const homeProteinCircle = document.getElementById("homeProteinCircle");
const homeProteinLeft = document.getElementById("homeProteinLeft");


function fmtTimeNow(){
  const d = new Date();
  return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
}
function fmtDateNow(){
  const d = new Date();
  return d.toLocaleDateString([], { weekday:"long", month:"short", day:"numeric" });
}

function dateISOFrom(baseDate, offsetDays){
  const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
  d.setDate(d.getDate() + offsetDays);
  return localISODate(d);
}

function refreshHome(){
  // time/date/name
  if(homeTime) homeTime.textContent = fmtTimeNow();
  if(homeDate) homeDate.textContent = fmtDateNow();
  if(homeName) homeName.textContent = (profile.name || "‚Äî").trim() || "‚Äî";

  // today routine
  const ar = getActiveRoutine();
  const todayIdx = getTodaySplitIndex(); // Mon=0..Sun=6
  const dayKey = DAY_KEYS[todayIdx];
  const day = ar.days?.[dayKey] || { label:"", rest:false, exercises:[] };

  const label = (day.label || "").trim();
  if(homeTodayTitle) homeTodayTitle.textContent = `TODAY ‚Äî ${dayKey}${label ? " ‚Ä¢ " + label : ""}`;

  if(homeTodayList) homeTodayList.innerHTML = "";
  if(homeRestNotice) homeRestNotice.style.display = "none";

  if(day.rest){
    if(homeRestNotice) homeRestNotice.style.display = "block";
  } else {
    const list = Array.isArray(day.exercises) ? day.exercises : [];
    if(homeTodayList){
      if(list.length === 0){
        homeTodayList.innerHTML = `<li class="muted">No exercises added for today.</li>`;
      } else {
        list.slice(0, 6).forEach(ex=>{
          const li = document.createElement("li");
          li.textContent = `${ex.name} ‚Äî ${ex.sets || "‚Äî"} sets ‚Ä¢ ${ex.reps || "‚Äî"} reps`;
          homeTodayList.appendChild(li);
        });
      }
    }
  }
    // ‚úÖ Protein-left circle (today)
  const td = todayISO();
  const obj = proteinMap?.[td] || {morning:0,lunch:0,pre:0,dinner:0,bed:0};
  const total = (Number(obj.morning)||0)+(Number(obj.lunch)||0)+(Number(obj.pre)||0)+(Number(obj.dinner)||0)+(Number(obj.bed)||0);

  const goal = getProteinGoal();
  const left = Math.max(goal - total, 0);
  const pct = Math.max(0, Math.min(1, goal ? (total/goal) : 0));
  const deg = Math.round(pct * 360);

  if(homeProteinLeft) homeProteinLeft.textContent = String(left);
  if(homeProteinCircle){
    homeProteinCircle.style.setProperty("--deg", `${deg}deg`);
  }
    // ‚úÖ Home "Check In" button state (add this BEFORE week dots section)
  if(homeCheckInBtn){
    const today = todayISO();
    const checked = attendance.has(today);

    homeCheckInBtn.textContent = checked ? "‚úÖ Checked In" : "‚úÖ Check In";
    homeCheckInBtn.classList.toggle("ghost", checked);
  }

  // week dots + count + streak + today highlight + rest-day markers
  const weekStart = weekStartDate(new Date());
  const dots = [];
  for(let i=0;i<7;i++){
    dots.push(dateISOFrom(weekStart, i));
  }

  const todayIso2 = todayISO();

  // helper: ISO date -> routine dayKey (Mon..Sun)
  function dayKeyFromISO(iso){
    const d = parseISO(iso);
    const dow = d.getDay(); // 0 Sun..6 Sat
    // If week starts Sunday, index matches Sun..Sat, but your DAY_KEYS is Mon..Sun
    if(profile.weekStart === "sun"){
      // map: Sun(0)->Sun, Mon(1)->Mon, ... Sat(6)->Sat
      if(dow === 0) return "Sun";
      return DAY_KEYS[dow - 1]; // Mon..Sat
    } else {
      // week starts Monday: Mon(1)->Mon ... Sat(6)->Sat, Sun(0)->Sun
      if(dow === 0) return "Sun";
      return DAY_KEYS[dow - 1]; // Mon..Sat
    }
  }

  function isRestDayISO(iso){
    const key = dayKeyFromISO(iso);
    const day = ar?.days?.[key];
    return !!day?.rest;
  }

  const attendedCount = dots.filter(d => attendance.has(d)).length;

  // TODAY highlight on letters
  const weekRowEl = document.getElementById("homeWeekRow");
  if(weekRowEl){
    const spans = weekRowEl.querySelectorAll(".wday");
    spans.forEach((s, idx)=>{
      const iso = dots[idx];
      s.classList.toggle("today", iso === todayIso2);
    });
  }

  // render dots
  if(homeWeekDots){
    homeWeekDots.innerHTML = "";
    dots.forEach((d)=>{
      const dot = document.createElement("div");
      const checked = attendance.has(d);
      const rest = isRestDayISO(d);

      dot.className = "wdot " + (checked ? "on" : "off");
      if(d === todayIso2) dot.classList.add("today");
      if(rest) dot.classList.add("rest");

      dot.title = d;
      homeWeekDots.appendChild(dot);
    });
  }

  if(homeWeekCount){
    homeWeekCount.textContent = `Workouts this week: ${attendedCount} / 7`;
  }

  // streak + best streak (ignores rest days)
  function calcStreaks(){
    // current streak (walk backward)
    let cur = 0;
    for(let back=0; back<400; back++){
      const iso = addDaysISO(todayIso2, -back);
      if(isRestDayISO(iso)) continue;          // skip rest days
      if(attendance.has(iso)) cur++;
      else break;
    }

    // best streak (scan last ~400 days)
    let best = 0;
    let run = 0;
    for(let back=399; back>=0; back--){
      const iso = addDaysISO(todayIso2, -back);
      if(isRestDayISO(iso)) continue;          // skip rest days
      if(attendance.has(iso)) run++;
      else run = 0;
      if(run > best) best = run;
    }

    return {cur, best};
  }

  const {cur, best} = calcStreaks();
  const homeStreakLine = document.getElementById("homeStreakLine");
  if(homeStreakLine){
    homeStreakLine.textContent = `üî• Streak: ${cur}   üèÜ Best: ${best}`;
  }


  // ‚úÖ Focus engine (Recovery warning > Stalled lift > Weekly countdown > Default)
  if(homeFocus){
    // basics
    const todayIso = todayISO();
    const yesterdayIso = addDaysISO(todayIso, -1);

    const todayIsRest = !!day.rest;

    // (1) Recovery warning: trained yesterday + low protein yesterday + today not rest
    const trainedYesterday = attendance.has(yesterdayIso);
    const yProtein = getProteinTotalForDate(yesterdayIso);
    const yLowProtein = yProtein < (getProteinGoal() * 0.75);

    // (5) Weekly goal countdown (target = number of non-rest days in routine)
    const weeklyTarget = routineWeeklyTargetDays(ar);
    const workoutsLeft = Math.max(weeklyTarget - attendedCount, 0);

    // (3) Stalled lift detection (check today's exercises)
    const todayExercises = Array.isArray(day.exercises) ? day.exercises : [];
    const stalledName = pickStalledExerciseFromToday(todayExercises);

    // priority messaging
    if(todayIsRest){
      homeFocus.textContent = "Recovery day: mobility + walk. Keep it easy and show up tomorrow.";
    }
    else if(trainedYesterday && yLowProtein){
      homeFocus.textContent =
        "Focus: go lighter today ‚Äî recovery may be limiting performance (trained yesterday + low protein).";
    }
    else if(stalledName){
      homeFocus.textContent =
        `Focus: ${stalledName} looks stalled ‚Äî change stimulus (add reps, slower tempo, or switch variation).`;
    }
    else if(workoutsLeft > 0){
      homeFocus.textContent =
        `Focus: ${workoutsLeft} session${workoutsLeft===1?"":"s"} left to hit your weekly routine goal (${weeklyTarget}).`;
    }
    else {
      // keep your original vibe
      if(label) homeFocus.textContent = `Focus: ${label}`;
      else homeFocus.textContent = "Focus: execute clean sets + progressive overload.";
    }
  }

}
  const homeCheckInBtn = document.getElementById("homeCheckInBtn");

function toggleTodayAttendance(){
  const today = todayISO();

  if(attendance.has(today)){
    attendance.delete(today);
  } else {
    attendance.add(today);
  }

  LS.set(KEY_ATT, [...attendance]);

  // refresh the home UI immediately
  refreshHome();

  // optional: keep calendar UI accurate if you‚Äôre already on that screen later
  // (won't error if not visible)
  renderCal();
}

homeCheckInBtn?.addEventListener("click", toggleTodayAttendance);
/* ---------------------------
   Screen Router (Option A) ‚Äî FIXED
---------------------------- */
const KEY_ACTIVE_SCREEN = "gym_active_screen_v1";

const onEnterScreen = {
  home: () => {
    refreshHome();
  },

  weight: () => {
    renderBW();
  },

  attendance: () => {
    renderCal();
  },

  protein: () => {
  if(pDate) pDate.value = todayISO();
  loadProteinDay(pDate?.value || todayISO());

  const pt = document.getElementById("proteinTitle");
  if (pt) pt.textContent = `Protein Intake (Goal ${getProteinGoal()}g)`;
},
  routine: () => {
    renderRoutineDropdown();
    renderPPL();
    buildRoutineExerciseSuggestions(); // ‚úÖ optional but recommended
  },

  lifts: () => {
    renderLiftSearchDropdown();
    renderLiftRoutineDropdown();
    renderLifts();
  },

  settings: () => {
    hydrateSettingsUI();
    renderStorageInfo();
    renderLastBackup();
  }
};

function showScreen(name){
  // remove active
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));

  // find target
  let el = document.getElementById(`screen-${name}`);

  // ‚úÖ fallback if invalid screen name stored
  if(!el){
    name = "home";
    el = document.getElementById("screen-home");
  }

  el.classList.add("active");

  localStorage.setItem(KEY_ACTIVE_SCREEN, name);

  // iOS Safari behaves better scrolling the document element
  (document.scrollingElement || document.documentElement).scrollTo(0, 0);

  onEnterScreen[name]?.();
  setActiveNav(name);

}

  function setActiveNav(name){
  document.querySelectorAll(".navBtn").forEach(b=>{
    b.classList.toggle("active", b.getAttribute("data-nav") === name);
  });
}
  
let navBound = false;

function bindNavigation(){
  if(navBound) return;
  navBound = true;

  document.addEventListener("click", (e)=>{
    const goBtn = e.target.closest("[data-go]");
    if(goBtn){
      showScreen(goBtn.dataset.go);
      return;
    }
    const homeBtn = e.target.closest("[data-home]");
    if(homeBtn){
      showScreen("home");
      return;
    }
  });
}


/* ---------------------------
   LOCAL date utils
---------------------------- */
function pad2(n){ return String(n).padStart(2,"0"); }
function localISODate(d){
  const dt = (d instanceof Date) ? d : new Date(d);
  return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
}
function todayISO(){ return localISODate(new Date()); }
function parseISO(s){
  const [y,m,dd]=s.split("-").map(Number);
  return new Date(y, m-1, dd);
}
function sameMonth(d, y, m){ return d.getFullYear()===y && d.getMonth()===m; }

function weekStartDate(baseDate=new Date()){
  const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
  const dow = d.getDay(); // 0 Sun..6 Sat

  if(profile.weekStart === "sun"){
    d.setDate(d.getDate() - dow);
  } else {
    const delta = (dow === 0) ? 6 : (dow - 1);
    d.setDate(d.getDate() - delta);
  }
  return d;
}

const DAY_KEYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
function dateForWeekdayIndex(dayIndex, baseDate=new Date()){
  const start = weekStartDate(baseDate);
  const out = new Date(start);
  out.setDate(start.getDate() + dayIndex);
  return localISODate(out);
}

/* ---------------------------
   Normalization
---------------------------- */
function normExName(s){
  return String(s||"")
    .toLowerCase()
    .replace(/\s+/g," ")
    .trim();
}

function cleanExerciseName(s){
  const raw = String(s || "").trim().replace(/\s+/g, " ");
  if(!raw) return "";
  return canonicalExerciseName(raw);
}

function loadCustomExercises(){
  // Backward compatible:
  // - v1: ["Pushup","Rowing Machine"]
  // - v2: [{name:"Pushup", type:"strength", coreMode:null}, ...]
  const raw = LS.get(KEY_CUSTOM_EX, []);
  const arr = Array.isArray(raw) ? raw : [];

  const out = [];
  arr.forEach(item=>{
    if(typeof item === "string"){
      const nm = cleanExerciseName(item);
      if(nm) out.push({ name: nm, type: "strength", coreMode: null });
      return;
    }
    if(item && typeof item === "object"){
      const nm = cleanExerciseName(item.name);
      if(!nm) return;

      const t = String(item.type || "strength").toLowerCase();
      const type = (t === "cardio" || t === "core" || t === "strength") ? t : "strength";

      const cmRaw = (item.coreMode == null) ? null : String(item.coreMode).toLowerCase();
      const coreMode = (type === "core" && (cmRaw === "time" || cmRaw === "reps")) ? cmRaw : null;

      out.push({ name: nm, type, coreMode });
    }
  });

  // De-dupe by normalized name, keep first
  const seen = new Set();
  const deduped = [];
  out.forEach(o=>{
    const key = normExName(o.name);
    if(seen.has(key)) return;
    seen.add(key);
    deduped.push(o);
  });

  // Sort by name for stable UI lists
  deduped.sort((a,b)=>a.name.localeCompare(b.name));

  return deduped;
}

function saveCustomExercises(arr){
  // Expect v2 format [{name,type,coreMode}]
  LS.set(KEY_CUSTOM_EX, Array.isArray(arr) ? arr : []);
}

function addCustomExercise(name, type="strength", coreMode=null){
  const cleaned = cleanExerciseName(name);
  if(!cleaned) return "";

  const t = String(type || "strength").toLowerCase();
  const safeType = (t === "cardio" || t === "core" || t === "strength") ? t : "strength";

  const cmRaw = (coreMode == null) ? null : String(coreMode).toLowerCase();
  const safeCoreMode = (safeType === "core" && (cmRaw === "time" || cmRaw === "reps")) ? cmRaw : null;

  const cur = loadCustomExercises();
  const exists = cur.some(x => normExName(x.name) === normExName(cleaned));

  if(!exists){
    cur.push({ name: cleaned, type: safeType, coreMode: safeCoreMode });
    cur.sort((a,b)=>a.name.localeCompare(b.name));
    saveCustomExercises(cur);
  }

  return cleaned;
}


  /* ---------------------------
   Canonical Exercise Naming
   - variants map to ONE canonical label
---------------------------- */
const CANONICAL_EXERCISE_MAP = {
  "cable crunch": "Cable Crunch",
  "cable crunches": "Cable Crunch",

  "leg extension": "Leg Extension",
  "leg extensions": "Leg Extension",

  "standing calf raise": "Standing Calf Raise",
  "standing calf raise (machine)": "Standing Calf Raise",

  "overhead dumbbell tricep extension": "Overhead Dumbbell Tricep Extension",
  "overhead dumbbell triceps extension": "Overhead Dumbbell Tricep Extension",

  "goblet squat": "Goblet Squat",
  "goblet squats": "Goblet Squat",

  "spin bike": "Stationary Bike",
  "stationary bike": "Stationary Bike",
};

function canonicalExerciseName(name){
  const raw = String(name || "").trim();
  if(!raw) return "";
  const key = normExName(raw);
  return CANONICAL_EXERCISE_MAP[key] || raw;
}
/* ---------------------------
   Canonical Exercise Library
---------------------------- */
const EXERCISE_LIBRARY = [
  // Barbell
  "Barbell Bench Press",
  "Incline Barbell Bench Press",
  "Barbell Squat",
  "Front Squat",
  "Barbell Back Squat",
  "Barbell Row",
  "Deadlift (Conventional)",
  "Romanian Deadlift",
  "Barbell Curl",

  // Machines / Cables
  "Leg Press",
  "Hack Squat",
  "Smith Machine Squat",
  "Lat Pulldown",
  "Underhand Lat Pulldown",
  "Seated Cable Row",
  "Cable Chest Flys",
  "Cable Crunch",
  "Chest Fly Machine",
  "Shoulder Press Machine",
  "Leg Extension",
  "Hamstring Curl",
  "Leg Curl Machine",
  "Standing Calf Raise (Machine)",
  "Standing Calf Raise",
  "Seated Calf Raise",
  "Triceps Rope Pushdowns",

  // Dumbbell
  "Dumbbell Bench Press",
  "Incline Dumbbell Press",
  "Dumbbell Shoulder Press",
  "Dumbbell Lateral Raises",
  "Lateral Raises",
  "Dumbbell Front Raises",
  "Dumbbell Chest Fly",
  "Dumbbell Row",
  "One-Arm Dumbbell Row",
  "Dumbbell Shrugs",
  "Dumbbell Bicep Curl",
  "Hammer Curl",
  "Concentration Curl",
  "Dumbbell Tricep Kickback",
  "Overhead Dumbbell Tricep Extension",
  "Goblet Squat",
  "Dumbbell Lunges",
  "Bulgarian Split Squat",
  "Dumbbell Romanian Deadlift",
  "Rear Delt Fly",
  "Dumbbell Alternating Curl",

  // Bodyweight / Misc
  "Chest Dips",
  "Pull-Ups / Assisted Pull-Ups",
  "Hanging Leg Raises",
  "Mobility + stretching",
  "Light walking or stretching",

  // Core
  "Plank",
  "Side Plank",
  "Leg Raises",
  "Bicycle Crunch",
  "Russian Twist",
  "Ab Wheel Rollout",
  "Mountain Climbers",

  // Cardio / Conditioning
  "Treadmill Walk / Run",
  "Incline Treadmill Walk",
  "Stair Climber",
  "Stationary Bike",
  "Elliptical",
  "Rowing Machine",
  "Jump Rope",
  "Battle Ropes",
  "Kettlebell Swings",
  "Sled Push / Pull",
  "Box Jumps",
  "Burpees"
];

  /* ---------------------------
   Exercise Metadata (Type + Core Mode)
   - Used to render correct logging UI later
---------------------------- */
const EXERCISE_META = (() => {
  const m = {};

  // Defaults: treat everything as strength unless explicitly tagged
  EXERCISE_LIBRARY.forEach(n => {
    const key = canonicalExerciseName(n);
    if(!m[key]) m[key] = { type: "strength", coreMode: null };
  });

  // Core (default reps-based unless overridden)
  const CORE_LIST = [
    "Plank",
    "Side Plank",
    "Leg Raises",
    "Bicycle Crunch",
    "Russian Twist",
    "Ab Wheel Rollout",
    "Mountain Climbers"
  ];
  CORE_LIST.forEach(n => {
    const key = canonicalExerciseName(n);
    m[key] = { type: "core", coreMode: "reps" };
  });

  // Core holds (time-based)
  const CORE_TIME = [
    "Plank",
    "Side Plank"
  ];
  CORE_TIME.forEach(n => {
    const key = canonicalExerciseName(n);
    m[key] = { type: "core", coreMode: "time" };
  });

  // Cardio / Conditioning
  const CARDIO_LIST = [
    "Treadmill Walk / Run",
    "Incline Treadmill Walk",
    "Stair Climber",
    "Stationary Bike",
    "Elliptical",
    "Rowing Machine",
    "Jump Rope",
    "Battle Ropes",
    "Kettlebell Swings",
    "Sled Push / Pull",
    "Box Jumps",
    "Burpees"
  ];
  CARDIO_LIST.forEach(n => {
    const key = canonicalExerciseName(n);
    m[key] = { type: "cardio", coreMode: null };
  });

  return m;
})();

function getDefaultExerciseMeta(exName){
  const key = canonicalExerciseName(exName || "");
  return EXERCISE_META[key] || null;
}

  
/* ---------------------------
   UID helper
---------------------------- */
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

/* ---------------------------
   Default Routine Seed
---------------------------- */
function defaultRoutine(){
  return {
    id: uid(),
    name: "PPL",
    source: "default",
    days: {
      Mon: { label:"Push", rest:false, exercises:[
        {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Dumbbell Bench Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Chest Dips", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Lateral Raises", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Chest Flys", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Triceps Rope Pushdowns", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Overhead Dumbbell Triceps Extension", sets:3, reps:"12‚Äì15", notes:""},
      ]},

      Tue: { label:"Pull", rest:false, exercises:[
        {name:"Underhand Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Barbell Row", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Dumbbell Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Rear Delt Fly", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Barbell Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hammer Curl", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Dumbbell Alternating Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hanging Leg Raises", sets:3, reps:"12‚Äì15", notes:"Core"},
      ]},

      Wed: { label:"Legs", rest:false, exercises:[
        {name:"Barbell Back Squat", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Goblet Squats", sets:3, reps:"12‚Äì15 steps", notes:""},
        {name:"Leg Curl Machine", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Standing Calf Raise", sets:3, reps:"15‚Äì20", notes:""},
        {name:"Leg Extensions", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Crunches", sets:3, reps:"20", notes:"Core"},
      ]},

      Thu: { label:"Push", rest:false, exercises:[
        {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Dumbbell Bench Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Chest Dips", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Lateral Raises", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Chest Flys", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Triceps Rope Pushdowns", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Overhead Dumbbell Triceps Extension", sets:3, reps:"12‚Äì15", notes:""},
      ]},

      Fri: { label:"Pull", rest:false, exercises:[
        {name:"Underhand Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Barbell Row", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Dumbbell Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Rear Delt Fly", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Barbell Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hammer Curl", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Dumbbell Alternating Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hanging Leg Raises", sets:3, reps:"12‚Äì15", notes:"Core"},
      ]},

      Sat: { label:"Legs", rest:false, exercises:[
        {name:"Barbell Back Squat", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Goblet Squats", sets:3, reps:"12‚Äì15 steps", notes:""},
        {name:"Leg Curl Machine", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Standing Calf Raise", sets:3, reps:"15‚Äì20", notes:""},
        {name:"Leg Extensions", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Crunches", sets:3, reps:"20", notes:"Core"},
      ]},

      Sun: { label:"Rest", rest:true, exercises:[] }
    }
  };
}

function makeUpperLowerTemplate(){
  const r = defaultRoutine();
  r.name = "Upper / Lower";

  r.days.Mon = { label:"Upper", rest:false, exercises:[
    {name:"Barbell Bench Press", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Shoulder Press", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Dumbbell Lateral Raises", sets:3, reps:"12‚Äì15", notes:""},
    {name:"Dumbbell Bicep Curl", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Triceps Rope Pushdowns", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Plank", sets:3, reps:"30‚Äì60s", notes:"Core"},
  ]};

  r.days.Tue = { label:"Lower", rest:false, exercises:[
    {name:"Barbell Squat", sets:4, reps:"5‚Äì8", notes:""},
    {name:"Romanian Deadlift", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Dumbbell Lunges", sets:3, reps:"10/leg", notes:""},
    {name:"Hamstring Curl", sets:3, reps:"12‚Äì15", notes:""},
    {name:"Standing Calf Raise (Machine)", sets:4, reps:"12‚Äì15", notes:""},
  ]};

  r.days.Wed = { label:"Active Recovery", rest:true, exercises:[
    {name:"Incline Treadmill Walk", sets:1, reps:"20‚Äì30 min", notes:"Cardio"},
    {name:"Mobility + stretching", sets:1, reps:"‚Äî", notes:""},
  ]};

  r.days.Thu = { label:"Upper", rest:false, exercises:[
    {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Pull-Ups / Assisted Pull-Ups", sets:4, reps:"6‚Äì10", notes:""},
    {name:"Dumbbell Row", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Chest Fly", sets:3, reps:"12", notes:""},
    {name:"Hammer Curl", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Overhead Dumbbell Tricep Extension", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Leg Raises", sets:3, reps:"10‚Äì15", notes:"Core"},
  ]};

  r.days.Fri = { label:"Lower", rest:false, exercises:[
    {name:"Deadlift (Conventional)", sets:4, reps:"3‚Äì5", notes:""},
    {name:"Hack Squat", sets:3, reps:"8‚Äì10", notes:"(or Smith Squat)"},
    {name:"Bulgarian Split Squat", sets:3, reps:"8/leg", notes:""},
    {name:"Leg Extension", sets:3, reps:"12‚Äì15", notes:""},
    {name:"Seated Calf Raise", sets:4, reps:"12‚Äì15", notes:""},
    {name:"Cable Crunch", sets:3, reps:"12‚Äì15", notes:"Core"},
  ]};

  r.days.Sat = { label:"Rest", rest:true, exercises:[
    {name:"Light walking or stretching", sets:1, reps:"‚Äî", notes:"Recovery"},
  ]};

  r.days.Sun = { label:"Cardio + Core", rest:false, exercises:[
    {name:"Stair Climber", sets:1, reps:"20‚Äì30 min", notes:"(or Stationary Bike)"},
    {name:"Russian Twist", sets:3, reps:"20", notes:"Core"},
    {name:"Plank", sets:3, reps:"45s", notes:"Core"},
  ]};

  return r;
}

function makeFullBody3Template(){
  const r = defaultRoutine();
  r.name = "Full Body (3-Day)";

  r.days.Mon = { label:"Full Body Day 1", rest:false, exercises:[
    {name:"Barbell Squat", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Barbell Bench Press", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Lat Pulldown", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Shoulder Press", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Plank", sets:3, reps:"45s", notes:"Core"},
  ]};

  r.days.Tue = { label:"Rest / Cardio", rest:true, exercises:[
    {name:"Incline Treadmill Walk", sets:1, reps:"25‚Äì30 min", notes:"(or Stationary Bike)"},
  ]};

  r.days.Wed = { label:"Full Body Day 2", rest:false, exercises:[
    {name:"Deadlift (Conventional)", sets:4, reps:"4‚Äì6", notes:""},
    {name:"Incline Dumbbell Press", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Seated Cable Row", sets:3, reps:"10", notes:""},
    {name:"Dumbbell Lunges", sets:3, reps:"10/leg", notes:""},
    {name:"Leg Raises", sets:3, reps:"10‚Äì15", notes:"Core"},
  ]};

  r.days.Thu = { label:"Rest", rest:true, exercises:[
    {name:"Mobility + stretching", sets:1, reps:"‚Äî", notes:"Recovery"},
  ]};

  r.days.Fri = { label:"Full Body Day 3", rest:false, exercises:[
    {name:"Leg Press", sets:4, reps:"10", notes:""},
    {name:"Pull-Ups / Assisted Pull-Ups", sets:3, reps:"AMRAP", notes:""},
    {name:"Dumbbell Chest Fly", sets:3, reps:"12", notes:""},
    {name:"Dumbbell Lateral Raises", sets:3, reps:"15", notes:""},
    {name:"Cable Crunch", sets:3, reps:"15", notes:"Core"},
  ]};

  r.days.Sat = { label:"Optional Conditioning", rest:true, exercises:[
    {name:"Rowing Machine", sets:1, reps:"15‚Äì20 min", notes:"(or Battle Ropes)"},
  ]};

  r.days.Sun = { label:"Rest", rest:true, exercises:[] };

  return r;
}

function makeBodyPartTemplate(){
  const r = defaultRoutine();
  r.name = "Body Part Split";

  r.days.Mon = { label:"Chest", rest:false, exercises:[
    {name:"Barbell Bench Press", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Chest Fly", sets:3, reps:"12", notes:""},
    {name:"Chest Fly Machine", sets:3, reps:"12‚Äì15", notes:""},
  ]};

  r.days.Tue = { label:"Back", rest:false, exercises:[
    {name:"Deadlift (Conventional)", sets:4, reps:"4‚Äì6", notes:""},
    {name:"Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Dumbbell Row", sets:3, reps:"8‚Äì10", notes:""},
  ]};

  r.days.Wed = { label:"Shoulders", rest:false, exercises:[
    {name:"Dumbbell Shoulder Press", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Lateral Raises", sets:4, reps:"12‚Äì15", notes:""},
    {name:"Dumbbell Front Raises", sets:3, reps:"12", notes:""},
    {name:"Dumbbell Shrugs", sets:3, reps:"12", notes:""},
  ]};

  r.days.Thu = { label:"Legs", rest:false, exercises:[
    {name:"Barbell Squat", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Romanian Deadlift", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Hamstring Curl", sets:3, reps:"12‚Äì15", notes:""},
    {name:"Standing Calf Raise (Machine)", sets:4, reps:"15", notes:""},
  ]};

  r.days.Fri = { label:"Arms + Core", rest:false, exercises:[
    {name:"Dumbbell Bicep Curl", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Hammer Curl", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Triceps Rope Pushdowns", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Overhead Dumbbell Tricep Extension", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Cable Crunch", sets:3, reps:"15", notes:"Core"},
    {name:"Russian Twist", sets:3, reps:"20", notes:"Core"},
  ]};

  r.days.Sat = { label:"Rest", rest:true, exercises:[] };

  r.days.Sun = { label:"Light Cardio", rest:true, exercises:[
    {name:"Stationary Bike", sets:1, reps:"20‚Äì30 min", notes:"(or Walk / Stretch)"},
  ]};

  return r;
  
}
  const ROUTINE_TEMPLATES = [
  { id:"tpl_ppl",          name:"PPL (6-day)",             build: ()=> defaultRoutine() },
  { id:"tpl_upperlower",   name:"Upper / Lower (7-day)",   build: ()=> makeUpperLowerTemplate() },
  { id:"tpl_fullbody3",    name:"Full Body (3-day)",       build: ()=> makeFullBody3Template() },
  { id:"tpl_bodypart",     name:"Body Part Split (7-day)", build: ()=> makeBodyPartTemplate() },
];

/* ---------------------------
   Routines state
---------------------------- */
function loadRoutines(){
  let routines = LS.get(KEY_ROUTINES, null);
  if(!Array.isArray(routines) || routines.length === 0){
    routines = [defaultRoutine()];
    LS.set(KEY_ROUTINES, routines);
  }
  routines.forEach(r=>{
    if(!r.days) r.days = {};
    DAY_KEYS.forEach(k=>{
      if(!r.days[k]) r.days[k] = {label:"", rest:false, exercises:[]};
      if(!Array.isArray(r.days[k].exercises)) r.days[k].exercises = [];
      if(typeof r.days[k].rest !== "boolean") r.days[k].rest = !!r.days[k].rest;
      if(typeof r.days[k].label !== "string") r.days[k].label = String(r.days[k].label||"");
      r.days[k].exercises = r.days[k].exercises.map(e=>({
        name: String(e.name||e.ex||""),
        sets: Number(e.sets)||0,
        reps: String(e.reps||""),
        notes: String(e.notes||"")
      })).filter(e=>e.name);
    });
    if(!r.id) r.id = uid();
    if(!r.name) r.name = "Routine";
    if(!r.source) r.source = "user"; // fallback for legacy routines
  });

  LS.set(KEY_ROUTINES, routines);

  let activeId = LS.get(KEY_ACTIVE_ROUTINE, null);
  if(!activeId || !routines.some(r=>r.id===activeId)){
    activeId = routines[0].id;
    LS.set(KEY_ACTIVE_ROUTINE, activeId);
  }
  return {routines, activeId};
}
({ routines, activeId: activeRoutineId } = loadRoutines());

function saveRoutines(){ LS.set(KEY_ROUTINES, routines); }
function setActiveRoutine(id){
  activeRoutineId = id;
  LS.set(KEY_ACTIVE_ROUTINE, id);
}
function getActiveRoutine(){
  return routines.find(r=>r.id===activeRoutineId) || routines[0];
}

/* ---------------------------
   Weight Tracker  ‚úÖ (COPY/PASTE THIS WHOLE BLOCK)
---------------------------- */
bwLogs = LS.get(KEY_BW, []);
function sortBW(){ bwLogs.sort((a,b)=>a.date.localeCompare(b.date)); }

const bwDate   = document.getElementById("bwDate");
const bwVal    = document.getElementById("bwVal");
const bwAddBtn = document.getElementById("bwAddBtn");
const bwTable  = document.getElementById("bwTable");
const bwLatest = document.getElementById("bwLatest");
const bwDelta  = document.getElementById("bwDelta");
const bwAvg    = document.getElementById("bwAvg");

const bwViewTableBtn = document.getElementById("bwViewTableBtn");
const bwViewGraphBtn = document.getElementById("bwViewGraphBtn");
const bwChartWrap    = document.getElementById("bwChartWrap");
const bwTableWrap    = document.getElementById("bwTableWrap");

let bwView = "table"; // "table" | "graph"

function setBWView(next){
  bwView = next;

  if(bwView === "table"){
    if(bwTableWrap) bwTableWrap.style.display = "";
    if(bwChartWrap) bwChartWrap.style.display = "none";
    bwViewTableBtn?.classList.remove("ghost");
    bwViewGraphBtn?.classList.add("ghost");
  } else {
    if(bwTableWrap) bwTableWrap.style.display = "none";
    if(bwChartWrap) bwChartWrap.style.display = "";
    bwViewTableBtn?.classList.add("ghost");
    bwViewGraphBtn?.classList.remove("ghost");
    renderBW(); // ensures chart draws correctly when shown
  }
}

bwViewTableBtn?.addEventListener("click", ()=> setBWView("table"));
bwViewGraphBtn?.addEventListener("click", ()=> setBWView("graph"));

if(bwDate) bwDate.value = todayISO();

/* ‚úÖ ADD weight */
bwAddBtn?.addEventListener("click", ()=>{
  const d = bwDate?.value || todayISO();
  const v = Number(bwVal?.value);

  if(!d || !isFinite(v)) return alert("Please enter date + bodyweight.");

  bwLogs = bwLogs.filter(x=>x.date !== d);
  bwLogs.push({date:d, bw:v});

  sortBW();
  LS.set(KEY_BW, bwLogs);

  if(bwVal) bwVal.value = "";
  renderBW();
});

/* ‚úÖ DELETE weight (ONE-TIME listener ‚Äî OUTSIDE renderBW) */
bwTable?.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-delbw]");
  if(!btn) return;

  const d = btn.getAttribute("data-delbw");
  bwLogs = bwLogs.filter(x=>x.date !== d);
  LS.set(KEY_BW, bwLogs);
  renderBW();
});

function bwStats(){
  sortBW();
  const latest = bwLogs[bwLogs.length-1];
  const prev = bwLogs[bwLogs.length-2];
  const delta = (latest && prev) ? (latest.bw - prev.bw) : null;

  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-6);
  const last7 = bwLogs.filter(x=>parseISO(x.date) >= cutoff);
  const avg = last7.length ? (last7.reduce((s,x)=>s+x.bw,0)/last7.length) : null;

  return {latest, prev, delta, avg, last7};
}

let bwChart;

function renderBW(){
  sortBW();
  const {latest, delta, avg} = bwStats();

  if(bwLatest) bwLatest.textContent = latest ? `${latest.bw.toFixed(1)} lbs (${latest.date})` : "‚Äî";

  if(bwDelta){
    if(delta === null) bwDelta.textContent = "‚Äî";
    else {
      const sign = delta > 0 ? "+" : "";
      bwDelta.textContent = `${sign}${delta.toFixed(1)} lbs`;
      bwDelta.className = "mono " + (delta>0 ? "bad" : (delta<0 ? "good" : ""));
    }
  }

  if(bwAvg) bwAvg.textContent = avg ? `${avg.toFixed(1)} lbs` : "‚Äî";

  /* ---- TABLE ---- */
  if(bwTable){
    bwTable.innerHTML = "";

    for(let i=0; i<bwLogs.length; i++){
      const cur = bwLogs[i];
      const prevBW = bwLogs[i-1]?.bw ?? null;

      const dlt = (prevBW===null) ? null : (cur.bw - prevBW);
      const trend = dlt===null ? "‚Äî" : (dlt>0 ? "‚Üë" : (dlt<0 ? "‚Üì" : "‚Äî"));
      const dltTxt = dlt===null ? "‚Äî" : `${dlt>0?"+":""}${dlt.toFixed(1)}`;
      const cls = dlt===null ? "" : (dlt>0 ? "bad" : (dlt<0 ? "good" : ""));

      const tr = document.createElement("tr");
      tr.classList.add("tap");

      tr.innerHTML = `
        <td class="mono">${escHTML(cur.date)}</td>
        <td class="mono">${cur.bw.toFixed(1)}</td>
        <td class="mono">${prevBW===null ? "‚Äî" : prevBW.toFixed(1)}</td>
        <td class="mono ${cls}">${dltTxt} ${trend}</td>
        <td><button data-delbw="${cur.date}">Delete</button></td>
      `;
      bwTable.appendChild(tr);
    }
  }

  /* ---- CHART ---- */
  if(bwView !== "graph") return;            // only draw chart when visible
  const canvas = document.getElementById("bwChart");
  if(!canvas) return;

  const labels = bwLogs.map(x=>x.date);
  const data = bwLogs.map(x=>x.bw);

  if(bwChart) bwChart.destroy();

  bwChart = new Chart(canvas, {
    type:"line",
    data:{ labels, datasets:[{ label:"Bodyweight (lbs)", data, tension:.25, pointRadius:3 }] },
    options:{
      responsive:true,
      plugins:{ legend:{display:false}, tooltip:{mode:"index", intersect:false} },
      scales:{
        x:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}},
        y:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}}
      }
    }
  });
}
/* ---------------------------
   Attendance Calendar
---------------------------- */
attendance = new Set(LS.get(KEY_ATT, []));

let calY = new Date().getFullYear();
let calM = new Date().getMonth();
const calTitle = document.getElementById("calTitle");
const calGrid = document.getElementById("calGrid");
const calCount = document.getElementById("calCount");

document.getElementById("prevMonthBtn")?.addEventListener("click", ()=>{
  calM--; if(calM<0){calM=11; calY--;}
  renderCal();
});
document.getElementById("nextMonthBtn")?.addEventListener("click", ()=>{
  calM++; if(calM>11){calM=0; calY++;}
  renderCal();
});
document.getElementById("clearMonthBtn")?.addEventListener("click", ()=>{
  const keep = [...attendance].filter(s=>{
    const d=parseISO(s);
    return !sameMonth(d, calY, calM);
  });
  attendance = new Set(keep);
  LS.set(KEY_ATT, [...attendance]);
  renderCal();
});

function renderCal(){
  const monthName = new Date(calY,calM,1).toLocaleString(undefined,{month:"long"});
  calTitle.textContent = `${monthName} ${calY}`;

  calGrid.innerHTML = "";
  const heads = ["S","M","T","W","T","F","S"];
  heads.forEach(h=>{
    const el=document.createElement("div");
    el.className="calHead";
    el.textContent=h;
    calGrid.appendChild(el);
  });

  const first = new Date(calY, calM, 1);
  const startDay = first.getDay();
  const daysInMonth = new Date(calY, calM+1, 0).getDate();

  for(let i=0;i<startDay;i++){
    const blank=document.createElement("div");
    blank.className="day off";
    blank.textContent="";
    calGrid.appendChild(blank);
  }

  let count=0;
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(calY, calM, d);
    const s = localISODate(date);
    const cell=document.createElement("div");
    cell.className="day";
    cell.innerHTML = `<div>${d}</div>`;
    if(attendance.has(s)){
      cell.classList.add("attended");
      cell.innerHTML += `<span class="dot"></span>`;
      count++;
    }
    cell.addEventListener("click", ()=>{
  if(attendance.has(s)) attendance.delete(s);
  else attendance.add(s);
  LS.set(KEY_ATT, [...attendance]);
  renderCal();
  refreshHome(); // ‚úÖ add this
});
    calGrid.appendChild(cell);
  }
  calCount.textContent = String(count);
}

/* ---------------------------
   Protein
---------------------------- */
// goal is dynamic from profile
const pDate = document.getElementById("pDate");
const pMorning = document.getElementById("pMorning");
const pLunch = document.getElementById("pLunch");
const pPre = document.getElementById("pPre");
const pDinner = document.getElementById("pDinner");
const pBed = document.getElementById("pBed");
const pTotal = document.getElementById("pTotal");
const pRemain= document.getElementById("pRemain");
const pStatus= document.getElementById("pStatus");
proteinMap = LS.get(KEY_PRO, {});

pDate.value = todayISO();

const pt = document.getElementById("proteinTitle");
if(pt) pt.textContent = `Protein Intake (Goal ${getProteinGoal()}g)`;

function loadProteinDay(d){
  const obj = proteinMap[d] || {morning:0,lunch:0,pre:0,dinner:0,bed:0};
  pMorning.value = obj.morning;
  pLunch.value = obj.lunch;
  pPre.value = obj.pre;
  pDinner.value = obj.dinner;
  pBed.value = obj.bed;
  renderProteinTotals();
}
function renderProteinTotals(){
  const total = (Number(pMorning.value)||0)+(Number(pLunch.value)||0)+(Number(pPre.value)||0)+(Number(pDinner.value)||0)+(Number(pBed.value)||0);
  pTotal.textContent = String(total);
  const rem = Math.max(getProteinGoal() - total, 0);
pRemain.textContent = String(rem);
  if(total >= getProteinGoal()){
    pStatus.textContent = "Hit goal ‚úÖ";
    pStatus.className = "good";
  } else if(total >= getProteinGoal()*0.75){
    pStatus.textContent = "Almost there";
    pStatus.className = "warn";
  } else {
    pStatus.textContent = "Under goal";
    pStatus.className = "muted";
  }
}
  function updateHomeProteinCirclePreview(){
  // only preview for TODAY (so it feels real-time)
  const td = todayISO();

  // read from the protein inputs (what user is typing)
  const total =
    (Number(pMorning?.value)||0) +
    (Number(pLunch?.value)||0) +
    (Number(pPre?.value)||0) +
    (Number(pDinner?.value)||0) +
    (Number(pBed?.value)||0);

  const goal = getProteinGoal();
  const left = Math.max(goal - total, 0);
  const pct = Math.max(0, Math.min(1, goal ? (total / goal) : 0));
  const deg = Math.round(pct * 360);

  // update HOME ring + number (even if Home isn't visible, it's still fine)
  if(homeProteinLeft) homeProteinLeft.textContent = String(left);
  if(homeProteinCircle){
    homeProteinCircle.style.setProperty("--deg", `${deg}deg`);
  }
}
[pMorning,pLunch,pPre,pDinner,pBed].forEach(inp=>{
  inp.addEventListener("input", ()=>{
    renderProteinTotals();
    // live-fill the Home ring while typing (only makes sense for today)
    if((pDate?.value || todayISO()) === todayISO()){
      updateHomeProteinCirclePreview();
    }
  });
});
  
pDate?.addEventListener("change", ()=>{
  loadProteinDay(pDate.value);
  if((pDate.value || todayISO()) === todayISO()){
    updateHomeProteinCirclePreview();
  }
});

document.getElementById("pSaveBtn")?.addEventListener("click", ()=>{
  const d = pDate.value || todayISO();
  proteinMap[d] = {
    morning:Number(pMorning.value)||0,
    lunch:Number(pLunch.value)||0,
    pre:Number(pPre.value)||0,
    dinner:Number(pDinner.value)||0,
    bed:Number(pBed.value)||0,
  };
  LS.set(KEY_PRO, proteinMap);

  // ‚úÖ ADD THESE
  renderHeaderPills();  // updates "Xg / Goal"
  refreshHome();        // updates home circle + focus text

  alert("Saved ‚úÖ");
});


/* ---------------------------
   Lifts + PR helpers
---------------------------- */
lifts = LS.get(KEY_LIFTS, []);

function ensureLiftCompatibility(){
  lifts = lifts.map(x=>{
    const ex = String(x.ex || x.exercise || "");
    const exNorm = x.exNorm || normExName(ex);
    return {
      ...x,
      ex,
      exNorm,
      routineId: x.routineId || "",
      routineName: x.routineName || "",
      dayKey: x.dayKey || ""
    };
  });
  LS.set(KEY_LIFTS, lifts);
}
ensureLiftCompatibility();
  migrateCanonicalNames();

  function migrateCanonicalNames(){
  // ---- Routines ----
  let routinesChanged = false;

  routines.forEach(r=>{
    DAY_KEYS.forEach(k=>{
      const day = r.days?.[k];
      if(!day || !Array.isArray(day.exercises)) return;

      day.exercises.forEach(ex=>{
        const after = canonicalExerciseName(ex.name);
        if(after && ex.name !== after){
          ex.name = after;
          routinesChanged = true;
        }
      });

      // Remove duplicates caused by merging names
      const seen = new Set();
      day.exercises = day.exercises.filter(ex=>{
        const n = normExName(ex.name);
        if(seen.has(n)) return false;
        seen.add(n);
        return true;
      });
    });
  });

  if(routinesChanged) saveRoutines();

  // ---- Lifts ----
  let liftsChanged = false;

  lifts = lifts.map(x=>{
    const after = canonicalExerciseName(x.ex);
    const afterNorm = normExName(after);
    if(x.ex !== after || x.exNorm !== afterNorm){
      liftsChanged = true;
      return { ...x, ex: after, exNorm: afterNorm };
    }
    return x;
  });

  if(liftsChanged) LS.set(KEY_LIFTS, lifts);
}
migrateCanonicalNames();

function liftStatsForExercise(exName){
  const n = normExName(exName);
  const exLifts = lifts.filter(x=> (x.exNorm || normExName(x.ex)) === n);

  const life = exLifts.length ? Math.max(...exLifts.map(x=>Number(x.weight)||0)) : null;

  const thisWeekStart = new Date(); thisWeekStart.setDate(thisWeekStart.getDate()-7);
  const lastWeekStart = new Date(); lastWeekStart.setDate(lastWeekStart.getDate()-14);

  const thisWeek = exLifts.filter(x=>parseISO(x.date) >= thisWeekStart);
  const lastWeek = exLifts.filter(x=>{
    const d = parseISO(x.date);
    return d >= lastWeekStart && d < thisWeekStart;
  });

  const thisWeekMax = thisWeek.length ? Math.max(...thisWeek.map(x=>Number(x.weight)||0)) : null;
  const lastWeekMax = lastWeek.length ? Math.max(...lastWeek.map(x=>Number(x.weight)||0)) : null;

  return { life, thisWeekMax, lastWeekMax };
}

function getLastLiftForExercise(exName){
  const n = normExName(exName);
  const exLifts = lifts
    .filter(x=> (x.exNorm || normExName(x.ex)) === n)
    .sort((a,b)=>b.date.localeCompare(a.date));
  return exLifts[0] || null;
}

function formatSetsDetail(lift){
  if(!lift) return "‚Äî";
  const topSet = (lift.weight && lift.reps) ? `${lift.weight} x ${lift.reps}` : "‚Äî";
  const details = Array.isArray(lift.details) && lift.details.length
    ? lift.details.map((s,i)=>`S${i+1}:${s.weight}x${s.reps}`).join("  ")
    : null;
  return `${lift.date} ‚Ä¢ Top: ${topSet}${details ? " ‚Ä¢ " + details : ""}`;
}

/* ---------------------------
   Routine UI
---------------------------- */
const routineSelect = document.getElementById("routineSelect");
const activeRoutineMeta = document.getElementById("activeRoutineMeta");
const newRoutineBtn = document.getElementById("newRoutineBtn");
const editRoutineBtn = document.getElementById("editRoutineBtn");
const dupRoutineBtn = document.getElementById("dupRoutineBtn");
const delRoutineBtn = document.getElementById("delRoutineBtn");

let activeDayIndex = 0; // Mon=0..Sun=6

function renderRoutineDropdown(forceId){
  const selected = forceId || activeRoutineId;

  routineSelect.innerHTML = "";

  // --- Created Workouts (your saved routines) ---
  const ogCreated = document.createElement("optgroup");
  ogCreated.label = "Created Workouts";

  routines.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = r.name;
    ogCreated.appendChild(opt);
  });

  routineSelect.appendChild(ogCreated);

  // --- Default / Template Workouts ---
  const ogTemplates = document.createElement("optgroup");
  ogTemplates.label = "Default / Template Workouts";

  ROUTINE_TEMPLATES.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t.id;      // tpl_*
    opt.textContent = t.name;
    ogTemplates.appendChild(opt);
  });

  routineSelect.appendChild(ogTemplates);

  // --- select active value ---
  const allValues = [...routineSelect.options].map(o=>o.value);

  // if selected is a real routine OR a template id, keep it
  const finalVal = allValues.includes(selected) ? selected : (routines[0]?.id || "");

  routineSelect.value = finalVal;

  // if it's a real routine, update active routine + meta
  if(finalVal && !finalVal.startsWith("tpl_")){
    setActiveRoutine(finalVal);
    const ar = getActiveRoutine();
    activeRoutineMeta.textContent = `${ar.name} ‚Ä¢ ${DAY_KEYS.length} days`;
  } else {
    // template selected, meta can stay based on current active routine
    const ar = getActiveRoutine();
    activeRoutineMeta.textContent = `${ar.name} ‚Ä¢ ${DAY_KEYS.length} days`;
  }
}
  
routineSelect?.addEventListener("change", ()=>{
  const val = routineSelect.value;

  // If they picked a template -> convert it into a REAL saved routine
  if(val.startsWith("tpl_")){
    const tpl = ROUTINE_TEMPLATES.find(t=>t.id === val);
    if(!tpl) return;

    const built = tpl.build();
    built.id = uid(); // ensure unique
    built.name = tpl.name; // keep template name
    routines.push(built);
    saveRoutines();

    setActiveRoutine(built.id);

    // re-render dropdown and select the newly created routine
    renderRoutineDropdown(built.id);
    renderPPL();
    renderLiftRoutineDropdown();
    buildRoutineExerciseSuggestions();

   renderHeaderPills();
    refreshHome();
    return;
  }

  // Normal: user selected a real created routine
  setActiveRoutine(val);
  renderRoutineDropdown(val);
  renderPPL();
  renderLiftRoutineDropdown();
  buildRoutineExerciseSuggestions();

   // ‚úÖ ADD
  renderHeaderPills();
  refreshHome(); 
});


newRoutineBtn?.addEventListener("click", ()=>{
  const base = defaultRoutine();
  base.name = `New Routine ${routines.length+1}`;
  base.source = "user";
  DAY_KEYS.forEach(k=>{
    base.days[k].exercises = [];
    base.days[k].rest = (k==="Sun");
    if(k==="Sun") base.days[k].label = "Rest";
  });
  routines.push(base);
  saveRoutines();
  
  setActiveRoutine(base.id);
  renderRoutineDropdown();
  openRoutineEditor(base.id);
});

dupRoutineBtn?.addEventListener("click", ()=>{
  const ar = getActiveRoutine();
  const copy = JSON.parse(JSON.stringify(ar));
  copy.source = "user";
  copy.id = uid();
  copy.name = `${ar.name} (Copy)`;
  routines.push(copy);
  saveRoutines();
  setActiveRoutine(copy.id);
  renderRoutineDropdown();
  renderPPL();
  renderLiftRoutineDropdown();
});

delRoutineBtn?.addEventListener("click", ()=>{
  if(routines.length <= 1){
    alert("You must keep at least one routine.");
    return;
  }
  const ar = getActiveRoutine();
  const ok = confirm(`Delete routine "${ar.name}"? (Logs will NOT be deleted.)`);
  if(!ok) return;
  routines = routines.filter(r=>r.id!==ar.id);
  saveRoutines();
  setActiveRoutine(routines[0].id);
  renderRoutineDropdown();
  renderPPL();
  renderLiftRoutineDropdown();
});

editRoutineBtn?.addEventListener("click", ()=>{
  openRoutineEditor(getActiveRoutine().id);
});

function getTodaySplitIndex(){
  const dow = new Date().getDay(); // Sun=0..Sat=6
  if(dow === 0) return 6;
  return dow - 1;
}

/* ---------------------------
   PPL display
---------------------------- */
const pplTabs = document.getElementById("pplTabs");
const pplList = document.getElementById("pplList");

  /* ---------------------------
   3D Carousel (Routine day picker)
---------------------------- */
const r3dStage = document.getElementById("r3dStage");
const r3dCarousel = document.getElementById("r3dCarousel");

let r3dAngle = 0;
let r3dVelocity = 0;
let r3dDrag = false;
let r3dLastX = 0;
let r3dLastT = 0;
let r3dMomentumRAF = 0;

const r3dRadius = 260;          // reduced depth (less distortion)
const r3dStep = 360 / 7;        // 7 days
const r3dTopPct = 22;           // matches your ‚Äúperfect‚Äù position
let r3dCards = [];

function r3dDayText(k){
  // k is "Mon"..."Sun" from DAY_KEYS
  return k.toUpperCase();
}
  // ‚úÖ ADD THIS RIGHT HERE
function escHTML(s){
  return String(s).replace(/[&<>"']/g, (c)=>(
    c === "&" ? "&amp;" :
    c === "<" ? "&lt;"  :
    c === ">" ? "&gt;"  :
    c === '"' ? "&quot;" : "&#39;"
  ));
}

function renderRoutineCarousel(){
  if(!r3dCarousel) return;

  const ar = getActiveRoutine();
  r3dCarousel.innerHTML = "";
  r3dCards = [];

  DAY_KEYS.forEach((k, idx)=>{
const day = (ar && ar.days && ar.days[k]) ? ar.days[k] : {};
const label = (day.label || "").trim();

const card = document.createElement("div");
card.className = "r3dCard";
card.dataset.idx = String(idx);

// ‚úÖ Your routine model uses `day.exercises` (not `items`)
const exercises = Array.isArray(day.exercises) ? day.exercises : [];
const exCount = exercises.length;

// ‚úÖ Only a rest day if the routine marks it as rest
const isRest = !!day.rest;


    
card.innerHTML = `
  <div class="r3dCardInner">
    <div class="r3dTop">
      <div>
        <div class="r3dDay">${r3dDayText(k)}</div>
        <div class="r3dLabel">${escHTML(label ? label : "‚Äî")}</div>
        <div class="r3dMeta">${exCount} ${exCount === 1 ? "exercise" : "exercises"}</div>
      </div>

      <div class="r3dBadges">
        <span class="r3dBadge ${isRest ? "rest" : ""}">
          ${isRest ? "Rest Day" : "Training Day"}
        </span>
        ${idx === activeDayIndex ? `<span class="r3dBadge">Active</span>` : ``}
      </div>
    </div>
  </div>
`;


    // tap to select
    card.addEventListener("click", ()=>{
      activeDayIndex = idx;
      snapCarouselToActive();
      renderPPL();
    });

    r3dCarousel.appendChild(card);
    r3dCards.push(card);
  });

  // start angle so active is centered
  snapCarouselToActive(true);
  updateCarouselTransforms();
}

function updateCarouselTransforms(){
  const base = r3dAngle;

  r3dCards.forEach((card, i)=>{
    const a = (i * r3dStep) + base;
    card.style.transform = `
      rotateY(${a}deg)
      translateZ(${r3dRadius}px)
      rotateY(${-a}deg)
    `;

    // make active card pop slightly
    const isActive = (i === activeDayIndex);
card.classList.toggle("isActive", isActive);
  });
}

function snapCarouselToActive(instant=false){
  const target = -(activeDayIndex * r3dStep);

  if(instant){
    r3dAngle = target;
    r3dVelocity = 0;
    return;
  }

  // softer + longer (glide feel)
  const start = r3dAngle;
  const delta = target - start;
  const t0 = performance.now();
  const dur = 420;

  function easeOutCubic(p){
    return 1 - Math.pow(1 - p, 3);
  }

  function tick(t){
    const p = Math.min(1, (t - t0) / dur);
    r3dAngle = start + delta * easeOutCubic(p);
    updateCarouselTransforms();
    if(p < 1) requestAnimationFrame(tick);
  }

  requestAnimationFrame(tick);
}



function bindCarouselGestures(){
  if(!r3dStage) return;

const onDown = (clientX)=>{
    // ‚úÖ BUG FIX: stop any existing momentum loop so it can't snap later mid-drag
    if(r3dMomentumRAF){
      cancelAnimationFrame(r3dMomentumRAF);
      r3dMomentumRAF = 0;
    }

    r3dDrag = true;
    r3dLastX = clientX;
    r3dLastT = performance.now();
    r3dVelocity = 0;
  };

  const onMove = (clientX)=>{
    if(!r3dDrag) return;
    const now = performance.now();
    const dx = clientX - r3dLastX;
    r3dLastX = clientX;

// smoother drag (less sensitive)
r3dAngle += dx * 0.30;

const dt = Math.max(16, now - r3dLastT);
r3dLastT = now;

// compute raw velocity, then smooth it (glide)
const v = (dx / dt) * 32;
r3dVelocity = (r3dVelocity * 0.55) + (v * 0.45);

updateCarouselTransforms();

  };
const onUp = ()=>{
  if(!r3dDrag) return;
  r3dDrag = false;

  const start = performance.now();
  const friction = 0.965;

  function momentum(t){
    r3dVelocity *= friction;
    r3dAngle += r3dVelocity * 0.34;
    updateCarouselTransforms();

    if (Math.abs(r3dVelocity) > 0.015 && (t - start) < 1200) {
      r3dMomentumRAF = requestAnimationFrame(momentum);
    } else {
      const nearest = Math.round((-r3dAngle) / r3dStep);
      activeDayIndex = (nearest % 7 + 7) % 7;
      snapCarouselToActive();
      renderPPL();
    }
  }

  r3dMomentumRAF = requestAnimationFrame(momentum);
};


  // pointer (desktop)
  r3dStage.addEventListener("pointerdown", (e)=> onDown(e.clientX));
  window.addEventListener("pointermove", (e)=> onMove(e.clientX));
  window.addEventListener("pointerup", onUp);

  // ‚úÖ BUG FIX: if the OS/browser cancels the pointer, we must end the gesture
  window.addEventListener("pointercancel", onUp);

  // touch (mobile)
  r3dStage.addEventListener("touchstart", (e)=> onDown(e.touches[0].clientX), {passive:true});
  r3dStage.addEventListener("touchmove", (e)=> onMove(e.touches[0].clientX), {passive:true});
  r3dStage.addEventListener("touchend", onUp);

  // ‚úÖ BUG FIX: touch can also be cancelled (app switch, notif shade, gesture nav, etc.)
  r3dStage.addEventListener("touchcancel", onUp);

  // ‚úÖ BUG FIX: if tab loses focus mid-drag, end gesture so it doesn't get stuck
  window.addEventListener("blur", onUp);
  document.addEventListener("visibilitychange", ()=> {
    if(document.visibilityState !== "visible") onUp();
  });
}

// call once
bindCarouselGestures();

function renderDayTabs(){
  if(!pplTabs) return;

  pplTabs.innerHTML = "";
  const ar = getActiveRoutine();

  DAY_KEYS.forEach((k, idx)=>{
    const day = (ar && ar.days && ar.days[k]) ? ar.days[k] : {};
    const isRest = !!day.rest;

    const b = document.createElement("div");
    b.className = "dayChip" + (idx===activeDayIndex ? " active" : "") + (isRest ? " rest" : "");
    b.title = isRest ? "Rest Day" : "Training Day";
    b.innerHTML = `
      <div>${k.toUpperCase()}</div>
      <span class="miniDot"></span>
    `;

    b.addEventListener("click", ()=>{
      activeDayIndex = idx;
      snapCarouselToActive();   // keeps carousel aligned with the tap
      renderPPL();              // refresh list + carousel + day row
    });

    pplTabs.appendChild(b);
  });
}


function renderPPL(){
renderRoutineCarousel();
renderDayTabs(); // ‚úÖ ADD THIS LINE

  const ar = getActiveRoutine();
  const dayKey = DAY_KEYS[activeDayIndex];
  const day = (ar && ar.days && ar.days[dayKey]) ? ar.days[dayKey] : {};


  pplList.innerHTML = "";

  if(day.rest){
    const restCard = document.createElement("div");
    restCard.className = "notice";
    restCard.innerHTML = `
            <div><strong>${escHTML(dayKey)}</strong> is marked as a Rest Day.</div>
      <div class="small muted">Exercises are stored but hidden. Toggle rest off in the Routine Editor.</div>
    `;
    pplList.appendChild(restCard);
    renderLiftSearchDropdown();
    return;
  }

  const list = Array.isArray(day.exercises) ? day.exercises : [];

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "notice";
    empty.textContent = "No exercises yet for this day. Click Edit to add exercises.";
    pplList.appendChild(empty);
    renderLiftSearchDropdown();
    return;
  }

  list.forEach(item=>{
    const ex = item.name;
    const {life, thisWeekMax, lastWeekMax} = liftStatsForExercise(ex);

    const isPRThisWeek = (life !== null && thisWeekMax !== null && thisWeekMax === life);
    const prBadge = isPRThisWeek ? `<span class="badge">üèÜ PR (this week)</span>` : ``;

    const card = document.createElement("div");
    card.className = "exerciseItem";
    card.innerHTML = `
      <div class="left">
        <div class="title">${escHTML(ex)}</div>
        <div class="meta">
          <span>${item.sets || "‚Äî"} sets</span>
          <span>‚Ä¢</span>
          <span>${item.reps || "‚Äî"} reps</span>
          ${item.notes ? `<span class="badge">${item.notes}</span>` : ""}
        </div>
      </div>
      <div class="right">
        <div class="line2">This week: <span class="mono">${thisWeekMax===null?"‚Äî":thisWeekMax}</span> lbs</div>
        <div class="line2">Last week: <span class="mono">${lastWeekMax===null?"‚Äî":lastWeekMax}</span> lbs</div>
        <div class="line2">Lifetime max: <span class="mono">${life===null?"‚Äî":life}</span> lbs</div>
        <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap;">
          ${prBadge}
          <button type="button" data-log="${ex}">Log Sets</button>
        </div>
      </div>
    `;

    const logBtn = card.querySelector('button[data-log]');
    if(logBtn){
      logBtn.addEventListener("click", ()=>{
        openLogModal(ex, Number(item.sets)||3, ar, dayKey, activeDayIndex);
      });
    }

    pplList.appendChild(card);
  });

  renderLiftSearchDropdown();
}

document.getElementById("startTodayBtn")?.addEventListener("click", ()=>{
  showScreen("routine");
  activeDayIndex = getTodaySplitIndex();
  renderPPL();
  document.getElementById("pplList").scrollIntoView({behavior:"smooth", block:"start"});
});


/* ---------------------------
   Lift Progress Log (Phase 4)
---------------------------- */
const liftTable = document.getElementById("liftTable");
const liftSearch = document.getElementById("liftSearch");
const liftRoutine = document.getElementById("liftRoutine");
const liftFrom = document.getElementById("liftFrom");
const liftTo = document.getElementById("liftTo");
const liftMetric = document.getElementById("liftMetric");
const liftLimit = document.getElementById("liftLimit");

const liftSearchBtn = document.getElementById("liftSearchBtn");
const liftClearBtn = document.getElementById("liftClearBtn");

const liftViewTableBtn = document.getElementById("liftViewTableBtn");
const liftViewGraphBtn = document.getElementById("liftViewGraphBtn");
const liftDownloadBtn = document.getElementById("liftDownloadBtn");

const liftTableWrap = document.getElementById("liftTableWrap");
const liftGraphWrap = document.getElementById("liftGraphWrap");

let liftView = "table"; // "table" | "graph"
let appliedLiftFilters = {
  ex: "",
  routineId: "",
  from: "",
  to: "",
  metric: "top",
  limit: 25
};

function collectAllExerciseNames(){
  const set = new Set();

  // 1Ô∏è‚É£ Canonical library first
  EXERCISE_LIBRARY.forEach(n => set.add(canonicalExerciseName(n)));

  // 1.5Ô∏è‚É£ Custom exercises created by you
loadCustomExercises().forEach(o => set.add(canonicalExerciseName(o.name)));

  // 2Ô∏è‚É£ Routine exercises
  routines.forEach(r=>{
    DAY_KEYS.forEach(k=>{
      (r.days?.[k]?.exercises || []).forEach(e=>{
    if(e?.name) set.add(canonicalExerciseName(e.name));
      });
    });
  });

  // 3Ô∏è‚É£ Logged lifts
  lifts.forEach(x=>{
    if(x.ex) set.add(canonicalExerciseName(x.ex));
  });

  return [...set].sort((a,b)=>a.localeCompare(b));
}

function renderLiftSearchDropdown(){
  const prev = liftSearch.value || "";
  const items = ["", ...collectAllExerciseNames()];
  liftSearch.innerHTML = "";
  items.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v === "" ? "All exercises" : v;
    liftSearch.appendChild(opt);
  });
  liftSearch.value = items.includes(prev) ? prev : "";
}
/* ---------------------------
   Exercise Picker (Add + Swap)
---------------------------- */
const exPickModal = document.getElementById("exPickModal");
const exPickTitle = document.getElementById("exPickTitle");
const exPickCloseBtn = document.getElementById("exPickCloseBtn");
const exPickCancelBtn = document.getElementById("exPickCancelBtn");
const exPickConfirmBtn = document.getElementById("exPickConfirmBtn");
const exPickSearch = document.getElementById("exPickSearch");
const exPickList = document.getElementById("exPickList");

let exPickSelected = "";                 // single mode selected
let exPickSelectedSet = new Set();       // multi mode selected set
let exPickMulti = false;                 // are we in multi mode?
let exPickOnConfirm = null;

function openExercisePicker({ title="Pick Exercise", initial="", onConfirm, multi=false, initialMulti=[] }){
  exPickTitle.textContent = title;

  exPickMulti = !!multi;
  exPickOnConfirm = onConfirm;

  // reset selections
  exPickSelected = initial || "";
  exPickSelectedSet = new Set(Array.isArray(initialMulti) ? initialMulti : []);

  exPickSearch.value = "";
  renderExercisePickerList();
  lockBodyScroll();                 // ‚úÖ ADD
  exPickModal.style.display = "block";
}


function closeExercisePicker(){
  exPickModal.style.display = "none";
  unlockBodyScroll(); // ‚úÖ ADD THIS
  exPickSelected = "";
  exPickSelectedSet = new Set();
  exPickMulti = false;
  exPickOnConfirm = null;
}


function renderExercisePickerList(){
  const rawQ = String(exPickSearch.value || "").trim();
  const q = normExName(rawQ);

  const all = collectAllExerciseNames();
  const filtered = q ? all.filter(n => normExName(n).includes(q)) : all;

  exPickList.innerHTML = "";

  // ‚úÖ "Create new" option when typing
  if(rawQ){
    const exists = all.some(n => normExName(n) === normExName(rawQ));
    if(!exists){
      const create = document.createElement("div");
      create.className = "exPickItem";
      create.innerHTML = ""; // never inject rawQ into innerHTML

      const row = document.createElement("div");
      row.className = "exPickRow";

      if(exPickMulti){
        const chk = document.createElement("span");
        chk.className = "exPickCheck";
        chk.textContent = "+";
        row.appendChild(chk);
      }

      const label = document.createElement("span");
      label.textContent = `‚ûï Create "${rawQ}"`;
      row.appendChild(label);

      create.appendChild(row);

      // ‚úÖ NEW: type toggle + (core) mode toggle + explicit Create button
      const metaRow = document.createElement("div");
      metaRow.style.display = "flex";
      metaRow.style.flexWrap = "wrap";
      metaRow.style.gap = "8px";
      metaRow.style.marginTop = "10px";
      metaRow.style.alignItems = "center";

      const typeWrap = document.createElement("label");
      typeWrap.style.display = "flex";
      typeWrap.style.alignItems = "center";
      typeWrap.style.gap = "8px";
      typeWrap.textContent = "Type";

      const typeSel = document.createElement("select");
      typeSel.innerHTML = `
        <option value="strength">Strength</option>
        <option value="cardio">Cardio</option>
        <option value="core">Core</option>
      `;
      typeWrap.appendChild(typeSel);

      const coreModeWrap = document.createElement("label");
      coreModeWrap.style.display = "none"; // only when type === core
      coreModeWrap.style.alignItems = "center";
      coreModeWrap.style.gap = "8px";
      coreModeWrap.textContent = "Core Mode";

      const coreModeSel = document.createElement("select");
      coreModeSel.innerHTML = `
        <option value="reps">Reps</option>
        <option value="time">Time</option>
      `;
      coreModeWrap.appendChild(coreModeSel);

      const createBtn = document.createElement("button");
      createBtn.className = "tap";
      createBtn.type = "button";
      createBtn.textContent = "Create";

      typeSel.addEventListener("change", ()=>{
        const t = String(typeSel.value || "strength").toLowerCase();
        coreModeWrap.style.display = (t === "core") ? "flex" : "none";
      });

      // Prevent clicking dropdowns from selecting the row
      [typeSel, coreModeSel].forEach(el=>{
        el.addEventListener("click", (e)=> e.stopPropagation());
      });

      createBtn.addEventListener("click", (e)=>{
        e.preventDefault();
        e.stopPropagation();

        const t = String(typeSel.value || "strength").toLowerCase();
        const cm = (t === "core")
          ? String(coreModeSel.value || "reps").toLowerCase()
          : null;

        const created = addCustomExercise(rawQ, t, cm);
        if(!created) return;

        if(exPickMulti){
          exPickSelectedSet.add(created);
          renderExercisePickerList();
          return;
        }

        exPickSelected = created;

        if(typeof exPickOnConfirm === "function"){
          exPickOnConfirm(exPickSelected);
        }

        closeExercisePicker();
      });

      metaRow.appendChild(typeWrap);
      metaRow.appendChild(coreModeWrap);
      metaRow.appendChild(createBtn);

      create.appendChild(metaRow);

      exPickList.appendChild(create);
    }
  }



exPickSearch.addEventListener("input", renderExercisePickerList);

exPickConfirmBtn.addEventListener("click", ()=>{
  if(exPickMulti){
    const picked = [...exPickSelectedSet];

    if(picked.length === 0){
      alert("Select at least one exercise.");
      return;
    }

    if(typeof exPickOnConfirm === "function"){
      exPickOnConfirm(picked);
    }

    closeExercisePicker();
    return;
  }

// single mode
if(!exPickSelected){
  alert("Pick an exercise first.");
  return;
}

if(typeof exPickOnConfirm === "function"){
  exPickOnConfirm(exPickSelected);
}
closeExercisePicker();

});

  /* ---------------------------
   Batch Add Modal (Multi-add sets/reps)
---------------------------- */
const batchAddModal = document.getElementById("batchAddModal");
const batchAddCloseBtn = document.getElementById("batchAddCloseBtn");
const batchAddCancelBtn = document.getElementById("batchAddCancelBtn");
const batchAddConfirmBtn = document.getElementById("batchAddConfirmBtn");
const batchAddList = document.getElementById("batchAddList");

let batchAddItems = []; // [{name, sets, reps}]

function openBatchAddModal(names){
  // ‚úÖ normalize: accept array OR single string
  const arr = Array.isArray(names)
    ? names
    : (typeof names === "string" && names.trim() ? [names.trim()] : []);

  batchAddItems = arr.map(n=>({
    name: canonicalExerciseName(n),
    sets: "",
    reps: ""
  }));

  renderBatchAddList();
  lockBodyScroll();                 // ‚úÖ ADD
  batchAddModal.style.display = "block";
}


function closeBatchAddModal(){
  batchAddModal.style.display = "none";
  unlockBodyScroll();               // ‚úÖ ADD
  batchAddItems = [];
}

function renderBatchAddList(){
  batchAddList.innerHTML = "";

  batchAddItems.forEach((it, idx)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.background = "#0f0f10";
    card.style.padding = "10px";

    card.innerHTML = `
      <div class="row" style="align-items:end;">
        <div style="flex:2 1 220px;">
          <div class="small muted">Exercise</div>
              <div style="font-weight:700; margin-top:4px;">${escHTML(it.name)}</div>
        </div>

        <label style="flex:0 0 120px;">Sets
          <input type="number" min="1" value="${it.sets}" data-bsets="${idx}" placeholder="3" />
        </label>

        <label style="flex:1 1 160px;">Reps
          <input value="${it.reps}" data-breps="${idx}" placeholder="8‚Äì10" />
        </label>

        <button type="button" class="miniBtn danger" data-bremove="${idx}">Remove</button>
      </div>
    `;

    batchAddList.appendChild(card);
  });

  // wire inputs
  batchAddList.querySelectorAll("[data-bsets]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const i = Number(inp.getAttribute("data-bsets"));
      batchAddItems[i].sets = inp.value;
    });
  });

  batchAddList.querySelectorAll("[data-breps]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const i = Number(inp.getAttribute("data-breps"));
      batchAddItems[i].reps = inp.value;
    });
  });

  batchAddList.querySelectorAll("[data-bremove]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.getAttribute("data-bremove"));
      batchAddItems.splice(i,1);
      renderBatchAddList();
    });
  });
  // auto-focus first sets input
setTimeout(()=>{
  batchAddList.querySelector("input[data-bsets]")?.focus();
}, 0);
}

[batchAddCloseBtn, batchAddCancelBtn].forEach(btn=>{
  btn?.addEventListener("click", closeBatchAddModal);
});
batchAddModal?.addEventListener("click", (e)=>{ if(e.target === batchAddModal) closeBatchAddModal(); });

batchAddConfirmBtn?.addEventListener("click", ()=>{
  // validate
  for(const it of batchAddItems){
    const sets = Number(it.sets);
    const reps = String(it.reps || "").trim();
    if(!sets || sets <= 0){
      alert(`Enter sets for: ${it.name}`);
      return;
    }
    if(!reps){
      alert(`Enter reps for: ${it.name}`);
      return;
    }
  }

  // add to current draft day
  const k = DAY_KEYS[editDayIndex];
  const day = draftRoutine.days[k];

  batchAddItems.forEach(it=>{
    day.exercises.push({
      name: canonicalExerciseName(it.name),
      sets: Number(it.sets),
      reps: String(it.reps).trim(),
      notes: ""
    });
  });

  closeBatchAddModal();
  renderRtDayPanel();
  buildRoutineExerciseSuggestions();
  renderLiftSearchDropdown();
});


[exPickCloseBtn, exPickCancelBtn].forEach(btn=>btn.addEventListener("click", closeExercisePicker));
exPickModal.addEventListener("click", (e)=>{ if(e.target === exPickModal) closeExercisePicker(); });

function renderLiftRoutineDropdown(){
  const prev = liftRoutine.value || "";
  liftRoutine.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "All routines";
  liftRoutine.appendChild(optAll);

  routines.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = r.name;
    liftRoutine.appendChild(opt);
  });

  liftRoutine.value = (prev && routines.some(r=>r.id===prev)) ? prev : "";
}

function applyLiftFiltersFromUI(){
  appliedLiftFilters = {
    ex: (liftSearch.value || "").trim(),
    routineId: (liftRoutine.value || "").trim(),
    from: (liftFrom.value || "").trim(),
    to: (liftTo.value || "").trim(),
    metric: (liftMetric.value || "top"),
    limit: Number(liftLimit.value || 25)
  };
}

function clearLiftFiltersUI(){
  liftSearch.value = "";
  liftRoutine.value = "";
  liftFrom.value = "";
  liftTo.value = "";
  liftMetric.value = "top";
  liftLimit.value = "25";
}

function getLiftFilteredData(){
  let arr = [...lifts];

  // exercise filter (normalized)
  if(appliedLiftFilters.ex){
    const n = normExName(appliedLiftFilters.ex);
    arr = arr.filter(x => (x.exNorm || normExName(x.ex)) === n);
  }

  // routine filter
  if(appliedLiftFilters.routineId){
    arr = arr.filter(x => String(x.routineId || "") === appliedLiftFilters.routineId);
  }

  // date range filter
  if(appliedLiftFilters.from){
    const f = parseISO(appliedLiftFilters.from);
    arr = arr.filter(x => parseISO(x.date) >= f);
  }
  if(appliedLiftFilters.to){
    const t = parseISO(appliedLiftFilters.to);
    arr = arr.filter(x => parseISO(x.date) <= t);
  }

  // sort newest for table, oldest for graph later
  arr.sort((a,b)=>b.date.localeCompare(a.date));

  // limit (table)
  if(liftView === "table"){
    const lim = Number(appliedLiftFilters.limit || 25);
    if(lim > 0) arr = arr.slice(0, lim);
  }

  return arr;
}

function renderLiftsTable(){
  liftTable.innerHTML = "";
  const visible = getLiftFilteredData();

  visible.forEach(x=>{
    const topSet = (x.weight && x.reps) ? `${x.weight} x ${x.reps}` : "‚Äî";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${x.date}</td>
            <td><span class="clickEx" data-hist="${escHTML(x.ex)}">${escHTML(x.ex)}</span></td>
      <td class="mono">${topSet}</td>
      <td class="mono">${x.sets ?? "‚Äî"}</td>
      <td>${x.pr ? '<span class="badge">üèÜ</span>' : ''}</td>
      <td><button data-dellift="${x.id}">Delete</button></td>
    `;
    liftTable.appendChild(tr);
  });

  liftTable.querySelectorAll("button[data-dellift]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-dellift");
      lifts = lifts.filter(x=>x.id!==id);
      LS.set(KEY_LIFTS, lifts);
      renderLiftSearchDropdown();
      renderLifts();   // rerun with applied filters
      renderPPL();
      buildRoutineExerciseSuggestions();
    });
  });

  liftTable.querySelectorAll("[data-hist]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const ex = el.getAttribute("data-hist");
      openHistoryModal(ex);
    });
  });
}

/* ---- Graph helpers ---- */
function estEpley1RM(weight, reps){
  const w = Number(weight)||0;
  const r = Number(reps)||0;
  if(!w || !r) return 0;
  return w * (1 + (r/30));
}
function calcVolume(lift){
  // Prefer details if present
  if(Array.isArray(lift.details) && lift.details.length){
    return lift.details.reduce((sum,s)=>sum + (Number(s.weight)||0)*(Number(s.reps)||0), 0);
  }
  const w = Number(lift.weight)||0;
  const r = Number(lift.reps)||0;
  const sets = Number(lift.sets)||1;
  return w * r * sets;
}
function weekKey(d){
  const ws = weekStartDate(d);
  return `${ws.getFullYear()}-${pad2(ws.getMonth()+1)}-${pad2(ws.getDate())}`;
}

let liftChart; // chart.js instance

const weekSeparatorsPlugin = {
  id: "weekSeparators",
  beforeDraw(chart, args, pluginOptions){
    const cfg = chart?.config?.options?.plugins?.weekSeparators;
    if(!cfg || cfg.enabled !== true) return;

    const {ctx, chartArea} = chart;
    const xScale = chart.scales?.x;
    if(!ctx || !chartArea || !xScale) return;

    const labels = chart.data.labels || [];
    if(labels.length < 2) return;

    // find week boundaries by comparing week keys across consecutive points
    const boundaries = [];
    let prevKey = null;
    for(let i=0;i<labels.length;i++){
      const d = parseISO(labels[i]);
      const key = weekKey(d);
      if(prevKey !== null && key !== prevKey){
        boundaries.push(i);
      }
      prevKey = key;
    }

    ctx.save();
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(154,160,166,0.22)";

    boundaries.forEach(i=>{
      const x = xScale.getPixelForValue(labels[i]);
      ctx.beginPath();
      ctx.moveTo(x, chartArea.top);
      ctx.lineTo(x, chartArea.bottom);
      ctx.stroke();
    });

    ctx.restore();
  }
};

function renderLiftsGraph(){
  const visible = getLiftFilteredData()
    .slice() // copy
    .sort((a,b)=>a.date.localeCompare(b.date)); // oldest -> newest

  const labels = visible.map(x=>x.date);

  const metric = appliedLiftFilters.metric || "top";
  const data = visible.map(x=>{
    if(metric === "e1rm") return estEpley1RM(x.weight, x.reps);
    if(metric === "vol") return calcVolume(x);
    return Number(x.weight)||0; // top
  });

  const yLabel =
    metric === "e1rm" ? "Est. 1RM (lbs)" :
    metric === "vol" ? "Volume" :
    "Top Weight (lbs)";

  const ctx = document.getElementById("liftChart");
  if(liftChart) liftChart.destroy();

  liftChart = new Chart(ctx, {
    type:"line",
    data:{
      labels,
      datasets:[{
        label: yLabel,
        data,
        tension:.25,
        pointRadius:3,
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{mode:"index", intersect:false},
        weekSeparators:{enabled:true}
      },
      scales:{
        x:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}},
        y:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}}
      }
    },
    plugins:[weekSeparatorsPlugin]
  });

  // If no data, show a friendly message
  if(labels.length === 0){
    // chart will just be empty; that's fine
  }
}

function setLiftView(next){
  liftView = next;

  if(liftView === "table"){
    liftTableWrap.style.display = "";
    liftGraphWrap.style.display = "none";
    liftViewTableBtn.classList.remove("ghost");
    liftViewGraphBtn.classList.add("ghost");
    liftDownloadBtn.classList.add("ghost");
    renderLiftsTable();
  } else {
    liftTableWrap.style.display = "none";
    liftGraphWrap.style.display = "";
    liftViewTableBtn.classList.add("ghost");
    liftViewGraphBtn.classList.remove("ghost");
    liftDownloadBtn.classList.remove("ghost");
    renderLiftsGraph();
  }
}

function renderLifts(){
  // uses appliedLiftFilters + current liftView
  if(liftView === "table") renderLiftsTable();
  else renderLiftsGraph();
}

liftViewTableBtn.addEventListener("click", ()=> setLiftView("table"));
liftViewGraphBtn.addEventListener("click", ()=> setLiftView("graph"));

liftSearchBtn.addEventListener("click", ()=>{
  applyLiftFiltersFromUI();
  renderLifts();
});

liftClearBtn.addEventListener("click", ()=>{
  clearLiftFiltersUI();
  applyLiftFiltersFromUI();
  setLiftView("table");
  renderLifts();
});

liftDownloadBtn.addEventListener("click", ()=>{
  if(!liftChart){
    alert("Switch to Graph view first.");
    return;
  }
  const url = liftChart.toBase64Image("image/png", 1);
  const a = document.createElement("a");
  a.href = url;
  a.download = `lift-graph-${localISODate(new Date())}.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

/* ---------------------------
   Log Sets Modal
---------------------------- */
const logModal = document.getElementById("logModal");
const logModalClose = document.getElementById("logModalClose");
const logModalExercise = document.getElementById("logModalExercise");
const logRoutineLine = document.getElementById("logRoutineLine");
const logModalDate = document.getElementById("logModalDate");
const logModalSets = document.getElementById("logModalSets");
const logAddSetBtn = document.getElementById("logAddSetBtn");
const logSaveBtn = document.getElementById("logSaveBtn");

const logPrevBox = document.getElementById("logPrevBox");
const logPrevText = document.getElementById("logPrevText");
const logCopyLastBtn = document.getElementById("logCopyLastBtn");
const logViewHistoryBtn = document.getElementById("logViewHistoryBtn");

let modalExerciseName = null;
let modalLastLift = null;
let modalRoutine = null;
let modalDayKey = null;
let modalDayIndex = null;

function openLogModal(exName, defaultSets=3, routineObj=null, dayKey="", dayIndex=0){
  modalExerciseName = canonicalExerciseName(exName);
  logModalExercise.textContent = modalExerciseName;
  logRoutineLine.textContent = routineObj ? `${routineObj.name} ‚Ä¢ ${dayKey}` : "‚Äî";
  modalRoutine = routineObj;
  modalDayKey = dayKey;
  modalDayIndex = dayIndex;

  logModalDate.value = dateForWeekdayIndex(dayIndex, new Date()) || todayISO();

  modalLastLift = getLastLiftForExercise(modalExerciseName);
  if(modalLastLift){
    logPrevBox.style.display = "block";
    logPrevText.textContent = formatSetsDetail(modalLastLift);
  } else {
    logPrevBox.style.display = "none";
    logPrevText.textContent = "‚Äî";
  }

  logModalSets.innerHTML = "";
  for(let i=0;i<defaultSets;i++) addSetRow();

  lockBodyScroll();
  logModal.style.display = "block";
}

  function closeLogModal(){
  logModal.style.display = "none";
  unlockBodyScroll();               // ‚úÖ ADD
  modalExerciseName = null;
  modalLastLift = null;
  modalRoutine = null;
  modalDayKey = null;
  modalDayIndex = null;
}

function renumberSetPills(){
  [...logModalSets.children].forEach((child, i)=>{
    const pillStrong = child.querySelector(".pill strong");
    if(pillStrong) pillStrong.textContent = String(i+1);
  });
}

function addSetRow(weight="", reps=""){
  const idx = logModalSets.children.length + 1;
  const row = document.createElement("div");
  row.className = "row";
  row.style.alignItems = "end";
  row.innerHTML = `
    <span class="pill"><span class="muted">Set</span> <strong class="mono">${idx}</strong></span>
    <label>Weight (lbs)
      <input type="number" step="0.5" inputmode="decimal" class="setWeight" placeholder="e.g., 75" value="${escHTML(weight)}" />
    </label>
    <label>Reps
      <input type="number" inputmode="numeric" class="setReps" placeholder="e.g., 8" value="${escHTML(reps)}" />
    </label>
    <button type="button" class="removeSetBtn">Remove</button>
  `;
  row.querySelector(".removeSetBtn").addEventListener("click", ()=>{
    row.remove();
    renumberSetPills();
  });
  logModalSets.appendChild(row);
}

logAddSetBtn.addEventListener("click", ()=> addSetRow());
logModalClose.addEventListener("click", closeLogModal);
logModal.addEventListener("click", (e)=>{ if(e.target === logModal) closeLogModal(); });

logCopyLastBtn.addEventListener("click", ()=>{
  if(!modalLastLift) return;
  logModalSets.innerHTML = "";

  if(Array.isArray(modalLastLift.details) && modalLastLift.details.length){
    modalLastLift.details.forEach(s=> addSetRow(String(s.weight ?? ""), String(s.reps ?? "")));
  } else {
    addSetRow(String(modalLastLift.weight ?? ""), String(modalLastLift.reps ?? ""));
  }
  renumberSetPills();
});

logViewHistoryBtn.addEventListener("click", ()=>{
  if(!modalExerciseName) return;
  openHistoryModal(modalExerciseName);
});

logSaveBtn.addEventListener("click", ()=>{
  if(!modalExerciseName) return;

  const date = logModalDate.value || todayISO();
  const setRows = [...logModalSets.querySelectorAll(".row")];

  const setsArr = [];
  for(const r of setRows){
    const w = Number(r.querySelector(".setWeight")?.value);
    const reps = Number(r.querySelector(".setReps")?.value);
    if(isFinite(w) && w > 0 && isFinite(reps) && reps > 0){
      setsArr.push({weight:w, reps:reps});
    }
  }

  if(setsArr.length === 0){
    alert("Enter at least one valid set (weight + reps).");
    return;
  }

  let top = setsArr[0];
  for(const s of setsArr){
    if(s.weight > top.weight) top = s;
  }

  const {life} = liftStatsForExercise(modalExerciseName);
  const isPR = (life === null) ? true : (top.weight > life);

  lifts.push({
    id: uid(),
    date,
    ex: modalExerciseName,
    exNorm: normExName(modalExerciseName),
    sets: setsArr.length,
    reps: top.reps,
    weight: top.weight,
    pr: isPR,
    details: setsArr,
    routineId: modalRoutine?.id || "",
    routineName: modalRoutine?.name || "",
    dayKey: modalDayKey || ""
  });

  lifts.sort((a,b)=>b.date.localeCompare(a.date));
  LS.set(KEY_LIFTS, lifts);

  const prevScroll = window.scrollY;
  closeLogModal();

  renderLiftSearchDropdown();
  renderLifts();      // Phase 4 respects applied filters
  renderPPL();
  window.scrollTo(0, prevScroll);
  buildRoutineExerciseSuggestions();

// ‚úÖ Stay on Routine screen after saving
// showScreen("lifts");
// setTimeout(()=>{
//   document.getElementById("liftTableWrap")?.scrollIntoView({behavior:"smooth", block:"start"});
// }, 0);
}); // ‚úÖ closes logSaveBtn click handler

/* ---------------------------
   History Modal
---------------------------- */
const histModal = document.getElementById("histModal");
const histCloseBtn = document.getElementById("histCloseBtn");
const histExercise = document.getElementById("histExercise");
const histTable = document.getElementById("histTable");

function closeHistoryModal(){
  histModal.style.display = "none";
  unlockBodyScroll();               // ‚úÖ ADD
}
histCloseBtn.addEventListener("click", closeHistoryModal);
histModal.addEventListener("click", (e)=>{ if(e.target === histModal) closeHistoryModal(); });

function openHistoryModal(exName){
  const exCanonical = canonicalExerciseName(exName);
  const n = normExName(exCanonical);

  histExercise.textContent = exCanonical;

  const exLifts = lifts
    .filter(x=> (x.exNorm || normExName(x.ex)) === n)
    .sort((a,b)=>b.date.localeCompare(a.date))
    .slice(0, 12);

  histTable.innerHTML = "";

  exLifts.forEach(x=>{
    const topSet = (x.weight && x.reps) ? `${x.weight} x ${x.reps}` : "‚Äî";
    const allSets = Array.isArray(x.details) && x.details.length
      ? x.details.map((s,i)=>`S${i+1}:${s.weight}x${s.reps}`).join("  ")
      : "‚Äî";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${x.date}</td>
      <td class="mono">${topSet}</td>
      <td class="mono">${allSets}</td>
      <td>${x.pr ? '<span class="badge">üèÜ</span>' : ''}</td>
    `;
    histTable.appendChild(tr);
  });

  lockBodyScroll();                 // ‚úÖ required
  histModal.style.display = "block";
}

/* ---------------------------
   Routine Editor (unchanged)
---------------------------- */
const rtModal = document.getElementById("rtModal");
const rtCloseBtn = document.getElementById("rtCloseBtn");
const rtCancelBtn = document.getElementById("rtCancelBtn");
const rtSaveBtn = document.getElementById("rtSaveBtn");

const rtName = document.getElementById("rtName");
const rtDayTabs = document.getElementById("rtDayTabs");
const rtDayLabel = document.getElementById("rtDayLabel");
const rtRestToggle = document.getElementById("rtRestToggle");
const rtDayRestNotice = document.getElementById("rtDayRestNotice");

const rtAddExName = document.getElementById("rtAddExName");
const rtAddExSets = document.getElementById("rtAddExSets");
const rtAddExReps = document.getElementById("rtAddExReps");
const rtAddExBtn = document.getElementById("rtAddExBtn");
const rtExList = document.getElementById("rtExList");
const rtAddMultiBtn = document.getElementById("rtAddMultiBtn");
const rtExSuggestions = document.getElementById("rtExSuggestions");

  function openAddExercisePicker(){
  // ‚úÖ remember where the Routine Editor modal is scrolled
  const modalCard = document.querySelector("#rtModal > div");
  const prevScroll = modalCard ? modalCard.scrollTop : 0;

  // ‚úÖ kill focus so iOS doesn‚Äôt scroll the page
  rtAddExName.blur();

  // ‚úÖ open picker
  openExercisePicker({
    title: "Pick exercise to add",
    initial: rtAddExName.value,
    onConfirm: (picked)=>{
      rtAddExName.value = picked;

      // ‚úÖ restore modal scroll after pick
      setTimeout(()=>{
        if(modalCard) modalCard.scrollTop = prevScroll;
      }, 0);
    }
  });

  // ‚úÖ restore immediately too (covers iOS ‚Äújump‚Äù before picker paints)
  setTimeout(()=>{
    if(modalCard) modalCard.scrollTop = prevScroll;
  }, 0);
}

// open picker on tap/click
rtAddExName.addEventListener("click", (e)=>{
  e.preventDefault();
  openAddExercisePicker();
});

// safety: if iOS still triggers focus somehow
rtAddExName.addEventListener("focus", (e)=>{
  e.preventDefault();
  openAddExercisePicker();
});

  
let editRoutineId = null;
let editDayIndex = 0;
let draftRoutine = null;

function buildRoutineExerciseSuggestions(){
  const list = collectAllExerciseNames();
  rtExSuggestions.innerHTML = "";
  list.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n;
    rtExSuggestions.appendChild(opt);
  });
}

function openRoutineEditor(routineId){
  const r = routines.find(x=>x.id===routineId);
  if(!r) return;

  setActiveRoutine(routineId);

  editRoutineId = routineId;
  editDayIndex = activeDayIndex;
  draftRoutine = JSON.parse(JSON.stringify(r));

  rtName.value = draftRoutine.name;

  buildRoutineExerciseSuggestions();
  renderRtDayTabs();
  renderRtDayPanel();

  lockBodyScroll();                 // ‚úÖ ADD
  rtModal.style.display = "block";
}

function closeRoutineEditor(){
  rtModal.style.display = "none";
  unlockBodyScroll();               // ‚úÖ ADD
  editRoutineId = null;
  editDayIndex = 0;
  draftRoutine = null;
}

rtCloseBtn.addEventListener("click", closeRoutineEditor);
rtCancelBtn.addEventListener("click", closeRoutineEditor);
rtModal.addEventListener("click", (e)=>{ if(e.target === rtModal) closeRoutineEditor(); });

function renderRtDayTabs(){
  rtDayTabs.innerHTML = "";
  DAY_KEYS.forEach((k, idx)=>{
    const day = draftRoutine.days[k];
    const label = (day.label||"").trim();
    const rest = !!day.rest;

    const b = document.createElement("div");
    b.className = "tab" + (idx===editDayIndex ? " active" : "");
    b.innerHTML = `
      <span>${k}</span>
      ${label ? `<span class="badge">${escHTML(label)}</span>` : ""}
      ${rest ? `<span class="badge">Rest</span>` : ""}
    `;
    b.addEventListener("click", ()=>{
      editDayIndex = idx;
      renderRtDayTabs();
      renderRtDayPanel();
    });
    rtDayTabs.appendChild(b);
  });
}

function renderRtDayPanel(){
  const k = DAY_KEYS[editDayIndex];
  const day = draftRoutine.days[k];

  rtDayLabel.value = day.label || "";
  rtRestToggle.value = day.rest ? "1" : "0";
  rtDayRestNotice.style.display = day.rest ? "block" : "none";

  rtExList.innerHTML = "";
  const list = day.exercises || [];

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "notice";
    empty.textContent = "No exercises for this day yet.";
    rtExList.appendChild(empty);
    return;
  }

  list.forEach((ex, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "rtExCard";

    wrap.innerHTML = `
      <div class="rtExTop">
        <div class="rtExName">${escHTML(ex.name || "Exercise")}</div>
        <span class="badge">${(ex.sets || "‚Äî")} sets ‚Ä¢ ${(ex.reps || "‚Äî")} reps</span>
      </div>

      <div class="row" style="margin-top:10px; align-items:end;">
        <label style="flex:2 1 240px;">Name
          <input data-field="name" value="${ex.name || ""}" />
        </label>

        <label style="flex:0 0 120px;">Sets
          <input data-field="sets" type="number" min="1" value="${ex.sets || ""}" />
        </label>

        <label style="flex:1 1 160px;">Reps
          <input data-field="reps" value="${ex.reps || ""}" />
        </label>
      </div>

      <div class="row" style="margin-top:8px;">
        <label style="flex:1 1 100%;">Notes
          <textarea data-field="notes" placeholder="optional">${ex.notes || ""}</textarea>
        </label>
      </div>

      <div class="rtActions">
        <button type="button" class="miniBtn" data-up="${idx}">‚Üë Up</button>
        <button type="button" class="miniBtn" data-down="${idx}">‚Üì Down</button>
        <button type="button" class="miniBtn" data-swap="${idx}">Swap</button>
        <button type="button" class="miniBtn danger" data-remove="${idx}">Remove</button>
      </div>
    `;

    // keep the rest of your event listeners EXACTLY as-is below

    wrap.querySelectorAll("[data-field]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const field = inp.getAttribute("data-field");
        if(field === "sets"){
          day.exercises[idx][field] = Number(inp.value)||0;
        }else{
          day.exercises[idx][field] = inp.value;
        }
      });
    });

    wrap.querySelector("[data-up]")?.addEventListener("click", ()=>{
      if(idx<=0) return;
      const tmp = day.exercises[idx-1];
      day.exercises[idx-1] = day.exercises[idx];
      day.exercises[idx] = tmp;
      renderRtDayPanel();
    });

    wrap.querySelector("[data-down]")?.addEventListener("click", ()=>{
      if(idx>=day.exercises.length-1) return;
      const tmp = day.exercises[idx+1];
      day.exercises[idx+1] = day.exercises[idx];
      day.exercises[idx] = tmp;
      renderRtDayPanel();
    });

    wrap.querySelector("[data-remove]")?.addEventListener("click", ()=>{
      day.exercises.splice(idx,1);
      renderRtDayPanel();
    });

    wrap.querySelector("[data-swap]")?.addEventListener("click", ()=>{
  const cur = day.exercises[idx]?.name || "";
  openExercisePicker({
    title: "Swap exercise",
    initial: cur,
    onConfirm: (picked)=>{
    day.exercises[idx].name = canonicalExerciseName(picked);
      renderRtDayPanel();
    }
  });
});

    rtExList.appendChild(wrap);
  });
}

rtDayLabel.addEventListener("input", ()=>{
  const k = DAY_KEYS[editDayIndex];
  draftRoutine.days[k].label = rtDayLabel.value;
  renderRtDayTabs();
});
rtRestToggle.addEventListener("change", ()=>{
  const k = DAY_KEYS[editDayIndex];
  draftRoutine.days[k].rest = (rtRestToggle.value === "1");
  if(draftRoutine.days[k].rest && !draftRoutine.days[k].label){
    draftRoutine.days[k].label = "Rest";
    rtDayLabel.value = "Rest";
  }
  rtDayRestNotice.style.display = draftRoutine.days[k].rest ? "block" : "none";
  renderRtDayTabs();

  // ‚úÖ ADD (live update if editing today's rest toggle)
  if(editDayIndex === getTodaySplitIndex()){
    renderHeaderPills();
    refreshHome();
  }
});

rtAddExBtn.addEventListener("click", ()=>{
  const k = DAY_KEYS[editDayIndex];
  const day = draftRoutine.days[k];

  const name = canonicalExerciseName(String(rtAddExName.value||"").trim());
  const sets = Number(rtAddExSets.value)||0;
  const reps = String(rtAddExReps.value||"").trim();

  if(!name) return alert("Enter an exercise name.");
  if(!sets || sets <= 0) return alert("Enter sets (number).");
  if(!reps) return alert("Enter reps (e.g., 8‚Äì10).");

  day.exercises.push({name, sets, reps, notes:""});
  rtAddExName.value = "";
  rtAddExSets.value = "";
  rtAddExReps.value = "";

  renderRtDayPanel();
  buildRoutineExerciseSuggestions();
  renderLiftSearchDropdown();
});

  rtAddMultiBtn?.addEventListener("click", ()=>{
  openExercisePicker({
    title: "Pick multiple exercises",
    multi: true,
    initialMulti: [],
    onConfirm: (pickedNames)=>{
      // pickedNames is an array when multi=true
      openBatchAddModal(pickedNames);
    }
  });
});


rtSaveBtn.addEventListener("click", ()=>{
  if(!draftRoutine) return;

  const name = String(rtName.value||"").trim();
  if(!name) return alert("Routine needs a name.");
  draftRoutine.name = name;

  const idx = routines.findIndex(r=>r.id===editRoutineId);
  if(idx < 0) return;

  routines[idx] = draftRoutine;
  saveRoutines();

  setActiveRoutine(draftRoutine.id);

  closeRoutineEditor();
renderRoutineDropdown();
renderPPL();
renderLiftRoutineDropdown();
buildRoutineExerciseSuggestions();

// ‚úÖ ADD: update header + home immediately (no manual refresh)
renderHeaderPills();
refreshHome();

// If onboarding is not done yet, finish it and send to Home
if(!isOnboardingDone()){
  setOnboardingDone();
  refreshHome();
  showScreen("home");
}
});

  function renderLastBackup(){
  const el = document.getElementById("lastBackupText");
  if(!el) return;

  const iso = localStorage.getItem(KEY_LAST_BACKUP);
  if(!iso){
    el.textContent = "‚Äî";
    return;
  }
  const d = new Date(iso);
  el.textContent = d.toLocaleString();
}

/* ---------------------------
   Export / Import / Reset
---------------------------- */
const importBtn = document.getElementById("settingsImportBtn");
const importFile = document.getElementById("settingsImportFile");
const backupNowBtn = document.getElementById("backupNowBtn");

function buildExportPayload(){
  return {
    v: 3,
    exportedAt: new Date().toISOString(),
    profile: LS.get(KEY_PROFILE, defaultProfile()),
    lastBackup: localStorage.getItem(KEY_LAST_BACKUP) || null,
    activeScreen: localStorage.getItem(KEY_ACTIVE_SCREEN) || "home",

    bwLogs: LS.get(KEY_BW, []),
    attendance: LS.get(KEY_ATT, []),
    proteinMap: LS.get(KEY_PRO, {}),
    lifts: LS.get(KEY_LIFTS, []),
    routines: LS.get(KEY_ROUTINES, []),
    activeRoutineId: LS.get(KEY_ACTIVE_ROUTINE, null)
  };
}
function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
backupNowBtn?.addEventListener("click", ()=>{
  const payload = buildExportPayload();
  const stamp = localISODate(new Date());
  downloadJSON(`gym-dashboard-${stamp}.json`, payload);

  // also save last backup time
  localStorage.setItem(KEY_LAST_BACKUP, new Date().toISOString());
  renderLastBackup();
});
importBtn?.addEventListener("click", ()=>{
  importFile.value = "";
  importFile.click();
});
importFile?.addEventListener("change", async ()=>{
  const file = importFile.files?.[0];
  if(!file) return;

  try{
    const text = await file.text();
    const data = JSON.parse(text);

    const bw = Array.isArray(data.bwLogs) ? data.bwLogs : null;
    const att = Array.isArray(data.attendance) ? data.attendance : null;
    const pro = (data.proteinMap && typeof data.proteinMap === "object") ? data.proteinMap : null;
    const lf = Array.isArray(data.lifts) ? data.lifts : null;
    const rts = Array.isArray(data.routines) ? data.routines : null;
    const arId = (typeof data.activeRoutineId === "string" || data.activeRoutineId === null) ? data.activeRoutineId : null;

    if(!bw || !att || !pro || !lf || !rts){
      alert("That file doesn‚Äôt look like a valid export from this dashboard.");
      return;
    }

    const ok = confirm("Import will overwrite your current saved data on this browser. Continue?");
    if(!ok) return;

    LS.set(KEY_BW, bw);
    LS.set(KEY_ATT, att);
    LS.set(KEY_PRO, pro);
    LS.set(KEY_LIFTS, lf);
    LS.set(KEY_ROUTINES, rts);
    LS.set(KEY_ACTIVE_ROUTINE, arId);

    bwLogs = LS.get(KEY_BW, []);
    attendance = new Set(LS.get(KEY_ATT, []));
    proteinMap = LS.get(KEY_PRO, {});
    lifts = LS.get(KEY_LIFTS, []);
    ensureLiftCompatibility();

    ({routines, activeId: activeRoutineId} = loadRoutines());

    // ‚úÖ init data + state first
renderCal();
loadProteinDay(todayISO());
renderLastBackup();

renderRoutineDropdown();
activeDayIndex = getTodaySplitIndex();
renderPPL();

renderLiftSearchDropdown();
renderLiftRoutineDropdown();
applyLiftFiltersFromUI();
setLiftView("table"); // sets UI state, table is fine hidden

buildRoutineExerciseSuggestions();

// ‚úÖ restore last visited screen (or home) LAST
hydrateOnboardingInputs();
    
  // 3) Normal app restore (validate)
  const last = localStorage.getItem(KEY_ACTIVE_SCREEN) || "home";
  const exists = !!document.getElementById(`screen-${last}`);
  showScreen(exists ? last : "home");


    alert("Imported ‚úÖ");
  }catch(e){
    alert("Import failed. Make sure you selected a valid JSON export file.");
  }
});

document.getElementById("settingsResetBtn")?.addEventListener("click", ()=>{
  const ok = confirm("Reset ALL saved gym data on this device/browser?");
  if(!ok) return;
  localStorage.removeItem(KEY_BW);
  localStorage.removeItem(KEY_ATT);
  localStorage.removeItem(KEY_PRO);
  localStorage.removeItem(KEY_LIFTS);
  localStorage.removeItem(KEY_TARGETS);
  localStorage.removeItem(KEY_ROUTINES);
  localStorage.removeItem(KEY_ACTIVE_ROUTINE);
  localStorage.removeItem(KEY_ACTIVE_SCREEN);

   // ‚úÖ STEP 5 ‚Äî reset onboarding state
  localStorage.removeItem(KEY_ONBOARD_DONE);
  
  location.reload();
});

function isOnboardingDone(){
  return localStorage.getItem(KEY_ONBOARD_DONE) === "1";
}

function setOnboardingDone(){
  localStorage.setItem(KEY_ONBOARD_DONE, "1");
}

function hasProfileCompleted(){
  const p = LS.get(KEY_PROFILE, null);
  if(!p || typeof p !== "object") return false;
  return String(p.name || "").trim().length > 0; // you can relax this if name is optional
}

function hasAtLeastOneRoutine(){
  const rts = LS.get(KEY_ROUTINES, []);
  return Array.isArray(rts) && rts.length > 0;
}

function routeInitialScreen(){
  hydrateOnboardingInputs();

  // 1) If profile isn‚Äôt completed ‚Üí Profile screen
  if(!hasProfileCompleted()){
    showScreen("profile");
    return;
  }

  // 2) If profile is done but onboarding not finished ‚Üí Routine screen
  if(!isOnboardingDone()){
    showScreen("onboard-routine");
    return;
  }

  // 3) Normal app restore
  showScreen(localStorage.getItem(KEY_ACTIVE_SCREEN) || "home");
}

  /* ---------------------------
   App Version + Update Banner (Production-grade)
   - version.json should be deployed alongside index.html
   - version.json example: { "version": "2026.02.11.1" }
   - We cache-bust + no-store to avoid stale reads.
   - When a new version is detected:
       1) show the banner
       2) attempt to update a Service Worker (if present)
       3) auto-refresh with a short countdown (user can postpone)
---------------------------- */

function showUpdateBanner(){
  const b = document.getElementById("updateBanner");
  if(b) b.style.display = "block";
}

function hideUpdateBanner(){
  const b = document.getElementById("updateBanner");
  if(b) b.style.display = "none";
}

function setUpdateBannerSub(text){
  const sub = document.querySelector("#updateBanner .updateSub");
  if(sub) sub.textContent = text;
}

function canAutoReloadNow(){
  // Prevent infinite refresh loops:
  const lastReload = Number(localStorage.getItem(KEY_APP_LAST_RELOAD) || "0");
  if(lastReload && (Date.now() - lastReload) < AUTO_REFRESH_COOLDOWN_MS) return false;

  // If user postponed recently, respect it
  const dismissedUntil = Number(localStorage.getItem(KEY_APP_UPDATE_DISMISSED_UNTIL) || "0");
  if(dismissedUntil && Date.now() < dismissedUntil) return false;

  // If tab is hidden, wait until it becomes visible
  if(document.visibilityState !== "visible") return false;

  // If offline, don‚Äôt force reload
  if(navigator && navigator.onLine === false) return false;

  return true;
}

async function tryUpdateServiceWorker(){
  // Optional: only relevant if you register a SW somewhere else.
  // Safe no-op if SW is not used.
  try{
    if(!("serviceWorker" in navigator)) return;

    const reg = await navigator.serviceWorker.getRegistration();
    if(!reg) return;

    // Ask browser to check for an updated SW script
    await reg.update();

    // If there‚Äôs a waiting SW, ask it to activate immediately.
    if(reg.waiting){
      reg.waiting.postMessage({ type: "SKIP_WAITING" });
    }
  }catch(e){
    // Non-fatal ‚Äî version.json-based reload still works.
    console.log("tryUpdateServiceWorker error:", e);
  }
}

let _versionPollTimer = null;
let _autoReloadTimer = null;
let _autoReloadTick = null;

function clearAutoReloadTimers(){
  if(_autoReloadTimer){ clearTimeout(_autoReloadTimer); _autoReloadTimer = null; }
  if(_autoReloadTick){ clearInterval(_autoReloadTick); _autoReloadTick = null; }
}

function scheduleAutoReload(){
  clearAutoReloadTimers();

  // If we can't auto reload, explain WHY (better UX)
  if(!canAutoReloadNow()){
    if(document.visibilityState !== "visible"){
      setUpdateBannerSub("Update available. Return to this tab to refresh.");
    }else if(navigator && navigator.onLine === false){
      setUpdateBannerSub("Update available. Reconnect to refresh.");
    }else{
      setUpdateBannerSub("Update available. Tap Refresh to load it.");
    }
    return;
  }

  let remaining = AUTO_REFRESH_COUNTDOWN_S;
  setUpdateBannerSub(`Auto-refreshing in ${remaining}s‚Ä¶ (click banner to postpone)`);

  // ‚úÖ IMPORTANT: only stop the interval at 0 ‚Äî DO NOT clear the timeout here
  _autoReloadTick = setInterval(()=>{
    remaining -= 1;

    if(remaining <= 0){
      clearInterval(_autoReloadTick);
      _autoReloadTick = null;
      return;
    }

    setUpdateBannerSub(`Auto-refreshing in ${remaining}s‚Ä¶ (click banner to postpone)`);
  }, 1000);

  _autoReloadTimer = setTimeout(()=>{
    clearAutoReloadTimers();
    localStorage.setItem(KEY_APP_LAST_RELOAD, String(Date.now()));

    // ‚úÖ Cache-busted reload (more reliable than location.reload())
    const u = new URL(location.href);
    u.searchParams.set("v", String(Date.now()));
    location.replace(u.toString());
  }, AUTO_REFRESH_COUNTDOWN_S * 1000);
}


function postponeAutoReload(minutes=10){
  clearAutoReloadTimers();
  const until = Date.now() + (minutes * 60 * 1000);
  localStorage.setItem(KEY_APP_UPDATE_DISMISSED_UNTIL, String(until));
  setUpdateBannerSub(`Update available. Postponed for ${minutes} minutes.`);
}

async function getLatestVersion(){
  const url = "./version.json?ts=" + Date.now();

  try{
    const res = await fetch(url, { cache: "no-store" });

    if(!res.ok){
      appHasService = false;
      updateConnectivityIndicators();
      console.log("version.json fetch failed:", res.status, url);
      return null;
    }

    const data = await res.json();
    const latest = String(data.version || "").trim();

    // If we can fetch and parse version.json, we DEFINITELY have service.
    appHasService = true;
    updateConnectivityIndicators();

    if(!latest){
      console.log("version.json missing 'version' field:", data);
      return null;
    }
    return latest;

  }catch(e){
    appHasService = false;
    updateConnectivityIndicators();
    console.log("version.json fetch error:", e);
    return null;
  }
}

async function checkForUpdate(){
  try{
    const latest = await getLatestVersion();
    if(!latest) return;

    const last = localStorage.getItem(KEY_APP_VERSION);

    // First run: store and render, no banner.
    if(!last){
      localStorage.setItem(KEY_APP_VERSION, latest);
      renderHeaderPills();
      return;
    }

    if(last !== latest){
  // track previous version before overwriting
  localStorage.setItem("gym_app_prev_version_v1", last);

  showUpdateBanner();
  localStorage.setItem(KEY_APP_VERSION, latest);
  renderHeaderPills();


      // Best-effort SW update (safe no-op if unused)
      tryUpdateServiceWorker();

      // Production behavior: auto-refresh with safeguards
      scheduleAutoReload();
      return;
    }

    // No update
    renderHeaderPills();
  }catch(e){
    console.log("checkForUpdate error:", e);
  }
}
  let appHasService = true; // "service" = can actually reach version.json

function setOnlineUI(isOnline, hasService){
  if(!hdrOnline || !hdrStatus || !hdrDot) return;

  hdrStatus.classList.remove("good","warn","bad");

  if(!isOnline){
    hdrOnline.textContent = "Offline";
    hdrDot.textContent = "üî¥";
    hdrStatus.classList.add("bad");
    return;
  }

  if(!hasService){
    hdrOnline.textContent = "Online (No Service)";
    hdrDot.textContent = "‚ö†Ô∏è";
    hdrStatus.classList.add("warn");
    return;
  }

  hdrOnline.textContent = "Synced";
  hdrDot.textContent = "üü¢";
  hdrStatus.classList.add("good");
}


function updateConnectivityIndicators(){
  const isOnline = navigator.onLine !== false;
  setOnlineUI(isOnline, appHasService);

  // ‚úÖ Keep Settings "Connection" pill synced with header in real time
  if(typeof renderUpdatesPanel === "function"){
    renderUpdatesPanel(null);
  }
}

window.addEventListener("online",  updateConnectivityIndicators);
window.addEventListener("offline", updateConnectivityIndicators);

function startVersionPolling(){
  if(_versionPollTimer) return;
  // Run immediately, then on an interval.
  checkForUpdate();
  _versionPollTimer = setInterval(()=>{
    // Don‚Äôt spam when hidden ‚Äî visibility handler will run a check upon return.
    if(document.visibilityState === "visible") checkForUpdate();
  }, VERSION_CHECK_INTERVAL_MS);
}

function stopVersionPolling(){
  if(_versionPollTimer){
    clearInterval(_versionPollTimer);
    _versionPollTimer = null;
  }
}

document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState === "visible"){
    // Re-check when user comes back (common after deployment)
    checkForUpdate();
  }
});

  /* ===========================
   SETTINGS: Updates Panel
=========================== */
const KEY_APP_PREV_VERSION = "gym_app_prev_version_v1";
const KEY_UP_LAST_CHECKED  = "gym_updates_last_checked_v1";
const KEY_UP_LAST_RESULT   = "gym_updates_last_result_v1";
const KEY_UP_FAIL_COUNT    = "gym_updates_fail_count_v1";
const KEY_UP_LAST_SUCCESS  = "gym_updates_last_success_v1";

// Build string (your mock shows ISO ‚Äú2026-02-11T15:22Z‚Äù)
const APP_BUILD = "2026-02-11T15:22Z";

function fmtDateTime(ms){
  if(!ms) return "‚Äî";
  try{
    const d = new Date(Number(ms));
    return d.toLocaleString(undefined, {
      year:"numeric", month:"short", day:"2-digit",
      hour:"2-digit", minute:"2-digit"
    }).replace(",", "") + " ‚Ä¢";
  }catch{
    return "‚Äî";
  }
}

async function getServiceWorkerState(){
  try{
    if(!("serviceWorker" in navigator)) return "OFF";
    const reg = await navigator.serviceWorker.getRegistration();
    return reg ? "ON" : "OFF";
  }catch{
    return "OFF";
  }
}

function setText(id, text){
  const el = document.getElementById(id);
  if(el) el.textContent = text;
}

function computeUpdateStatus(current, latest){
  if(!latest) return "Checking‚Ä¶";
  if(!current) return "Unknown";
  return (current === latest) ? "Up to date" : "Update available";
}

function renderUpdatesPanel(latestVersionMaybe=null){
  const current = localStorage.getItem(KEY_APP_VERSION) || "‚Äî";
  const prev    = localStorage.getItem(KEY_APP_PREV_VERSION) || "‚Äî";
  const latest  = latestVersionMaybe || localStorage.getItem("gym_latest_seen_version_v1") || current;

  // Connection uses your existing indicators logic:
     const isOnline = navigator.onLine !== false;

  let icon = "üî¥";
  let text = "Offline";

  if(isOnline){
    if(typeof appHasService !== "undefined"){
      if(appHasService){
        icon = "üü¢";
        text = "Synced";
      }else{
        icon = "‚ö†Ô∏è";
        text = "Online (No Service)";
      }
    }else{
      icon = "üü¢";
      text = "Synced";
    }
  }



  const lastChecked = Number(localStorage.getItem(KEY_UP_LAST_CHECKED) || "0");

  setText("upCurVer",   `üßæ Current Version: ${current}`);
  setText("upPrevVer",  `üïò Previous Version: ${prev}`);
  setText("upLatestVer",`‚¨ÜÔ∏è Latest Available: ${latest}`);

  setText("upConn", `üåê Connection: ${icon} ${text}`);
  setText("upStatus",   `‚úÖ Update Status: ${computeUpdateStatus(current, latest)}`);
  setText("upChecked",  lastChecked ? `üïí Last Checked: ${new Date(lastChecked).toLocaleString()}` : "üïí Last Checked: ‚Äî");

  setText("upBuild",    `üß± Build: ${APP_BUILD}`);

  // SW state async
  getServiceWorkerState().then(state=>{
    setText("upSW", `üß© Service Worker: ${state}`);
  });
}

async function doCheckNow(){
  localStorage.setItem(KEY_UP_LAST_CHECKED, String(Date.now()));
  const latest = await getLatestVersion();
  if(latest){
    localStorage.setItem("gym_latest_seen_version_v1", latest);
  }
  renderUpdatesPanel(latest || null);
  // keep your existing banner/auto-refresh logic untouched:
  await checkForUpdate();
}

function saveUpdateResult(obj){
  localStorage.setItem(KEY_UP_LAST_RESULT, JSON.stringify(obj));
}

function loadUpdateResult(){
  try{
    return JSON.parse(localStorage.getItem(KEY_UP_LAST_RESULT) || "null");
  }catch{
    return null;
  }
}

function showUpdateResultPopup(result){
  // Now rendered inline (dropdown panel) instead of a popup modal.
  const panel = document.getElementById("upResultPanel");
  if(!panel) return;

  // Hide diagnostics if open
  const diag = document.getElementById("upDiagPanel");
  if(diag) diag.style.display = "none";

  const tryBtn = document.getElementById("uModalTryAgain");
  const l1 = document.getElementById("uResLine1");
  const l2 = document.getElementById("uResLine2");
  const l3 = document.getElementById("uResLine3");
  const l4 = document.getElementById("uResLine4");
  const l5 = document.getElementById("uResLine5");
  const l6 = document.getElementById("uResLine6");

  // ‚úÖ BUG FIX: avoid hard crash if any result lines are missing
  if(!l1 || !l2 || !l3 || !l4 || !l5 || !l6) return;


  const ok = !!result?.ok;

  l1.textContent = ok ? "‚úÖ Update Successful" : "‚ö†Ô∏è Update Failed";

  if(ok){
    l2.textContent = `Updated to: ${result.updatedTo || "‚Äî"}`;
    l3.textContent = `Reload triggered: ${result.reloadTriggered ? "Yes" : "No"}`;
    l4.textContent = `Service Worker reset: ${result.swReset ? "Yes" : "No"}`;
    l5.textContent = `Cache cleared: ${result.cacheCleared ? "Yes" : "No"}`;
    l6.textContent = `Time: ${result.timeLabel || "‚Äî"}`;
    if(tryBtn) tryBtn.style.display = "none";
  }else{
    l2.textContent = `Step failed: ${result.stepFailed || "Unknown"}`;
    l3.textContent = `Reason: ${result.reason || "Unknown"}`;
    l4.textContent = `Suggestion: ${result.suggestion || "Try again"}`;
    l5.textContent = `Time: ${result.timeLabel || "‚Äî"}`;
    l6.textContent = "";
    if(tryBtn) tryBtn.style.display = "inline-flex";
  }

  panel.style.display = "block";
  // Make sure it lands in-view on mobile
  panel.scrollIntoView({behavior:"smooth", block:"start"});
}

function hideUpdateResultPopup(){
  const panel = document.getElementById("upResultPanel");
  if(panel) panel.style.display = "none";
}

async function fullWipeAndReload(){
  const timeLabel = new Date().toLocaleString();

  // Steps we report in popup:
  let cacheCleared = false;
  let swReset = false;

  try{
    // 1) Unregister ALL service workers
    if("serviceWorker" in navigator){
      const regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r=>r.unregister()));
      swReset = true;
    }

    // 2) Clear Cache Storage
    if("caches" in window){
      const keys = await caches.keys();
      await Promise.all(keys.map(k=>caches.delete(k)));
      cacheCleared = true;
    }

    // Save success info BEFORE leaving page
    const updatedTo = localStorage.getItem(KEY_APP_VERSION) || localStorage.getItem("gym_latest_seen_version_v1") || "‚Äî";
    const result = {
      ok: true,
      updatedTo,
      reloadTriggered: true,
      swReset,
      cacheCleared,
      timeLabel
    };

    saveUpdateResult(result);
    localStorage.setItem(KEY_UP_LAST_SUCCESS, String(Date.now()));

    // 3) Cache-bust reload (hard refresh)
    localStorage.setItem(KEY_APP_LAST_RELOAD, String(Date.now()));
    location.replace(location.pathname + "?v=" + Date.now());
  }catch(e){
    const failCount = Number(localStorage.getItem(KEY_UP_FAIL_COUNT) || "0") + 1;
    localStorage.setItem(KEY_UP_FAIL_COUNT, String(failCount));

    const result = {
      ok: false,
      stepFailed: (!swReset && "Service Worker reset") || (!cacheCleared && "Cache clear") || "Unknown",
      reason: String(e?.message || e || "Unknown error"),
      suggestion: "Try again",
      timeLabel
    };

    saveUpdateResult(result);
    showUpdateResultPopup(result);
  }
}

async function clearCacheAndReload(){
  const timeLabel = new Date().toLocaleString();

  try{
    let cacheCleared = false;

    if("caches" in window){
      const keys = await caches.keys();
      await Promise.all(keys.map(k=>caches.delete(k)));
      cacheCleared = true;
    }

    const result = {
      ok: true,
      updatedTo: localStorage.getItem(KEY_APP_VERSION) || "‚Äî",
      reloadTriggered: true,
      swReset: false,
      cacheCleared,
      timeLabel
    };

    saveUpdateResult(result);

    localStorage.setItem(KEY_APP_LAST_RELOAD, String(Date.now()));
    location.replace(location.pathname + "?v=" + Date.now());
  }catch(e){
    const failCount = Number(localStorage.getItem(KEY_UP_FAIL_COUNT) || "0") + 1;
    localStorage.setItem(KEY_UP_FAIL_COUNT, String(failCount));

    const result = {
      ok: false,
      stepFailed: "Cache clear",
      reason: String(e?.message || e || "Unknown error"),
      suggestion: "Try again",
      timeLabel
    };

    saveUpdateResult(result);
    showUpdateResultPopup(result);
  }
}

function showDiagnosticsPopup(){
  // Now rendered inline (dropdown panel) instead of a popup modal.
  const panel = document.getElementById("upDiagPanel");
  if(!panel) return;

  // Hide result if open
  const res = document.getElementById("upResultPanel");
  if(res) res.style.display = "none";

  const failCount = Number(localStorage.getItem(KEY_UP_FAIL_COUNT) || "0");
  const lastSuccess = Number(localStorage.getItem(KEY_UP_LAST_SUCCESS) || "0");
  const lastChecked = Number(localStorage.getItem(KEY_UP_LAST_CHECKED) || "0");

  setText("uDiag1", `Fail count: ${failCount}`);
  setText("uDiag2", `Last success: ${lastSuccess ? new Date(lastSuccess).toLocaleString() : "‚Äî"}`);
  setText("uDiag3", `Last checked: ${lastChecked ? new Date(lastChecked).toLocaleString() : "‚Äî"}`);
  setText("uDiag4", `Current version: ${localStorage.getItem(KEY_APP_VERSION) || "‚Äî"}`);
  setText("uDiag5", `Latest seen: ${localStorage.getItem("gym_latest_seen_version_v1") || "‚Äî"}`);

  panel.style.display = "block";
  panel.scrollIntoView({behavior:"smooth", block:"start"});
}


/* Bind buttons once */
function bindUpdatesPanel(){
  document.getElementById("upCheckNowBtn")?.addEventListener("click", doCheckNow);
  document.getElementById("upUpdateNowBtn")?.addEventListener("click", fullWipeAndReload);
  document.getElementById("upClearCacheBtn")?.addEventListener("click", clearCacheAndReload);

  // Advanced dropdowns (inline)
  document.getElementById("upShowResultBtn")?.addEventListener("click", ()=>{
    const panel = document.getElementById("upResultPanel");
    if(panel && panel.style.display === "block"){
      hideUpdateResultPopup();
      return;
    }

    const last = loadUpdateResult();
    if(last) showUpdateResultPopup(last);
    else showUpdateResultPopup({
      ok: false,
      stepFailed: "‚Äî",
      reason: "No update result saved yet.",
      suggestion: "Run Check Now or Update Now",
      timeLabel: new Date().toLocaleString()
    });
  });

  document.getElementById("upDiagBtn")?.addEventListener("click", ()=>{
    const panel = document.getElementById("upDiagPanel");
    if(panel && panel.style.display === "block"){
      const p = document.getElementById("upDiagPanel");
      if(p) p.style.display = "none";
      return;
    }
    showDiagnosticsPopup();
  });

  document.getElementById("upResultHideBtn")?.addEventListener("click", hideUpdateResultPopup);
  document.getElementById("upDiagHideBtn")?.addEventListener("click", ()=>{
    const p = document.getElementById("upDiagPanel");
    if(p) p.style.display = "none";
  });

  document.getElementById("uModalTryAgain")?.addEventListener("click", ()=>{
    hideUpdateResultPopup();
    fullWipeAndReload();
  });

  // Keep Connection pill synced with header (online/offline changes)
  window.addEventListener("online",  ()=>renderUpdatesPanel());
  window.addEventListener("offline", ()=>renderUpdatesPanel());
}



// If user clicks the banner anywhere (except the refresh button), postpone.
document.addEventListener("click", (e)=>{
  const banner = e.target.closest("#updateBanner");
  if(!banner) return;

  const refreshBtn = e.target.closest("#updateRefreshBtn");
  if(refreshBtn) return; // handled below

  // Postpone for 10 minutes
  postponeAutoReload(10);
});

document.addEventListener("click", (e)=>{
  const btn = e.target.closest("#updateRefreshBtn");
  if(!btn) return;

  // force a reload (browser will fetch latest files)
  location.reload();
});
  
/* ---------------------------
   Init (single pass)
---------------------------- */
function init(){
  // Load core state
  profile = loadProfile();

  ({routines, activeId: activeRoutineId} = loadRoutines());

  bwLogs = LS.get(KEY_BW, []);
  attendance = new Set(LS.get(KEY_ATT, []));
  proteinMap = LS.get(KEY_PRO, {});
  lifts = LS.get(KEY_LIFTS, []);
  ensureLiftCompatibility();
  migrateCanonicalNames();

  // Bind once
  bindNavigation();

  // Static UI (not screen-specific)
  hydrateSettingsUI();
  hydrateOnboardingInputs();
  renderHeaderPills();
  renderStorageInfo();
  renderLastBackup();
  
  bindUpdatesPanel();
  renderUpdatesPanel();


  // Default view settings
  setBWView("table");
  setLiftView("table");
  applyLiftFiltersFromUI();

  startVersionPolling();        // ‚úÖ Production-grade version polling


  // Route LAST (this calls showScreen which renders what‚Äôs needed)
  routeInitialScreen();
}

window.addEventListener("DOMContentLoaded", init);


})();
</script>

  <!-- ‚úÖ Update Banner (shows when a new deploy is detected) -->
<div id="updateBanner" class="updateBanner" style="display:none;">
  <div class="updateBannerInner">
    <div class="updateText">
      <div class="updateTitle">‚ú® Update available</div>
      <div class="updateSub">Refresh to load the latest version.</div>
    </div>
    <button id="updateRefreshBtn" class="miniBtn tap">Refresh</button>
  </div>
</div>
  <!-- Bottom Navigation -->
<nav class="bottomNav">
  <div class="bottomNavInner">
    <button class="navBtn tap" data-go="home" data-nav="home">
  <div class="icon">üè†</div><div>Home</div>
</button>

<button class="navBtn tap" data-go="routine" data-nav="routine">
  <div class="icon">üóìÔ∏è</div><div>Routine</div>
</button>
<button class="navBtn tap" type="button" data-go="lifts" data-nav="lifts">
      <div class="icon">üìà</div><div>Progress</div>
    </button>
<button class="navBtn tap" type="button" data-go="settings" data-nav="settings">
      <div class="icon">‚öôÔ∏è</div><div>Settings</div>
    </button>
  </div>
</nav>
</body>
</html>
