<!doctype html>


<html lang="en">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Gym Dashboard</title>
  <style>
    
  :root{
  --bg0:#070708;
  --bg1:#0b0b0c;

  --card:#121214;
  --card-soft: rgba(18,18,20,.88);

  --text:#f5f6f7;
  --muted:#9aa0a6;

  --line: rgba(255,255,255,.08);

  --accent:#7CFC00;   /* Apple Fitness‚Äìstyle green */
  --danger:#ff6b6b;
  --warn:#ffd166;

  --good: var(--accent);
  --bad:  var(--danger);

  --radius:16px;
  --shadow: 0 14px 40px rgba(0,0,0,.45);
}

/* ===========================
   GLOBAL iOS INPUT ZOOM KILL
=========================== */
input,
select,
textarea{
  font-size: 16px !important;
}

/* Prevent iOS from auto-scaling text */
html{
  -webkit-text-size-adjust: 100%;
}

/* Visual-only: prevent nested scrolling in Exercise Picker */
#exPickModal > div{
  overflow: hidden !important;   /* card does not scroll */
  display:flex;
  flex-direction:column;
}

#exPickList{
  flex:1;                        /* list fills remaining space */
  overflow-y:auto;               /* list scrolls */
  -webkit-overflow-scrolling: touch;
}


/* ---------------------------
   MODAL SCROLL FIX (mobile + desktop)
   - make the MODAL CARD the scroller
   - avoid nested scrolling on iOS
---------------------------- */

/* overlays */
:is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal){
  overflow:hidden;                 /* prevents overlay scroll fighting */
  -webkit-overflow-scrolling:touch;
}

    /* ===========================
   EXERCISE PICKER SIZE FIX
   - keeps modal small
   - list scrolls instead
=========================== */

#exPickModal > div{
  max-height: calc(100dvh - 32px);
  overflow: hidden;
}

#exPickList{
  margin-top: 10px;
  border: 1px solid #202124;
  border-radius: 12px;

  max-height: 320px;      /* adjust if needed */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

    /* ===========================
   iOS PWA INPUT ZOOM FIX
   Prevents auto-zoom on focus
=========================== */

/* Exercise picker inputs */
#exPickModal input,
#exPickModal select,
#exPickModal textarea{
  font-size: 16px !important;
}

/* Batch add modal inputs (just in case) */
#batchAddModal input,
#batchAddModal select{
  font-size: 16px !important;
}
    

:is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal) > div{
  max-height: calc(100dvh - 32px); /* true mobile viewport height */
  overflow-y:auto;                 /* scroll the whole modal */
  -webkit-overflow-scrolling:touch;
  display:flex;
  flex-direction:column;
}

/* ‚úÖ Log Sets list should NOT be its own scrollbar (prevents nested scroll on iOS) */
#logModalSets{
  overflow: visible;
  max-height: none;
}

/* ‚úÖ Routine Editor list should NOT be its own scrollbar */
#rtExList{
  overflow: visible !important;
  max-height: none !important;
}

/* keep action buttons visible in modals */
#rtModal .btnRow,
#logModal .btnRow{
  position: sticky;
  bottom: 0;
  background: linear-gradient(
    to bottom,
    rgba(18,18,20,0),
    rgba(18,18,20,1) 35%
  );
  padding-top: 10px;
}
/* ‚úÖ END MODAL SCROLL FIX */

    /* ---------------------------
   MODAL GLASS + ANIMATION
---------------------------- */

/* overlay fade */
:is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal){
  animation: modalFadeIn .14s ease;
}

/* the modal card */
:is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal) > div{
  animation: modalPopIn .14s ease;
  background: rgba(18,18,20,.92) !important;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  box-shadow: 0 16px 50px rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.10) !important;
}

/* keyframes */
@keyframes modalFadeIn{
  from{ opacity:0; }
  to{ opacity:1; }
}
@keyframes modalPopIn{
  from{ opacity:0; transform: translateY(10px) scale(.98); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}

/* respect reduced motion */
@media (prefers-reduced-motion: reduce){
  :is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal),
  :is(#logModal,#histModal,#rtModal,#exPickModal,#batchAddModal) > div{
    animation: none !important;
  }
}
    
    *{box-sizing:border-box}
body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
  color: var(--text);

  background:
    radial-gradient(1200px 800px at 50% 140px, rgba(124,252,0,.08), transparent 72%),
    radial-gradient(1200px 900px at 50% 65%, rgba(124,252,0,.03), transparent 70%),
    linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 55%, var(--bg0) 120%);
  background-attachment: fixed; /* ‚úÖ makes it feel like one continuous ‚Äúcanvas‚Äù */
}


    /* ‚úÖ Unified app header (matches mockup) */
header{
  position: sticky;
  top: 0;
  z-index: 60;
  padding: calc(env(safe-area-inset-top) + 14px) 16px 14px;

  background: linear-gradient(
    to bottom,
    rgba(7,7,8,.92),
    rgba(7,7,8,.55),
    rgba(7,7,8,0)
  );

  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-bottom: none;
}
header h1{
  margin:0;
  font-size:26px;
  font-weight:800;
  letter-spacing:.2px;
  color: var(--text);
}

header .sub{
  margin-top:6px;
  font-size:13px;
  color: var(--muted);
}
    main{
      padding:14px 12px 80px;
      display:grid;
      gap:12px;
      max-width:1100px;
      margin:0 auto;
      position: relative; /* ‚úÖ ADD */
    }

main > *{
  position: relative;
  z-index: 1;
}
    .grid2{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid2{grid-template-columns: 1fr 1fr;}
    }
    
    #homeFocus{
  white-space: pre-line;
}
   .card{
  background: rgba(18,18,20,.72);   /* ‚úÖ translucent so the body gradient shows through */
  border: 1px solid rgba(255,255,255,.08);
  border-radius: var(--radius);
  padding:14px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.4px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:11px;
      color:var(--muted);
      min-width: 120px;
      flex:1 1 140px;
    }
    input, select, button, textarea{
      background:#0f0f10;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:38px; resize:vertical;}
    input::placeholder{color:#666}
    button{
      cursor:pointer;
      background:#0f0f10;
      font-weight:600;
    }
    button:hover{border-color:#2a2b2f}
    .btnRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--text)}
    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-align:left;
      vertical-align:top;
    }
    th{
      color:var(--muted);
      font-weight:700;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.6px;
      background:#0f0f10;
    }
    tr:last-child td{border-bottom:none}
    .mono{font-variant-numeric: tabular-nums;}
    .good{color:var(--good); font-weight:700;}
    .bad{color:var(--bad); font-weight:700;}
    .warn{color:var(--warn); font-weight:700;}
    .muted{color:var(--muted)}
    .small{font-size:11px}
    .splitTabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      color:var(--muted);
      background:#0f0f10;
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .tab.active{
      color:var(--text);
      border-color:#2a2b2f;
    }
    .exerciseList{
      display:grid;
      gap:8px;
    }
    .exerciseItem{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#0f0f10;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .exerciseItem .left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .exerciseItem .title{
      font-size:13px;
      font-weight:700;
    }
    .exerciseItem .meta{
      font-size:11px;
      color:var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .exerciseItem .right{
      text-align:right;
      min-width:160px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .exerciseItem .right .line2{
      font-size:11px;
      color:var(--muted);
    }
    .badge{
      display:inline-block;
      padding:4px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:11px;
      color:var(--text);
      background:#121214;
    }
    .calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      margin-top:10px;
      user-select:none;
    }
    .calHead{
      font-size:10px;
      color:var(--muted);
      text-align:center;
      padding:4px 0;
    }
    .day{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 0;
      text-align:center;
      font-size:12px;
      background:#0f0f10;
      cursor:pointer;
    }
    .day.off{opacity:.35; cursor:default;}
    .day.attended{
      border-color:#2a2b2f;
      outline:2px solid rgba(124,252,0,.25);
    }
    .day.attended .dot{
      display:block;
      margin:6px auto 0;
      width:6px; height:6px;
      border-radius:50%;
      background:var(--good);
    }
    .topRight{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .ghost{
      border-color:transparent;
      color:var(--muted);
    }
    .ghost:hover{border-color:var(--line)}
    .notice{
      border:1px dashed #2a2b2f;
      border-radius:12px;
      padding:10px;
      color:var(--muted);
      font-size:12px;
      background:#0f0f10;
    }
    .clickEx{cursor:pointer; text-decoration:underline; text-decoration-color:#2a2b2f;}
    .clickEx:hover{opacity:.85;}
    .divider{
      height:1px;
      background:var(--line);
      margin:10px 0;
    }
    .miniBtn{
      padding:8px 10px;
      font-size:12px;
    }
    .danger{
      border-color: rgba(255, 107, 107, .35);
      color: var(--bad);
    }
    /* Exercise picker list items */
.exPickItem{
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  cursor:pointer;
}
.exPickItem:last-child{border-bottom:none;}
.exPickItem:hover{opacity:.85;}
.exPickItem.active{
  outline:2px solid rgba(124,252,0,.25);
  background:#0f0f10;
}
    .exPickRow{
  display:flex;
  gap:10px;
  align-items:center;
}
.exPickCheck{
  width:16px;
  height:16px;
  border:1px solid var(--line);
  border-radius:4px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
}
.exPickItem.active .exPickCheck{
  border-color: rgba(124,252,0,.35);
}
    /* ---------------------------
   APP SCREENS (Option A)
---------------------------- */

/* ‚úÖ Screen title row (not a second header) */
.screenTop{
  position: relative;     /* not sticky */
  top: auto;
  z-index: 1;

  display:flex;
  align-items:center;
  gap:10px;

  padding: 6px 2px 12px;  /* small spacing inside page */
  background: transparent;
  backdrop-filter: none;
  border-bottom: none;
}

.homeGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}

.proCircle{
  width:74px;
  height:74px;
  border-radius:999px;
  border:1px solid var(--line);
  display:grid;
  place-items:center;

  position:relative;
  overflow:hidden;            /* keeps everything inside the circle */
  background: transparent;     /* IMPORTANT: remove gradient from here */
}

/* the gradient ring layer */
.proCircle::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background: conic-gradient(var(--good) var(--deg, 0deg), #202124 0deg);
}

/* ensure inner content is above the gradient */
.proCircleInner{
  position:relative;
  z-index:1;
  width:58px;
  height:58px;
  border-radius:999px;
  background:#0f0f10;
  border:1px solid var(--line);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
}
.proCircleInner .big{
  font-size: 13px;
  font-weight: 700;
  line-height: 0.95;
}

.proCircleInner .small{
  font-size: 8px;
  letter-spacing: 0.2px;
  opacity: 0.75;
}

    /* Home ‚Äì Focus This Week layout */
.proCircleWrap{
  display:flex;
  align-items:center;
  gap:14px;
}

.proCircle{
  flex:0 0 auto;   /* prevents shrinking */
}

#homeFocus{
  flex:1;
  line-height:1.3;
}

.homeGrid button{
  padding:18px 12px;
  border-radius:14px;
  text-align:left;
}
.primary{
  background: rgba(124,252,0,.10);
  border-color: rgba(124,252,0,.28);
  color: var(--text);
}
.primary:hover{
  border-color: rgba(124,252,0,.45);
}
/* ===========================
   HOME APP TILES (visual only)
=========================== */

.homeGrid{
  gap:12px; /* slightly more breathing room */
}

/* make each Home button feel like a real app tile */
.homeGrid button{
  background: rgba(18,18,20,.86) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  box-shadow: 0 10px 26px rgba(0,0,0,.35) !important;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);

  /* ‚¨áÔ∏è SLIMMER TILE SETTINGS */
  padding: 10px 12px !important;   /* was 16px 14px */
  gap:6px;                         /* was 10px */
  min-height: 64px;                /* was 92px */

  border-radius: 16px !important;  /* slightly tighter */
  display:flex;
  flex-direction:column;
  justify-content:center;          /* centers icon/text vertically */
  text-align:left;

  position: relative;
  overflow: hidden;
}

/* subtle internal highlight (iOS-style glass) */
.homeGrid button::before{
  content:"";
  position:absolute;
  inset:-2px;
  background: radial-gradient(
    420px 220px at 18% 0%,
    rgba(124,252,0,.12),
    transparent 55%
  );
  opacity: .7;
  pointer-events:none;
}

/* tap / hover feedback */
.homeGrid button:hover{
  border-color: rgba(255,255,255,.16) !important;
  transform: translateY(-1px);
}
.homeGrid button:active{
  transform: scale(.985);
}


  .bullets{
  margin:10px 0 0;
  padding-left:18px;
}
.bullets li{
  margin:6px 0;
  font-size:13px;
}

.homeHeaderCard{
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:flex-end;
}

.homeTitle{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.bigTime{
  font-size:18px;
  font-weight:800;
  letter-spacing:.4px;
}

.smallDate{
  color:var(--muted);
  font-size:12px;
}

.homeStack{
  display:grid;
  gap:12px;
  margin-top:12px;
}

.weekRow{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
}

.weekDots{
  display:flex;
  justify-content:center;
  gap:18px;
  margin-top:8px;
  align-items:center;
}

.wdot{
  width:10px;
  height:10px;
  border-radius:50%;
  border:1px solid var(--line);
  background:transparent;
  opacity:.9;
}

.wdot.on{
  background:var(--good);
  border-color: rgba(124,252,0,.35);
}

.wdot.off{
  opacity:.35;
}

.kpiLine{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
  margin-top:10px;
}

.kpiLine .muted{font-size:12px;}

/* ‚úÖ Prevent background scroll while a modal is open (iOS + desktop) */
body.modalOpen{
  overflow: hidden;
  height: 100%;
  touch-action: none;
}

/* ---------------------------
   APP-LIKE UPGRADE (Bottom Nav + Transitions)
---------------------------- */

/* safe area + extra space for bottom nav */
main{
  padding-bottom: calc(110px + env(safe-area-inset-bottom));
}

/* screen transitions */
.screen{
  display:none;
  opacity:0;
  transform: translateY(10px);
  transition: opacity .18s ease, transform .18s ease;
}
.screen.active{
  display:block;
  opacity:1;
  transform: translateY(0);
}

/* Bottom navigation */
.bottomNav{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
  background: rgba(11,11,12,.94);
  backdrop-filter: blur(14px);
  border-top: 1px solid var(--line);
  z-index: 60;
}

.bottomNavInner{
  max-width: 1100px;
  margin: 0 auto;
  display:flex;
  gap:10px;
}

.navBtn{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  padding: 10px 10px;
  border-radius: 14px;
  background: transparent;
  border: 1px solid transparent;
  color: var(--muted);
  font-size: 11px;
  user-select:none;
}

.navBtn .icon{
  font-size: 18px;
  line-height: 1;
}

.navBtn.active{
  color: var(--text);
  background: rgba(124,252,0,.06);
  border-color: rgba(124,252,0,.22);
}

/* optional: reduce header prominence when bottom nav exists */
header{
  position: sticky;
  top: 0;
  z-index: 40;
}

/* little ‚Äútap‚Äù feel */
.navBtn:active{
  transform: translateY(1px);
}
  /* ---------------------------
   Haptic-style tap feedback
---------------------------- */
.tap{
  transition: transform .08s ease, opacity .08s ease;
  will-change: transform, opacity;
}

.tap:active{
  transform: scale(0.97);
  opacity: 0.85;
}

/* optional: reduce motion respect */
@media (prefers-reduced-motion: reduce){
  .tap{
    transition: none;
  }
}
      /* ---------------------------
   Update Banner (Option 1)
---------------------------- */
.updateBanner{
  position: fixed;
  left: 0; right: 0;
  bottom: calc(86px + env(safe-area-inset-bottom)); /* sits above bottom nav */
  padding: 0 12px;
  z-index: 80;
}

.updateBannerInner{
  max-width: 1100px;
  margin: 0 auto;
  background: rgba(18,18,20,.96);
  border: 1px solid rgba(124,252,0,.22);
  border-radius: 14px;
  padding: 10px 12px;
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  backdrop-filter: blur(12px);
}

.updateText{display:flex; flex-direction:column; gap:2px;}
.updateTitle{font-weight:800; font-size:13px;}
.updateSub{font-size:11px; color:var(--muted);}

    /* ===========================
   ROUTINE EDITOR (BIGGEST VISUAL WIN)
   - header + day tabs + add CTA + exercise cards + sticky footer
=========================== */

#rtModal > div{
  padding: 0 !important;              /* remove inline padding look */
  overflow: hidden;                    /* lets sticky footer look clean */
}

 /* ===========================
   ROUTINE EDITOR ‚Äì RESTORE SCROLL
   (visual-only, keeps JS intact)
=========================== */

#rtModal > div{
  display: flex;
  flex-direction: column;
  max-height: calc(100dvh - 32px);
  overflow: hidden !important; /* header + footer stay fixed */
}

/* üëá THIS is the scrollable area */
#rtModal .rtBody{
  flex: 1 1 auto;
  min-height: 0;               /* REQUIRED for flex scroll */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}


/* Header row inside Routine Editor */
#rtModal .rtHead{
  position: sticky;
  top: 0;
  z-index: 5;
  padding: 14px 14px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  background: linear-gradient(to bottom,
    rgba(18,18,20,.98),
    rgba(18,18,20,.80),
    rgba(18,18,20,0)
  );
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

#rtModal .rtHead h2{
  margin:0;
  font-size:15px;
  letter-spacing:.2px;
}

#rtModal .rtHead .rtClose{
  border-radius: 999px;
  padding: 8px 12px;
}

/* Body padding */
#rtModal .rtBody{
  padding: 0 14px 14px;
}

/* Day tabs ‚Äì more ‚ÄúiOS segmented‚Äù feel */
#rtModal #rtDayTabs{
  gap:6px;
}
#rtModal #rtDayTabs .tab{
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(15,15,16,.9);
}
#rtModal #rtDayTabs .tab.active{
  background: rgba(124,252,0,.08);
  border-color: rgba(124,252,0,.25);
}

/* Add Exercise CTA ‚Äì looks like a button tile */
#rtModal .rtAddWrap{
  border: 1px dashed rgba(124,252,0,.25);
  border-radius: 14px;
  padding: 12px;
  background: rgba(124,252,0,.04);
  display:flex;
  gap:10px;
  align-items:flex-end;
  flex-wrap:wrap;
}

#rtModal .rtAddWrap .rtPick{
  flex: 1 1 260px;
  min-width: 240px;
}

#rtModal .rtAddWrap input[readonly]{
  cursor: pointer;
  background: rgba(15,15,16,.9);
  border-color: rgba(255,255,255,.10);
}

#rtModal .rtAddWrap .hint{
  margin-top:6px;
  font-size:11px;
  color: var(--muted);
}

/* Exercise list cards ‚Äì stop using generic .card look */
#rtModal .rtExCard{
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  background: rgba(15,15,16,.92);
  padding: 12px;
  box-shadow: 0 10px 24px rgba(0,0,0,.35);
}

#rtModal .rtExTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

#rtModal .rtExName{
  font-weight: 800;
  font-size: 13px;
}

#rtModal .rtMetaRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
  color: var(--muted);
  font-size: 11px;
}

#rtModal .rtActions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}

#rtModal .rtActions .miniBtn{
  border-radius: 12px;
}

/* Sticky footer actions */
#rtModal .rtFooter{
  position: sticky;
  bottom: 0;
  z-index: 5;
  padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
  background: linear-gradient(
    to bottom,
    rgba(18,18,20,0),
    rgba(18,18,20,.85) 35%,
    rgba(18,18,20,.98)
  );
  border-top: 1px solid rgba(255,255,255,.06);
  display:flex;
  gap:10px;
  justify-content:flex-end;
}

#rtModal #rtSaveBtn{
  background: rgba(124,252,0,.12);
  border-color: rgba(124,252,0,.30);
}
#rtModal #rtSaveBtn:hover{
  border-color: rgba(124,252,0,.45);
}


    
  </style>
</head>

<body>
<header>
  <h1>Gym Dashboard</h1>
  <div class="sub" id="headerSub">‚Äî</div>
</header>

<main>

  <!-- ONBOARDING: PROFILE -->
<section id="screen-profile" class="screen">
  <div class="screenTop">
    <h2 style="margin:0;">Create Profile</h2>
  </div>

  <section class="card">
    <div class="notice" style="margin-bottom:10px;">
      Let‚Äôs set up your basics. You can change this later.
    </div>

    <div class="row">
      <label>Name
        <input id="obName" placeholder="e.g., Jordan" />
      </label>

      <label>Units
        <select id="obUnits">
          <option value="lbs" selected>lbs</option>
        </select>
      </label>

      <label>Protein Goal (g)
        <input id="obProteinGoal" type="number" min="0" placeholder="240" />
      </label>

      <label>Week Starts On
        <select id="obWeekStart">
          <option value="mon" selected>Monday</option>
          <option value="sun">Sunday</option>
        </select>
      </label>

      <label>Hide Rest Days
        <select id="obHideRest">
          <option value="1" selected>ON</option>
          <option value="0">OFF</option>
        </select>
      </label>
    </div>

    <div class="btnRow">
      <button id="obProfileNextBtn">Next ‚Üí Routine</button>
    </div>
  </section>
</section>

<!-- ONBOARDING: ROUTINE -->
<section id="screen-onboard-routine" class="screen">
  <div class="screenTop">
    <button class="ghost" type="button" id="obRoutineBackBtn">‚Üê Back</button>
    <h2 style="margin:0;">Create Routine</h2>
  </div>

  <section class="card">
    <div class="notice" style="margin-bottom:10px;">
      Create your routine. You can edit it anytime later.
    </div>

    <div class="row">
  <label>Routine Name
    <input id="obRoutineName" placeholder="e.g., PPL, Upper/Lower, 3-day split" />
  </label>

  <label style="min-width:220px; flex:0 0 auto;">
    Start From Template
    <select id="obRoutineTemplate">
      <option value="blank" selected>Blank (build my own)</option>
      <option value="ppl">PPL (6-day)</option>
      <option value="upperlower">Upper / Lower (7-day)</option>
      <option value="fullbody3">Full Body (3-day)</option>
      <option value="bodypart">Body Part Split (7-day)</option>
    </select>
  </label>

  <button id="obRoutineCreateBtn">Create & Edit</button>
</div>

    <div class="notice small muted" style="margin-top:10px;">
      This will open the Routine Editor so you can add exercises.
    </div>
  </section>
</section>

  <!-- HOME SCREEN -->
  <section id="screen-home" class="screen">

  <!-- Quick View -->
  <section class="card">
    <div class="homeHeaderCard">
      <div class="homeTitle">
        <div class="bigTime" id="homeTime">‚Äî</div>
        <div class="smallDate" id="homeDate">‚Äî</div>
      </div>
      <div class="pill">
        <span class="muted">Welcome</span> <strong id="homeName">‚Äî</strong>
      </div>
    </div>
  </section>

  <div class="homeStack">

    <!-- Today workout -->
    <section class="card">
      <div class="topRight">
        <h2 id="homeTodayTitle">TODAY ‚Äî ‚Äî</h2>
        <button class="ghost miniBtn" type="button" data-go="routine">Go to Routine ‚Üí</button>
      </div>
      <ul class="bullets" id="homeTodayList"></ul>
      <div class="notice" id="homeRestNotice" style="margin-top:10px; display:none;">
        Today is marked as a Rest Day.
      </div>
    </section>

    <!-- This week -->
    <section class="card">
      <h2>This Week</h2>

      <div class="weekRow">
        <span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span><span>S</span>
      </div>

      <div class="weekDots" id="homeWeekDots"></div>

     <div class="kpiLine">
  <span class="muted" id="homeWeekCount">‚Äî</span>

  <div style="display:flex; gap:8px; align-items:center;">
    <button class="miniBtn" type="button" id="homeCheckInBtn">‚úÖ Check In</button>
    <button class="ghost miniBtn" type="button" data-go="attendance">Attendance ‚Üí</button>
  </div>
</div>
    </section>

    <!-- Focus -->
    <section class="card">
  <h2>Focus This Week</h2>

  <div class="proCircleWrap" style="margin-top:10px;">
    <div class="proCircle tap" id="homeProteinCircle" data-go="protein" role="button" tabindex="0" aria-label="Open Protein screen">
      <div class="proCircleInner">
        <div class="big" id="homeProteinLeft">‚Äî</div>
        <div class="small">g left</div>
      </div>
    </div>

    <div class="notice" id="homeFocus" style="flex:1;">‚Äî</div>
  </div>
</section>

    <!-- Navigation tiles -->
    <section class="card">
      <div class="homeGrid">
        <button class="card tap" data-go="weight">üìâ Weight</button>
        <button class="card tap" data-go="attendance">üìÖ Attendance</button>
        <button class="card tap" data-go="protein">üçó Protein</button>
        <button class="card tap" data-go="routine">üóìÔ∏è Routine</button>
        <button class="card tap" data-go="lifts">üìà Progress</button>
        <button class="card tap" data-go="settings">‚öôÔ∏è Settings</button>
      </div>
    </section>

  </div>
</section>


  <!-- WEIGHT SCREEN -->
  <section id="screen-weight" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Weight</h2>
    </div>

    <!-- WEIGHT CARD (your original card restored) -->
    <section class="card">
      <div class="topRight">
  <h2>Weekly Weight Tracker</h2>
  <div class="row" style="gap:6px;">
    <button id="bwViewTableBtn" class="miniBtn">Table</button>
    <button id="bwViewGraphBtn" class="miniBtn ghost">Graph</button>
  </div>
</div>


      <div class="row">
        <label>Date
          <input type="date" id="bwDate" />
        </label>
        <label>Bodyweight (lbs)
          <input type="number" id="bwVal" placeholder="e.g., 198.6" step="0.1" />
        </label>
      <button id="bwAddBtn" class="tap">Add</button>
      </div>

      <div class="btnRow">
        <span class="pill"><span class="muted">Latest:</span> <strong class="mono" id="bwLatest">‚Äî</strong></span>
        <span class="pill"><span class="muted">Last Œî:</span> <strong class="mono" id="bwDelta">‚Äî</strong></span>
        <span class="pill"><span class="muted">7-day avg:</span> <strong class="mono" id="bwAvg">‚Äî</strong></span>
      </div>

  <div id="bwChartWrap" style="margin-top:10px; display:none;">
  <canvas id="bwChart" height="120"></canvas>
</div>

<div id="bwTableWrap" style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>BW (lbs)</th>
              <th>Prev</th>
              <th>Œî</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="bwTable"></tbody>
        </table>
      </div>
    </section>
  </section>

  <!-- ATTENDANCE SCREEN -->
  <section id="screen-attendance" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Attendance</h2>
    </div>

    <section class="card">
      <div class="topRight">
        <h2>Attendance (Tap days you went)</h2>
        <div class="row" style="gap:6px;">
          <button id="prevMonthBtn">‚óÄ</button>
          <span class="pill"><strong id="calTitle">‚Äî</strong></span>
          <button id="nextMonthBtn">‚ñ∂</button>
        </div>
      </div>

      <div class="calendar" id="calGrid"></div>

      <div class="btnRow">
        <span class="pill"><span class="muted">This month:</span> <strong class="mono" id="calCount">0</strong></span>
        <button id="clearMonthBtn">Clear This Month</button>
      </div>

      <div class="notice" style="margin-top:10px;">
        Tap days you trained. This calendar only tracks workout attendance.
      </div>
    </section>
  </section>

  <!-- PROTEIN SCREEN -->
  <section id="screen-protein" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Protein</h2>
    </div>

    <section class="card">
      <h2 id="proteinTitle">Protein Intake</h2>
      <div class="row">
        <label>Date
          <input type="date" id="pDate" />
        </label>
        <label>Morning (g)
          <input type="number" id="pMorning" placeholder="0" />
        </label>
        <label>Lunch (g)
          <input type="number" id="pLunch" placeholder="0" />
        </label>
        <label>Pre-Gym (g)
          <input type="number" id="pPre" placeholder="0" />
        </label>
        <label>Dinner (g)
          <input type="number" id="pDinner" placeholder="0" />
        </label>
        <label>Bedtime (g)
          <input type="number" id="pBed" placeholder="0" />
        </label>
<button id="pSaveBtn" class="primary tap" type="button">Save</button>
      </div>

      <div class="btnRow">
        <span class="pill"><span class="muted">Total:</span> <strong class="mono" id="pTotal">0</strong>g</span>
        <span class="pill"><span class="muted">Remaining:</span> <strong class="mono" id="pRemain">0</strong>g</span>
        <span class="pill"><span class="muted">Status:</span> <strong id="pStatus">‚Äî</strong></span>
      </div>
    </section>
  </section>

  <!-- ROUTINE SCREEN -->
  <section id="screen-routine" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Routine</h2>
    </div>

    <section class="card">
      <div class="topRight">
        <div>
          <h2 style="margin-bottom:6px;">Routine (Mon‚ÄìSun)</h2>
          <div class="small muted" id="activeRoutineMeta">‚Äî</div>
        </div>

        <div class="row" style="gap:6px;">
          <label style="min-width:220px; flex:0 0 auto;">
            Active Routine
            <select id="routineSelect"></select>
          </label>

          <button id="newRoutineBtn" class="miniBtn">New</button>
          <button id="editRoutineBtn" class="miniBtn">Edit</button>
          <button id="dupRoutineBtn" class="miniBtn">Duplicate</button>
          <button id="delRoutineBtn" class="miniBtn danger">Delete</button>

          <button id="startTodayBtn" class="miniBtn">Start Today</button>
        </div>
      </div>

      <div class="splitTabs" id="pplTabs"></div>
      <div class="exerciseList" id="pplList"></div>

      <div class="notice" style="margin-top:10px;">
        Tip: Tap ‚ÄúLog Sets‚Äù on an exercise to record sets/reps/weight. PR is based on your lifetime max for that exercise.
      </div>
    </section>
  </section>

  <!-- LIFTS SCREEN -->
  <section id="screen-lifts" class="screen">
    <div class="screenTop">
      <button class="ghost" type="button" data-home>‚Üê Back</button>
      <h2 style="margin:0;">Progress</h2>
    </div>

    <section class="card">
      <div class="topRight">
        <h2>Lift Progress Log</h2>
        <div class="row" style="gap:6px;">
          <button id="liftViewTableBtn" class="miniBtn">Table</button>
          <button id="liftViewGraphBtn" class="miniBtn ghost">Graph</button>
          <button id="liftDownloadBtn" class="miniBtn ghost" title="Download current graph">Download PNG</button>
        </div>
      </div>

      <div class="row">
        <label>Exercise
          <select id="liftSearch"></select>
        </label>

        <label>Routine
          <select id="liftRoutine"></select>
        </label>

        <label>Date From
          <input type="date" id="liftFrom" />
        </label>

        <label>Date To
          <input type="date" id="liftTo" />
        </label>
      </div>

      <div class="row" style="margin-top:8px;">
        <label>Metric (Graph)
          <select id="liftMetric">
            <option value="top" selected>Top Weight</option>
            <option value="e1rm">Estimated 1RM (Epley)</option>
            <option value="vol">Volume</option>
          </select>
        </label>

        <label>Rows (Table)
          <select id="liftLimit">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="0">All</option>
          </select>
        </label>

        <button id="liftSearchBtn">Search</button>
        <button id="liftClearBtn" class="ghost">Clear</button>
      </div>

      <div id="liftTableWrap" style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Exercise</th>
              <th>Top Set</th>
              <th>Sets</th>
              <th>PR</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="liftTable"></tbody>
        </table>
      </div>

      <div id="liftGraphWrap" style="margin-top:10px; display:none;">
        <canvas id="liftChart" height="140"></canvas>
        <div class="notice" style="margin-top:10px;">
          Weekly separators are shown as vertical lines for easier progress blocks.
        </div>
      </div>

      <div class="notice" style="margin-top:10px;">
        Tap an exercise name in the table to view history.
      </div>
    </section>
  </section>

  <!-- SETTINGS SCREEN -->
<section id="screen-settings" class="screen">
  <div class="screenTop">
    <button class="ghost" type="button" data-home>‚Üê Back</button>
    <h2 style="margin:0;">Settings</h2>
  </div>

  <!-- Profile -->
  <section class="card">
    <h2>Profile</h2>
    <div class="row">
      <label>Name (optional)
        <input id="setName" placeholder="e.g., Jordan" />
      </label>

      <label>Units
        <select id="setUnits">
          <option value="lbs" selected>lbs</option>
        </select>
      </label>

      <label>Protein Goal (g)
        <input id="setProteinGoal" type="number" min="0" placeholder="240" />
      </label>

      <label>Week Starts On
        <select id="setWeekStart">
          <option value="mon" selected>Monday</option>
          <option value="sun">Sunday</option>
        </select>
      </label>

      <label>Hide Rest Days
        <select id="setHideRest">
          <option value="1" selected>ON</option>
          <option value="0">OFF</option>
        </select>
      </label>

      <button id="saveProfileBtn">Save Profile</button>
    </div>
  </section>

  <!-- Import / Backup -->
  <section class="card">
    <h2>Import / Backup</h2>
    <div class="row" style="gap:6px;">
      <button class="miniBtn" id="settingsImportBtn">Import</button>
      <input id="settingsImportFile" type="file" accept="application/json" style="display:none;" />

      <button class="miniBtn" id="backupNowBtn">Backup Now</button>

      <span class="pill">
        <span class="muted">Last Backup:</span>
        <strong class="mono" id="lastBackupText">‚Äî</strong>
      </span>
    </div>

    <div class="notice" style="margin-top:10px;">
      <div><strong>Storage</strong></div>
      <div class="small muted" id="storageInfo">‚Äî</div>
      <div class="small warn" id="storageWarn" style="display:none;">Storage is getting large ‚Äî consider backing up.</div>
    </div>
  </section>

  <!-- Refresh -->
  <section class="card">
    <h2>Refresh</h2>
    <div class="notice">Choose what to refresh (useful after an import or manual edits).</div>

    <div class="row" style="margin-top:10px;">
      <label><span class="muted">Routine</span>
        <select id="rfRoutine"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>
      <label><span class="muted">Progress</span>
        <select id="rfLifts"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>
      <label><span class="muted">Weight</span>
        <select id="rfWeight"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>
      <label><span class="muted">Attendance</span>
        <select id="rfAttendance"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>
      <label><span class="muted">Protein</span>
        <select id="rfProtein"><option value="1" selected>Yes</option><option value="0">No</option></select>
      </label>

      <button id="runRefreshBtn">Refresh Selected</button>
    </div>
  </section>

  <!-- Reset -->
  <section class="card">
    <h2>Reset</h2>
    <div class="notice">
      This clears everything on this device/browser.
      <div class="small muted">Tip: Backup first.</div>
    </div>

    <div class="btnRow">
      <button id="settingsResetBtn" class="danger">Reset ALL Data</button>
    </div>
  </section>
</section>


  <!-- ‚úÖ KEEP YOUR MODALS EXACTLY AS-IS BELOW -->
  <!-- LOG SETS MODAL -->
  <div id="logModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
    <div style="max-width:520px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
      <div class="topRight">
        <div>
          <h2 style="margin:0;">Log Sets</h2>
          <div class="small muted" id="logRoutineLine">‚Äî</div>
        </div>
      </div>

      <div class="notice" style="margin-top:10px;">
        <div><strong id="logModalExercise">‚Äî</strong></div>
        <div class="small muted">Enter what you actually did. Add/remove sets as needed.</div>
      </div>

      <div id="logPrevBox" class="notice" style="margin-top:10px; display:none;">
        <div class="small muted">Last time:</div>
        <div id="logPrevText" class="mono">‚Äî</div>
        <div class="btnRow" style="margin-top:8px;">
          <button id="logCopyLastBtn" type="button">Copy last time</button>
          <button id="logViewHistoryBtn" type="button" class="ghost">View history</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Date
          <input type="date" id="logModalDate" />
        </label>
      </div>

      <div id="logModalSets" style="margin-top:10px; display:grid; gap:8px;"></div>

     <div class="btnRow">
  <button id="logAddSetBtn" class="tap">Add Set</button>
  <button id="logSaveBtn" class="tap">Confirm & Save</button>
  <button id="logModalClose" class="tap ghost" type="button">Close</button>
</div>
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div id="histModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
    <div style="max-width:640px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
      <div class="topRight">
        <h2 style="margin:0;">Exercise History</h2>
        <button id="histCloseBtn">Close</button>
      </div>

      <div class="notice" style="margin-top:10px;">
        <div><strong id="histExercise">‚Äî</strong></div>
        <div class="small muted">Most recent first. Shows your saved set details (if available).</div>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Top Set</th>
              <th>All Sets</th>
              <th>PR</th>
            </tr>
          </thead>
          <tbody id="histTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ROUTINE EDITOR MODAL -->
<div id="rtModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
  <div style="max-width:760px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px;">
    
    <!-- Sticky Header -->
    <div class="rtHead">
      <h2>Routine Editor</h2>
      <button id="rtCloseBtn" class="rtClose ghost" type="button">Close</button>
    </div>

    <div class="rtBody">
      <div class="row" style="margin-top:10px;">
        <label>Routine Name
          <input id="rtName" placeholder="e.g., PPL (6 days)" />
        </label>
      </div>

      <div class="divider"></div>

      <div class="splitTabs" id="rtDayTabs"></div>

      <div class="row" style="margin-top:8px;">
        <label style="min-width:220px; flex:0 0 auto;">Day Label (optional)
          <input id="rtDayLabel" placeholder="e.g., Push / Pull / Legs / Upper" />
        </label>

        <label style="min-width:220px; flex:0 0 auto;">Rest Day?
          <select id="rtRestToggle">
            <option value="0" selected>No</option>
            <option value="1">Yes (hide day)</option>
          </select>
        </label>
      </div>

      <div id="rtDayRestNotice" class="notice" style="margin-top:10px; display:none;">
        This day is marked as a Rest Day. Exercises are kept but hidden on the dashboard.
      </div>

      <div class="divider"></div>

      <!-- Add Exercise CTA tile -->
      <div class="rtAddWrap" style="margin-top:10px;">
        <div class="rtPick">
          <label style="min-width:260px; width:100%;">Add Exercise
            <input id="rtAddExName" list="rtExSuggestions" placeholder="Tap to pick an exercise..." readonly />
            <datalist id="rtExSuggestions"></datalist>
          </label>
          <div class="hint">Tap to choose from your library</div>
        </div>

        <label style="width:110px;">Sets
          <input id="rtAddExSets" type="number" min="1" placeholder="3" />
        </label>

        <label style="width:140px;">Reps
          <input id="rtAddExReps" placeholder="8‚Äì10" />
        </label>

        <button id="rtAddExBtn" class="tap">Add</button>
        <button id="rtAddMultiBtn" class="ghost tap" type="button">Add Multiple</button>
      </div>

      <div id="rtExList" style="margin-top:12px; display:grid; gap:10px;"></div>

      <div class="notice" style="margin-top:10px;">
        Swap replaces an exercise only for this day. Reorder uses Up/Down.
      </div>
    </div>

    <!-- Sticky Footer -->
    <div class="rtFooter">
      <button id="rtCancelBtn" class="ghost tap" type="button">Cancel</button>
      <button id="rtSaveBtn" class="tap" type="button">Save Routine</button>
    </div>

  </div>
</div>

  <!-- EXERCISE PICKER MODAL -->
<div id="exPickModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
  <div style="max-width:520px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
    <div class="topRight">
      <h2 style="margin:0;" id="exPickTitle">Pick Exercise</h2>
      <button id="exPickCloseBtn">Close</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <label style="min-width:220px; flex:1 1 220px;">Search
        <input id="exPickSearch" placeholder="Type to filter..." />
      </label>
    </div>

    <div id="exPickList"></div>

    <div class="btnRow">
      <button id="exPickConfirmBtn">Confirm</button>
      <button id="exPickCancelBtn" class="ghost">Cancel</button>
    </div>
  </div>
</div>

  <!-- BATCH ADD MODAL (Multi-add sets/reps screen) -->
<div id="batchAddModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
  <div style="max-width:640px; margin:16px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
    <div class="topRight">
      <h2 style="margin:0;">Add Multiple Exercises</h2>
      <button id="batchAddCloseBtn" type="button">Close</button>
    </div>

    <div class="notice" style="margin-top:10px;">
      <div class="small muted">Set the Sets + Reps for each exercise, then confirm.</div>
    </div>

    <div id="batchAddList" style="margin-top:10px; display:grid; gap:8px;"></div>

    <div class="btnRow">
      <button id="batchAddConfirmBtn" type="button">Add to Day</button>
      <button id="batchAddCancelBtn" type="button" class="ghost">Cancel</button>
    </div>
  </div>
</div>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ---------------------------
   Storage helpers (hardened)
---------------------------- */
const LS = {
  get(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(raw === null || raw === undefined || raw === "") return fallback;
      return JSON.parse(raw);
    }catch(e){
      console.warn(`[LS.get] Corrupt JSON for key "${key}"`, e);
      return fallback;
    }
  },
  set(key, value){
    try{
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    }catch(e){
      // Quota exceeded / private mode / storage blocked
      console.error(`[LS.set] Failed to write key "${key}"`, e);
      alert("Storage is full or blocked in this browser. Free up space or disable private mode.");
      return false;
    }
  },
  remove(key){
    try{ localStorage.removeItem(key); }catch{}
  }
};

// Small guards
function isPlainObject(x){
  return !!x && typeof x === "object" && !Array.isArray(x);
}
function safeISODate(s){
  const v = String(s || "").trim();
  // Expect YYYY-MM-DD
  return /^\d{4}-\d{2}-\d{2}$/.test(v) ? v : null;
}
function toNum(x, fallback=0){
  const n = Number(x);
  return Number.isFinite(n) ? n : fallback;
}


  /* ---------------------------
   DOM helpers
---------------------------- */
const $  = (id)=>document.getElementById(id);
const $$ = (sel, root=document)=>[...root.querySelectorAll(sel)];

const KEY_BW = "gym_bw_logs_v1";
const KEY_ATT = "gym_attendance_v1";
const KEY_PRO = "gym_protein_v1";
const KEY_LIFTS = "gym_lifts_v1";
const KEY_TARGETS = "gym_targets_v1";

const KEY_ROUTINES = "gym_routines_v1";
const KEY_ACTIVE_ROUTINE = "gym_active_routine_id_v1";
const KEY_PROFILE = "gym_profile_v1";
const KEY_LAST_BACKUP = "gym_last_backup_v1";
const KEY_ONBOARD_DONE = "gym_onboard_done_v1";
const KEY_CUSTOM_EX = "gym_custom_ex_v1";
const KEY_APP_VERSION = "gym_app_version_v1"; // ‚úÖ ADD THIS

  /* ---------------------------
   Core state loaders (sanitize + self-heal)
---------------------------- */
function loadBWLogs(){
  const raw = LS.get(KEY_BW, []);
  if(!Array.isArray(raw)) return [];
  const cleaned = raw.map(x=>({
    date: safeISODate(x?.date),
    value: toNum(x?.value, toNum(x?.bw, null))
  }))
  .filter(x=>x.date && Number.isFinite(x.value));
  LS.set(KEY_BW, cleaned);
  return cleaned;
}

function loadAttendance(){
  const raw = LS.get(KEY_ATT, []);
  if(!Array.isArray(raw)) return new Set();
  const cleaned = raw.map(safeISODate).filter(Boolean);
  LS.set(KEY_ATT, cleaned);
  return new Set(cleaned);
}

function loadProteinMap(){
  const raw = LS.get(KEY_PRO, {});
  if(!isPlainObject(raw)) return {};
  const out = {};
  for(const [k,v] of Object.entries(raw)){
    const d = safeISODate(k);
    if(!d || !isPlainObject(v)) continue;
    out[d] = {
      morning: toNum(v.morning, 0),
      lunch:   toNum(v.lunch, 0),
      pre:     toNum(v.pre, 0),
      dinner:  toNum(v.dinner, 0),
      bed:     toNum(v.bed, 0)
    };
  }
  LS.set(KEY_PRO, out);
  return out;
}

function loadLifts(){
  const raw = LS.get(KEY_LIFTS, []);
  if(!Array.isArray(raw)) return [];
  const cleaned = raw.map(x=>({
    id: x?.id || uid(),
    date: safeISODate(x?.date),
    routineId: (typeof x?.routineId === "string") ? x.routineId : null,
    routineName: (typeof x?.routineName === "string") ? x.routineName : "",
    dayKey: (typeof x?.dayKey === "string") ? x.dayKey : "",
    exercise: String(x?.exercise || x?.name || "").trim(),
    top: toNum(x?.top, toNum(x?.weight, 0)),
    e1rm: toNum(x?.e1rm, 0),
    volume: toNum(x?.volume, 0),
    details: Array.isArray(x?.details) ? x.details : []
  }))
  .filter(x=>x.date && x.exercise);
  LS.set(KEY_LIFTS, cleaned);
  return cleaned;
}

function reloadCoreState(){
  profile = loadProfile();
  ({routines, activeId: activeRoutineId} = loadRoutines());

  bwLogs = loadBWLogs();
  attendance = loadAttendance();
  proteinMap = loadProteinMap();
  lifts = loadLifts();

  ensureLiftCompatibility();
  migrateCanonicalNames();
}



let modalDepth = 0;

// iOS-safe scroll freeze
let __scrollY = 0;
let __lockApplied = false;

function lockBodyScroll(){
  // Only apply the body lock once (first modal)
  if(modalDepth === 0 && !__lockApplied){
    __scrollY = window.scrollY || 0;

    // Add your existing class (keeps your CSS behavior)
    document.body.classList.add("modalOpen");

    // iOS: overflow hidden alone can still allow ‚Äúbounce‚Äù/jump.
    // Pin body in place to prevent background movement.
    document.body.style.position = "fixed";
    document.body.style.top = `-${__scrollY}px`;
    document.body.style.left = "0";
    document.body.style.right = "0";
    document.body.style.width = "100%";

    __lockApplied = true;
  }

  modalDepth++;
}

function unlockBodyScroll(){
  modalDepth = Math.max(0, modalDepth - 1);

  // Only release when the last modal closes
  if(modalDepth === 0 && __lockApplied){
    document.body.classList.remove("modalOpen");

    // Restore body scroll position safely
    document.body.style.position = "";
    document.body.style.top = "";
    document.body.style.left = "";
    document.body.style.right = "";
    document.body.style.width = "";

    window.scrollTo(0, __scrollY);
    __lockApplied = false;
  }
}

  /* ---------------------------
   Modal controller (hardened)
   - overlay click close
   - ESC close topmost
   - prevents modalDepth desync
---------------------------- */

let __modalBound = false;

// True if modal is currently visible (matches your display-based approach)
function isModalVisible(el){
  return !!el && el.style && el.style.display === "block";
}

// Open/Close wrappers to keep lock/unlock consistent
function openModalEl(el){
  if(!el) return;
  if(isModalVisible(el)) return; // prevent double-open increments
  lockBodyScroll();
  el.style.display = "block";
}

function closeModalEl(el){
  if(!el) return;
  if(!isModalVisible(el)) return; // prevent double-close decrements
  el.style.display = "none";
  unlockBodyScroll();
}

// Close ‚Äútopmost‚Äù modal by priority (last opened tends to be these)
function closeTopModal(){
  // NOTE: order matters: child modals first
  if(typeof closeBatchAddModal === "function" && isModalVisible(batchAddModal)) return closeBatchAddModal();
  if(typeof closeExercisePicker === "function" && isModalVisible(exPickModal)) return closeExercisePicker();
  if(typeof closeRoutineEditor === "function" && isModalVisible(rtModal)) return closeRoutineEditor();
  if(typeof closeHistoryModal === "function" && isModalVisible(histModal)) return closeHistoryModal();
  if(typeof closeLogModal === "function" && isModalVisible(logModal)) return closeLogModal();
}

function bindModalSystem(){
  if(__modalBound) return;
  __modalBound = true;

  // ESC closes the topmost visible modal
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      closeTopModal();
    }
  });

  // Overlay click closes any modal when clicking the overlay itself
  // (we attach listeners once the elements exist; safe to call after DOM refs are defined)
  const bindOverlay = (modalEl, closeFn)=>{
    if(!modalEl || typeof closeFn !== "function") return;
    modalEl.addEventListener("click", (e)=>{
      if(e.target === modalEl) closeFn();
    });
  };

  // These variables exist in your file as DOM refs:
  // logModal, histModal, rtModal, exPickModal, batchAddModal
  bindOverlay(logModal, closeLogModal);
  bindOverlay(histModal, closeHistoryModal);
  bindOverlay(rtModal, closeRoutineEditor);
  bindOverlay(exPickModal, closeExercisePicker);
  bindOverlay(batchAddModal, closeBatchAddModal);
}


  /* ---------------------------
   Global State (safe defaults)
---------------------------- */
let profile = defaultProfile();
let routines = [];
let activeRoutineId = null;

let bwLogs = [];
let attendance = new Set();
let proteinMap = {};
let lifts = [];

  /* ---------------------------
   SETTINGS bindings
---------------------------- */
const setName = document.getElementById("setName");
const setProteinGoal = document.getElementById("setProteinGoal");
const setWeekStart = document.getElementById("setWeekStart");
const setHideRest = document.getElementById("setHideRest");
const saveProfileBtn = document.getElementById("saveProfileBtn");

const storageInfo = document.getElementById("storageInfo");
const storageWarn = document.getElementById("storageWarn");
const runRefreshBtn = document.getElementById("runRefreshBtn");

function bytesToNice(n){
  if(!isFinite(n)) return "0 B";
  const u = ["B","KB","MB","GB"];
  let i=0, v=n;
  while(v>=1024 && i<u.length-1){ v/=1024; i++; }
  return `${v.toFixed(i===0?0:1)} ${u[i]}`;
}

function renderStorageInfo(){
  if(!storageInfo) return;

  let totalBytes = 0;
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    const v = localStorage.getItem(k) || "";
    totalBytes += (k.length + v.length) * 2; // rough UTF-16 bytes
  }

  storageInfo.textContent = `Approx localStorage size: ${bytesToNice(totalBytes)} ‚Ä¢ Keys: ${localStorage.length}`;

  if(storageWarn){
    storageWarn.style.display = (totalBytes > 3_000_000) ? "block" : "none"; // ~3MB warning
  }
}

function hydrateSettingsUI(){
  if(setName) setName.value = profile.name || "";
  if(setProteinGoal) setProteinGoal.value = String(getProteinGoal());
  if(setWeekStart) setWeekStart.value = profile.weekStart || "mon";
  if(setHideRest) setHideRest.value = profile.hideRestDays ? "1" : "0";
}

saveProfileBtn?.addEventListener("click", ()=>{
  saveProfile({
    name: String(setName?.value || "").trim(),
    proteinGoal: Number(setProteinGoal?.value || 240) || 240,
    weekStart: (setWeekStart?.value === "sun") ? "sun" : "mon",
    hideRestDays: (setHideRest?.value === "0") ? false : true
  });

  // update protein screen title immediately
  const pt = document.getElementById("proteinTitle");
  if(pt) pt.textContent = `Protein Intake (Goal ${getProteinGoal()}g)`;

  hydrateSettingsUI();
  renderStorageInfo();
  alert("Profile saved ‚úÖ");
});

runRefreshBtn?.addEventListener("click", ()=>{
  const rRoutine = document.getElementById("rfRoutine")?.value === "1";
  const rLifts   = document.getElementById("rfLifts")?.value === "1";
  const rWeight  = document.getElementById("rfWeight")?.value === "1";
  const rAtt     = document.getElementById("rfAttendance")?.value === "1";
  const rPro     = document.getElementById("rfProtein")?.value === "1";

  if(rWeight) renderBW();
  if(rAtt) renderCal();
  if(rPro) loadProteinDay(pDate.value || todayISO());

  if(rRoutine){
    renderRoutineDropdown();
    renderPPL();
    buildRoutineExerciseSuggestions();
  }
  if(rLifts){
    renderLiftSearchDropdown();
    renderLiftRoutineDropdown();
    applyLiftFiltersFromUI();
    renderLifts();
  }

  refreshHome();
  renderStorageInfo();
  alert("Refreshed ‚úÖ");
});

const obName = document.getElementById("obName");
const obUnits = document.getElementById("obUnits");
const obProteinGoal = document.getElementById("obProteinGoal");
const obWeekStart = document.getElementById("obWeekStart");
const obHideRest = document.getElementById("obHideRest");
const obProfileNextBtn = document.getElementById("obProfileNextBtn");

const obRoutineBackBtn = document.getElementById("obRoutineBackBtn");
const obRoutineName = document.getElementById("obRoutineName");
const obRoutineCreateBtn = document.getElementById("obRoutineCreateBtn");
const obRoutineTemplate = document.getElementById("obRoutineTemplate");

// Seed onboarding inputs from existing profile (if any)
function hydrateOnboardingInputs(){
  if(!obName) return;
  obName.value = profile.name || "";
  obProteinGoal.value = String(getProteinGoal());
  obWeekStart.value = profile.weekStart || "mon";
  obHideRest.value = profile.hideRestDays ? "1" : "0";
}

obProfileNextBtn?.addEventListener("click", ()=>{
  const nm = String(obName?.value || "").trim();
  if(!nm){
    alert("Please enter a name to continue.");
    obName?.focus?.();
    return;
  }

  // sanitize + protect against invalid numbers
  const proteinGoal = Number(obProteinGoal?.value);
  const cleanedProtein = Number.isFinite(proteinGoal) && proteinGoal >= 0 ? proteinGoal : 240;

  saveProfile({
    name: nm,
    proteinGoal: cleanedProtein,
    weekStart: (obWeekStart?.value === "sun") ? "sun" : "mon",
    hideRestDays: (obHideRest?.value === "0") ? false : true
  });

  // If profile exists but onboarding not done, go to routine creation
  if(!isOnboardingDone()){
    showScreen("onboard-routine");
  }else{
    showScreen("home");
  }
});


obRoutineBackBtn?.addEventListener("click", ()=>{
  showScreen("profile");
});

obRoutineCreateBtn?.addEventListener("click", ()=>{
  if(!hasProfileCompleted()){
    showScreen("profile");
    return;
  }

  const name = String(obRoutineName?.value || "").trim() || "My Routine";
  const tpl = String(obRoutineTemplate?.value || "blank");

  let base;

  if(tpl === "upperlower"){
    base = makeUpperLowerTemplate();
  } else if(tpl === "fullbody3"){
    base = makeFullBody3Template();
  } else if(tpl === "bodypart"){
    base = makeBodyPartTemplate();
  } else if(tpl === "ppl"){
    base = defaultRoutine();
  } else {
    base = defaultRoutine();
    base.name = "Routine";
    DAY_KEYS.forEach(k=>{
      base.days[k].exercises = [];
      base.days[k].rest = false;
      base.days[k].label = "";
    });
  }

  // ‚úÖ deep-copy so template object never gets mutated elsewhere
  base = JSON.parse(JSON.stringify(base));

  base.name = name;
  base.source = "onboarding";
  base.id = uid();

  // ‚úÖ prevent duplicate inserts from double-clicks
  const exists = routines.some(r => r.id === base.id);
  if(!exists){
    routines.push(base);
    saveRoutines();
  }else{
    // extremely unlikely (uid collision), but safe
    saveRoutines();
  }

  // mark onboarding complete
  if(!isOnboardingDone()) setOnboardingDone();

  // set as active routine
  setActiveRoutine(base.id);

  // go to routine screen first
  showScreen("routine");

  // ensure dropdown + list are correct right away
  renderRoutineDropdown(base.id);
  activeDayIndex = getTodaySplitIndex();
  renderPPL();
  buildRoutineExerciseSuggestions();

  // then open editor
  try{
    openRoutineEditor(base.id);
  }catch(e){
    console.warn("Routine editor failed to open after onboarding.", e);
  }
});


  /* ---------------------------
   Profile (Onboarding base)
---------------------------- */
function defaultProfile(){
  return {
    name: "",
    units: "lbs",        // ‚úÖ lbs only
    proteinGoal: 240,
    weekStart: "mon",    // "mon" | "sun"
    hideRestDays: true
  };
}


function loadProfile(){
  const raw = LS.get(KEY_PROFILE, null);
  const base = {
    name: "",
    goalWeight: "",
    proteinGoal: 160
  };

  if(!raw || typeof raw !== "object") return base;

  const name = String(raw.name || "").trim();
  const goalWeight = (raw.goalWeight === null || raw.goalWeight === undefined) ? "" : String(raw.goalWeight).trim();
  const proteinGoal = toNum(raw.proteinGoal, base.proteinGoal);

  const cleaned = {
    ...base,
    name,
    goalWeight,
    proteinGoal: Math.max(0, proteinGoal)
  };

  // Self-heal storage
  LS.set(KEY_PROFILE, cleaned);
  return cleaned;
}



function saveProfile(next){
  profile = {
    ...profile,
    ...next
  };
  LS.set(KEY_PROFILE, profile);
  renderHeaderSub();
  refreshHome();
  hydrateSettingsUI(); // ‚úÖ add this line
}


function renderHeaderSub(){
  const sub = document.getElementById("headerSub");
  if(!sub) return;

  const restTxt = profile?.hideRestDays ? "Rest days hidden" : "Rest days shown";
  const goal = Number(profile?.proteinGoal || 240) || 240;

  const v = localStorage.getItem(KEY_APP_VERSION) || "";

  sub.textContent =
    `Minimal tracker ‚Ä¢ Protein goal ${goal}g ‚Ä¢ ${restTxt}` +
    (v ? ` ‚Ä¢ v${v}` : "");
}




// Replace PRO_GOAL usage with this
function getProteinGoal(){
  return Number(profile.proteinGoal || 240) || 240;
}

  /* ---------------------------
   Focus helpers (Recovery / Stalled / Weekly countdown)
---------------------------- */
function addDaysISO(iso, delta){
  const d = parseISO(iso);
  d.setDate(d.getDate() + delta);
  return localISODate(d);
}

function getProteinTotalForDate(iso){
  const obj = proteinMap?.[iso] || {morning:0,lunch:0,pre:0,dinner:0,bed:0};
  return (Number(obj.morning)||0)+(Number(obj.lunch)||0)+(Number(obj.pre)||0)+(Number(obj.dinner)||0)+(Number(obj.bed)||0);
}

function routineWeeklyTargetDays(routineObj){
  // counts how many days in the routine are NOT rest days
  let n = 0;
  DAY_KEYS.forEach(k=>{
    const day = routineObj?.days?.[k];
    if(day && !day.rest) n++;
  });
  // fallback so it never becomes 0
  return Math.max(1, n);
}

function isStalledExercise(exName, lookback=3){
  const n = normExName(exName);
  const exLifts = lifts
    .filter(x => (x.exNorm || normExName(x.ex)) === n)
    .sort((a,b)=> b.date.localeCompare(a.date))
    .slice(0, lookback);

  // need at least 3 sessions to call it "stalled"
  if(exLifts.length < lookback) return false;

  const weights = exLifts.map(x=>Number(x.weight)||0);
  const maxW = Math.max(...weights);
  const newest = weights[0];

  // stalled = newest is not the best of the last 3
  return newest < maxW || newest === maxW; // (still stalled if it‚Äôs flat)
}

function pickStalledExerciseFromToday(todayExercises){
  for(const ex of (todayExercises || [])){
    if(ex?.name && isStalledExercise(ex.name, 3)){
      return ex.name;
    }
  }
  return "";
}
  
  /* ---------------------------
   HOME screen logic
---------------------------- */
const homeTime = document.getElementById("homeTime");
const homeDate = document.getElementById("homeDate");
const homeName = document.getElementById("homeName");
const homeTodayTitle = document.getElementById("homeTodayTitle");
const homeTodayList = document.getElementById("homeTodayList");
const homeRestNotice = document.getElementById("homeRestNotice");
const homeWeekDots = document.getElementById("homeWeekDots");
const homeWeekCount = document.getElementById("homeWeekCount");
const homeFocus = document.getElementById("homeFocus");
const homeProteinCircle = document.getElementById("homeProteinCircle");
const homeProteinLeft = document.getElementById("homeProteinLeft");


function fmtTimeNow(){
  const d = new Date();
  return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
}
function fmtDateNow(){
  const d = new Date();
  return d.toLocaleDateString([], { weekday:"long", month:"short", day:"numeric" });
}

function dateISOFrom(baseDate, offsetDays){
  const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
  d.setDate(d.getDate() + offsetDays);
  return localISODate(d);
}

function refreshHome(){
  // Ensure core objects exist (prevents crashes if storage was wiped/corrupted)
  if(!profile || typeof profile !== "object") profile = loadProfile?.() || { name:"" };
  if(!(attendance instanceof Set)){
    const rawAtt = LS.get(KEY_ATT, []);
    attendance = new Set(Array.isArray(rawAtt) ? rawAtt : []);
  }
  if(!proteinMap || typeof proteinMap !== "object") proteinMap = LS.get(KEY_PRO, {}) || {};

  // time/date/name
  if(homeTime) homeTime.textContent = fmtTimeNow();
  if(homeDate) homeDate.textContent = fmtDateNow();
  if(homeName) homeName.textContent = String(profile.name || "‚Äî").trim() || "‚Äî";

  // active routine safety
  let ar = null;
  try{ ar = getActiveRoutine?.(); }catch{}
  if(!ar || typeof ar !== "object"){
    ar = { days: {} };
    DAY_KEYS.forEach(k => (ar.days[k] = { label:"", rest:false, exercises:[] }));
  }

  // today routine
  let todayIdx = 0;
  try{ todayIdx = getTodaySplitIndex?.() ?? 0; }catch{ todayIdx = 0; }
  todayIdx = Math.max(0, Math.min(6, Number(todayIdx) || 0));

  const dayKey = DAY_KEYS[todayIdx] || "Mon";
  const day = ar.days?.[dayKey] || { label:"", rest:false, exercises:[] };

  const label = String(day.label || "").trim();
  if(homeTodayTitle) homeTodayTitle.textContent = `TODAY ‚Äî ${dayKey}${label ? " ‚Ä¢ " + label : ""}`;

  if(homeTodayList) homeTodayList.innerHTML = "";
  if(homeRestNotice) homeRestNotice.style.display = "none";

  if(day.rest){
    if(homeRestNotice) homeRestNotice.style.display = "block";
  } else {
    const list = Array.isArray(day.exercises) ? day.exercises : [];
    if(homeTodayList){
      if(list.length === 0){
        homeTodayList.innerHTML = `<li class="muted">No exercises added for today.</li>`;
      } else {
        list.slice(0, 6).forEach(ex=>{
          const nm = String(ex?.name || "").trim();
          if(!nm) return;
          const li = document.createElement("li");
          li.textContent = `${nm} ‚Äî ${ex.sets || "‚Äî"} sets ‚Ä¢ ${ex.reps || "‚Äî"} reps`;
          homeTodayList.appendChild(li);
        });
      }
    }
  }

  // ‚úÖ Protein-left circle (today)
  const td = todayISO();
  const obj = proteinMap?.[td] || {morning:0,lunch:0,pre:0,dinner:0,bed:0};
  const total =
    (Number(obj.morning)||0)+
    (Number(obj.lunch)||0)+
    (Number(obj.pre)||0)+
    (Number(obj.dinner)||0)+
    (Number(obj.bed)||0);

  const goal = (typeof getProteinGoal === "function") ? getProteinGoal() : (Number(profile.proteinGoal) || 240);
  const left = Math.max(goal - total, 0);
  const pct = Math.max(0, Math.min(1, goal ? (total/goal) : 0));
  const deg = Math.round(pct * 360);

  if(homeProteinLeft) homeProteinLeft.textContent = String(left);
  if(homeProteinCircle) homeProteinCircle.style.setProperty("--deg", `${deg}deg`);

  // ‚úÖ Home "Check In" button state
  if(homeCheckInBtn){
    const checked = attendance.has(td);
    homeCheckInBtn.textContent = checked ? "‚úÖ Checked In" : "‚úÖ Check In";
    homeCheckInBtn.classList.toggle("ghost", checked);
  }

  // week dots + count
  let weekStart = null;
  try{
    weekStart = (typeof weekStartDate === "function") ? weekStartDate(new Date()) : null;
  }catch{ weekStart = null; }

  // fallback week start if helper missing
  if(!(weekStart instanceof Date)){
    const now = new Date();
    const dow = now.getDay(); // 0=Sun
    const mondayOffset = (dow + 6) % 7; // days since Monday
    weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - mondayOffset);
  }

  const dots = [];
  for(let i=0;i<7;i++){
    try{
      dots.push(dateISOFrom(weekStart, i));
    }catch{
      // last-resort ISO
      const d = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate() + i);
      dots.push(localISODate(d));
    }
  }

  // ‚úÖ FIX: .len -> .length (this was breaking your home screen)
  const attendedCount = dots.filter(d => attendance.has(d)).length;

  if(homeWeekDots){
    homeWeekDots.innerHTML = "";
    dots.forEach(d=>{
      const dot = document.createElement("div");
      dot.className = "wdot " + (attendance.has(d) ? "on" : "off");
      dot.title = d;
      homeWeekDots.appendChild(dot);
    });
  }

  if(homeWeekCount){
    homeWeekCount.textContent = `Workouts this week: ${attendedCount} / 7`;
  }

  // ‚úÖ Focus engine (Recovery warning > Stalled lift > Weekly countdown > Default)
  if(homeFocus){
    const todayIso = td;

    let yesterdayIso = null;
    try{
      yesterdayIso = (typeof addDaysISO === "function") ? addDaysISO(todayIso, -1) : null;
    }catch{ yesterdayIso = null; }

    // fallback if helper missing
    if(!yesterdayIso){
      const t = new Date();
      t.setDate(t.getDate() - 1);
      yesterdayIso = localISODate(t);
    }

    const todayIsRest = !!day.rest;

    const trainedYesterday = attendance.has(yesterdayIso);

    let yProtein = 0;
    try{
      yProtein = (typeof getProteinTotalForDate === "function") ? getProteinTotalForDate(yesterdayIso) : 0;
    }catch{ yProtein = 0; }

    const yLowProtein = yProtein < (goal * 0.75);

    let weeklyTarget = 7;
    try{
      weeklyTarget = (typeof routineWeeklyTargetDays === "function") ? routineWeeklyTargetDays(ar) : 7;
    }catch{ weeklyTarget = 7; }
    weeklyTarget = Math.max(0, Math.min(7, Number(weeklyTarget) || 0));

    const workoutsLeft = Math.max(weeklyTarget - attendedCount, 0);

    const todayExercises = Array.isArray(day.exercises) ? day.exercises : [];
    let stalledName = "";
    try{
      stalledName = (typeof pickStalledExerciseFromToday === "function") ? (pickStalledExerciseFromToday(todayExercises) || "") : "";
    }catch{ stalledName = ""; }

    if(todayIsRest){
      homeFocus.textContent = "Recovery day: mobility + walk. Keep it easy and show up tomorrow.";
    }
    else if(trainedYesterday && yLowProtein){
      homeFocus.textContent =
        "Focus: go lighter today ‚Äî recovery may be limiting performance (trained yesterday + low protein).";
    }
    else if(stalledName){
      homeFocus.textContent =
        `Focus: ${stalledName} looks stalled ‚Äî change stimulus (add reps, slower tempo, or switch variation).`;
    }
    else if(workoutsLeft > 0){
      homeFocus.textContent =
        `Focus: ${workoutsLeft} session${workoutsLeft===1?"":"s"} left to hit your weekly routine goal (${weeklyTarget}).`;
    }
    else {
      if(label) homeFocus.textContent = `Focus: ${label}`;
      else homeFocus.textContent = "Focus: execute clean sets + progressive overload.";
    }
  }
}
  const homeCheckInBtn = document.getElementById("homeCheckInBtn");

function toggleTodayAttendance(){
  const today = todayISO();

  if(!(attendance instanceof Set)){
    const rawAtt = LS.get(KEY_ATT, []);
    attendance = new Set(Array.isArray(rawAtt) ? rawAtt : []);
  }

  if(attendance.has(today)){
    attendance.delete(today);
  } else {
    attendance.add(today);
  }

  LS.set(KEY_ATT, [...attendance]);

  // refresh the home UI immediately
  refreshHome();

  // keep calendar UI accurate if available
  if(typeof renderCal === "function"){
    try{ renderCal(); }catch{}
  }
}


homeCheckInBtn?.addEventListener("click", toggleTodayAttendance);
/* ---------------------------
   Screen Router (Option A) ‚Äî FIXED
---------------------------- */
const KEY_ACTIVE_SCREEN = "gym_active_screen_v1";

const onEnterScreen = {
  home: () => {
    refreshHome();
  },

  weight: () => {
    renderBW();
  },

  attendance: () => {
    renderCal();
  },

  protein: () => {
  if(pDate) pDate.value = todayISO();
  loadProteinDay(pDate?.value || todayISO());

  const pt = document.getElementById("proteinTitle");
  if (pt) pt.textContent = `Protein Intake (Goal ${getProteinGoal()}g)`;
},
  routine: () => {
    renderRoutineDropdown();
    renderPPL();
    buildRoutineExerciseSuggestions(); // ‚úÖ optional but recommended
  },

  lifts: () => {
    renderLiftSearchDropdown();
    renderLiftRoutineDropdown();
    renderLifts();
  },

  settings: () => {
    hydrateSettingsUI();
    renderStorageInfo();
    renderLastBackup();
  }
};

function normalizeScreenName(name){
  return String(name ?? "").trim();
}

function getScreenEl(name){
  const n = normalizeScreenName(name);
  if(!n) return null;
  return document.getElementById(`screen-${n}`);
}

function showScreen(name){
  // Normalize + validate first (prevents hard crashes on bad state)
  let screenName = normalizeScreenName(name);
  let el = getScreenEl(screenName);

  // ‚úÖ fallback if invalid screen name stored / passed
  if(!el){
    screenName = "home";
    el = document.getElementById("screen-home");
    if(!el){
      // If even home is missing, fail silently instead of breaking the app.
      return;
    }
  }

  // Remove active (only if we have a valid target)
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  el.classList.add("active");

  // Persist last screen (keeps existing behavior)
  localStorage.setItem(KEY_ACTIVE_SCREEN, screenName);

  // iOS Safari behaves better scrolling the document element
  (document.scrollingElement || document.documentElement).scrollTo(0, 0);

  // Screen-specific hooks should never be allowed to break navigation
  try{
    onEnterScreen[screenName]?.();
  }catch(err){
    console.error(`[onEnterScreen] Failed for "${screenName}"`, err);
  }

  setActiveNav(screenName);
}

function setActiveNav(name){
  const screenName = normalizeScreenName(name);
  document.querySelectorAll(".navBtn").forEach(b=>{
    b.classList.toggle("active", b.getAttribute("data-nav") === screenName);
  });
}

let navBound = false;

function bindNavigation(){
  if(navBound) return;
  navBound = true;

  document.addEventListener("click", (e)=>{
    const goBtn = e.target.closest("[data-go]");
    if(goBtn){
      showScreen(goBtn.dataset.go);
      return;
    }
    const homeBtn = e.target.closest("[data-home]");
    if(homeBtn){
      showScreen("home");
      return;
    }
  });
}


/* ---------------------------
   LOCAL date utils
---------------------------- */
function pad2(n){ return String(n).padStart(2,"0"); }
function localISODate(d){
  const dt = (d instanceof Date) ? d : new Date(d);
  return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
}
function todayISO(){ return localISODate(new Date()); }
function parseISO(s){
  const [y,m,dd]=s.split("-").map(Number);
  return new Date(y, m-1, dd);
}
function sameMonth(d, y, m){ return d.getFullYear()===y && d.getMonth()===m; }

function weekStartDate(baseDate=new Date()){
  const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
  const dow = d.getDay(); // 0 Sun..6 Sat

  if(profile.weekStart === "sun"){
    d.setDate(d.getDate() - dow);
  } else {
    const delta = (dow === 0) ? 6 : (dow - 1);
    d.setDate(d.getDate() - delta);
  }
  return d;
}

const DAY_KEYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
function dateForWeekdayIndex(dayIndex, baseDate=new Date()){
  const start = weekStartDate(baseDate);
  const out = new Date(start);
  out.setDate(start.getDate() + dayIndex);
  return localISODate(out);
}

/* ---------------------------
   Normalization
---------------------------- */
function normExName(s){
  return String(s||"")
    .toLowerCase()
    .replace(/\s+/g," ")
    .trim();
}

function cleanExerciseName(s){
  const raw = String(s || "").trim().replace(/\s+/g, " ");
  if(!raw) return "";
  return canonicalExerciseName(raw);
}

function loadCustomExercises(){
  const arr = LS.get(KEY_CUSTOM_EX, []);
  return Array.isArray(arr) ? arr : [];
}
function saveCustomExercises(arr){
  LS.set(KEY_CUSTOM_EX, arr);
}
function addCustomExercise(name){
  const cleaned = cleanExerciseName(name);
  if(!cleaned) return "";

  const cur = loadCustomExercises();
  const exists = cur.some(x => normExName(x) === normExName(cleaned));
  if(!exists){
    cur.push(cleaned);
    cur.sort((a,b)=>a.localeCompare(b));
    saveCustomExercises(cur);
  }

  // ‚úÖ automatically add to Exercise Meta library (auto-type inference)
  const inferred = inferExerciseType(cleaned);
  learnExerciseType(cleaned, inferred);

  return cleaned;
}


  /* ---------------------------
   Canonical Exercise Naming
   - variants map to ONE canonical label
---------------------------- */
const CANONICAL_EXERCISE_MAP = {
  "cable crunch": "Cable Crunch",
  "cable crunches": "Cable Crunch",

  "leg extension": "Leg Extension",
  "leg extensions": "Leg Extension",

  "standing calf raise": "Standing Calf Raise",
  "standing calf raise (machine)": "Standing Calf Raise",

  "overhead dumbbell tricep extension": "Overhead Dumbbell Tricep Extension",
  "overhead dumbbell triceps extension": "Overhead Dumbbell Tricep Extension",

  "goblet squat": "Goblet Squat",
  "goblet squats": "Goblet Squat",

  "spin bike": "Stationary Bike",
  "stationary bike": "Stationary Bike",
};

function canonicalExerciseName(name){
  const raw = String(name || "").trim();
  if(!raw) return "";
  const key = normExName(raw);
  return CANONICAL_EXERCISE_MAP[key] || raw;
}
/* ---------------------------
   Canonical Exercise Library
---------------------------- */
const EXERCISE_LIBRARY = [
  // Barbell
  "Barbell Bench Press",
  "Incline Barbell Bench Press",
  "Barbell Squat",
  "Front Squat",
  "Barbell Back Squat",
  "Barbell Row",
  "Deadlift (Conventional)",
  "Romanian Deadlift",
  "Barbell Curl",

  // Machines / Cables
  "Leg Press",
  "Hack Squat",
  "Smith Machine Squat",
  "Lat Pulldown",
  "Underhand Lat Pulldown",
  "Seated Cable Row",
  "Cable Chest Flys",
  "Cable Crunch",
  "Chest Fly Machine",
  "Shoulder Press Machine",
  "Leg Extension",
  "Hamstring Curl",
  "Leg Curl Machine",
  "Standing Calf Raise (Machine)",
  "Standing Calf Raise",
  "Seated Calf Raise",
  "Triceps Rope Pushdowns",

  // Dumbbell
  "Dumbbell Bench Press",
  "Incline Dumbbell Press",
  "Dumbbell Shoulder Press",
  "Dumbbell Lateral Raises",
  "Lateral Raises",
  "Dumbbell Front Raises",
  "Dumbbell Chest Fly",
  "Dumbbell Row",
  "One-Arm Dumbbell Row",
  "Dumbbell Shrugs",
  "Dumbbell Bicep Curl",
  "Hammer Curl",
  "Concentration Curl",
  "Dumbbell Tricep Kickback",
  "Overhead Dumbbell Tricep Extension",
  "Goblet Squat",
  "Dumbbell Lunges",
  "Bulgarian Split Squat",
  "Dumbbell Romanian Deadlift",
  "Rear Delt Fly",
  "Dumbbell Alternating Curl",

  // Bodyweight / Misc
  "Chest Dips",
  "Pull-Ups / Assisted Pull-Ups",
  "Hanging Leg Raises",
  "Mobility + stretching",
  "Light walking or stretching",

  // Core
  "Plank",
  "Side Plank",
  "Leg Raises",
  "Bicycle Crunch",
  "Russian Twist",
  "Ab Wheel Rollout",
  "Mountain Climbers",

  // Cardio / Conditioning
  "Treadmill Walk / Run",
  "Incline Treadmill Walk",
  "Stair Climber",
  "Stationary Bike",
  "Elliptical",
  "Rowing Machine",
  "Jump Rope",
  "Battle Ropes",
  "Kettlebell Swings",
  "Sled Push / Pull",
  "Box Jumps",
  "Burpees"
];

/* ---------------------------
   Exercise Type Library (Strength / Cardio / Core)
   - Auto-assign types in Routine Editor (no manual selector)
   - Custom exercises get added automatically
---------------------------- */

const KEY_EX_META = "gym_ex_meta_v1"; // stores user-learned overrides

function loadExerciseMeta(){
  const raw = LS.get(KEY_EX_META, {});
  return (raw && typeof raw === "object" && !Array.isArray(raw)) ? raw : {};
}
function saveExerciseMeta(meta){
  LS.set(KEY_EX_META, meta || {});
}

let EX_META = loadExerciseMeta();

// Built-in type hints (only need to list non-strength; everything else defaults to strength)
const BUILTIN_TYPE_HINTS = {
  // Cardio (add more anytime)
  "treadmill": "cardio",
  "run": "cardio",
  "running": "cardio",
  "jog": "cardio",
  "bike": "cardio",
  "stationary bike": "cardio",
  "spin bike": "cardio",
  "rower": "cardio",
  "rowing": "cardio",
  "elliptical": "cardio",
  "stair": "cardio",
  "stairmaster": "cardio",
  "walking": "cardio",
  "walk": "cardio",

  // Core (add more anytime)
  "plank": "core",
  "side plank": "core",
  "crunch": "core",
  "sit up": "core",
  "sit-up": "core",
  "leg raise": "core",
  "hollow hold": "core",
  "russian twist": "core",
  "ab": "core",
  "abs": "core"
};

function inferExerciseType(name){
  const n = normExName(name);
  if(!n) return "strength";

  // 1) user-learned override (exact)
  const key = normExName(canonicalExerciseName(name));
  const user = EX_META?.[key]?.type;
  if(user === "strength" || user === "cardio" || user === "core") return user;

  // 2) built-in contains-match hints
  for(const [frag, t] of Object.entries(BUILTIN_TYPE_HINTS)){
    if(n.includes(frag)) return t;
  }

  // 3) default
  return "strength";
}

function getExerciseType(name){
  return inferExerciseType(name);
}

function learnExerciseType(name, type){
  const key = normExName(canonicalExerciseName(name));
  if(!key) return;
  if(type !== "strength" && type !== "cardio" && type !== "core") return;
  EX_META[key] = { type, updatedAt: Date.now() };
  saveExerciseMeta(EX_META);
}

function ensureExerciseHasType(exObj){
  if(!exObj || typeof exObj !== "object") return exObj;
  if(exObj.type !== "strength" && exObj.type !== "cardio" && exObj.type !== "core"){
    exObj.type = getExerciseType(exObj.name || "");
  }
  return exObj;
}

function normalizeRoutineExerciseObject(exObj){
  if(!exObj || typeof exObj !== "object") return null;
  exObj.name = canonicalExerciseName(exObj.name || "");
  ensureExerciseHasType(exObj);
  return exObj;
}

function normalizeRoutineExercises(routine){
  if(!routine || typeof routine !== "object") return routine;
  if(!routine.days) return routine;
  DAY_KEYS.forEach(k=>{
    const day = routine.days[k];
    if(!day || typeof day !== "object") return;
    if(!Array.isArray(day.exercises)) day.exercises = [];
    day.exercises = day.exercises
      .map(normalizeRoutineExerciseObject)
      .filter(Boolean);
  });
  return routine;
}

function hasLoggedTodayForExercise(exName){
  const n = normExName(canonicalExerciseName(exName));
  const d = todayISO();
  // NOTE: currently stored in `lifts` (we will evolve to unified logs next)
  return Array.isArray(lifts) && lifts.some(x=>{
    const ex = x.ex || x.exercise || x.name;
    const xn = x.exNorm || normExName(canonicalExerciseName(ex || ""));
    return x.date === d && xn === n;
  });
}

  
/* ---------------------------
   UID helper
---------------------------- */
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

/* ---------------------------
   Default Routine Seed
---------------------------- */
function defaultRoutine(){
  return {
    id: uid(),
    name: "PPL",
    source: "default",
    days: {
      Mon: { label:"Push", rest:false, exercises:[
        {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Dumbbell Bench Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Chest Dips", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Lateral Raises", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Chest Flys", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Triceps Rope Pushdowns", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Overhead Dumbbell Triceps Extension", sets:3, reps:"12‚Äì15", notes:""},
      ]},

      Tue: { label:"Pull", rest:false, exercises:[
        {name:"Underhand Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Barbell Row", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Dumbbell Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Rear Delt Fly", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Barbell Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hammer Curl", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Dumbbell Alternating Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hanging Leg Raises", sets:3, reps:"12‚Äì15", notes:"Core"},
      ]},

      Wed: { label:"Legs", rest:false, exercises:[
        {name:"Barbell Back Squat", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Goblet Squats", sets:3, reps:"12‚Äì15 steps", notes:""},
        {name:"Leg Curl Machine", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Standing Calf Raise", sets:3, reps:"15‚Äì20", notes:""},
        {name:"Leg Extensions", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Crunches", sets:3, reps:"20", notes:"Core"},
      ]},

      Thu: { label:"Push", rest:false, exercises:[
        {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Dumbbell Bench Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Chest Dips", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Lateral Raises", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Chest Flys", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Triceps Rope Pushdowns", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Overhead Dumbbell Triceps Extension", sets:3, reps:"12‚Äì15", notes:""},
      ]},

      Fri: { label:"Pull", rest:false, exercises:[
        {name:"Underhand Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Barbell Row", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Dumbbell Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Rear Delt Fly", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Barbell Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hammer Curl", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Dumbbell Alternating Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hanging Leg Raises", sets:3, reps:"12‚Äì15", notes:"Core"},
      ]},

      Sat: { label:"Legs", rest:false, exercises:[
        {name:"Barbell Back Squat", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Goblet Squats", sets:3, reps:"12‚Äì15 steps", notes:""},
        {name:"Leg Curl Machine", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Standing Calf Raise", sets:3, reps:"15‚Äì20", notes:""},
        {name:"Leg Extensions", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Crunches", sets:3, reps:"20", notes:"Core"},
      ]},

      Sun: { label:"Rest", rest:true, exercises:[] }
    }
  };
}

function makeUpperLowerTemplate(){
  const r = defaultRoutine();
  r.name = "Upper / Lower";

  r.days.Mon = { label:"Upper", rest:false, exercises:[
    {name:"Barbell Bench Press", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Shoulder Press", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Dumbbell Lateral Raises", sets:3, reps:"12‚Äì15", notes:""},
    {name:"Dumbbell Bicep Curl", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Triceps Rope Pushdowns", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Plank", sets:3, reps:"30‚Äì60s", notes:"Core"},
  ]};

  r.days.Tue = { label:"Lower", rest:false, exercises:[
    {name:"Barbell Squat", sets:4, reps:"5‚Äì8", notes:""},
    {name:"Romanian Deadlift", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Dumbbell Lunges", sets:3, reps:"10/leg", notes:""},
    {name:"Hamstring Curl", sets:3, reps:"12‚Äì15", notes:""},
    {name:"Standing Calf Raise (Machine)", sets:4, reps:"12‚Äì15", notes:""},
  ]};

  r.days.Wed = { label:"Active Recovery", rest:true, exercises:[
    {name:"Incline Treadmill Walk", sets:1, reps:"20‚Äì30 min", notes:"Cardio"},
    {name:"Mobility + stretching", sets:1, reps:"‚Äî", notes:""},
  ]};

  r.days.Thu = { label:"Upper", rest:false, exercises:[
    {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Pull-Ups / Assisted Pull-Ups", sets:4, reps:"6‚Äì10", notes:""},
    {name:"Dumbbell Row", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Chest Fly", sets:3, reps:"12", notes:""},
    {name:"Hammer Curl", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Overhead Dumbbell Tricep Extension", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Leg Raises", sets:3, reps:"10‚Äì15", notes:"Core"},
  ]};

  r.days.Fri = { label:"Lower", rest:false, exercises:[
    {name:"Deadlift (Conventional)", sets:4, reps:"3‚Äì5", notes:""},
    {name:"Hack Squat", sets:3, reps:"8‚Äì10", notes:"(or Smith Squat)"},
    {name:"Bulgarian Split Squat", sets:3, reps:"8/leg", notes:""},
    {name:"Leg Extension", sets:3, reps:"12‚Äì15", notes:""},
    {name:"Seated Calf Raise", sets:4, reps:"12‚Äì15", notes:""},
    {name:"Cable Crunch", sets:3, reps:"12‚Äì15", notes:"Core"},
  ]};

  r.days.Sat = { label:"Rest", rest:true, exercises:[
    {name:"Light walking or stretching", sets:1, reps:"‚Äî", notes:"Recovery"},
  ]};

  r.days.Sun = { label:"Cardio + Core", rest:false, exercises:[
    {name:"Stair Climber", sets:1, reps:"20‚Äì30 min", notes:"(or Stationary Bike)"},
    {name:"Russian Twist", sets:3, reps:"20", notes:"Core"},
    {name:"Plank", sets:3, reps:"45s", notes:"Core"},
  ]};

  return r;
}

function makeFullBody3Template(){
  const r = defaultRoutine();
  r.name = "Full Body (3-Day)";

  r.days.Mon = { label:"Full Body Day 1", rest:false, exercises:[
    {name:"Barbell Squat", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Barbell Bench Press", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Lat Pulldown", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Shoulder Press", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Plank", sets:3, reps:"45s", notes:"Core"},
  ]};

  r.days.Tue = { label:"Rest / Cardio", rest:true, exercises:[
    {name:"Incline Treadmill Walk", sets:1, reps:"25‚Äì30 min", notes:"(or Stationary Bike)"},
  ]};

  r.days.Wed = { label:"Full Body Day 2", rest:false, exercises:[
    {name:"Deadlift (Conventional)", sets:4, reps:"4‚Äì6", notes:""},
    {name:"Incline Dumbbell Press", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Seated Cable Row", sets:3, reps:"10", notes:""},
    {name:"Dumbbell Lunges", sets:3, reps:"10/leg", notes:""},
    {name:"Leg Raises", sets:3, reps:"10‚Äì15", notes:"Core"},
  ]};

  r.days.Thu = { label:"Rest", rest:true, exercises:[
    {name:"Mobility + stretching", sets:1, reps:"‚Äî", notes:"Recovery"},
  ]};

  r.days.Fri = { label:"Full Body Day 3", rest:false, exercises:[
    {name:"Leg Press", sets:4, reps:"10", notes:""},
    {name:"Pull-Ups / Assisted Pull-Ups", sets:3, reps:"AMRAP", notes:""},
    {name:"Dumbbell Chest Fly", sets:3, reps:"12", notes:""},
    {name:"Dumbbell Lateral Raises", sets:3, reps:"15", notes:""},
    {name:"Cable Crunch", sets:3, reps:"15", notes:"Core"},
  ]};

  r.days.Sat = { label:"Optional Conditioning", rest:true, exercises:[
    {name:"Rowing Machine", sets:1, reps:"15‚Äì20 min", notes:"(or Battle Ropes)"},
  ]};

  r.days.Sun = { label:"Rest", rest:true, exercises:[] };

  return r;
}

function makeBodyPartTemplate(){
  const r = defaultRoutine();
  r.name = "Body Part Split";

  r.days.Mon = { label:"Chest", rest:false, exercises:[
    {name:"Barbell Bench Press", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Chest Fly", sets:3, reps:"12", notes:""},
    {name:"Chest Fly Machine", sets:3, reps:"12‚Äì15", notes:""},
  ]};

  r.days.Tue = { label:"Back", rest:false, exercises:[
    {name:"Deadlift (Conventional)", sets:4, reps:"4‚Äì6", notes:""},
    {name:"Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Dumbbell Row", sets:3, reps:"8‚Äì10", notes:""},
  ]};

  r.days.Wed = { label:"Shoulders", rest:false, exercises:[
    {name:"Dumbbell Shoulder Press", sets:4, reps:"8‚Äì10", notes:""},
    {name:"Dumbbell Lateral Raises", sets:4, reps:"12‚Äì15", notes:""},
    {name:"Dumbbell Front Raises", sets:3, reps:"12", notes:""},
    {name:"Dumbbell Shrugs", sets:3, reps:"12", notes:""},
  ]};

  r.days.Thu = { label:"Legs", rest:false, exercises:[
    {name:"Barbell Squat", sets:4, reps:"6‚Äì8", notes:""},
    {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Romanian Deadlift", sets:3, reps:"8‚Äì10", notes:""},
    {name:"Hamstring Curl", sets:3, reps:"12‚Äì15", notes:""},
    {name:"Standing Calf Raise (Machine)", sets:4, reps:"15", notes:""},
  ]};

  r.days.Fri = { label:"Arms + Core", rest:false, exercises:[
    {name:"Dumbbell Bicep Curl", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Hammer Curl", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Triceps Rope Pushdowns", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Overhead Dumbbell Tricep Extension", sets:3, reps:"10‚Äì12", notes:""},
    {name:"Cable Crunch", sets:3, reps:"15", notes:"Core"},
    {name:"Russian Twist", sets:3, reps:"20", notes:"Core"},
  ]};

  r.days.Sat = { label:"Rest", rest:true, exercises:[] };

  r.days.Sun = { label:"Light Cardio", rest:true, exercises:[
    {name:"Stationary Bike", sets:1, reps:"20‚Äì30 min", notes:"(or Walk / Stretch)"},
  ]};

  return r;
  
}
  const ROUTINE_TEMPLATES = [
  { id:"tpl_ppl",          name:"PPL (6-day)",             build: ()=> defaultRoutine() },
  { id:"tpl_upperlower",   name:"Upper / Lower (7-day)",   build: ()=> makeUpperLowerTemplate() },
  { id:"tpl_fullbody3",    name:"Full Body (3-day)",       build: ()=> makeFullBody3Template() },
  { id:"tpl_bodypart",     name:"Body Part Split (7-day)", build: ()=> makeBodyPartTemplate() },
];

/* ---------------------------
   Routines state
---------------------------- */
function loadRoutines(){
  let routines = LS.get(KEY_ROUTINES, null);
  if(!Array.isArray(routines) || routines.length === 0){
    routines = [defaultRoutine()];
    LS.set(KEY_ROUTINES, routines);
  }
  routines.forEach(r=>{
    if(!r.days) r.days = {};
    DAY_KEYS.forEach(k=>{
      if(!r.days[k]) r.days[k] = {label:"", rest:false, exercises:[]};
      if(!Array.isArray(r.days[k].exercises)) r.days[k].exercises = [];
      if(typeof r.days[k].rest !== "boolean") r.days[k].rest = !!r.days[k].rest;
      if(typeof r.days[k].label !== "string") r.days[k].label = String(r.days[k].label||"");
      r.days[k].exercises = r.days[k].exercises.map(e=>({
        name: String(e.name||e.ex||""),
        sets: Number(e.sets)||0,
        reps: String(e.reps||""),
        notes: String(e.notes||"")
      })).filter(e=>e.name);
    });
    if(!r.id) r.id = uid();
    if(!r.name) r.name = "Routine";
    if(!r.source) r.source = "user"; // fallback for legacy routines
  });

  LS.set(KEY_ROUTINES, routines);

  let activeId = LS.get(KEY_ACTIVE_ROUTINE, null);
  if(!activeId || !routines.some(r=>r.id===activeId)){
    activeId = routines[0].id;
    LS.set(KEY_ACTIVE_ROUTINE, activeId);
  }
  return {routines, activeId};
}
({ routines, activeId: activeRoutineId } = loadRoutines());

function saveRoutines(){ LS.set(KEY_ROUTINES, routines); }
function setActiveRoutine(id){
  activeRoutineId = id;
  LS.set(KEY_ACTIVE_ROUTINE, id);
}
function getActiveRoutine(){
  return routines.find(r=>r.id===activeRoutineId) || routines[0];
}

/* ---------------------------
   Weight Tracker  ‚úÖ (COPY/PASTE THIS WHOLE BLOCK)
---------------------------- */
bwLogs = LS.get(KEY_BW, []);
function sortBW(){ bwLogs.sort((a,b)=>a.date.localeCompare(b.date)); }

const bwDate   = document.getElementById("bwDate");
const bwVal    = document.getElementById("bwVal");
const bwAddBtn = document.getElementById("bwAddBtn");
const bwTable  = document.getElementById("bwTable");
const bwLatest = document.getElementById("bwLatest");
const bwDelta  = document.getElementById("bwDelta");
const bwAvg    = document.getElementById("bwAvg");

const bwViewTableBtn = document.getElementById("bwViewTableBtn");
const bwViewGraphBtn = document.getElementById("bwViewGraphBtn");
const bwChartWrap    = document.getElementById("bwChartWrap");
const bwTableWrap    = document.getElementById("bwTableWrap");

let bwView = "table"; // "table" | "graph"

function setBWView(next){
  bwView = next;

  if(bwView === "table"){
    if(bwTableWrap) bwTableWrap.style.display = "";
    if(bwChartWrap) bwChartWrap.style.display = "none";
    bwViewTableBtn?.classList.remove("ghost");
    bwViewGraphBtn?.classList.add("ghost");
  } else {
    if(bwTableWrap) bwTableWrap.style.display = "none";
    if(bwChartWrap) bwChartWrap.style.display = "";
    bwViewTableBtn?.classList.add("ghost");
    bwViewGraphBtn?.classList.remove("ghost");
    renderBW(); // ensures chart draws correctly when shown
  }
}

bwViewTableBtn?.addEventListener("click", ()=> setBWView("table"));
bwViewGraphBtn?.addEventListener("click", ()=> setBWView("graph"));

if(bwDate) bwDate.value = todayISO();

/* ‚úÖ ADD weight */
bwAddBtn?.addEventListener("click", ()=>{
  const d = bwDate?.value || todayISO();
  const v = Number(bwVal?.value);

  if(!d || !isFinite(v)) return alert("Please enter date + bodyweight.");

  bwLogs = bwLogs.filter(x=>x.date !== d);
  bwLogs.push({date:d, bw:v});

  sortBW();
  LS.set(KEY_BW, bwLogs);

  if(bwVal) bwVal.value = "";
  renderBW();
});

/* ‚úÖ DELETE weight (ONE-TIME listener ‚Äî OUTSIDE renderBW) */
bwTable?.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-delbw]");
  if(!btn) return;

  const d = btn.getAttribute("data-delbw");
  bwLogs = bwLogs.filter(x=>x.date !== d);
  LS.set(KEY_BW, bwLogs);
  renderBW();
});

function bwStats(){
  sortBW();
  const latest = bwLogs[bwLogs.length-1];
  const prev = bwLogs[bwLogs.length-2];
  const delta = (latest && prev) ? (latest.bw - prev.bw) : null;

  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-6);
  const last7 = bwLogs.filter(x=>parseISO(x.date) >= cutoff);
  const avg = last7.length ? (last7.reduce((s,x)=>s+x.bw,0)/last7.length) : null;

  return {latest, prev, delta, avg, last7};
}

let bwChart;

function renderBW(){
  sortBW();
  const {latest, delta, avg} = bwStats();

  if(bwLatest) bwLatest.textContent = latest ? `${latest.bw.toFixed(1)} lbs (${latest.date})` : "‚Äî";

  if(bwDelta){
    if(delta === null) bwDelta.textContent = "‚Äî";
    else {
      const sign = delta > 0 ? "+" : "";
      bwDelta.textContent = `${sign}${delta.toFixed(1)} lbs`;
      bwDelta.className = "mono " + (delta>0 ? "bad" : (delta<0 ? "good" : ""));
    }
  }

  if(bwAvg) bwAvg.textContent = avg ? `${avg.toFixed(1)} lbs` : "‚Äî";

  /* ---- TABLE ---- */
  if(bwTable){
    bwTable.innerHTML = "";

    for(let i=0; i<bwLogs.length; i++){
      const cur = bwLogs[i];
      const prevBW = bwLogs[i-1]?.bw ?? null;

      const dlt = (prevBW===null) ? null : (cur.bw - prevBW);
      const trend = dlt===null ? "‚Äî" : (dlt>0 ? "‚Üë" : (dlt<0 ? "‚Üì" : "‚Äî"));
      const dltTxt = dlt===null ? "‚Äî" : `${dlt>0?"+":""}${dlt.toFixed(1)}`;
      const cls = dlt===null ? "" : (dlt>0 ? "bad" : (dlt<0 ? "good" : ""));

      const tr = document.createElement("tr");
      tr.classList.add("tap");

      tr.innerHTML = `
        <td class="mono">${cur.date}</td>
        <td class="mono">${cur.bw.toFixed(1)}</td>
        <td class="mono">${prevBW===null ? "‚Äî" : prevBW.toFixed(1)}</td>
        <td class="mono ${cls}">${dltTxt} ${trend}</td>
        <td><button data-delbw="${cur.date}">Delete</button></td>
      `;
      bwTable.appendChild(tr);
    }
  }

  /* ---- CHART ---- */
  if(bwView !== "graph") return;            // only draw chart when visible
  const canvas = document.getElementById("bwChart");
  if(!canvas) return;

  const labels = bwLogs.map(x=>x.date);
  const data = bwLogs.map(x=>x.bw);

  if(bwChart) bwChart.destroy();

  bwChart = new Chart(canvas, {
    type:"line",
    data:{ labels, datasets:[{ label:"Bodyweight (lbs)", data, tension:.25, pointRadius:3 }] },
    options:{
      responsive:true,
      plugins:{ legend:{display:false}, tooltip:{mode:"index", intersect:false} },
      scales:{
        x:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}},
        y:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}}
      }
    }
  });
}
/* ---------------------------
   Attendance Calendar
---------------------------- */
attendance = new Set(LS.get(KEY_ATT, []));

let calY = new Date().getFullYear();
let calM = new Date().getMonth();
const calTitle = document.getElementById("calTitle");
const calGrid = document.getElementById("calGrid");
const calCount = document.getElementById("calCount");

document.getElementById("prevMonthBtn")?.addEventListener("click", ()=>{
  calM--; if(calM<0){calM=11; calY--;}
  renderCal();
});
document.getElementById("nextMonthBtn")?.addEventListener("click", ()=>{
  calM++; if(calM>11){calM=0; calY++;}
  renderCal();
});
document.getElementById("clearMonthBtn")?.addEventListener("click", ()=>{
  const keep = [...attendance].filter(s=>{
    const d=parseISO(s);
    return !sameMonth(d, calY, calM);
  });
  attendance = new Set(keep);
  LS.set(KEY_ATT, [...attendance]);
  renderCal();
});

function renderCal(){
  const monthName = new Date(calY,calM,1).toLocaleString(undefined,{month:"long"});
  calTitle.textContent = `${monthName} ${calY}`;

  calGrid.innerHTML = "";
  const heads = ["S","M","T","W","T","F","S"];
  heads.forEach(h=>{
    const el=document.createElement("div");
    el.className="calHead";
    el.textContent=h;
    calGrid.appendChild(el);
  });

  const first = new Date(calY, calM, 1);
  const startDay = first.getDay();
  const daysInMonth = new Date(calY, calM+1, 0).getDate();

  for(let i=0;i<startDay;i++){
    const blank=document.createElement("div");
    blank.className="day off";
    blank.textContent="";
    calGrid.appendChild(blank);
  }

  let count=0;
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(calY, calM, d);
    const s = localISODate(date);
    const cell=document.createElement("div");
    cell.className="day";
    cell.innerHTML = `<div>${d}</div>`;
    if(attendance.has(s)){
      cell.classList.add("attended");
      cell.innerHTML += `<span class="dot"></span>`;
      count++;
    }
    cell.addEventListener("click", ()=>{
  if(attendance.has(s)) attendance.delete(s);
  else attendance.add(s);
  LS.set(KEY_ATT, [...attendance]);
  renderCal();
  refreshHome(); // ‚úÖ add this
});
    calGrid.appendChild(cell);
  }
  calCount.textContent = String(count);
}

/* ---------------------------
   Protein
---------------------------- */
// goal is dynamic from profile
const pDate = document.getElementById("pDate");
const pMorning = document.getElementById("pMorning");
const pLunch = document.getElementById("pLunch");
const pPre = document.getElementById("pPre");
const pDinner = document.getElementById("pDinner");
const pBed = document.getElementById("pBed");
const pTotal = document.getElementById("pTotal");
const pRemain= document.getElementById("pRemain");
const pStatus= document.getElementById("pStatus");
proteinMap = LS.get(KEY_PRO, {});

pDate.value = todayISO();

const pt = document.getElementById("proteinTitle");
if(pt) pt.textContent = `Protein Intake (Goal ${getProteinGoal()}g)`;

function loadProteinDay(d){
  const obj = proteinMap[d] || {morning:0,lunch:0,pre:0,dinner:0,bed:0};
  pMorning.value = obj.morning;
  pLunch.value = obj.lunch;
  pPre.value = obj.pre;
  pDinner.value = obj.dinner;
  pBed.value = obj.bed;
  renderProteinTotals();
}
function renderProteinTotals(){
  const total = (Number(pMorning.value)||0)+(Number(pLunch.value)||0)+(Number(pPre.value)||0)+(Number(pDinner.value)||0)+(Number(pBed.value)||0);
  pTotal.textContent = String(total);
  const rem = Math.max(getProteinGoal() - total, 0);
pRemain.textContent = String(rem);
  if(total >= getProteinGoal()){
    pStatus.textContent = "Hit goal ‚úÖ";
    pStatus.className = "good";
  } else if(total >= getProteinGoal()*0.75){
    pStatus.textContent = "Almost there";
    pStatus.className = "warn";
  } else {
    pStatus.textContent = "Under goal";
    pStatus.className = "muted";
  }
}
  function updateHomeProteinCirclePreview(){
  // only preview for TODAY (so it feels real-time)
  const td = todayISO();

  // read from the protein inputs (what user is typing)
  const total =
    (Number(pMorning?.value)||0) +
    (Number(pLunch?.value)||0) +
    (Number(pPre?.value)||0) +
    (Number(pDinner?.value)||0) +
    (Number(pBed?.value)||0);

  const goal = getProteinGoal();
  const left = Math.max(goal - total, 0);
  const pct = Math.max(0, Math.min(1, goal ? (total / goal) : 0));
  const deg = Math.round(pct * 360);

  // update HOME ring + number (even if Home isn't visible, it's still fine)
  if(homeProteinLeft) homeProteinLeft.textContent = String(left);
  if(homeProteinCircle){
    homeProteinCircle.style.setProperty("--deg", `${deg}deg`);
  }
}
[pMorning,pLunch,pPre,pDinner,pBed].forEach(inp=>{
  inp.addEventListener("input", ()=>{
    renderProteinTotals();
    // live-fill the Home ring while typing (only makes sense for today)
    if((pDate?.value || todayISO()) === todayISO()){
      updateHomeProteinCirclePreview();
    }
  });
});
  
pDate?.addEventListener("change", ()=>{
  loadProteinDay(pDate.value);
  if((pDate.value || todayISO()) === todayISO()){
    updateHomeProteinCirclePreview();
  }
});

document.getElementById("pSaveBtn").addEventListener("click", ()=>{
  const d = pDate.value || todayISO();
  proteinMap[d] = {
    morning:Number(pMorning.value)||0,
    lunch:Number(pLunch.value)||0,
    pre:Number(pPre.value)||0,
    dinner:Number(pDinner.value)||0,
    bed:Number(pBed.value)||0,
  };
  LS.set(KEY_PRO, proteinMap);
refreshHome();
alert("Saved ‚úÖ");
});

/* ---------------------------
   Lifts + PR helpers
---------------------------- */
lifts = LS.get(KEY_LIFTS, []);

function ensureLiftCompatibility(){
  lifts = lifts.map(x=>{
    const ex = String(x.ex || x.exercise || "");
    const exNorm = x.exNorm || normExName(ex);
    return {
      ...x,
      ex,
      exNorm,
      routineId: x.routineId || "",
      routineName: x.routineName || "",
      dayKey: x.dayKey || ""
    };
  });
  LS.set(KEY_LIFTS, lifts);
}
ensureLiftCompatibility();
  migrateCanonicalNames();

  function migrateCanonicalNames(){
  // ---- Routines ----
  let routinesChanged = false;

  routines.forEach(r=>{
    DAY_KEYS.forEach(k=>{
      const day = r.days?.[k];
      if(!day || !Array.isArray(day.exercises)) return;

      day.exercises.forEach(ex=>{
        const after = canonicalExerciseName(ex.name);
        if(after && ex.name !== after){
          ex.name = after;
          routinesChanged = true;
        }
      });

      // Remove duplicates caused by merging names
      const seen = new Set();
      day.exercises = day.exercises.filter(ex=>{
        const n = normExName(ex.name);
        if(seen.has(n)) return false;
        seen.add(n);
        return true;
      });
    });
  });

  if(routinesChanged) saveRoutines();

  // ---- Lifts ----
  let liftsChanged = false;

  lifts = lifts.map(x=>{
    const after = canonicalExerciseName(x.ex);
    const afterNorm = normExName(after);
    if(x.ex !== after || x.exNorm !== afterNorm){
      liftsChanged = true;
      return { ...x, ex: after, exNorm: afterNorm };
    }
    return x;
  });

  if(liftsChanged) LS.set(KEY_LIFTS, lifts);
}
migrateCanonicalNames();

function liftStatsForExercise(exName){
  const n = normExName(exName);
  const exLifts = lifts.filter(x=> (x.exNorm || normExName(x.ex)) === n);

  const life = exLifts.length ? Math.max(...exLifts.map(x=>Number(x.weight)||0)) : null;

  const thisWeekStart = new Date(); thisWeekStart.setDate(thisWeekStart.getDate()-7);
  const lastWeekStart = new Date(); lastWeekStart.setDate(lastWeekStart.getDate()-14);

  const thisWeek = exLifts.filter(x=>parseISO(x.date) >= thisWeekStart);
  const lastWeek = exLifts.filter(x=>{
    const d = parseISO(x.date);
    return d >= lastWeekStart && d < thisWeekStart;
  });

  const thisWeekMax = thisWeek.length ? Math.max(...thisWeek.map(x=>Number(x.weight)||0)) : null;
  const lastWeekMax = lastWeek.length ? Math.max(...lastWeek.map(x=>Number(x.weight)||0)) : null;

  return { life, thisWeekMax, lastWeekMax };
}

function getLastLiftForExercise(exName){
  const n = normExName(exName);
  const exLifts = lifts
    .filter(x=> (x.exNorm || normExName(x.ex)) === n)
    .sort((a,b)=>b.date.localeCompare(a.date));
  return exLifts[0] || null;
}

function formatSetsDetail(lift){
  if(!lift) return "‚Äî";
  const topSet = (lift.weight && lift.reps) ? `${lift.weight} x ${lift.reps}` : "‚Äî";
  const details = Array.isArray(lift.details) && lift.details.length
    ? lift.details.map((s,i)=>`S${i+1}:${s.weight}x${s.reps}`).join("  ")
    : null;
  return `${lift.date} ‚Ä¢ Top: ${topSet}${details ? " ‚Ä¢ " + details : ""}`;
}

/* ---------------------------
   Routine UI
---------------------------- */
const routineSelect = document.getElementById("routineSelect");
const activeRoutineMeta = document.getElementById("activeRoutineMeta");
const newRoutineBtn = document.getElementById("newRoutineBtn");
const editRoutineBtn = document.getElementById("editRoutineBtn");
const dupRoutineBtn = document.getElementById("dupRoutineBtn");
const delRoutineBtn = document.getElementById("delRoutineBtn");

let activeDayIndex = 0; // Mon=0..Sun=6

function renderRoutineDropdown(forceId){
  const selected = forceId || activeRoutineId;

  routineSelect.innerHTML = "";

  // --- Created Workouts (your saved routines) ---
  const ogCreated = document.createElement("optgroup");
  ogCreated.label = "Created Workouts";

  routines.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = r.name;
    ogCreated.appendChild(opt);
  });

  routineSelect.appendChild(ogCreated);

  // --- Default / Template Workouts ---
  const ogTemplates = document.createElement("optgroup");
  ogTemplates.label = "Default / Template Workouts";

  ROUTINE_TEMPLATES.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t.id;      // tpl_*
    opt.textContent = t.name;
    ogTemplates.appendChild(opt);
  });

  routineSelect.appendChild(ogTemplates);

  // --- select active value ---
  const allValues = [...routineSelect.options].map(o=>o.value);

  // if selected is a real routine OR a template id, keep it
  const finalVal = allValues.includes(selected) ? selected : (routines[0]?.id || "");

  routineSelect.value = finalVal;

  // if it's a real routine, update active routine + meta
  if(finalVal && !finalVal.startsWith("tpl_")){
    setActiveRoutine(finalVal);
    const ar = getActiveRoutine();
    activeRoutineMeta.textContent = `${ar.name} ‚Ä¢ ${DAY_KEYS.length} days`;
  } else {
    // template selected, meta can stay based on current active routine
    const ar = getActiveRoutine();
    activeRoutineMeta.textContent = `${ar.name} ‚Ä¢ ${DAY_KEYS.length} days`;
  }
}
  
routineSelect.addEventListener("change", ()=>{
  const val = routineSelect.value;

  // If they picked a template -> convert it into a REAL saved routine
  if(val.startsWith("tpl_")){
    const tpl = ROUTINE_TEMPLATES.find(t=>t.id === val);
    if(!tpl) return;

    const built = tpl.build();
    built.id = uid(); // ensure unique
    built.name = tpl.name; // keep template name
    routines.push(built);
    saveRoutines();

    setActiveRoutine(built.id);

    // re-render dropdown and select the newly created routine
    renderRoutineDropdown(built.id);
    renderPPL();
    renderLiftRoutineDropdown();
    buildRoutineExerciseSuggestions();

    return;
  }

  // Normal: user selected a real created routine
  setActiveRoutine(val);
  renderRoutineDropdown(val);
  renderPPL();
  renderLiftRoutineDropdown();
  buildRoutineExerciseSuggestions();
});


newRoutineBtn.addEventListener("click", ()=>{
  const base = defaultRoutine();
  base.name = `New Routine ${routines.length+1}`;
  base.source = "user";
  DAY_KEYS.forEach(k=>{
    base.days[k].exercises = [];
    base.days[k].rest = (k==="Sun");
    if(k==="Sun") base.days[k].label = "Rest";
  });
  routines.push(base);
  saveRoutines();
  
  setActiveRoutine(base.id);
  renderRoutineDropdown();
  openRoutineEditor(base.id);
});

dupRoutineBtn.addEventListener("click", ()=>{
  const ar = getActiveRoutine();
  const copy = JSON.parse(JSON.stringify(ar));
  copy.source = "user";
  copy.id = uid();
  copy.name = `${ar.name} (Copy)`;
  routines.push(copy);
  saveRoutines();
  setActiveRoutine(copy.id);
  renderRoutineDropdown();
  renderPPL();
  renderLiftRoutineDropdown();
});

delRoutineBtn.addEventListener("click", ()=>{
  if(routines.length <= 1){
    alert("You must keep at least one routine.");
    return;
  }
  const ar = getActiveRoutine();
  const ok = confirm(`Delete routine "${ar.name}"? (Logs will NOT be deleted.)`);
  if(!ok) return;
  routines = routines.filter(r=>r.id!==ar.id);
  saveRoutines();
  setActiveRoutine(routines[0].id);
  renderRoutineDropdown();
  renderPPL();
  renderLiftRoutineDropdown();
});

editRoutineBtn.addEventListener("click", ()=>{
  openRoutineEditor(getActiveRoutine().id);
});

function getTodaySplitIndex(){
  const dow = new Date().getDay(); // Sun=0..Sat=6
  if(dow === 0) return 6;
  return dow - 1;
}

/* ---------------------------
   PPL display
---------------------------- */
const pplTabs = document.getElementById("pplTabs");
const pplList = document.getElementById("pplList");

function renderDayTabs(){
  pplTabs.innerHTML = "";
  const ar = getActiveRoutine();

  DAY_KEYS.forEach((k, idx)=>{
    const day = ar.days[k];
    const label = (day.label || "").trim();
    const rest = !!day.rest;

    const b = document.createElement("div");
    b.className = "tab" + (idx===activeDayIndex ? " active" : "");
    b.innerHTML = `
      <span>${k}</span>
      ${label ? `<span class="badge">${label}</span>` : ""}
      ${rest ? `<span class="badge">Rest</span>` : ""}
    `;
    b.addEventListener("click", ()=>{
      activeDayIndex = idx;
      renderPPL();
    });
    pplTabs.appendChild(b);
  });
}

function renderPPL(){
  renderDayTabs();

  const ar = getActiveRoutine();
  const dayKey = DAY_KEYS[activeDayIndex];
  const day = ar.days[dayKey];

  pplList.innerHTML = "";

  if(day.rest){
    const restCard = document.createElement("div");
    restCard.className = "notice";
    restCard.innerHTML = `
      <div><strong>${dayKey}</strong> is marked as a Rest Day.</div>
      <div class="small muted">Exercises are stored but hidden. Toggle rest off in the Routine Editor.</div>
    `;
    pplList.appendChild(restCard);
    renderLiftSearchDropdown();
    return;
  }

  const list = Array.isArray(day.exercises) ? day.exercises : [];

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "notice";
    empty.textContent = "No exercises yet for this day. Click Edit to add exercises.";
    pplList.appendChild(empty);
    renderLiftSearchDropdown();
    return;
  }

  list.forEach(item=>{
    const ex = item.name;

    // ‚úÖ Type chip + logged badge (resets daily automatically)
    const type = (item.type === "strength" || item.type === "cardio" || item.type === "core")
      ? item.type
      : getExerciseType(ex);
    item.type = type;

    const logged = hasLoggedTodayForExercise(ex);

    // Strength-only stats for now (we‚Äôll adapt these later when we implement type-aware progress)
    const {life, thisWeekMax, lastWeekMax} = liftStatsForExercise(ex);
    const isPRThisWeek = (life !== null && thisWeekMax !== null && thisWeekMax === life);
    const prBadge = isPRThisWeek ? `<span class="badge">üèÜ PR (this week)</span>` : ``;

    const card = document.createElement("div");
    card.className = "exerciseItem";
    card.innerHTML = `
      <div class="left">
        <div class="title" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span>${ex}</span>
          <span class="badge">${type.toUpperCase()}</span>
          ${logged ? `<span class="badge">‚úì Logged</span>` : ``}
        </div>

        <div class="meta">
          <span>${item.sets || "‚Äî"} sets</span>
          <span>‚Ä¢</span>
          <span>${item.reps || "‚Äî"} reps</span>
          ${item.notes ? `<span class="badge">${item.notes}</span>` : ""}
        </div>
      </div>
      <div class="right">
        <div class="line2">This week: <span class="mono">${thisWeekMax===null?"‚Äî":thisWeekMax}</span> lbs</div>
        <div class="line2">Last week: <span class="mono">${lastWeekMax===null?"‚Äî":lastWeekMax}</span> lbs</div>
        <div class="line2">Lifetime max: <span class="mono">${life===null?"‚Äî":life}</span> lbs</div>
        <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap;">
          ${prBadge}
          <button type="button" data-log="${ex}">Log Sets</button>
        </div>
      </div>
    `;

    const logBtn = card.querySelector('button[data-log]');
    if(logBtn){
      logBtn.addEventListener("click", ()=>{
        openLogModal(ex, Number(item.sets)||3, ar, dayKey, activeDayIndex);
      });
    }

    pplList.appendChild(card);
  });

  renderLiftSearchDropdown();
}


/* ---------------------------
   Lift Progress Log (Phase 4)
---------------------------- */
const liftTable = document.getElementById("liftTable");
const liftSearch = document.getElementById("liftSearch");
const liftRoutine = document.getElementById("liftRoutine");
const liftFrom = document.getElementById("liftFrom");
const liftTo = document.getElementById("liftTo");
const liftMetric = document.getElementById("liftMetric");
const liftLimit = document.getElementById("liftLimit");

const liftSearchBtn = document.getElementById("liftSearchBtn");
const liftClearBtn = document.getElementById("liftClearBtn");

const liftViewTableBtn = document.getElementById("liftViewTableBtn");
const liftViewGraphBtn = document.getElementById("liftViewGraphBtn");
const liftDownloadBtn = document.getElementById("liftDownloadBtn");

const liftTableWrap = document.getElementById("liftTableWrap");
const liftGraphWrap = document.getElementById("liftGraphWrap");

let liftView = "table"; // "table" | "graph"
let appliedLiftFilters = {
  ex: "",
  routineId: "",
  from: "",
  to: "",
  metric: "top",
  limit: 25
};

function collectAllExerciseNames(){
  const set = new Set();

  // 1Ô∏è‚É£ Canonical library first
  EXERCISE_LIBRARY.forEach(n => set.add(canonicalExerciseName(n)));

  // 1.5Ô∏è‚É£ Custom exercises created by you
loadCustomExercises().forEach(n => set.add(canonicalExerciseName(n)));

  // 2Ô∏è‚É£ Routine exercises
  routines.forEach(r=>{
    DAY_KEYS.forEach(k=>{
      (r.days?.[k]?.exercises || []).forEach(e=>{
    if(e?.name) set.add(canonicalExerciseName(e.name));
      });
    });
  });

  // 3Ô∏è‚É£ Logged lifts
  lifts.forEach(x=>{
    if(x.ex) set.add(canonicalExerciseName(x.ex));
  });

  return [...set].sort((a,b)=>a.localeCompare(b));
}

function renderLiftSearchDropdown(){
  const prev = liftSearch.value || "";
  const items = ["", ...collectAllExerciseNames()];
  liftSearch.innerHTML = "";
  items.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v === "" ? "All exercises" : v;
    liftSearch.appendChild(opt);
  });
  liftSearch.value = items.includes(prev) ? prev : "";
}
/* ---------------------------
   Exercise Picker (Add + Swap)
---------------------------- */
const exPickModal = document.getElementById("exPickModal");
const exPickTitle = document.getElementById("exPickTitle");
const exPickCloseBtn = document.getElementById("exPickCloseBtn");
const exPickCancelBtn = document.getElementById("exPickCancelBtn");
const exPickConfirmBtn = document.getElementById("exPickConfirmBtn");
const exPickSearch = document.getElementById("exPickSearch");
const exPickList = document.getElementById("exPickList");

let exPickSelected = "";                 // single mode selected
let exPickSelectedSet = new Set();       // multi mode selected set
let exPickMulti = false;                 // are we in multi mode?
let exPickOnConfirm = null;

function openExercisePicker({ title="Pick Exercise", initial="", onConfirm, multi=false, initialMulti=[] }){
  exPickTitle.textContent = title;

  exPickMulti = !!multi;
  exPickOnConfirm = onConfirm;

  // reset selections
  exPickSelected = initial || "";
  exPickSelectedSet = new Set(Array.isArray(initialMulti) ? initialMulti : []);

  exPickSearch.value = "";
  renderExercisePickerList();
openModalEl(exPickModal);
}


function closeExercisePicker(){
closeModalEl(exPickModal);
  exPickSelected = "";
  exPickSelectedSet = new Set();
  exPickMulti = false;
  exPickOnConfirm = null;
}


function renderExercisePickerList(){
  const rawQ = String(exPickSearch.value || "").trim();
  const q = normExName(rawQ);

  const all = collectAllExerciseNames();
  const filtered = q ? all.filter(n => normExName(n).includes(q)) : all;

  exPickList.innerHTML = "";

  // ‚úÖ "Create new" option when typing
  if(rawQ){
    const exists = all.some(n => normExName(n) === normExName(rawQ));
    if(!exists){
      const create = document.createElement("div");
      create.className = "exPickItem";
      create.innerHTML = `
        <div class="exPickRow">
          ${exPickMulti ? `<span class="exPickCheck">+</span>` : ``}
          <span>‚ûï Create "<strong>${rawQ}</strong>"</span>
        </div>
      `;
      create.addEventListener("click", ()=>{
  const created = addCustomExercise(rawQ);
  if(!created) return;

        if(exPickMulti){
          exPickSelectedSet.add(created);
          renderExercisePickerList();
        } else {
          exPickSelected = created;
          [...exPickList.querySelectorAll(".exPickItem")].forEach(x=>x.classList.remove("active"));
          create.classList.add("active");
        }
      });
      exPickList.appendChild(create);
    }
  }

  if(filtered.length === 0){
    if(!rawQ){
      exPickList.innerHTML = `<div class="notice">No matches.</div>`;
    }
    return;
  }

  filtered.forEach(name=>{
    const isActive = exPickMulti ? exPickSelectedSet.has(name) : (name === exPickSelected);

    const div = document.createElement("div");
    div.className = "exPickItem" + (isActive ? " active" : "");

    div.innerHTML = `
      <div class="exPickRow">
        ${exPickMulti ? `<span class="exPickCheck">${isActive ? "‚úì" : ""}</span>` : ``}
        <span>${name}</span>
      </div>
    `;

    div.addEventListener("click", ()=>{
      if(exPickMulti){
        if(exPickSelectedSet.has(name)) exPickSelectedSet.delete(name);
        else exPickSelectedSet.add(name);
        renderExercisePickerList();
      } else {
        exPickSelected = name;
        [...exPickList.querySelectorAll(".exPickItem")].forEach(x=>x.classList.remove("active"));
        div.classList.add("active");
      }
    });

    exPickList.appendChild(div);
  });
}


exPickSearch.addEventListener("input", renderExercisePickerList);

exPickConfirmBtn.addEventListener("click", ()=>{
  if(exPickMulti){
    const picked = [...exPickSelectedSet];

    if(picked.length === 0){
      alert("Select at least one exercise.");
      return;
    }

    if(typeof exPickOnConfirm === "function"){
      exPickOnConfirm(picked);
    }

    closeExercisePicker();
    return;
  }

  // single mode
if(!exPickSelected){
  const typed = cleanExerciseName(exPickSearch.value);
  if(!typed){
    alert("Pick an exercise first.");
    return;
  }
  exPickSelected = typed;
}

if(typeof exPickOnConfirm === "function"){
  exPickOnConfirm(exPickSelected);
}
closeExercisePicker();
});

  /* ---------------------------
   Batch Add Modal (Multi-add sets/reps)
---------------------------- */
const batchAddModal = document.getElementById("batchAddModal");
const batchAddCloseBtn = document.getElementById("batchAddCloseBtn");
const batchAddCancelBtn = document.getElementById("batchAddCancelBtn");
const batchAddConfirmBtn = document.getElementById("batchAddConfirmBtn");
const batchAddList = document.getElementById("batchAddList");

let batchAddItems = []; // [{name, sets, reps}]

function openBatchAddModal(names){
  // ‚úÖ normalize: accept array OR single string
  const arr = Array.isArray(names)
    ? names
    : (typeof names === "string" && names.trim() ? [names.trim()] : []);

  batchAddItems = arr.map(n=>({
    name: canonicalExerciseName(n),
    sets: "",
    reps: ""
  }));

  renderBatchAddList();
openModalEl(batchAddModal);
}


function closeBatchAddModal(){
closeModalEl(batchAddModal);             // ‚úÖ ADD
  batchAddItems = [];
}

function renderBatchAddList(){
  batchAddList.innerHTML = "";

  batchAddItems.forEach((it, idx)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.background = "#0f0f10";
    card.style.padding = "10px";

    card.innerHTML = `
      <div class="row" style="align-items:end;">
        <div style="flex:2 1 220px;">
          <div class="small muted">Exercise</div>
          <div style="font-weight:700; margin-top:4px;">${it.name}</div>
        </div>

        <label style="flex:0 0 120px;">Sets
          <input type="number" min="1" value="${it.sets}" data-bsets="${idx}" placeholder="3" />
        </label>

        <label style="flex:1 1 160px;">Reps
          <input value="${it.reps}" data-breps="${idx}" placeholder="8‚Äì10" />
        </label>

        <button type="button" class="miniBtn danger" data-bremove="${idx}">Remove</button>
      </div>
    `;

    batchAddList.appendChild(card);
  });

  // wire inputs
  batchAddList.querySelectorAll("[data-bsets]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const i = Number(inp.getAttribute("data-bsets"));
      batchAddItems[i].sets = inp.value;
    });
  });

  batchAddList.querySelectorAll("[data-breps]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const i = Number(inp.getAttribute("data-breps"));
      batchAddItems[i].reps = inp.value;
    });
  });

  batchAddList.querySelectorAll("[data-bremove]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.getAttribute("data-bremove"));
      batchAddItems.splice(i,1);
      renderBatchAddList();
    });
  });
  // auto-focus first sets input
setTimeout(()=>{
  batchAddList.querySelector("input[data-bsets]")?.focus();
}, 0);
}

[batchAddCloseBtn, batchAddCancelBtn].forEach(btn=>{
  btn?.addEventListener("click", closeBatchAddModal);
});
batchAddModal?.addEventListener("click", (e)=>{ if(e.target === batchAddModal) closeBatchAddModal(); });

batchAddConfirmBtn?.addEventListener("click", ()=>{
  // validate
  for(const it of batchAddItems){
    const sets = Number(it.sets);
    const reps = String(it.reps || "").trim();
    if(!sets || sets <= 0){
      alert(`Enter sets for: ${it.name}`);
      return;
    }
    if(!reps){
      alert(`Enter reps for: ${it.name}`);
      return;
    }
  }

  // add to current draft day
  const k = DAY_KEYS[editDayIndex];
  const day = draftRoutine.days[k];

  batchAddItems.forEach(it=>{
const exName = canonicalExerciseName(it.name);
day.exercises.push({
  name: exName,
  type: getExerciseType(exName),
  sets: Number(it.sets),
  reps: String(it.reps).trim(),
  notes: ""
});

  });

  closeBatchAddModal();
  renderRtDayPanel();
  buildRoutineExerciseSuggestions();
  renderLiftSearchDropdown();
});


[exPickCloseBtn, exPickCancelBtn].forEach(btn=>btn.addEventListener("click", closeExercisePicker));
exPickModal.addEventListener("click", (e)=>{ if(e.target === exPickModal) closeExercisePicker(); });

function renderLiftRoutineDropdown(){
  const prev = liftRoutine.value || "";
  liftRoutine.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "All routines";
  liftRoutine.appendChild(optAll);

  routines.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = r.name;
    liftRoutine.appendChild(opt);
  });

  liftRoutine.value = (prev && routines.some(r=>r.id===prev)) ? prev : "";
}

function applyLiftFiltersFromUI(){
  appliedLiftFilters = {
    ex: (liftSearch.value || "").trim(),
    routineId: (liftRoutine.value || "").trim(),
    from: (liftFrom.value || "").trim(),
    to: (liftTo.value || "").trim(),
    metric: (liftMetric.value || "top"),
    limit: Number(liftLimit.value || 25)
  };
}

function clearLiftFiltersUI(){
  liftSearch.value = "";
  liftRoutine.value = "";
  liftFrom.value = "";
  liftTo.value = "";
  liftMetric.value = "top";
  liftLimit.value = "25";
}

function getLiftFilteredData(){
  let arr = [...lifts];

  // exercise filter (normalized)
  if(appliedLiftFilters.ex){
    const n = normExName(appliedLiftFilters.ex);
    arr = arr.filter(x => (x.exNorm || normExName(x.ex)) === n);
  }

  // routine filter
  if(appliedLiftFilters.routineId){
    arr = arr.filter(x => String(x.routineId || "") === appliedLiftFilters.routineId);
  }

  // date range filter
  if(appliedLiftFilters.from){
    const f = parseISO(appliedLiftFilters.from);
    arr = arr.filter(x => parseISO(x.date) >= f);
  }
  if(appliedLiftFilters.to){
    const t = parseISO(appliedLiftFilters.to);
    arr = arr.filter(x => parseISO(x.date) <= t);
  }

  // sort newest for table, oldest for graph later
  arr.sort((a,b)=>b.date.localeCompare(a.date));

  // limit (table)
  if(liftView === "table"){
    const lim = Number(appliedLiftFilters.limit || 25);
    if(lim > 0) arr = arr.slice(0, lim);
  }

  return arr;
}

function renderLiftsTable(){
  liftTable.innerHTML = "";
  const visible = getLiftFilteredData();

  visible.forEach(x=>{
    const topSet = (x.weight && x.reps) ? `${x.weight} x ${x.reps}` : "‚Äî";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${x.date}</td>
      <td><span class="clickEx" data-hist="${x.ex}">${x.ex}</span></td>
      <td class="mono">${topSet}</td>
      <td class="mono">${x.sets ?? "‚Äî"}</td>
      <td>${x.pr ? '<span class="badge">üèÜ</span>' : ''}</td>
      <td><button data-dellift="${x.id}">Delete</button></td>
    `;
    liftTable.appendChild(tr);
  });

  liftTable.querySelectorAll("button[data-dellift]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-dellift");
      lifts = lifts.filter(x=>x.id!==id);
      LS.set(KEY_LIFTS, lifts);
      renderLiftSearchDropdown();
      renderLifts();   // rerun with applied filters
      renderPPL();
      buildRoutineExerciseSuggestions();
    });
  });

  liftTable.querySelectorAll("[data-hist]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const ex = el.getAttribute("data-hist");
      openHistoryModal(ex);
    });
  });
}

/* ---- Graph helpers ---- */
function estEpley1RM(weight, reps){
  const w = Number(weight)||0;
  const r = Number(reps)||0;
  if(!w || !r) return 0;
  return w * (1 + (r/30));
}
function calcVolume(lift){
  // Prefer details if present
  if(Array.isArray(lift.details) && lift.details.length){
    return lift.details.reduce((sum,s)=>sum + (Number(s.weight)||0)*(Number(s.reps)||0), 0);
  }
  const w = Number(lift.weight)||0;
  const r = Number(lift.reps)||0;
  const sets = Number(lift.sets)||1;
  return w * r * sets;
}
function weekKey(d){
  const ws = weekStartDate(d);
  return `${ws.getFullYear()}-${pad2(ws.getMonth()+1)}-${pad2(ws.getDate())}`;
}

let liftChart; // chart.js instance

const weekSeparatorsPlugin = {
  id: "weekSeparators",
  beforeDraw(chart, args, pluginOptions){
    const cfg = chart?.config?.options?.plugins?.weekSeparators;
    if(!cfg || cfg.enabled !== true) return;

    const {ctx, chartArea} = chart;
    const xScale = chart.scales?.x;
    if(!ctx || !chartArea || !xScale) return;

    const labels = chart.data.labels || [];
    if(labels.length < 2) return;

    // find week boundaries by comparing week keys across consecutive points
    const boundaries = [];
    let prevKey = null;
    for(let i=0;i<labels.length;i++){
      const d = parseISO(labels[i]);
      const key = weekKey(d);
      if(prevKey !== null && key !== prevKey){
        boundaries.push(i);
      }
      prevKey = key;
    }

    ctx.save();
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(154,160,166,0.22)";

    boundaries.forEach(i=>{
      const x = xScale.getPixelForValue(labels[i]);
      ctx.beginPath();
      ctx.moveTo(x, chartArea.top);
      ctx.lineTo(x, chartArea.bottom);
      ctx.stroke();
    });

    ctx.restore();
  }
};

function renderLiftsGraph(){
  const visible = getLiftFilteredData()
    .slice() // copy
    .sort((a,b)=>a.date.localeCompare(b.date)); // oldest -> newest

  const labels = visible.map(x=>x.date);

  const metric = appliedLiftFilters.metric || "top";
  const data = visible.map(x=>{
    if(metric === "e1rm") return estEpley1RM(x.weight, x.reps);
    if(metric === "vol") return calcVolume(x);
    return Number(x.weight)||0; // top
  });

  const yLabel =
    metric === "e1rm" ? "Est. 1RM (lbs)" :
    metric === "vol" ? "Volume" :
    "Top Weight (lbs)";

  const ctx = document.getElementById("liftChart");
  if(liftChart) liftChart.destroy();

  liftChart = new Chart(ctx, {
    type:"line",
    data:{
      labels,
      datasets:[{
        label: yLabel,
        data,
        tension:.25,
        pointRadius:3,
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{mode:"index", intersect:false},
        weekSeparators:{enabled:true}
      },
      scales:{
        x:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}},
        y:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}}
      }
    },
    plugins:[weekSeparatorsPlugin]
  });

  // If no data, show a friendly message
  if(labels.length === 0){
    // chart will just be empty; that's fine
  }
}

function setLiftView(next){
  liftView = next;

  if(liftView === "table"){
    liftTableWrap.style.display = "";
    liftGraphWrap.style.display = "none";
    liftViewTableBtn.classList.remove("ghost");
    liftViewGraphBtn.classList.add("ghost");
    liftDownloadBtn.classList.add("ghost");
    renderLiftsTable();
  } else {
    liftTableWrap.style.display = "none";
    liftGraphWrap.style.display = "";
    liftViewTableBtn.classList.add("ghost");
    liftViewGraphBtn.classList.remove("ghost");
    liftDownloadBtn.classList.remove("ghost");
    renderLiftsGraph();
  }
}

function renderLifts(){
  // uses appliedLiftFilters + current liftView
  if(liftView === "table") renderLiftsTable();
  else renderLiftsGraph();
}

liftViewTableBtn.addEventListener("click", ()=> setLiftView("table"));
liftViewGraphBtn.addEventListener("click", ()=> setLiftView("graph"));

liftSearchBtn.addEventListener("click", ()=>{
  applyLiftFiltersFromUI();
  renderLifts();
});

liftClearBtn.addEventListener("click", ()=>{
  clearLiftFiltersUI();
  applyLiftFiltersFromUI();
  setLiftView("table");
  renderLifts();
});

liftDownloadBtn.addEventListener("click", ()=>{
  if(!liftChart){
    alert("Switch to Graph view first.");
    return;
  }
  const url = liftChart.toBase64Image("image/png", 1);
  const a = document.createElement("a");
  a.href = url;
  a.download = `lift-graph-${localISODate(new Date())}.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

/* ---------------------------
   Log Sets Modal
---------------------------- */
const logModal = document.getElementById("logModal");
const logModalClose = document.getElementById("logModalClose");
const logModalExercise = document.getElementById("logModalExercise");
const logRoutineLine = document.getElementById("logRoutineLine");
const logModalDate = document.getElementById("logModalDate");
const logModalSets = document.getElementById("logModalSets");
const logAddSetBtn = document.getElementById("logAddSetBtn");
const logSaveBtn = document.getElementById("logSaveBtn");

const logPrevBox = document.getElementById("logPrevBox");
const logPrevText = document.getElementById("logPrevText");
const logCopyLastBtn = document.getElementById("logCopyLastBtn");
const logViewHistoryBtn = document.getElementById("logViewHistoryBtn");

let modalExerciseName = null;
let modalLastLift = null;
let modalRoutine = null;
let modalDayKey = null;
let modalDayIndex = null;

function openLogModal(exName, defaultSets=3, routineObj=null, dayKey="", dayIndex=0){
  modalExerciseName = canonicalExerciseName(exName);
  logModalExercise.textContent = modalExerciseName;
  logRoutineLine.textContent = routineObj ? `${routineObj.name} ‚Ä¢ ${dayKey}` : "‚Äî";
  modalRoutine = routineObj;
  modalDayKey = dayKey;
  modalDayIndex = dayIndex;

  logModalDate.value = dateForWeekdayIndex(dayIndex, new Date()) || todayISO();

  modalLastLift = getLastLiftForExercise(modalExerciseName);
  if(modalLastLift){
    logPrevBox.style.display = "block";
    logPrevText.textContent = formatSetsDetail(modalLastLift);
  } else {
    logPrevBox.style.display = "none";
    logPrevText.textContent = "‚Äî";
  }

  logModalSets.innerHTML = "";
  for(let i=0;i<defaultSets;i++) addSetRow();

openModalEl(logModal);
}

  function closeLogModal(){
  closeModalEl(logModal);        // ‚úÖ ADD
  modalExerciseName = null;
  modalLastLift = null;
  modalRoutine = null;
  modalDayKey = null;
  modalDayIndex = null;
}

function renumberSetPills(){
  [...logModalSets.children].forEach((child, i)=>{
    const pillStrong = child.querySelector(".pill strong");
    if(pillStrong) pillStrong.textContent = String(i+1);
  });
}

function addSetRow(weight="", reps=""){
  const idx = logModalSets.children.length + 1;
  const row = document.createElement("div");
  row.className = "row";
  row.style.alignItems = "end";
  row.innerHTML = `
    <span class="pill"><span class="muted">Set</span> <strong class="mono">${idx}</strong></span>
    <label>Weight (lbs)
      <input type="number" step="0.5" inputmode="decimal" class="setWeight" placeholder="e.g., 75" value="${weight}" />
    </label>
    <label>Reps
      <input type="number" inputmode="numeric" class="setReps" placeholder="e.g., 8" value="${reps}" />
    </label>
    <button type="button" class="removeSetBtn">Remove</button>
  `;
  row.querySelector(".removeSetBtn").addEventListener("click", ()=>{
    row.remove();
    renumberSetPills();
  });
  logModalSets.appendChild(row);
}

logAddSetBtn.addEventListener("click", ()=> addSetRow());
logModalClose.addEventListener("click", closeLogModal);
logModal.addEventListener("click", (e)=>{ if(e.target === logModal) closeLogModal(); });

logCopyLastBtn.addEventListener("click", ()=>{
  if(!modalLastLift) return;
  logModalSets.innerHTML = "";

  if(Array.isArray(modalLastLift.details) && modalLastLift.details.length){
    modalLastLift.details.forEach(s=> addSetRow(String(s.weight ?? ""), String(s.reps ?? "")));
  } else {
    addSetRow(String(modalLastLift.weight ?? ""), String(modalLastLift.reps ?? ""));
  }
  renumberSetPills();
});

logViewHistoryBtn.addEventListener("click", ()=>{
  if(!modalExerciseName) return;
  openHistoryModal(modalExerciseName);
});

logSaveBtn.addEventListener("click", ()=>{
  if(!modalExerciseName) return;

  const date = logModalDate.value || todayISO();
  const setRows = [...logModalSets.querySelectorAll(".row")];

  const setsArr = [];
  for(const r of setRows){
    const w = Number(r.querySelector(".setWeight")?.value);
    const reps = Number(r.querySelector(".setReps")?.value);
    if(isFinite(w) && w > 0 && isFinite(reps) && reps > 0){
      setsArr.push({weight:w, reps:reps});
    }
  }

  if(setsArr.length === 0){
    alert("Enter at least one valid set (weight + reps).");
    return;
  }

  let top = setsArr[0];
  for(const s of setsArr){
    if(s.weight > top.weight) top = s;
  }

  const {life} = liftStatsForExercise(modalExerciseName);
  const isPR = (life === null) ? true : (top.weight > life);

  lifts.push({
    id: uid(),
    date,
    ex: modalExerciseName,
    exNorm: normExName(modalExerciseName),
    sets: setsArr.length,
    reps: top.reps,
    weight: top.weight,
    pr: isPR,
    details: setsArr,
    routineId: modalRoutine?.id || "",
    routineName: modalRoutine?.name || "",
    dayKey: modalDayKey || ""
  });

  lifts.sort((a,b)=>b.date.localeCompare(a.date));
  LS.set(KEY_LIFTS, lifts);

  const prevScroll = window.scrollY;
  closeLogModal();

  renderLiftSearchDropdown();
  renderLifts();      // Phase 4 respects applied filters
  renderPPL();
  window.scrollTo(0, prevScroll);
  buildRoutineExerciseSuggestions();

// ‚úÖ Stay on Routine screen after saving
// showScreen("lifts");
// setTimeout(()=>{
//   document.getElementById("liftTableWrap")?.scrollIntoView({behavior:"smooth", block:"start"});
// }, 0);
}); // ‚úÖ closes logSaveBtn click handler

/* ---------------------------
   History Modal
---------------------------- */
const histModal = document.getElementById("histModal");
const histCloseBtn = document.getElementById("histCloseBtn");
const histExercise = document.getElementById("histExercise");
const histTable = document.getElementById("histTable");

function closeHistoryModal(){
 closeModalEl(histModal);             // ‚úÖ ADD
}
histCloseBtn.addEventListener("click", closeHistoryModal);
histModal.addEventListener("click", (e)=>{ if(e.target === histModal) closeHistoryModal(); });

function openHistoryModal(exName){
  const exCanonical = canonicalExerciseName(exName);
  const n = normExName(exCanonical);

  histExercise.textContent = exCanonical;

  const exLifts = lifts
    .filter(x=> (x.exNorm || normExName(x.ex)) === n)
    .sort((a,b)=>b.date.localeCompare(a.date))
    .slice(0, 12);

  histTable.innerHTML = "";

  exLifts.forEach(x=>{
    const topSet = (x.weight && x.reps) ? `${x.weight} x ${x.reps}` : "‚Äî";
    const allSets = Array.isArray(x.details) && x.details.length
      ? x.details.map((s,i)=>`S${i+1}:${s.weight}x${s.reps}`).join("  ")
      : "‚Äî";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${x.date}</td>
      <td class="mono">${topSet}</td>
      <td class="mono">${allSets}</td>
      <td>${x.pr ? '<span class="badge">üèÜ</span>' : ''}</td>
    `;
    histTable.appendChild(tr);
  });

  openModalEl(histModal);

}

/* ---------------------------
   Routine Editor (unchanged)
---------------------------- */
const rtModal = document.getElementById("rtModal");
const rtCloseBtn = document.getElementById("rtCloseBtn");
const rtCancelBtn = document.getElementById("rtCancelBtn");
const rtSaveBtn = document.getElementById("rtSaveBtn");

const rtName = document.getElementById("rtName");
const rtDayTabs = document.getElementById("rtDayTabs");
const rtDayLabel = document.getElementById("rtDayLabel");
const rtRestToggle = document.getElementById("rtRestToggle");
const rtDayRestNotice = document.getElementById("rtDayRestNotice");

const rtAddExName = document.getElementById("rtAddExName");
const rtAddExSets = document.getElementById("rtAddExSets");
const rtAddExReps = document.getElementById("rtAddExReps");
const rtAddExBtn = document.getElementById("rtAddExBtn");
const rtExList = document.getElementById("rtExList");
const rtAddMultiBtn = document.getElementById("rtAddMultiBtn");
const rtExSuggestions = document.getElementById("rtExSuggestions");

  function openAddExercisePicker(){
  // ‚úÖ remember where the Routine Editor modal is scrolled
  const modalCard = document.querySelector("#rtModal > div");
  const prevScroll = modalCard ? modalCard.scrollTop : 0;

  // ‚úÖ kill focus so iOS doesn‚Äôt scroll the page
  rtAddExName.blur();

  // ‚úÖ open picker
  openExercisePicker({
    title: "Pick exercise to add",
    initial: rtAddExName.value,
    onConfirm: (picked)=>{
      rtAddExName.value = picked;

      // ‚úÖ restore modal scroll after pick
      setTimeout(()=>{
        if(modalCard) modalCard.scrollTop = prevScroll;
      }, 0);
    }
  });

  // ‚úÖ restore immediately too (covers iOS ‚Äújump‚Äù before picker paints)
  setTimeout(()=>{
    if(modalCard) modalCard.scrollTop = prevScroll;
  }, 0);
}

// open picker on tap/click
rtAddExName.addEventListener("click", (e)=>{
  e.preventDefault();
  openAddExercisePicker();
});

// safety: if iOS still triggers focus somehow
rtAddExName.addEventListener("focus", (e)=>{
  e.preventDefault();
  openAddExercisePicker();
});

  
let editRoutineId = null;
let editDayIndex = 0;
let draftRoutine = null;

function buildRoutineExerciseSuggestions(){
  const list = collectAllExerciseNames();
  rtExSuggestions.innerHTML = "";
  list.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n;
    rtExSuggestions.appendChild(opt);
  });
}

function openRoutineEditor(routineId){
  const r = routines.find(x=>x.id===routineId);
  if(!r) return;

  setActiveRoutine(routineId);

  editRoutineId = routineId;
  editDayIndex = activeDayIndex;
  draftRoutine = JSON.parse(JSON.stringify(r));

  rtName.value = draftRoutine.name;

  buildRoutineExerciseSuggestions();
  renderRtDayTabs();
  renderRtDayPanel();

openModalEl(rtModal);
}

function closeRoutineEditor(){
 closeModalEl(rtModal);            // ‚úÖ ADD
  editRoutineId = null;
  editDayIndex = 0;
  draftRoutine = null;
}

rtCloseBtn.addEventListener("click", closeRoutineEditor);
rtCancelBtn.addEventListener("click", closeRoutineEditor);
rtModal.addEventListener("click", (e)=>{ if(e.target === rtModal) closeRoutineEditor(); });

function renderRtDayPanel(){
  const k = DAY_KEYS[editDayIndex];
  const day = draftRoutine.days[k];

  rtDayLabel.value = day.label || "";
  rtRestToggle.value = day.rest ? "1" : "0";
  rtDayRestNotice.style.display = day.rest ? "block" : "none";

  rtExList.innerHTML = "";
  const list = Array.isArray(day.exercises) ? day.exercises : (day.exercises = []);

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "notice";
    empty.textContent = "No exercises for this day yet.";
    rtExList.appendChild(empty);
    return;
  }

  list.forEach((ex, idx)=>{
    // Ensure name + type are always normalized
    ex.name = canonicalExerciseName(ex.name || "");
    ex.type = (ex.type === "strength" || ex.type === "cardio" || ex.type === "core")
      ? ex.type
      : getExerciseType(ex.name || "");

    const exType = ex.type;

    const wrap = document.createElement("div");
    wrap.className = "rtExCard";

    wrap.innerHTML = `
      <div class="rtExTop">
        <div class="rtExName">${ex.name || "Exercise"}</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
          <span class="badge">${exType.toUpperCase()}</span>
          <span class="badge">${(ex.sets || "‚Äî")} sets ‚Ä¢ ${(ex.reps || "‚Äî")} reps</span>
        </div>
      </div>

      <div class="row" style="margin-top:10px; align-items:end;">
        <label style="flex:2 1 240px;">Name
          <input data-field="name" value="${ex.name || ""}" />
        </label>

        <label style="flex:0 0 120px;">Sets
          <input data-field="sets" type="number" min="1" value="${ex.sets || ""}" />
        </label>

        <label style="flex:1 1 160px;">Reps
          <input data-field="reps" value="${ex.reps || ""}" />
        </label>
      </div>

      <div class="row" style="margin-top:8px;">
        <label style="flex:1 1 100%;">Notes
          <textarea data-field="notes" placeholder="optional">${ex.notes || ""}</textarea>
        </label>
      </div>

      <div class="rtActions">
        <button type="button" class="miniBtn" data-up="${idx}">‚Üë Up</button>
        <button type="button" class="miniBtn" data-down="${idx}">‚Üì Down</button>
        <button type="button" class="miniBtn" data-swap="${idx}">Swap</button>
        <button type="button" class="miniBtn danger" data-remove="${idx}">Remove</button>
      </div>
    `;

    // Field inputs (name / sets / reps / notes)
    wrap.querySelectorAll("[data-field]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const field = inp.getAttribute("data-field");

        if(field === "sets"){
          day.exercises[idx].sets = Number(inp.value) || 0;
          return;
        }

        if(field === "name"){
          const newName = canonicalExerciseName(inp.value);
          day.exercises[idx].name = newName;
          day.exercises[idx].type = getExerciseType(newName); // ‚úÖ auto-type
          // Re-render so the type chip updates instantly
          renderRtDayPanel();
          return;
        }

        // reps, notes
        day.exercises[idx][field] = inp.value;
      });
    });

    // Up/Down/Swap/Remove buttons (existing behavior preserved)
    const btnUp = wrap.querySelector(`[data-up="${idx}"]`);
    const btnDown = wrap.querySelector(`[data-down="${idx}"]`);
    const btnSwap = wrap.querySelector(`[data-swap="${idx}"]`);
    const btnRemove = wrap.querySelector(`[data-remove="${idx}"]`);

    if(btnUp){
      btnUp.addEventListener("click", ()=>{
        if(idx <= 0) return;
        const tmp = day.exercises[idx-1];
        day.exercises[idx-1] = day.exercises[idx];
        day.exercises[idx] = tmp;
        renderRtDayPanel();
      });
    }

    if(btnDown){
      btnDown.addEventListener("click", ()=>{
        if(idx >= day.exercises.length-1) return;
        const tmp = day.exercises[idx+1];
        day.exercises[idx+1] = day.exercises[idx];
        day.exercises[idx] = tmp;
        renderRtDayPanel();
      });
    }

    if(btnSwap){
      btnSwap.addEventListener("click", ()=>{
        openExercisePicker({
          onPick: (picked)=>{
            const exName = canonicalExerciseName(picked);
            day.exercises[idx].name = exName;
            day.exercises[idx].type = getExerciseType(exName);
            renderRtDayPanel();
          }
        });
      });
    }

    if(btnRemove){
      btnRemove.addEventListener("click", ()=>{
        day.exercises.splice(idx, 1);
        renderRtDayPanel();
      });
    }

    rtExList.appendChild(wrap);
  });
}


rtDayLabel.addEventListener("input", ()=>{
  const k = DAY_KEYS[editDayIndex];
  draftRoutine.days[k].label = rtDayLabel.value;
  renderRtDayTabs();
});
rtRestToggle.addEventListener("change", ()=>{
  const k = DAY_KEYS[editDayIndex];
  draftRoutine.days[k].rest = (rtRestToggle.value === "1");
  if(draftRoutine.days[k].rest && !draftRoutine.days[k].label){
    draftRoutine.days[k].label = "Rest";
    rtDayLabel.value = "Rest";
  }
  rtDayRestNotice.style.display = draftRoutine.days[k].rest ? "block" : "none";
  renderRtDayTabs();
});

rtAddExBtn.addEventListener("click", ()=>{
  const k = DAY_KEYS[editDayIndex];
  const day = draftRoutine.days[k];

  const name = canonicalExerciseName(String(rtAddExName.value||"").trim());
  const sets = Number(rtAddExSets.value)||0;
  const reps = String(rtAddExReps.value||"").trim();

  if(!name) return alert("Enter an exercise name.");
  if(!sets || sets <= 0) return alert("Enter sets (number).");
  if(!reps) return alert("Enter reps (e.g., 8‚Äì10).");

  day.exercises.push({name, sets, reps, notes:""});
  rtAddExName.value = "";
  rtAddExSets.value = "";
  rtAddExReps.value = "";

  renderRtDayPanel();
  buildRoutineExerciseSuggestions();
  renderLiftSearchDropdown();
});

  rtAddMultiBtn?.addEventListener("click", ()=>{
  openExercisePicker({
    title: "Pick multiple exercises",
    multi: true,
    initialMulti: [],
    onConfirm: (pickedNames)=>{
      // pickedNames is an array when multi=true
      openBatchAddModal(pickedNames);
    }
  });
});


rtSaveBtn.addEventListener("click", ()=>{
  if(!draftRoutine) return;

  const name = String(rtName.value||"").trim();
  if(!name) return alert("Routine needs a name.");
  draftRoutine.name = name;

  const idx = routines.findIndex(r=>r.id===editRoutineId);
  if(idx < 0) return;

  routines[idx] = draftRoutine;
  saveRoutines();

  setActiveRoutine(draftRoutine.id);

  closeRoutineEditor();
  renderRoutineDropdown();
  renderPPL();
  renderLiftRoutineDropdown();
  buildRoutineExerciseSuggestions();

  // If onboarding is not done yet, finish it and send to Home
if(!isOnboardingDone()){
  setOnboardingDone();
  refreshHome();
  showScreen("home");
}
});

  function renderLastBackup(){
  const el = document.getElementById("lastBackupText");
  if(!el) return;

  const iso = localStorage.getItem(KEY_LAST_BACKUP);
  if(!iso){
    el.textContent = "‚Äî";
    return;
  }
  const d = new Date(iso);
  el.textContent = d.toLocaleString();
}

/* ---------------------------
   Export / Import / Reset
---------------------------- */
const importBtn = document.getElementById("settingsImportBtn");
const importFile = document.getElementById("settingsImportFile");
const backupNowBtn = document.getElementById("backupNowBtn");

function buildExportPayload(){
  return {
    v: 3,
    exportedAt: new Date().toISOString(),
    profile: LS.get(KEY_PROFILE, defaultProfile()),
    lastBackup: localStorage.getItem(KEY_LAST_BACKUP) || null,
    activeScreen: localStorage.getItem(KEY_ACTIVE_SCREEN) || "home",

    bwLogs: LS.get(KEY_BW, []),
    attendance: LS.get(KEY_ATT, []),
    proteinMap: LS.get(KEY_PRO, {}),
    lifts: LS.get(KEY_LIFTS, []),
    routines: LS.get(KEY_ROUTINES, []),
    activeRoutineId: LS.get(KEY_ACTIVE_ROUTINE, null)
  };
}
function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
backupNowBtn.addEventListener("click", ()=>{
  const payload = buildExportPayload();
  const stamp = localISODate(new Date());
  downloadJSON(`gym-dashboard-${stamp}.json`, payload);

  // also save last backup time
  localStorage.setItem(KEY_LAST_BACKUP, new Date().toISOString());
  renderLastBackup();
});
importBtn.addEventListener("click", ()=>{
  importFile.value = "";
  importFile.click();
});
importFile.addEventListener("change", async ()=>{
  const file = importFile.files?.[0];
  if(!file) return;

  try{
    const text = await file.text();
    const data = JSON.parse(text);

    const bw = Array.isArray(data.bwLogs) ? data.bwLogs : null;
    const att = Array.isArray(data.attendance) ? data.attendance : null;
    const pro = (data.proteinMap && typeof data.proteinMap === "object") ? data.proteinMap : null;
    const lf = Array.isArray(data.lifts) ? data.lifts : null;
    const rts = Array.isArray(data.routines) ? data.routines : null;
    const arId = (typeof data.activeRoutineId === "string" || data.activeRoutineId === null) ? data.activeRoutineId : null;

    if(!bw || !att || !pro || !lf || !rts){
      alert("That file doesn‚Äôt look like a valid export from this dashboard.");
      return;
    }

    const ok = confirm("Import will overwrite your current saved data on this browser. Continue?");
    if(!ok) return;

    LS.set(KEY_BW, bw);
    LS.set(KEY_ATT, att);
    LS.set(KEY_PRO, pro);
    LS.set(KEY_LIFTS, lf);
    LS.set(KEY_ROUTINES, rts);
    LS.set(KEY_ACTIVE_ROUTINE, arId);

    reloadCoreState();

    // ‚úÖ init data + state first
renderCal();
loadProteinDay(todayISO());
renderLastBackup();

renderRoutineDropdown();
activeDayIndex = getTodaySplitIndex();
renderPPL();

renderLiftSearchDropdown();
renderLiftRoutineDropdown();
applyLiftFiltersFromUI();
setLiftView("table"); // sets UI state, table is fine hidden

buildRoutineExerciseSuggestions();

// ‚úÖ restore last visited screen (or home) LAST
hydrateOnboardingInputs();
    
  // 3) Normal app restore (validate)
  const last = localStorage.getItem(KEY_ACTIVE_SCREEN) || "home";
  const exists = !!document.getElementById(`screen-${last}`);
  showScreen(exists ? last : "home");


    alert("Imported ‚úÖ");
  }catch(e){
    alert("Import failed. Make sure you selected a valid JSON export file.");
  }
});

document.getElementById("settingsResetBtn").addEventListener("click", ()=>{
  const ok = confirm("Reset ALL saved gym data on this device/browser?");
  if(!ok) return;
  localStorage.removeItem(KEY_BW);
  localStorage.removeItem(KEY_ATT);
  localStorage.removeItem(KEY_PRO);
  localStorage.removeItem(KEY_LIFTS);
  localStorage.removeItem(KEY_TARGETS);
  localStorage.removeItem(KEY_ROUTINES);
  localStorage.removeItem(KEY_ACTIVE_ROUTINE);
  localStorage.removeItem(KEY_ACTIVE_SCREEN);

   // ‚úÖ STEP 5 ‚Äî reset onboarding state
  localStorage.removeItem(KEY_ONBOARD_DONE);
  
  location.reload();
});

function isOnboardingDone(){
  return localStorage.getItem(KEY_ONBOARD_DONE) === "1";
}

function setOnboardingDone(){
  localStorage.setItem(KEY_ONBOARD_DONE, "1");
}

function hasProfileCompleted(){
  const p = LS.get(KEY_PROFILE, null);
  if(!p || typeof p !== "object") return false;
  const name = String(p.name || "").trim();
  return name.length > 0;
}


function hasAtLeastOneRoutine(){
  const rts = LS.get(KEY_ROUTINES, []);
  return Array.isArray(rts) && rts.length > 0;
}

function routeInitialScreen(){
  hydrateOnboardingInputs();

  // 1) If profile isn‚Äôt completed ‚Üí Profile screen
  if(!hasProfileCompleted()){
    showScreen("profile");
    return;
  }

  // 2) If profile is done but onboarding not finished ‚Üí Routine screen
  if(!isOnboardingDone()){
    showScreen("onboard-routine");
    return;
  }

  // 3) Normal app restore (validate before using)
  const last = localStorage.getItem(KEY_ACTIVE_SCREEN);
  if(last && getScreenEl(last)){
    showScreen(last);
    return;
  }

  showScreen("home");
}

  /* ---------------------------
   App Version + Update Banner
   - bump APP_VERSION on each deploy
---------------------------- */
function showUpdateBanner(){
  const b = document.getElementById("updateBanner");
  if(b) b.style.display = "block";
}

function hideUpdateBanner(){
  const b = document.getElementById("updateBanner");
  if(b) b.style.display = "none";
}

async function checkForUpdate(){
  try{
    const url = "./version.json?ts=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });

    if(!res.ok){
      console.log("version.json fetch failed:", res.status, url);
      return;
    }

    const data = await res.json();
    const latest = String(data.version || "").trim();
    if(!latest){
      console.log("version.json missing 'version' field:", data);
      return;
    }

    const last = localStorage.getItem(KEY_APP_VERSION);

    console.log("Version check:", { last, latest });

    if(!last){
      localStorage.setItem(KEY_APP_VERSION, latest);
      renderHeaderSub();
      return;
    }

    if(last !== latest){
      showUpdateBanner();
      localStorage.setItem(KEY_APP_VERSION, latest);
      renderHeaderSub();
      return;
    }

    renderHeaderSub();
  }catch(e){
    console.log("checkForUpdate error:", e);
  }
}


document.addEventListener("click", (e)=>{
  const btn = e.target.closest("#updateRefreshBtn");
  if(!btn) return;

  // force a reload (browser will fetch latest files)
  location.reload();
});
  
/* ---------------------------
   Init (single pass)
---------------------------- */
function init(){
  // Load core state (hardened)
  reloadCoreState();

  // Bind once
  bindNavigation();

  bindModalSystem();


  // Static UI (not screen-specific)
  hydrateSettingsUI();
  hydrateOnboardingInputs();
  renderHeaderSub();
  renderStorageInfo();
  renderLastBackup();

  // Default view settings
  setBWView("table");
  setLiftView("table");
  applyLiftFiltersFromUI();

  checkForUpdate();

  // Route LAST (this calls showScreen which renders what‚Äôs needed)
  routeInitialScreen();
}


window.addEventListener("DOMContentLoaded", init);

</script>

  <!-- ‚úÖ Update Banner (shows when a new deploy is detected) -->
<div id="updateBanner" class="updateBanner" style="display:none;">
  <div class="updateBannerInner">
    <div class="updateText">
      <div class="updateTitle">‚ú® Update available</div>
      <div class="updateSub">Refresh to load the latest version.</div>
    </div>
    <button id="updateRefreshBtn" class="miniBtn tap">Refresh</button>
  </div>
</div>
  <!-- Bottom Navigation -->
<nav class="bottomNav">
  <div class="bottomNavInner">
    <button class="navBtn tap" data-go="home" data-nav="home">
  <div class="icon">üè†</div><div>Home</div>
</button>

<button class="navBtn tap" data-go="routine" data-nav="routine">
  <div class="icon">üóìÔ∏è</div><div>Routine</div>
</button>
<button class="navBtn tap" type="button" data-go="lifts" data-nav="lifts">
      <div class="icon">üìà</div><div>Progress</div>
    </button>
<button class="navBtn tap" type="button" data-go="settings" data-nav="settings">
      <div class="icon">‚öôÔ∏è</div><div>Settings</div>
    </button>
  </div>
</nav>
</body>
</html>
