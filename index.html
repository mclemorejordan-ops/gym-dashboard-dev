
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />

  <!-- iOS Add to Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Gym Dashboard" />

  <title>Gym Dashboard</title>

  <!-- Chart.js (used later in Progress/Weight) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --hair: rgba(255,255,255,.10);

      --accent: #7c5cff;
      --good: #37d67a;
      --warn: #ffd166;
      --bad: #ff5c7a;

      --r: 18px;
      --shadow: 0 18px 40px rgba(0,0,0,.45);

      --navH: 78px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.24), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(55,214,122,.14), transparent 55%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    .app{
      min-height: 100%;
      padding: env(safe-area-inset-top) 14px calc(var(--navH) + env(safe-area-inset-bottom)) 14px;
      max-width: 780px;
      margin: 0 auto;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(11,15,23,.88), rgba(11,15,23,.55));
      padding: 14px 0 10px 0;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 4px 2px 6px 2px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .brand .title{
      font-weight: 720;
      letter-spacing: .2px;
      font-size: 18px;
      line-height: 1.15;
    }
    .brand .subtitle{
      font-size: 12px;
      color: var(--muted);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--hair);
      color: var(--text);
      font-size: 13px;
      user-select:none;
      max-width: 52vw;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    main{ padding-top: 10px; }

    .grid{
      display:grid;
      gap: 12px;
    }
    @media (min-width: 640px){
      .grid.cols2{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--hair);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px 0;
      font-size: 14px;
      letter-spacing: .3px;
      color: var(--muted);
      font-weight: 650;
      text-transform: uppercase;
    }

    .btnrow{ display:flex; gap: 10px; flex-wrap: wrap; }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 650;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid var(--hair);
      user-select:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.75));
      border-color: rgba(124,92,255,.35);
    }
    .btn.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }
    .btn:active{ transform: translateY(1px); }

    .muted{ color: var(--muted); }
    .kpi{
      display:flex;
      flex-direction:column;
      gap: 4px;
      padding: 8px 0 0 0;
    }
    .kpi .big{
      font-size: 22px;
      font-weight: 760;
      letter-spacing: .2px;
    }
    .kpi .small{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }

    .form{ display:grid; gap: 10px; }
    .row2{ display:grid; gap: 10px; }
    @media (min-width: 640px){ .row2{ grid-template-columns: 1fr 1fr; } }

    label{
      display:flex;
      flex-direction:column;
      gap: 7px;
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 650;
      letter-spacing: .2px;
    }
    input, select{
      appearance:none;
      border-radius: 14px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    input::placeholder{ color: rgba(255,255,255,.35); }
    input:focus, select:focus{
      border-color: rgba(124,92,255,.40);
      box-shadow: 0 0 0 4px rgba(124,92,255,.14);
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 12px 12px;
    }
    .toggle .ttext{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .toggle .ttext .a{ color: var(--text); font-weight: 700; font-size: 14px; }
    .toggle .ttext .b{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    .switch{
      width: 52px;
      height: 30px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      position: relative;
      flex: 0 0 auto;
      cursor:pointer;
      user-select:none;
    }
    .switch::after{
      content:"";
      position:absolute;
      top: 50%;
      left: 3px;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.82);
      transition: left .16s ease, background .16s ease;
    }
    .switch.on{
      background: rgba(124,92,255,.30);
      border-color: rgba(124,92,255,.34);
    }
    .switch.on::after{
      left: 25px;
      background: rgba(255,255,255,.92);
    }

    .tplGrid{ display:grid; gap: 10px; }
    @media (min-width: 640px){ .tplGrid{ grid-template-columns: 1fr 1fr; } }
    .tpl{
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease;
    }
    .tpl:active{ transform: translateY(1px); }
    .tpl .name{ font-weight: 780; letter-spacing: .2px; margin-bottom: 4px; }
    .tpl .desc{ color: var(--muted); font-size: 12.5px; line-height: 1.35; }
    .tpl.selected{
      border-color: rgba(124,92,255,.34);
      background: rgba(124,92,255,.12);
      box-shadow: 0 0 0 4px rgba(124,92,255,.10);
    }

    .note{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }
    /* Home Dashboard */
    .homeRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .dots{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .dotDay{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    .dotDay.on{
      background: rgba(55,214,122,.55);
      border-color: rgba(55,214,122,.50);
    }
    .dotLabel{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .ringWrap{
      width: 120px;
      height: 120px;
      border-radius: 999px;
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      flex: 0 0 auto;
    }
    .ringWrap::before{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 999px;
      background: rgba(11,15,23,.95);
      border: 1px solid rgba(255,255,255,.08);
    }
    .ringText{
      position: relative;
      z-index: 2;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap: 2px;
    }
    .ringText .big{
      font-size: 18px;
      font-weight: 850;
      letter-spacing:.2px;
    }
    .ringText .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.2;
    }
        /* Log Sets */
    .logGrid{ display:grid; gap:12px; }
    .logRow2{ display:grid; gap:10px; }
    @media (min-width: 640px){
      .logRow2{ grid-template-columns: 1fr 1fr; }
    }
    .log3{ display:grid; gap:10px; }
    @media (min-width: 640px){
      .log3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .chiprow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip2{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-size: 12.5px;
      font-weight: 700;
      user-select:none;
    }

    .sets{
      display:grid;
      gap:10px;
    }
    .setCard{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .setTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .setTop .t{
      font-weight: 820;
      letter-spacing:.15px;
    }
    .mini2{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12px;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      user-select:none;
    }
    .mini2.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }

    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 10px 0;
    }
        /* Progress */
    .chartWrap{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px;
      overflow:hidden;
    }
    canvas{
      max-width: 100%;
      height: 280px;
    }
    @media (min-width: 640px){
      canvas{ height: 320px; }
    }
        /* Routine Editor */
    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-size: 12.5px;
      font-weight: 700;
      user-select:none;
      cursor:pointer;
    }
    .pill.active{
      background: rgba(124,92,255,.14);
      border-color: rgba(124,92,255,.22);
    }

    .dayGrid{
      display:grid;
      gap:10px;
    }
    @media (min-width: 640px){
      .dayGrid{ grid-template-columns: 1fr 1fr; }
    }
    .dayCard{
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dayTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .dayTitle{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .dayTitle .lbl{
      font-weight: 820;
      letter-spacing:.15px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 46vw;
    }
    .dayTitle .sub{
      font-size: 12.5px;
      color: var(--muted);
    }
    .exList{ display:grid; gap:8px; }
    .exRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .exRow .n{
      font-weight: 750;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 44vw;
    }

    /* Library UI */
    .seg{
      display:flex;
      gap: 8px;
      padding: 6px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
    }
    .segbtn{
      flex:1;
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12.5px;
      color: var(--muted);
      background: transparent;
      user-select:none;
    }
    .segbtn.active{
      color: var(--text);
      background: rgba(124,92,255,.16);
      border: 1px solid rgba(124,92,255,.22);
    }

    .list{
      display:grid;
      gap: 10px;
    }
    .item{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .item .left{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
    }
    .item .name{
      font-weight: 820;
      letter-spacing: .15px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 58vw;
    }
    .item .meta{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }
    .item .actions{
      display:flex;
      gap: 8px;
      flex: 0 0 auto;
    }
    .mini{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12px;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      user-select:none;
    }
    .mini.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }
    /* Attendance */
    .calWrap{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px;
    }
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      user-select:none;
    }
    .calCell{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding: 10px 8px;
      min-height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 750;
      cursor:pointer;
    }
    .calCell.header{
      cursor: default;
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.65);
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .2px;
      min-height: 36px;
    }
    .calCell.blank{
      cursor: default;
      background: transparent;
      border: 1px dashed rgba(255,255,255,.10);
      opacity: .55;
    }
    .calCell.on{
      background: rgba(55,214,122,.22);
      border-color: rgba(55,214,122,.35);
    }
    .calTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .calTitle{
      font-weight: 820;
      letter-spacing:.2px;
    }
    /* Bottom nav */
    .nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: calc(var(--navH) + env(safe-area-inset-bottom));
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px;
      display:flex;
      justify-content:center;
      z-index: 50;
      pointer-events:none;
    }
    .navbar{
      width: min(780px, calc(100% - 18px));
      display:flex;
      justify-content:space-between;
      gap: 8px;
      background: rgba(16,20,30,.72);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 8px;
      backdrop-filter: blur(18px);
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      pointer-events:auto;
    }
    .navbtn{
      flex: 1;
      appearance:none;
      border:none;
      background: transparent;
      color: var(--muted);
      padding: 10px 6px;
      border-radius: 16px;
      font-size: 11.5px;
      font-weight: 650;
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .navbtn .dot{
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .navbtn.active{
      color: var(--text);
      background: rgba(124,92,255,.14);
      border: 1px solid rgba(124,92,255,.22);
    }
    .navbtn.active .dot{
      background: rgba(124,92,255,.22);
      border-color: rgba(124,92,255,.30);
    }

    /* Modal */
    .modalHost{
      position: fixed;
      inset: 0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index: 80;
      padding: 0 10px;
    }
    .modalHost.show{ display:flex; }
    .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    .sheet{
      position:relative;
      width: min(780px, 100%);
      max-height: 82vh;
      overflow:auto;
      background: rgba(16,20,30,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px 22px 0 0;
      box-shadow: 0 22px 60px rgba(0,0,0,.65);
      padding: 14px;
      transform: translateY(10px);
    }
    .sheetHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 10px;
    }
    .sheetHeader .h{
      font-weight: 760;
      letter-spacing: .2px;
    }
    .xbtn{
      appearance:none;
      border:none;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 700;
    }
    .pulse{
  animation: pulseAnim 1.2s ease;
}
@keyframes pulseAnim{
  0%{ box-shadow: 0 0 0 0 rgba(124,92,255,.6); }
  70%{ box-shadow: 0 0 0 10px rgba(124,92,255,0); }
  100%{ box-shadow: 0 0 0 0 rgba(124,92,255,0); }
}
    /* Glass dropdown (routine picker) */
.popHost{
  position: fixed;
  inset: 0;
  z-index: 95;
  display: none;
}
.popHost.show{ display:block; }

.popBackdrop{
  position:absolute;
  inset:0;
  background: rgba(0,0,0,.25);
  backdrop-filter: blur(6px);
}

.popPanel{
  position:absolute;
  width: min(420px, calc(100vw - 24px));
  max-height: min(360px, calc(100vh - 140px));
  overflow:auto;

  background: rgba(16,20,30,.72);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 18px;
  box-shadow: 0 22px 60px rgba(0,0,0,.65);
  backdrop-filter: blur(18px);

  padding: 10px;
}

.popTitle{
  font-size: 12px;
  color: rgba(255,255,255,.65);
  letter-spacing: .2px;
  font-weight: 700;
  padding: 6px 6px 10px 6px;
  border-bottom: 1px solid rgba(255,255,255,.10);
  margin-bottom: 10px;
}

.popItem{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;

  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  cursor:pointer;
  user-select:none;
}
.popItem:active{ transform: translateY(1px); }

.popItem .l{
  min-width:0;
  display:flex;
  flex-direction:column;
  gap: 3px;
}
.popItem .n{
  font-weight: 820;
  overflow:hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 52vw;
}
.popItem .m{
  font-size: 12px;
  color: rgba(255,255,255,.60);
}
.popBadge{
  font-size: 12px;
  font-weight: 800;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(124,92,255,.28);
  background: rgba(124,92,255,.16);
}
   /* Routine layout refinements (locked design) */
.rHdrRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.manageLink{
  margin-top: 10px;
  font-weight: 750;
  color: rgba(255,255,255,.72);
  cursor:pointer;
  user-select:none;
}
.manageLink:active{ transform: translateY(1px); }

.carouselCard{
  padding: 14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.carouselTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.carouselMid{
  text-align:center;
  flex: 1;
  min-width: 0;
}

.carouselTitle{
  font-weight: 860;
  letter-spacing:.2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.carouselSub{
  font-size: 12.5px;
  color: var(--muted);
  margin-top: 2px;
}

.weekRow{
  display:flex;
  flex-direction:column;
  gap: 8px;
}

.weekLabel{
  font-size: 12px;
  color: rgba(255,255,255,.55);
  letter-spacing: .35em;
  text-align:center;
  user-select:none;
}

.weekDots{
  display:flex;
  justify-content:center;
  gap: 10px;
  user-select:none;
}

.weekDot{
  width: 12px;
  height: 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
}
.weekDot.on{
  background: rgba(124,92,255,.75);
  border-color: rgba(124,92,255,.55);
} 
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="title" id="appTitle">Gym Dashboard</div>
          <div class="subtitle" id="appSubtitle">Offline • Add to Home Screen • Local data</div>
        </div>
        <div class="chip" id="chipStatus">Not set up</div>
      </div>
    </header>

    <main id="viewRoot"></main>
  </div>

  <div class="nav">
    <div class="navbar" id="navbar"></div>
  </div>

  <!-- Modal Host -->
  <div class="modalHost" id="modalHost" aria-hidden="true">
    <div class="backdrop" id="modalBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHeader">
        <div class="h" id="modalTitle">Modal</div>
        <button class="xbtn" id="modalClose">Close</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    /********************
     * 1) State + Storage
     ********************/
    const STORAGE_KEY = "gymdash:v1";

    const DefaultState = () => ({
      schemaVersion: 1,
      createdAt: Date.now(),
      profile: null,
      routines: [],
      activeRoutineId: null,
      exerciseLibrary: {
        weightlifting: [],
        cardio: [],
        core: []
      },
      logs: {
        workouts: [],
        weight: [],
        protein: []
      },
      attendance: []
    });

    const Storage = {
      load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return DefaultState();
          const parsed = JSON.parse(raw);
          if(!parsed || typeof parsed !== "object") return DefaultState();
          if(!("schemaVersion" in parsed)) return DefaultState();
          return parsed;
        }catch(e){
          return DefaultState();
        }
      },
      save(state){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      },
      reset(){
        localStorage.removeItem(STORAGE_KEY);
      }
    };
    /********************
     * Backup / Import (Step 10)
     ********************/
    function downloadTextFile(filename, text, mime="application/json"){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 250);
    }

    function exportBackupJSON(){
      // Keep export simple: full state snapshot
      const payload = {
        exportedAt: new Date().toISOString(),
        app: "gym-dashboard-dev",
        data: state
      };
      return JSON.stringify(payload, null, 2);
    }

    function validateImportedState(obj){
      // Accept either raw state or wrapped { data: state }
      const imported = (obj && typeof obj === "object" && "data" in obj) ? obj.data : obj;

      if(!imported || typeof imported !== "object") throw new Error("Invalid JSON object.");
      if(typeof imported.schemaVersion !== "number") throw new Error("Invalid backup: missing schemaVersion.");

      // Must contain expected top-level fields (loose validation)
      if(!("profile" in imported)) throw new Error("Invalid backup: missing profile.");
      if(!("routines" in imported)) throw new Error("Invalid backup: missing routines.");
      if(!("exerciseLibrary" in imported)) throw new Error("Invalid backup: missing exerciseLibrary.");
      if(!("logs" in imported)) throw new Error("Invalid backup: missing logs.");
      if(!("attendance" in imported)) throw new Error("Invalid backup: missing attendance.");

      return imported;
    }

    function importBackupJSON(jsonText){
      let parsed;
      try{
        parsed = JSON.parse(jsonText);
      }catch(e){
        throw new Error("Could not parse JSON. Make sure it’s valid.");
      }

      const importedState = validateImportedState(parsed);

      // Overwrite local storage + live state
      state = importedState;
      Storage.save(state);
    }
    let state = Storage.load();

    /********************
     * 2) Helpers
     ********************/
    const $ = (sel, root=document) => root.querySelector(sel);

    const el = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if(k === "class") n.className = v;
        else if(k === "text") n.textContent = v;
        else if(k === "html") n.innerHTML = v;
        else if(k.startsWith("on") && typeof v === "function"){
          n.addEventListener(k.slice(2).toLowerCase(), v);
        } else {
          n.setAttribute(k, v);
        }
      }
      children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
      return n;
    };

    const uid = (prefix="id") => `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;

        const pad2 = (n) => String(n).padStart(2, "0");

    const Dates = {
      todayISO(){
        const d = new Date();
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      },
      // weekStartsOn: "mon" | "sun"
      startOfWeekISO(dateISO, weekStartsOn){
        const d = new Date(dateISO + "T00:00:00");
        const dow = d.getDay(); // 0=Sun..6=Sat
        const weekStart = (weekStartsOn === "sun") ? 0 : 1;
        // how many days to subtract to get week start
        let diff = dow - weekStart;
        if(diff < 0) diff += 7;
        d.setDate(d.getDate() - diff);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      },
      addDaysISO(dateISO, days){
        const d = new Date(dateISO + "T00:00:00");
        d.setDate(d.getDate() + days);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      },
      sameISO(a,b){ return String(a) === String(b); }
    };

    function getTodayWorkout(){
      const routine = Routines.getActive();
      if(!routine || !(routine.days?.length)) return { routine: null, day: null, dayIndex: null };

      const today = new Date();
      const idx = today.getDay(); // 0=Sun..6=Sat
      // Our routine days are stored order 0..6 (Day 1..Day 7)
      const day = routine.days.find(d => d.order === idx) || routine.days[idx] || null;
      return { routine, day, dayIndex: idx };
    }

    function isTrained(dateISO){
      return (state.attendance || []).includes(dateISO);
    }

    function toggleTrained(dateISO){
      state.attendance = state.attendance || [];
      const i = state.attendance.indexOf(dateISO);
      if(i >= 0) state.attendance.splice(i, 1);
      else state.attendance.push(dateISO);
      Storage.save(state);
    }
    /********************
     * Attendance Helpers (Step 9)
     ********************/
    function ymFromISO(dateISO){
      const [y,m] = String(dateISO).split("-").map(x => parseInt(x,10));
      return { y, m }; // m = 1..12
    }

    function monthTitle(y, m){
      const d = new Date(y, m-1, 1);
      return d.toLocaleString(undefined, { month:"long", year:"numeric" });
    }

    function daysInMonth(y, m){
      return new Date(y, m, 0).getDate(); // m is 1..12
    }

    function firstDayDow(y, m){
      return new Date(y, m-1, 1).getDay(); // 0=Sun..6=Sat
    }

    function isoForYMD(y, m, d){
      return `${y}-${pad2(m)}-${pad2(d)}`;
    }

    const AttendanceEngine = {
      ensure(){
        state.attendance = state.attendance || [];
      },
      monthCount(y, m){
        this.ensure();
        const prefix = `${y}-${pad2(m)}-`;
        return state.attendance.filter(x => String(x).startsWith(prefix)).length;
      },
      clearMonth(y, m){
        this.ensure();
        const prefix = `${y}-${pad2(m)}-`;
        state.attendance = state.attendance.filter(x => !String(x).startsWith(prefix));
        Storage.save(state);
      }
    };

    const normName = (s) => (s || "").trim().replace(/\s+/g, " ").toLowerCase();

    /********************
     * 3) Routine templates
     ********************/
    const RoutineTemplates = [
      { key:"ppl", name:"PPL", desc:"Push / Pull / Legs • 6 days + 1 rest",
        buildDays(){ return [
          { label:"Push", isRest:false },{ label:"Pull", isRest:false },{ label:"Legs", isRest:false },
          { label:"Push", isRest:false },{ label:"Pull", isRest:false },{ label:"Legs", isRest:false },
          { label:"Rest", isRest:true }
        ];}},
      { key:"upper_lower", name:"Upper / Lower", desc:"4 training days • balanced • strength + size",
        buildDays(){ return [
          { label:"Upper", isRest:false },{ label:"Lower", isRest:false },{ label:"Rest", isRest:true },
          { label:"Upper", isRest:false },{ label:"Lower", isRest:false },{ label:"Rest", isRest:true },
          { label:"Rest", isRest:true }
        ];}},
      { key:"full_body_3", name:"Full Body (3-day)", desc:"3 training days • simple and effective",
        buildDays(){ return [
          { label:"Full Body", isRest:false },{ label:"Rest", isRest:true },
          { label:"Full Body", isRest:false },{ label:"Rest", isRest:true },
          { label:"Full Body", isRest:false },{ label:"Rest", isRest:true },{ label:"Rest", isRest:true }
        ];}},
      { key:"body_part_split", name:"Body Part Split", desc:"Chest/Back/Legs/Shoulders/Arms + rest",
        buildDays(){ return [
          { label:"Chest", isRest:false },{ label:"Back", isRest:false },{ label:"Legs", isRest:false },
          { label:"Shoulders", isRest:false },{ label:"Arms", isRest:false },
          { label:"Rest", isRest:true },{ label:"Rest", isRest:true }
        ];}},
      { key:"blank", name:"Blank", desc:"Start from scratch (you’ll edit days + exercises)",
        buildDays(){ return [
          { label:"Day 1", isRest:false },{ label:"Day 2", isRest:false },{ label:"Day 3", isRest:false },
          { label:"Day 4", isRest:false },{ label:"Day 5", isRest:false },{ label:"Day 6", isRest:false },
          { label:"Day 7", isRest:false }
        ];}}
    ];

    function createRoutineFromTemplate(templateKey, routineName){
      const tpl = RoutineTemplates.find(t => t.key === templateKey);
      if(!tpl) throw new Error("Invalid template key");

      const routineId = uid("rt");
      const days = tpl.buildDays().map((d, idx) => ({
        id: uid("day"),
        order: idx,
        label: d.label,
        isRest: !!d.isRest,
        exercises: []
      }));

      return {
        id: routineId,
        name: routineName || tpl.name,
        templateKey: tpl.key,
        createdAt: Date.now(),
        days
      };
    }

    /********************
     * 4) Exercise Library Module (Step 3)
     ********************/
    const ExerciseLibrary = {
      typeKeys: ["weightlifting","cardio","core"],
      typeLabel(type){
        if(type === "weightlifting") return "Weightlifting";
        if(type === "cardio") return "Cardio";
        return "Core";
      },
      ensureSeeded(){
        // Only seed if ALL empty
        const lib = state.exerciseLibrary || (state.exerciseLibrary = { weightlifting:[], cardio:[], core:[] });
        const empty = (lib.weightlifting?.length||0) === 0 && (lib.cardio?.length||0) === 0 && (lib.core?.length||0) === 0;
        if(!empty) return;

        lib.weightlifting = [
          { id: uid("ex"), type:"weightlifting", name:"Bench Press", equipment:"barbell", primaryMuscle:"chest", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Incline Dumbbell Press", equipment:"dumbbell", primaryMuscle:"chest", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Lat Pulldown", equipment:"cable", primaryMuscle:"back", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Barbell Squat", equipment:"barbell", primaryMuscle:"legs", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Curl", equipment:"dumbbell", primaryMuscle:"biceps", isCompound:false, createdAt:Date.now() }
        ];

        lib.cardio = [
          { id: uid("ex"), type:"cardio", name:"Treadmill Run", modality:"run", supportsIncline:true, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Stationary Bike", modality:"bike", supportsIncline:false, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Rowing Machine", modality:"row", supportsIncline:false, createdAt:Date.now() }
        ];

        lib.core = [
          { id: uid("ex"), type:"core", name:"Plank", equipment:"bodyweight", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Hanging Knee Raise", equipment:"bodyweight", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Cable Crunch", equipment:"cable", createdAt:Date.now() }
        ];

        Storage.save(state);
      },
      list(type){
        return (state.exerciseLibrary?.[type] || []);
      },
      existsByName(type, name, excludeId=null){
        const n = normName(name);
        return this.list(type).some(x => normName(x.name) === n && x.id !== excludeId);
      },
      add(type, data){
        if(this.existsByName(type, data.name)) throw new Error("Exercise already exists in this category.");
        const ex = { id: uid("ex"), type, createdAt: Date.now(), ...data };
        state.exerciseLibrary[type].push(ex);
        Storage.save(state);
        return ex;
      },
      update(type, id, patch){
        const arr = this.list(type);
        const idx = arr.findIndex(x => x.id === id);
        if(idx < 0) throw new Error("Exercise not found.");
        const nextName = patch.name ?? arr[idx].name;
        if(this.existsByName(type, nextName, id)) throw new Error("Another exercise with that name already exists.");
        arr[idx] = { ...arr[idx], ...patch };
        Storage.save(state);
        return arr[idx];
      },
      remove(type, id){
        const arr = this.list(type);
        const idx = arr.findIndex(x => x.id === id);
        if(idx < 0) return;
        arr.splice(idx, 1);
        Storage.save(state);
      }
    };

        /********************
     * 4b) Routine Engine (Step 4)
     ********************/
    const Routines = {
      getAll(){ return state.routines || (state.routines = []); },
      getActive(){
        const id = state.activeRoutineId;
        return this.getAll().find(r => r.id === id) || null;
      },
      setActive(id){
        state.activeRoutineId = id;
        Storage.save(state);
      },
      addFromTemplate(templateKey, nameOverride=null){
        const tplName = RoutineTemplates.find(t => t.key === templateKey)?.name || "Routine";
        const routine = createRoutineFromTemplate(templateKey, nameOverride || tplName);
        this.getAll().push(routine);
        state.activeRoutineId = routine.id;
        Storage.save(state);
        return routine;
      },
      duplicate(routineId){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) throw new Error("Routine not found.");
        const copy = {
          ...r,
          id: uid("rt"),
          name: `${r.name} (Copy)`,
          createdAt: Date.now(),
          days: (r.days || []).map(d => ({
            ...d,
            id: uid("day"),
            exercises: (d.exercises || []).map(ex => ({ ...ex, id: uid("rx") }))
          }))
        };
        this.getAll().push(copy);
        state.activeRoutineId = copy.id;
        Storage.save(state);
        return copy;
      },
      remove(routineId){
        const arr = this.getAll();
        const idx = arr.findIndex(x => x.id === routineId);
        if(idx < 0) return;
        arr.splice(idx, 1);

        // If deleted active routine, pick next best
        if(state.activeRoutineId === routineId){
          state.activeRoutineId = arr[0]?.id || null;
        }
        Storage.save(state);
      },
      rename(routineId, newName){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) throw new Error("Routine not found.");
        r.name = (newName || "").trim() || r.name;
        Storage.save(state);
      },

      getDay(routineId, dayId){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) return null;
        return (r.days || []).find(d => d.id === dayId) || null;
      },

      setRestDay(routineId, dayId, isRest){
        const day = this.getDay(routineId, dayId);
        if(!day) throw new Error("Day not found.");
        day.isRest = !!isRest;
        Storage.save(state);
      },

      setDayLabel(routineId, dayId, label){
        const day = this.getDay(routineId, dayId);
        if(!day) throw new Error("Day not found.");
        day.label = (label || "").trim() || day.label;
        Storage.save(state);
      },

      addExerciseToDay(routineId, dayId, exType, exerciseId){
        const day = this.getDay(routineId, dayId);
        if(!day) throw new Error("Day not found.");
        const libItem = (state.exerciseLibrary?.[exType] || []).find(x => x.id === exerciseId);
        if(!libItem) throw new Error("Exercise not found in library.");
        day.exercises = day.exercises || [];
        day.exercises.push({
          id: uid("rx"),
          exerciseId,
          type: exType,
          nameSnap: libItem.name,
          createdAt: Date.now()
        });
        Storage.save(state);
      },

      removeExerciseFromDay(routineId, dayId, routineExerciseId){
        const day = this.getDay(routineId, dayId);
        if(!day) throw new Error("Day not found.");
        day.exercises = day.exercises || [];
        const idx = day.exercises.findIndex(x => x.id === routineExerciseId);
        if(idx >= 0) day.exercises.splice(idx, 1);
        Storage.save(state);
      }
    };

    // Shared helper for "Pick exercise" modals
    function resolveExerciseName(type, exerciseId, fallback){
      const found = (state.exerciseLibrary?.[type] || []).find(x => x.id === exerciseId);
      return found?.name || fallback || "Unknown exercise";
    }
    /********************
     * 4c) Protein (Today) Helpers (Step 5)
     ********************/
    function getProteinForDate(dateISO){
      state.logs = state.logs || { workouts: [], weight: [], protein: [] };
      state.logs.protein = state.logs.protein || [];
      let entry = state.logs.protein.find(x => x.dateISO === dateISO);
      if(!entry){
        entry = { dateISO, meals: [] }; // meals: [{ id, label, grams }]
        state.logs.protein.push(entry);
        Storage.save(state);
      }
      return entry;
    }

    function upsertMeal(dateISO, mealId, label, grams){
      const p = getProteinForDate(dateISO);
      p.meals = p.meals || [];
      const idx = p.meals.findIndex(m => m.id === mealId);
      const clean = {
        id: mealId || uid("meal"),
        label: (label || "").trim() || "Meal",
        grams: Math.max(0, Math.round(Number(grams) || 0))
      };
      if(idx >= 0) p.meals[idx] = clean;
      else p.meals.push(clean);
      Storage.save(state);
      return clean.id;
    }

    function deleteMeal(dateISO, mealId){
      const p = getProteinForDate(dateISO);
      p.meals = p.meals || [];
      const idx = p.meals.findIndex(m => m.id === mealId);
      if(idx >= 0) p.meals.splice(idx, 1);
      Storage.save(state);
    }

    function totalProtein(dateISO){
      const p = getProteinForDate(dateISO);
      return (p.meals || []).reduce((sum,m) => sum + (Number(m.grams)||0), 0);
    }
    /********************
     * 4d) Log Engine + PR Engine (Step 6)  ✅ FIXED
     ********************/
    const LogEngine = {
      ensure(){
        state.logs = state.logs || { workouts: [], weight: [], protein: [] };
        state.logs.workouts = state.logs.workouts || [];
      },

      addEntry(entry){
        this.ensure();
        state.logs.workouts.push(entry);
        Storage.save(state);
      },

      entriesForExercise(type, exerciseId){
        this.ensure();
        return state.logs.workouts
          .filter(e => e.type === type && e.exerciseId === exerciseId)
          .sort((a,b) => (b.dateISO || "").localeCompare(a.dateISO || "") || (b.createdAt||0)-(a.createdAt||0));
      },

      lifetimeBests(type, exerciseId){
        const entries = this.entriesForExercise(type, exerciseId);
        const bests = {
          bestWeight: null,
          best1RM: null,
          bestVolume: null,
          bestPace: null
        };

        for(const e of entries){
          if(e?.summary){
            if(type === "weightlifting"){
              if(Number.isFinite(e.summary.bestWeight)) bests.bestWeight = Math.max(bests.bestWeight ?? -Infinity, e.summary.bestWeight);
              if(Number.isFinite(e.summary.best1RM)) bests.best1RM = Math.max(bests.best1RM ?? -Infinity, e.summary.best1RM);
              if(Number.isFinite(e.summary.totalVolume)) bests.bestVolume = Math.max(bests.bestVolume ?? -Infinity, e.summary.totalVolume);
            } else if(type === "cardio"){
              if(Number.isFinite(e.summary.paceSecPerUnit)){
                bests.bestPace = Math.min(bests.bestPace ?? Infinity, e.summary.paceSecPerUnit);
              }
            } else if(type === "core"){
              if(Number.isFinite(e.summary.totalVolume)) bests.bestVolume = Math.max(bests.bestVolume ?? -Infinity, e.summary.totalVolume);
            }
          }
        }

        if(bests.bestWeight === -Infinity) bests.bestWeight = null;
        if(bests.best1RM === -Infinity) bests.best1RM = null;
        if(bests.bestVolume === -Infinity) bests.bestVolume = null;
        if(bests.bestPace === Infinity) bests.bestPace = null;

        return bests;
      },

      computeWeightliftingSummary(sets){
        const cleanSets = (sets || []).map(s => ({
          weight: Number(s.weight) || 0,
          reps: Math.max(0, Math.floor(Number(s.reps) || 0))
        }));

        let totalVolume = 0;
        let bestWeight = 0;
        let best1RM = 0;

        for(const s of cleanSets){
          totalVolume += (s.weight * s.reps);
          bestWeight = Math.max(bestWeight, s.weight);
          const epley = (s.reps > 0) ? (s.weight * (1 + (s.reps / 30))) : 0;
          best1RM = Math.max(best1RM, epley);
        }

        return {
          totalVolume: round2(totalVolume),
          bestWeight: round2(bestWeight),
          best1RM: round2(best1RM)
        };
      },

      computeCardioSummary(sets){
        const clean = (sets || []).map(s => ({
          timeSec: Math.max(0, Math.floor(Number(s.timeSec) || 0)),
          distance: Number(s.distance) || 0,
          incline: Number.isFinite(Number(s.incline)) ? Number(s.incline) : null
        }));

        const s = clean[0] || { timeSec:0, distance:0, incline:null };
        const pace = (s.distance > 0) ? (s.timeSec / s.distance) : null;

        return {
          timeSec: s.timeSec,
          distance: round2(s.distance),
          incline: s.incline,
          paceSecPerUnit: (pace === null) ? null : round2(pace)
        };
      },

      computeCoreSummary(sets){
        const clean = (sets || []).map(s => ({
          sets: Math.max(0, Math.floor(Number(s.sets) || 0)),
          reps: Math.max(0, Math.floor(Number(s.reps) || 0)),
          timeSec: Math.max(0, Math.floor(Number(s.timeSec) || 0)),
          weight: Number(s.weight) || 0
        }));

        let totalVolume = 0;
        for(const s of clean){
          if(s.reps > 0){
            const w = (s.weight > 0) ? s.weight : 1;
            totalVolume += (s.reps * s.sets * w);
          }else{
            totalVolume += s.timeSec;
          }
        }

        return { totalVolume: round2(totalVolume) };
      },

      computePRFlags(type, exerciseId, summary){
        const prev = this.lifetimeBests(type, exerciseId);

        const pr = {
          isPRWeight: false,
          isPR1RM: false,
          isPRVolume: false,
          isPRPace: false
        };

        if(type === "weightlifting"){
          if(Number.isFinite(summary.bestWeight)){
            pr.isPRWeight = (prev.bestWeight === null) ? (summary.bestWeight > 0) : (summary.bestWeight > prev.bestWeight);
          }
          if(Number.isFinite(summary.best1RM)){
            pr.isPR1RM = (prev.best1RM === null) ? (summary.best1RM > 0) : (summary.best1RM > prev.best1RM);
          }
          if(Number.isFinite(summary.totalVolume)){
            pr.isPRVolume = (prev.bestVolume === null) ? (summary.totalVolume > 0) : (summary.totalVolume > prev.bestVolume);
          }
        } else if(type === "cardio"){
          if(summary.paceSecPerUnit !== null && Number.isFinite(summary.paceSecPerUnit)){
            pr.isPRPace = (prev.bestPace === null) ? (summary.paceSecPerUnit > 0) : (summary.paceSecPerUnit < prev.bestPace);
          }
        } else if(type === "core"){
          if(Number.isFinite(summary.totalVolume)){
            pr.isPRVolume = (prev.bestVolume === null) ? (summary.totalVolume > 0) : (summary.totalVolume > prev.bestVolume);
          }
        }

        return pr;
      }
    };

    function round2(n){
      return Math.round((Number(n) || 0) * 100) / 100;
    }

    function formatTime(sec){
      const s = Math.max(0, Math.floor(Number(sec) || 0));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    function formatPace(paceSecPerUnit){
      if(paceSecPerUnit === null || !Number.isFinite(paceSecPerUnit)) return "—";
      return `${formatTime(paceSecPerUnit)} / unit`;
    }
        /********************
     * 4e) Progress Helpers (Step 7)
     ********************/
    let __progressChart = null;

    function destroyProgressChart(){
      try{
        if(__progressChart){
          __progressChart.destroy();
          __progressChart = null;
        }
      }catch(e){
        __progressChart = null;
      }
    }

    function downloadCanvasPNG(canvas, filename){
      try{
        const url = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = url;
        a.download = filename || "progress.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){
        Modal.open({
          title: "Download failed",
          bodyNode: el("div", {}, [
            el("div", { class:"note", text:"Could not export image. Try again or use a different browser." }),
            el("div", { style:"height:12px" }),
            el("button", { class:"btn primary", onClick: Modal.close }, ["OK"])
          ])
        });
      }
    }

    function buildSeries(type, entries){
      // entries expected ascending by date
      const labels = entries.map(e => e.dateISO);

      if(type === "weightlifting"){
        const topWeight = entries.map(e => Number(e.summary?.bestWeight) || 0);
        const est1RM = entries.map(e => Number(e.summary?.best1RM) || 0);
        const volume = entries.map(e => Number(e.summary?.totalVolume) || 0);
        return { labels, datasets: { topWeight, est1RM, volume } };
      }

      if(type === "cardio"){
        const pace = entries.map(e => (e.summary?.paceSecPerUnit == null ? null : Number(e.summary.paceSecPerUnit)));
        const distance = entries.map(e => Number(e.summary?.distance) || 0);
        const timeSec = entries.map(e => Number(e.summary?.timeSec) || 0);
        return { labels, datasets: { pace, distance, timeSec } };
      }

      // core
      const volume = entries.map(e => Number(e.summary?.totalVolume) || 0);
      return { labels, datasets: { volume } };
    }

    function renderProgressChart(canvas, type, metricKey, series){
      destroyProgressChart();

      // Build chart dataset (no custom colors per your standards — Chart.js defaults)
      let data = [];
      let label = "";

      if(type === "weightlifting"){
        if(metricKey === "topWeight"){ data = series.datasets.topWeight; label = "Top Weight"; }
        else if(metricKey === "est1RM"){ data = series.datasets.est1RM; label = "Estimated 1RM (Epley)"; }
        else { data = series.datasets.volume; label = "Volume"; }
      } else if(type === "cardio"){
        if(metricKey === "pace"){ data = series.datasets.pace; label = "Pace (sec/unit) (lower is better)"; }
        else if(metricKey === "distance"){ data = series.datasets.distance; label = "Distance"; }
        else { data = series.datasets.timeSec; label = "Time (sec)"; }
      } else {
        data = series.datasets.volume;
        label = "Core Volume";
      }

      const ctx = canvas.getContext("2d");
      __progressChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: series.labels,
          datasets: [{
            label,
            data,
            tension: 0.25,
            spanGaps: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      return __progressChart;
    }
        /********************
     * 4f) Weight Engine + Chart Helpers (Step 8)
     ********************/
    const WeightEngine = {
      ensure(){
        state.logs = state.logs || { workouts: [], weight: [], protein: [] };
        state.logs.weight = state.logs.weight || [];
      },

      add(dateISO, weight){
        this.ensure();
        const d = String(dateISO || Dates.todayISO());
        const w = Number(weight);
        if(!Number.isFinite(w) || w <= 0) throw new Error("Enter a valid weight.");

        // Upsert by date (one entry per day)
        const idx = state.logs.weight.findIndex(x => x.dateISO === d);
        const entry = { id: uid("wt"), dateISO: d, weight: round2(w), createdAt: Date.now() };
        if(idx >= 0) state.logs.weight[idx] = { ...state.logs.weight[idx], ...entry };
        else state.logs.weight.push(entry);

        Storage.save(state);
        return entry;
      },

      remove(id){
        this.ensure();
        const idx = state.logs.weight.findIndex(x => x.id === id);
        if(idx >= 0){
          state.logs.weight.splice(idx, 1);
          Storage.save(state);
        }
      },

      listDesc(){
        this.ensure();
        const arr = [...state.logs.weight];
        arr.sort((a,b) => (b.dateISO || "").localeCompare(a.dateISO || "") || (b.createdAt||0)-(a.createdAt||0));
        return arr;
      },

      listAsc(){
        return this.listDesc().reverse();
      },

      latest(){
        const d = this.listDesc();
        return d[0] || null;
      },

      previous(){
        const d = this.listDesc();
        return d[1] || null;
      },

      delta(){
        const a = this.latest();
        const b = this.previous();
        if(!a || !b) return null;
        return round2((a.weight || 0) - (b.weight || 0));
      },

      avg7(dateISO){
        // 7-day window ending at dateISO (inclusive)
        this.ensure();
        const end = new Date(String(dateISO || Dates.todayISO()) + "T00:00:00");
        const start = new Date(end);
        start.setDate(start.getDate() - 6);

        const items = state.logs.weight.filter(x => {
          const d = new Date(x.dateISO + "T00:00:00");
          return d >= start && d <= end;
        });

        if(items.length === 0) return null;
        const avg = items.reduce((sum,x) => sum + (Number(x.weight)||0), 0) / items.length;
        return round2(avg);
      }
    };

    let __weightChart = null;

    function destroyWeightChart(){
      try{
        if(__weightChart){
          __weightChart.destroy();
          __weightChart = null;
        }
      }catch(e){
        __weightChart = null;
      }
    }

    function renderWeightChart(canvas, entriesAsc){
      destroyWeightChart();
      const labels = entriesAsc.map(e => e.dateISO);
      const data = entriesAsc.map(e => Number(e.weight) || 0);

      const ctx = canvas.getContext("2d");
      __weightChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Bodyweight",
            data,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: false } }
        }
      });

      return __weightChart;
    }
    /********************
 * 4f) Routine/Attendance Helpers (NEW)
 ********************/

// Attendance helpers (explicit add/remove for manual override scenarios)
function attendanceHas(dateISO){
  state.attendance = state.attendance || [];
  return state.attendance.includes(dateISO);
}
function attendanceAdd(dateISO){
  state.attendance = state.attendance || [];
  if(!state.attendance.includes(dateISO)){
    state.attendance.push(dateISO);
    Storage.save(state);
  }
}
function attendanceRemove(dateISO){
  state.attendance = state.attendance || [];
  const i = state.attendance.indexOf(dateISO);
  if(i >= 0){
    state.attendance.splice(i, 1);
    Storage.save(state);
  }
}

// Routine logging helpers (per-routine-exercise instance)
function hasRoutineExerciseLog(dateISO, routineExerciseId){
  LogEngine.ensure();
  return state.logs.workouts.some(e => e.dateISO === dateISO && e.routineExerciseId === routineExerciseId);
}

function lifetimeMaxSet(type, exerciseId){
  if(type !== "weightlifting") return null;
  const entries = LogEngine.entriesForExercise(type, exerciseId);
  let best = null;
  for(const e of entries){
    for(const s of (e.sets || [])){
      const w = Number(s.weight) || 0;
      const r = Math.max(0, Math.floor(Number(s.reps) || 0));
      if(w <= 0 || r <= 0) continue;
      if(!best) best = { weight: w, reps: r };
      else if(w > best.weight) best = { weight: w, reps: r };
      else if(w === best.weight && r > best.reps) best = { weight: w, reps: r };
    }
  }
  return best;
}

// Floating "Next →" nudge (transient UI only)
let __nextNudge = null; // { dateISO, dayOrder, nextRoutineExerciseId }
function setNextNudge(n){ __nextNudge = n; }

function ensureFloatNext(){
  if(document.getElementById("floatNext")) return;
  const host = el("div", { class:"floatNext", id:"floatNext" }, [
    el("button", { class:"btn", id:"floatNextBtn" }, ["Next →"])
  ]);
  document.body.appendChild(host);
}

function maybeShowNextNudge(dateISO, day){
  const host = document.getElementById("floatNext");
  const btn = document.getElementById("floatNextBtn");
  if(!host || !btn) return;

  const shouldShow = __nextNudge &&
    __nextNudge.dateISO === dateISO &&
    __nextNudge.dayOrder === day.order &&
    __nextNudge.nextRoutineExerciseId;

  host.classList.toggle("show", !!shouldShow);

  if(shouldShow){
    btn.onclick = () => {
      const rxId = __nextNudge.nextRoutineExerciseId;
      const node = document.getElementById(`rx_${rxId}`);
      if(node){
        node.scrollIntoView({ behavior:"smooth", block:"center" });
        node.classList.remove("pulse");
        void node.offsetWidth;
        node.classList.add("pulse");
      }
      __nextNudge = null;
      host.classList.remove("show");
    };
  }else{
    btn.onclick = null;
  }
}

function showToast(message){
  try{
    const existing = document.getElementById("toastTemp");
    if(existing) existing.remove();
    const t = el("div", {
      id:"toastTemp",
      style:"position:fixed; top: 14px; left: 50%; transform: translateX(-50%); z-index: 90; padding: 10px 12px; border-radius: 999px; background: rgba(16,20,30,.92); border: 1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.92); font-size: 12.5px; box-shadow: 0 18px 44px rgba(0,0,0,.55);"
    }, [message]);
    document.body.appendChild(t);
    setTimeout(() => { try{ t.remove(); }catch(e){} }, 1100);
  }catch(e){}
}
    /********************
 * 4g) Glass Dropdown (Popover) UI
 ********************/
let __pop = null;

function PopoverEnsure(){
  if(__pop) return __pop;

  const host = el("div", { class:"popHost", id:"popHost" }, []);
  const backdrop = el("div", { class:"popBackdrop", id:"popBackdrop" }, []);
  const panel = el("div", { class:"popPanel", id:"popPanel" }, []);

  backdrop.addEventListener("click", PopoverClose);

  host.appendChild(backdrop);
  host.appendChild(panel);
  document.body.appendChild(host);

  __pop = { host, panel };
  return __pop;
}

function PopoverOpen(anchorEl, bodyNode){
  const { host, panel } = PopoverEnsure();

  panel.innerHTML = "";
  if(bodyNode) panel.appendChild(bodyNode);

  // Position under anchor, keep within viewport
  const r = anchorEl.getBoundingClientRect();
  const pad = 12;

  // default: left aligned to anchor
  let left = r.left;
  const maxLeft = window.innerWidth - panel.offsetWidth - pad;

  // temporarily show to compute panel width/height
  host.classList.add("show");
  host.style.display = "block";
  const pw = panel.offsetWidth || Math.min(420, window.innerWidth - 24);

  left = Math.max(pad, Math.min(left, window.innerWidth - pw - pad));

  let top = r.bottom + 10;
  const ph = panel.offsetHeight || 320;

  // if it would go below, flip above anchor
  if(top + ph > window.innerHeight - pad){
    top = Math.max(pad, r.top - ph - 10);
  }

  panel.style.left = `${Math.round(left)}px`;
  panel.style.top  = `${Math.round(top)}px`;
}

function PopoverClose(){
  const p = PopoverEnsure();
  p.host.classList.remove("show");
  p.host.style.display = "none";   // ✅ actually hide it
  p.panel.innerHTML = "";          // ✅ clear list so it doesn't linger
}

    /********************
     * 5) Modal
     ********************/
    const Modal = {
      open({ title, bodyNode }){
        $("#modalTitle").textContent = title || "Modal";
        const host = $("#modalHost");
        const body = $("#modalBody");
        body.innerHTML = "";
        if(bodyNode) body.appendChild(bodyNode);
        host.classList.add("show");
        host.setAttribute("aria-hidden","false");
      },
      close(){
        const host = $("#modalHost");
        host.classList.remove("show");
        host.setAttribute("aria-hidden","true");
        $("#modalBody").innerHTML = "";
      }
    };

    $("#modalClose").addEventListener("click", Modal.close);
    $("#modalBackdrop").addEventListener("click", Modal.close);

    /********************
     * 6) Router + Views
     ********************/
    const Routes = {
  // Bottom nav (mobile-first)
  home: { label: "Home", nav:true },
  routine: { label: "Routine", nav:true },
  progress: { label: "Progress", nav:true },
  settings: { label: "Settings", nav:true },

  // Non-nav routes (opened via buttons/links)
  weight: { label: "Weight", nav:false },
  attendance: { label: "Attendance", nav:false },
  routine_editor: { label: "Routine Editor", nav:false }
};

const NAV_KEYS = Object.entries(Routes)
  .filter(([,v]) => v.nav)
  .map(([k]) => k);

function renderNav(){
  const nav = $("#navbar");
  nav.innerHTML = "";

  const disabled = !state.profile;

  NAV_KEYS.forEach((key) => {
    const r = Routes[key];
    nav.appendChild(el("button", {
      class: "navbtn" + (key === currentRoute ? " active" : ""),
      onClick: () => {
        if(disabled){ navigate("home"); return; }
        navigate(key);
      }
    }, [
      el("div", { class:"dot" }),
      el("div", { text: r.label })
    ]));
  });
}


    let currentRoute = "home";

    function setChip(){
      const chip = $("#chipStatus");
      if(state.profile?.name) chip.textContent = `Hi, ${state.profile.name}`;
      else chip.textContent = "Not set up";
    }

    function navigate(routeKey){
      destroyProgressChart();
      destroyWeightChart();
      currentRoute = routeKey;
      renderNav();
      renderView();
    }


    function renderView(){
      setChip();
      const root = $("#viewRoot");
      root.innerHTML = "";

      if(!state.profile){
        root.appendChild(Views.Onboarding());
        return;
      }

          if(currentRoute === "home") root.appendChild(Views.Home());
else if(currentRoute === "routine") root.appendChild(Views.Routine());
else if(currentRoute === "progress") root.appendChild(Views.Progress());
else if(currentRoute === "settings") root.appendChild(Views.Settings());
    }

    /********************
     * 7) Views
     ********************/
    const Views = {
      Onboarding(){
        let hideRestDays = true;
        let selectedTpl = "ppl";

        const errorBox = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

        const switchNode = el("div", { class:"switch on" });
        switchNode.addEventListener("click", () => {
          hideRestDays = !hideRestDays;
          switchNode.classList.toggle("on", hideRestDays);
        });

        const tplCardsHost = el("div", { class:"tplGrid" });
        const renderTplCards = () => {
          tplCardsHost.innerHTML = "";
          RoutineTemplates.forEach(t => {
            tplCardsHost.appendChild(el("div", {
              class: "tpl" + (t.key === selectedTpl ? " selected" : ""),
              onClick: () => { selectedTpl = t.key; renderTplCards(); }
            }, [
              el("div", { class:"name", text: t.name }),
              el("div", { class:"desc", text: t.desc })
            ]));
          });
        };
        renderTplCards();

        const nameInput = el("input", { type:"text", placeholder:"Jordan" });
        const proteinInput = el("input", { type:"number", inputmode:"numeric", placeholder:"180", min:"0" });

        const weekSelect = el("select", {});
        weekSelect.appendChild(el("option", { value:"mon", text:"Monday" }));
        weekSelect.appendChild(el("option", { value:"sun", text:"Sunday" }));
        weekSelect.value = "mon";

        const finish = () => {
          errorBox.style.display = "none";
          errorBox.textContent = "";

          const cleanName = (nameInput.value || "").trim();
          const cleanProtein = Number(proteinInput.value);
          const weekStartsOn = weekSelect.value === "sun" ? "sun" : "mon";

          if(!cleanName){
            errorBox.textContent = "Please enter your name.";
            errorBox.style.display = "block";
            return;
          }
          if(!Number.isFinite(cleanProtein) || cleanProtein <= 0){
            errorBox.textContent = "Please enter a valid daily protein goal (grams).";
            errorBox.style.display = "block";
            return;
          }

          const profile = {
            name: cleanName,
            proteinGoal: Math.round(cleanProtein),
            weekStartsOn,
            hideRestDays: !!hideRestDays
          };

          const routineName = RoutineTemplates.find(t => t.key === selectedTpl)?.name || "Routine";
          const routine = createRoutineFromTemplate(selectedTpl, routineName);

          state.profile = profile;
          state.routines = [routine];
          state.activeRoutineId = routine.id;

          // Seed library if empty
          ExerciseLibrary.ensureSeeded();

          Storage.save(state);
          navigate("home");
        };

        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Welcome" }),
            el("div", { class:"kpi" }, [
              el("div", { class:"big", text:"Let’s set up your dashboard" }),
              el("div", { class:"small", text:"Create your profile and choose a routine template. You can edit everything later." })
            ])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Create profile" }),
            el("div", { class:"form" }, [
              el("div", { class:"row2" }, [
                el("label", {}, [ el("span", { text:"Name" }), nameInput ]),
                el("label", {}, [ el("span", { text:"Protein goal (grams/day)" }), proteinInput ])
              ]),
              el("div", { class:"row2" }, [
                el("label", {}, [ el("span", { text:"Week starts on" }), weekSelect ]),
                el("div", { class:"toggle" }, [
                  el("div", { class:"ttext" }, [
                    el("div", { class:"a", text:"Hide rest days" }),
                    el("div", { class:"b", text:"Rest days won’t appear on Home (Routine can still show them later)" })
                  ]),
                  switchNode
                ])
              ]),
              errorBox
            ])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Choose a routine template" }),
            tplCardsHost,
            el("div", { style:"height:10px" }),
            el("div", { class:"btnrow" }, [
              el("button", { class:"btn primary", onClick: finish }, ["Finish setup"]),
              el("button", {
                class:"btn danger",
                onClick: () => {
                  Modal.open({
                    title: "Reset local data",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text:"This clears everything saved in this browser for the app." }),
                      el("div", { style:"height:12px" }),
                      el("div", { class:"btnrow" }, [
                        el("button", {
                          class:"btn danger",
                          onClick: () => {
                            Storage.reset();
                            state = Storage.load();
                            Modal.close();
                            navigate("home");
                          }
                        }, ["Reset"]),
                        el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                      ])
                    ])
                  });
                }
              }, ["Reset"])
            ])
          ])
        ]);
      },

      Home(){
        ExerciseLibrary.ensureSeeded();

        const todayISO = Dates.todayISO();
        const weekStartsOn = state.profile?.weekStartsOn || "mon";
        const weekStartISO = Dates.startOfWeekISO(todayISO, weekStartsOn);

        const { routine, day } = getTodayWorkout();

        const trainedThisWeek = [];
        for(let i=0;i<7;i++){
          const dISO = Dates.addDaysISO(weekStartISO, i);
          trainedThisWeek.push({ dateISO: dISO, trained: isTrained(dISO) });
        }

        // Protein
        const goal = Number(state.profile?.proteinGoal) || 0;
        const done = totalProtein(todayISO);
        const left = Math.max(0, goal - done);
        const pct = goal > 0 ? Math.max(0, Math.min(1, done / goal)) : 0;
        const deg = Math.round(pct * 360);

        const openProteinModal = () => {
          Modal.open({
            title: "Today’s protein",
            bodyNode: buildProteinTodayModal(todayISO, goal)
          });
        };

        const openCheckIn = () => {
          toggleTrained(todayISO);
          renderView();
        };

        const workoutTitle = !routine ? "No routine selected"
          : (!day ? "No day found"
          : (day.isRest ? "Rest Day" : day.label));

        const workoutSub = !routine ? "Go to Routine → create/select a routine."
          : (!day ? "Open Routine Editor to fix day mapping."
          : (day.isRest ? "Recovery day. Hydrate + mobility."
          : `${(day.exercises || []).length} exercises planned`));

        const workoutExercises = (day?.isRest || !day) ? []
          : (day.exercises || []).map(rx => resolveExerciseName(rx.type, rx.exerciseId, rx.nameSnap));

        const ring = el("div", {
          class:"ringWrap",
          style: `background: conic-gradient(rgba(124,92,255,.95) 0deg ${deg}deg, rgba(255,255,255,.10) ${deg}deg 360deg);`
        }, [
          el("div", { class:"ringText" }, [
            el("div", { class:"big", text: `${left}g` }),
            el("div", { class:"small", text: "left" }),
            el("div", { class:"small", text: `${done} / ${goal}g` })
          ])
        ]);

        const dots = el("div", { class:"dots" });
        trainedThisWeek.forEach((d, idx) => {
          const dot = el("div", { class:"dotDay" + (d.trained ? " on" : "") });
          dots.appendChild(dot);
        });

        const weekLabel = weekStartsOn === "sun" ? "Week (Sun–Sat)" : "Week (Mon–Sun)";

        return el("div", { class:"grid cols2" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Today’s workout" }),
            el("div", { class:"kpi" }, [
              el("div", { class:"big", text: workoutTitle }),
              el("div", { class:"small", text: workoutSub })
            ]),
            el("div", { style:"height:10px" }),

            (workoutExercises.length === 0)
              ? el("div", { class:"note", text: day?.isRest ? "Rest day is enabled." : "Add exercises in Routine Editor." })
              : el("div", { class:"list" }, workoutExercises.slice(0,6).map(n =>
                  el("div", { class:"item" }, [
                    el("div", { class:"left" }, [ el("div", { class:"name", text: n }) ]),
                    el("div", { class:"actions" }, [ el("div", { class:"meta", text:"Planned" }) ])
                  ])
                )),

            el("div", { style:"height:10px" }),
            el("div", { class:"btnrow" }, [
              el("button", { class:"btn primary", onClick: openCheckIn }, [isTrained(todayISO) ? "Undo check-in" : "Check in"]),
              el("button", { class:"btn", onClick: () => navigate("routine") }, ["Edit routine"])
            ])
          ]),

          el("div", { class:"card" }, [
            el("h2", { text:"Protein" }),
            el("div", { class:"homeRow" }, [
              el("div", { class:"kpi" }, [
                el("div", { class:"big", text: `${left}g left` }),
                el("div", { class:"small", text:"Tap to log meals for today." })
              ]),
              el("div", { onClick: openProteinModal }, [ ring ])
            ]),
            el("div", { style:"height:10px" }),
            el("div", { class:"btnrow" }, [
              el("button", { class:"btn primary", onClick: openProteinModal }, ["Log meals"])
            ])
          ]),

          el("div", { class:"card" }, [
            el("h2", { text:"Attendance" }),
            el("div", { class:"note", text: weekLabel }),
            el("div", { style:"height:10px" }),
            dots,
            el("div", { style:"height:10px" }),
            el("div", { class:"note", text:`This week: ${trainedThisWeek.filter(x => x.trained).length} sessions` })
          ]),

          el("div", { class:"card" }, [
            el("h2", { text:"Quick stats" }),
            el("div", { class:"note", text:`Exercises saved: ${
              (state.exerciseLibrary.weightlifting?.length||0) +
              (state.exerciseLibrary.cardio?.length||0) +
              (state.exerciseLibrary.core?.length||0)
            }` }),
            el("div", { style:"height:10px" }),
            el("div", { class:"note", text:`Active routine: ${Routines.getActive()?.name || "—"}` })
          ])
        ]);

        function buildProteinTodayModal(dateISO, goal){
          const container = el("div", { class:"grid" });

          const listHost = el("div", { class:"list" });
          const footer = el("div", { class:"note" });

          function repaint(){
            listHost.innerHTML = "";

            const p = getProteinForDate(dateISO);
            const meals = p.meals || [];

            if(meals.length === 0){
              listHost.appendChild(el("div", { class:"note", text:"No meals logged yet. Add one below." }));
            }else{
              meals.forEach(m => {
                listHost.appendChild(el("div", { class:"item" }, [
                  el("div", { class:"left" }, [
                    el("div", { class:"name", text: m.label }),
                    el("div", { class:"meta", text: `${m.grams}g` })
                  ]),
                  el("div", { class:"actions" }, [
                    el("button", { class:"mini", onClick: () => openMealEditor(m) }, ["Edit"]),
                    el("button", { class:"mini danger", onClick: () => { deleteMeal(dateISO, m.id); repaint(); renderView(); } }, ["Delete"])
                  ])
                ]));
              });
            }

            const done = totalProtein(dateISO);
            const left = Math.max(0, goal - done);
            footer.textContent = `Today: ${done}g • Left: ${left}g • Goal: ${goal}g`;
          }

          function openMealEditor(meal){
            const labelInput = el("input", { type:"text", placeholder:"Meal name", value: meal?.label || "" });
            const gramsInput = el("input", { type:"number", inputmode:"numeric", placeholder:"Protein grams", min:"0", value: meal?.grams ?? "" });
            const err = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

            Modal.open({
              title: meal ? "Edit meal" : "Add meal",
              bodyNode: el("div", {}, [
                el("label", {}, [ el("span", { text:"Label" }), labelInput ]),
                el("label", {}, [ el("span", { text:"Protein (grams)" }), gramsInput ]),
                err,
                el("div", { style:"height:12px" }),
                el("div", { class:"btnrow" }, [
                  el("button", {
                    class:"btn primary",
                    onClick: () => {
                      err.style.display = "none";
                      const label = (labelInput.value || "").trim();
                      const grams = Number(gramsInput.value);
                      if(!label){ err.textContent="Label required."; err.style.display="block"; return; }
                      if(!Number.isFinite(grams) || grams < 0){ err.textContent="Enter valid grams."; err.style.display="block"; return; }
                      upsertMeal(dateISO, meal?.id || null, label, grams);
                      Modal.close();
                      repaint();
                      renderView(); // update ring live
                    }
                  }, ["Save"]),
                  el("button", { class:"btn", onClick: () => { Modal.close(); } }, ["Cancel"])
                ])
              ])
            });
          }

          const addBtn = el("button", { class:"btn primary", onClick: () => openMealEditor(null) }, ["Add meal"]);

          container.appendChild(el("div", { class:"note", text:`Date: ${dateISO}` }));
          container.appendChild(listHost);
          container.appendChild(el("div", { class:"btnrow" }, [ addBtn ]));
          container.appendChild(footer);

          repaint();
          return container;
        }
      },

Routine(){
  const root = el("div", { class:"grid" });

  let routine = Routines.getActive();
  if(!routine){
    root.appendChild(el("div", { class:"card" }, [
      el("h2", { text:"Routine" }),
      el("div", { class:"note", text:"No active routine found. Create one in Settings." })
    ]));
    return root;
  }

  const today = new Date();
  const todayIndex = today.getDay();               // 0=Sun..6=Sat
  const todayISO = today.toISOString().slice(0,10);

  let selectedIndex = todayIndex;

  function getDay(index){
    routine = Routines.getActive(); // ✅ always refresh active routine
    return (routine?.days || []).find(d => d.order === index) || null;
  }

  function openRoutinePicker(anchorBtn){
    const all = Routines.getAll();
    if(!all || all.length === 0){
      showToast("No routines found.");
      return;
    }

    const activeId = Routines.getActive()?.id || null;

    const body = el("div", {}, [
      el("div", { class:"popTitle", text:"Select routine" }),
      el("div", { style:"display:grid; gap:10px;" }, all.map(r => {
        const isActive = (r.id === activeId);
        return el("div", {
          class:"popItem",
          onClick: () => {
            Routines.setActive(r.id);
            routine = Routines.getActive();
            selectedIndex = todayIndex;

            PopoverClose();     // ✅ now truly closes
            repaint();          // ✅ updates immediately
          }
        }, [
          el("div", { class:"l" }, [
            el("div", { class:"n", text:r.name }),
            el("div", { class:"m", text: isActive ? "Currently active" : "Tap to activate" })
          ]),
          isActive ? el("div", { class:"popBadge", text:"Active" }) : el("div", { class:"m", text:"" })
        ]);
      }))
    ]);

    PopoverOpen(anchorBtn, body);
  }

  function repaint(){
    routine = Routines.getActive();
    root.innerHTML = "";

    const day = getDay(selectedIndex);

    // ────────────────────────────
    // Header Card (locked layout)
    // ────────────────────────────
    root.appendChild(el("div", { class:"card" }, [
      el("h2", { text:"Routine" }),
      el("div", { class:"note", text:`${routine.name} • Mon–Sun` }),

      el("div", { style:"height:10px" }),

      el("div", { class:"rHdrRow" }, [
        el("button", {
          class:"btn ghost",
          onClick: (e) => openRoutinePicker(e.currentTarget)
        }, [`${routine.name} ▼`]),

        el("button", {
          class:"btn primary",
          onClick: () => {
            selectedIndex = todayIndex;
            repaint();
            setTimeout(()=>{
              const first = root.querySelector("[data-unlogged='true']");
              if(first){
                first.scrollIntoView({ behavior:"smooth", block:"center" });
                first.classList.add("pulse");
                setTimeout(()=>first.classList.remove("pulse"),1200);
              }
            },0);
          }
        }, ["▶ Start Today"])
      ]),

      el("div", {
        class:"manageLink",
        onClick: () => navigate("routine_editor")
      }, ["Manage Routine ▾"])
    ]));

    if(!day){
      root.appendChild(el("div", { class:"card note" }, ["No day found."]));
      return;
    }

    // ────────────────────────────
    // 3D Card Carousel (visual container)
    // ────────────────────────────
    root.appendChild(el("div", { class:"card carouselCard" }, [
      el("div", { class:"carouselTop" }, [
        el("button", {
          class:"btn",
          onClick: () => { selectedIndex = (selectedIndex + 6) % 7; repaint(); }
        }, ["◀"]),

        el("div", { class:"carouselMid" }, [
          el("div", {
            class:"carouselTitle",
            text: `${["SUN","MON","TUE","WED","THU","FRI","SAT"][selectedIndex]} — ${day.label || "Day"}`
          }),
          el("div", {
            class:"carouselSub",
            text: day.isRest ? "Rest" : `${(day.exercises||[]).length} exercises`
          })
        ]),

        el("button", {
          class:"btn",
          onClick: () => { selectedIndex = (selectedIndex + 1) % 7; repaint(); }
        }, ["▶"])
      ]),

      el("div", { class:"weekRow" }, [
        el("div", { class:"weekLabel", text:"M   T   W   T   F   S   S" }),
        el("div", { class:"weekDots" }, [
          // order = Mon Tue Wed Thu Fri Sat Sun
          ...[1,2,3,4,5,6,0].map(i => el("div", {
            class: "weekDot" + (i === selectedIndex ? " on" : "")
          }))
        ])
      ])
    ]));

    // Rest Day
    if(day.isRest){
      root.appendChild(el("div", { class:"card" }, [
        el("h2", { text:"Rest" }),
        el("div", { class:"note", text:"Today is a scheduled rest day." })
      ]));
      return;
    }

    // ────────────────────────────
    // Exercise Cards
    // ────────────────────────────
    (day.exercises || []).forEach(rx => {
      const exName = resolveExerciseName(rx.type, rx.exerciseId, rx.nameSnap);
      const logged = hasRoutineExerciseLog(todayISO, rx.id);

      const max = lifetimeMaxSet(rx.type, rx.exerciseId);
      const maxText = max ? `${max.weight} × ${max.reps}` : "—";

      root.appendChild(el("div", {
        class:"card",
        id:`rx_${rx.id}`,
        "data-unlogged": logged ? "false" : "true"
      }, [
        el("div", { style:"font-weight:860; letter-spacing:.1px;", text: exName }),
        el("div", { class:"note", text:`🏆 Lifetime Max: ${maxText}` }),

        el("div", { style:"height:10px" }),

        el("div", { class:"rHdrRow" }, [
          el("button", {
            class:"btn primary",
            onClick: () => alert("Workout execution comes next phase.")
          }, ["Log Sets"]),

          el("button", {
            class:"btn ghost",
            onClick: () => navigate("progress")
          }, ["History →"])
        ])
      ]));
    });
  }

  repaint();
  return root;
},

           Progress(){
        ExerciseLibrary.ensureSeeded();
        LogEngine.ensure();

        // Defaults
        let type = "weightlifting";
        let exerciseId = (state.exerciseLibrary?.weightlifting?.[0]?.id) || null;

        // Metric default per type
        let metric = "topWeight"; // weightlifting: topWeight|est1RM|volume
        // cardio: pace|distance|timeSec
        // core: volume

        const root = el("div", { class:"grid" });

        const header = el("div", { class:"card" }, [
          el("h2", { text:"Progress" }),
          el("div", { class:"note", text:"View your history by exercise. Switch metrics and export the chart as a PNG." })
        ]);

        const controls = el("div", { class:"card" }, [
          el("h2", { text:"Filters" })
        ]);

        const tableCard = el("div", { class:"card" }, [
          el("h2", { text:"Table" })
        ]);

        const chartCard = el("div", { class:"card" }, [
          el("h2", { text:"Graph" })
        ]);

        root.appendChild(header);
        root.appendChild(controls);
        root.appendChild(chartCard);
        root.appendChild(tableCard);

        // Controls
        const typeSelect = el("select", {});
        ["weightlifting","cardio","core"].forEach(t => {
          typeSelect.appendChild(el("option", { value:t, text: t === "weightlifting" ? "Weightlifting" : (t === "cardio" ? "Cardio" : "Core") }));
        });

        const exSelect = el("select", {});
        const metricSelect = el("select", {});

        const chartWrap = el("div", { class:"chartWrap" });
        const canvas = el("canvas", {});
        chartWrap.appendChild(canvas);

        const downloadBtn = el("button", {
          class:"btn",
          onClick: () => {
            const exName = resolveExerciseName(type, exerciseId, "exercise").replace(/\s+/g,"_");
            downloadCanvasPNG(canvas, `progress_${type}_${exName}.png`);
          }
        }, ["Download PNG"]);

        const refreshBtn = el("button", {
          class:"btn",
          onClick: () => repaint(true)
        }, ["Refresh"]);

        controls.appendChild(el("div", { class:"row2" }, [
          el("label", {}, [ el("span", { text:"Type" }), typeSelect ]),
          el("label", {}, [ el("span", { text:"Exercise" }), exSelect ])
        ]));

        controls.appendChild(el("div", { class:"row2" }, [
          el("label", {}, [ el("span", { text:"Metric" }), metricSelect ]),
          el("div", { style:"display:flex; align-items:end; gap:10px; flex-wrap:wrap;" }, [
            downloadBtn,
            refreshBtn
          ])
        ]));

        // Chart area
        chartCard.appendChild(chartWrap);
        const chartNote = el("div", { class:"note", style:"margin-top:10px;" });
        chartCard.appendChild(chartNote);

        // Table area
        const tableHost = el("div", { class:"list" });
        tableCard.appendChild(tableHost);

        // Events
        typeSelect.value = type;
        typeSelect.addEventListener("change", () => {
          type = typeSelect.value;
          exerciseId = (state.exerciseLibrary?.[type]?.[0]?.id) || null;
          metric = defaultMetricForType(type);
          repaint(true);
        });

        exSelect.addEventListener("change", () => {
          exerciseId = exSelect.value || null;
          repaint(true);
        });

        metricSelect.addEventListener("change", () => {
          metric = metricSelect.value;
          repaint(true);
        });

        // Initial paint
        repaint(true);

        // Ensure chart cleaned up if you navigate away later
        // (Chart.js can leak if you re-enter view repeatedly)
        setTimeout(() => {
          // noop — chart exists only for this view lifetime
        }, 0);

        return root;

        function defaultMetricForType(t){
          if(t === "weightlifting") return "topWeight";
          if(t === "cardio") return "pace";
          return "volume";
        }

        function repaint(forceChart){
          // Exercise dropdown
          exSelect.innerHTML = "";
          const lib = (state.exerciseLibrary?.[type] || []).slice().sort((a,b) => (a.name||"").localeCompare(b.name||""));
          if(lib.length === 0){
            exSelect.appendChild(el("option", { value:"", text:"No exercises — create one in Library" }));
            exerciseId = null;
          }else{
            lib.forEach(x => exSelect.appendChild(el("option", { value:x.id, text:x.name })));
            if(!exerciseId || !lib.some(x => x.id === exerciseId)) exerciseId = lib[0].id;
            exSelect.value = exerciseId;
          }

          // Metric dropdown
          metricSelect.innerHTML = "";
          if(type === "weightlifting"){
            metricSelect.appendChild(el("option", { value:"topWeight", text:"Top Weight" }));
            metricSelect.appendChild(el("option", { value:"est1RM", text:"Estimated 1RM (Epley)" }));
            metricSelect.appendChild(el("option", { value:"volume", text:"Volume" }));
          }else if(type === "cardio"){
            metricSelect.appendChild(el("option", { value:"pace", text:"Pace (lower is better)" }));
            metricSelect.appendChild(el("option", { value:"distance", text:"Distance" }));
            metricSelect.appendChild(el("option", { value:"timeSec", text:"Time" }));
          }else{
            metricSelect.appendChild(el("option", { value:"volume", text:"Core Volume" }));
          }
          // keep selection if possible
          const allVals = [...metricSelect.querySelectorAll("option")].map(o => o.value);
          if(!allVals.includes(metric)) metric = defaultMetricForType(type);
          metricSelect.value = metric;

          // Data
          if(!exerciseId){
            tableHost.innerHTML = "";
            tableHost.appendChild(el("div", { class:"note", text:"Select or create an exercise to view progress." }));
            destroyProgressChart();
            chartNote.textContent = "No data.";
            return;
          }

          // Get entries for exercise, ascending for chart
          const desc = LogEngine.entriesForExercise(type, exerciseId); // desc
          const asc = [...desc].reverse(); // asc

          // Table (most recent first)
          tableHost.innerHTML = "";
          if(desc.length === 0){
            tableHost.appendChild(el("div", { class:"note", text:"No logs yet. Go to Log and save a few entries." }));
          }else{
            desc.slice(0, 25).forEach(e => {
              tableHost.appendChild(el("div", { class:"item" }, [
                el("div", { class:"left" }, [
                  el("div", { class:"name", text: e.dateISO }),
                  el("div", { class:"meta", text: tableLine(e) })
                ]),
                el("div", { class:"actions" }, [
                  el("div", { class:"meta", text: prLine(e.pr) })
                ])
              ]));
            });
          }

          // Chart
          if(asc.length < 2){
            destroyProgressChart();
            chartNote.textContent = "Add at least 2 entries to see a trend line.";
            if(asc.length === 1){
              // Still render a single-point chart if you want; but we’ll keep it simple
            }
            return;
          }

          const series = buildSeries(type, asc);
          renderProgressChart(canvas, type, metric, series);

          const exName = resolveExerciseName(type, exerciseId, "exercise");
          chartNote.textContent = `${exName} • ${asc.length} entries`;

          function tableLine(e){
            if(e.type === "weightlifting"){
              const w = Number.isFinite(e.summary?.bestWeight) ? e.summary.bestWeight : "—";
              const r = Number.isFinite(e.summary?.best1RM) ? e.summary.best1RM : "—";
              const v = Number.isFinite(e.summary?.totalVolume) ? e.summary.totalVolume : "—";
              return `Top W: ${w} • Est1RM: ${r} • Vol: ${v}`;
            }
            if(e.type === "cardio"){
              const t = Number.isFinite(e.summary?.timeSec) ? formatTime(e.summary.timeSec) : "—";
              const d = Number.isFinite(e.summary?.distance) ? e.summary.distance : "—";
              const p = formatPace(e.summary?.paceSecPerUnit);
              return `Time: ${t} • Dist: ${d} • Pace: ${p}`;
            }
            const v = Number.isFinite(e.summary?.totalVolume) ? e.summary.totalVolume : "—";
            return `Core Vol: ${v}`;
          }

          function prLine(pr){
            if(!pr) return "";
            const b = [];
            if(pr.isPRWeight) b.push("PR W");
            if(pr.isPR1RM) b.push("PR 1RM");
            if(pr.isPRVolume) b.push("PR Vol");
            if(pr.isPRPace) b.push("PR Pace");
            return b.join(" • ");
          }
        }
      },
            Weight(){
        WeightEngine.ensure();

        const root = el("div", { class:"grid" });

        const header = el("div", { class:"card" }, [
          el("h2", { text:"Weight" }),
          el("div", { class:"note", text:"Log your bodyweight. See your trend, delta vs last entry, and 7-day average." })
        ]);

        const entryCard = el("div", { class:"card" }, [
          el("h2", { text:"Add entry" })
        ]);

        const statsCard = el("div", { class:"card" }, [
          el("h2", { text:"Stats" })
        ]);

        const chartCard = el("div", { class:"card" }, [
          el("h2", { text:"Graph" })
        ]);

        const tableCard = el("div", { class:"card" }, [
          el("h2", { text:"Table" })
        ]);

        root.appendChild(header);
        root.appendChild(entryCard);
        root.appendChild(statsCard);
        root.appendChild(chartCard);
        root.appendChild(tableCard);

        const dateInput = el("input", { type:"date", value: Dates.todayISO() });
        const weightInput = el("input", { type:"number", inputmode:"decimal", placeholder:"e.g., 185.4", min:"0", step:"0.1" });

        const saveBtn = el("button", {
          class:"btn primary",
          onClick: () => {
            try{
              WeightEngine.add(dateInput.value || Dates.todayISO(), weightInput.value);
              weightInput.value = "";
              repaint();
            }catch(e){
              Modal.open({
                title: "Can’t save",
                bodyNode: el("div", {}, [
                  el("div", { class:"note", text: e.message || "Unable to save weight." }),
                  el("div", { style:"height:12px" }),
                  el("button", { class:"btn primary", onClick: Modal.close }, ["OK"])
                ])
              });
            }
          }
        }, ["Save"]);

        entryCard.appendChild(el("div", { class:"row2" }, [
          el("label", {}, [ el("span", { text:"Date" }), dateInput ]),
          el("label", {}, [ el("span", { text:"Weight" }), weightInput ])
        ]));
        entryCard.appendChild(el("div", { style:"height:10px" }));
        entryCard.appendChild(el("div", { class:"btnrow" }, [saveBtn]));

        // Stats UI
        const statsHost = el("div", { class:"kpi" });
        statsCard.appendChild(statsHost);

        // Chart UI
        const chartWrap = el("div", { class:"chartWrap" });
        const canvas = el("canvas", {});
        chartWrap.appendChild(canvas);

        const dlBtn = el("button", {
          class:"btn",
          onClick: () => downloadCanvasPNG(canvas, `weight_${Dates.todayISO()}.png`)
        }, ["Download PNG"]);

        chartCard.appendChild(chartWrap);
        chartCard.appendChild(el("div", { style:"height:10px" }));
        const chartNote = el("div", { class:"note" });
        chartCard.appendChild(chartNote);
        chartCard.appendChild(el("div", { style:"height:10px" }));
        chartCard.appendChild(el("div", { class:"btnrow" }, [dlBtn]));

        // Table UI
        const tableHost = el("div", { class:"list" });
        tableCard.appendChild(tableHost);

        repaint();
        return root;

        function repaint(){
          WeightEngine.ensure();

          const latest = WeightEngine.latest();
          const prev = WeightEngine.previous();
          const delta = WeightEngine.delta();

          const avg7 = WeightEngine.avg7(latest?.dateISO || Dates.todayISO());

          statsHost.innerHTML = "";
          statsHost.appendChild(el("div", { class:"big", text: latest ? `${latest.weight}` : "—" }));
          statsHost.appendChild(el("div", { class:"small", text: latest ? `Latest • ${latest.dateISO}` : "No weight entries yet." }));

          const deltaText = (delta === null) ? "—" : (delta > 0 ? `+${delta}` : `${delta}`);
          statsHost.appendChild(el("div", { class:"small", text: `Delta vs previous: ${deltaText}` }));

          const avgText = (avg7 === null) ? "—" : `${avg7}`;
          statsHost.appendChild(el("div", { class:"small", text: `7-day avg: ${avgText}` }));

          // Table
          const desc = WeightEngine.listDesc();
          tableHost.innerHTML = "";

          if(desc.length === 0){
            tableHost.appendChild(el("div", { class:"note", text:"No entries yet. Add one above." }));
          }else{
            desc.slice(0, 45).forEach(row => {
              tableHost.appendChild(el("div", { class:"item" }, [
                el("div", { class:"left" }, [
                  el("div", { class:"name", text: row.dateISO }),
                  el("div", { class:"meta", text: `Weight: ${row.weight}` })
                ]),
                el("div", { class:"actions" }, [
                  el("button", {
                    class:"mini danger",
                    onClick: () => {
                      Modal.open({
                        title: "Delete entry?",
                        bodyNode: el("div", {}, [
                          el("div", { class:"note", text:`Delete ${row.weight} on ${row.dateISO}?` }),
                          el("div", { style:"height:12px" }),
                          el("div", { class:"btnrow" }, [
                            el("button", {
                              class:"btn danger",
                              onClick: () => {
                                WeightEngine.remove(row.id);
                                Modal.close();
                                repaint();
                              }
                            }, ["Delete"]),
                            el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                          ])
                        ])
                      });
                    }
                  }, ["Delete"])
                ])
              ]));
            });
          }

          // Chart (last 30 points)
          const asc = WeightEngine.listAsc().slice(-30);
          if(asc.length < 2){
            destroyWeightChart();
            chartNote.textContent = "Add at least 2 entries to see the trend line.";
            return;
          }

          renderWeightChart(canvas, asc);
          chartNote.textContent = `Showing last ${asc.length} entries`;
        }
      },
            Attendance(){
        AttendanceEngine.ensure();

        // default month = current
        const today = Dates.todayISO();
        let { y, m } = ymFromISO(today);

        const weekStartsOn = state.profile?.weekStartsOn || "mon"; // affects calendar header order
        const weekStart = (weekStartsOn === "sun") ? 0 : 1;

        const root = el("div", { class:"grid" });

        const header = el("div", { class:"card" }, [
          el("h2", { text:"Attendance" }),
          el("div", { class:"note", text:"Tap a day to mark it trained. Shows monthly count + clear month." })
        ]);

        const card = el("div", { class:"card" }, [
          el("h2", { text:"Calendar" })
        ]);

        const wrap = el("div", { class:"calWrap" });
        const top = el("div", { class:"calTop" });

        const title = el("div", { class:"calTitle" });
        const monthKpi = el("div", { class:"note" });

        const prevBtn = el("button", { class:"btn", onClick: () => { stepMonth(-1); } }, ["Prev"]);
        const nextBtn = el("button", { class:"btn", onClick: () => { stepMonth(1); } }, ["Next"]);

        const clearBtn = el("button", {
          class:"btn danger",
          onClick: () => {
            Modal.open({
              title: "Clear this month?",
              bodyNode: el("div", {}, [
                el("div", { class:"note", text:`This removes all trained days for ${monthTitle(y,m)}.` }),
                el("div", { style:"height:12px" }),
                el("div", { class:"btnrow" }, [
                  el("button", {
                    class:"btn danger",
                    onClick: () => {
                      AttendanceEngine.clearMonth(y, m);
                      Modal.close();
                      repaint();
                      renderView(); // Home dots update too
                    }
                  }, ["Clear month"]),
                  el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                ])
              ])
            });
          }
        }, ["Clear month"]);

        top.appendChild(el("div", { class:"btnrow" }, [prevBtn, nextBtn]));
        top.appendChild(el("div", { style:"flex:1" }));
        top.appendChild(clearBtn);

        const grid = el("div", { class:"calGrid" });

        wrap.appendChild(top);
        wrap.appendChild(el("div", { style:"height:10px" }));
        wrap.appendChild(title);
        wrap.appendChild(el("div", { style:"height:6px" }));
        wrap.appendChild(monthKpi);
        wrap.appendChild(el("div", { style:"height:12px" }));
        wrap.appendChild(grid);

        card.appendChild(wrap);
        root.appendChild(header);
        root.appendChild(card);

        repaint();
        return root;

        function stepMonth(delta){
          m += delta;
          if(m <= 0){ m = 12; y -= 1; }
          if(m >= 13){ m = 1; y += 1; }
          repaint();
        }

        function weekdayLabels(){
          const sun = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
          if(weekStart === 0) return sun;
          return ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
        }

        function repaint(){
          AttendanceEngine.ensure();
          title.textContent = monthTitle(y, m);

          const count = AttendanceEngine.monthCount(y, m);
          monthKpi.textContent = `This month: ${count} sessions`;

          grid.innerHTML = "";

          // headers
          weekdayLabels().forEach(lbl => {
            grid.appendChild(el("div", { class:"calCell header", text: lbl }));
          });

          const dim = daysInMonth(y, m);
          const firstDow = firstDayDow(y, m); // 0=Sun..6=Sat

          // convert firstDow to our grid index based on weekStart
          let leading = firstDow - weekStart;
          if(leading < 0) leading += 7;

          for(let i=0;i<leading;i++){
            grid.appendChild(el("div", { class:"calCell blank", text:"" }));
          }

          for(let d=1; d<=dim; d++){
            const dateISO = isoForYMD(y, m, d);
            const on = isTrained(dateISO);

            const cell = el("div", {
              class: "calCell" + (on ? " on" : ""),
              text: String(d),
              onClick: () => {
                toggleTrained(dateISO);
                repaint();
                renderView(); // updates Home dots too
              }
            });

            grid.appendChild(cell);
          }

          // pad to full weeks for cleaner bottom edge (optional)
          const totalCells = 7 + leading + dim; // +7 for header row
          const remainder = totalCells % 7;
          if(remainder !== 0){
            const pads = 7 - remainder;
            for(let i=0;i<pads;i++){
              grid.appendChild(el("div", { class:"calCell blank", text:"" }));
            }
          }
        }
      },
         Settings(){
        function openImportPasteModal(){
          const ta = el("textarea", {
            style:"width:100%; min-height: 260px; border-radius: 14px; padding: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: rgba(255,255,255,.92); font-size: 12px; outline:none; resize: vertical;",
            placeholder:"Paste your backup JSON here…"
          });

          const err = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

          Modal.open({
            title: "Import from paste",
            bodyNode: el("div", {}, [
              el("div", { class:"note", text:"This will overwrite your current data in this browser." }),
              el("div", { style:"height:10px" }),
              ta,
              err,
              el("div", { style:"height:12px" }),
              el("div", { class:"btnrow" }, [
                el("button", {
                  class:"btn danger",
                  onClick: () => {
                    err.style.display = "none";
                    try{
                      importBackupJSON(ta.value || "");
                      Modal.close();
                      navigate("home");
                    }catch(e){
                      err.textContent = e.message || "Import failed.";
                      err.style.display = "block";
                    }
                  }
                }, ["Import (overwrite)"]),
                el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
              ])
            ])
          });
        }

        function openImportFileModal(){
          const input = el("input", { type:"file", accept:"application/json,.json" });
          const err = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

          Modal.open({
            title: "Import from file",
            bodyNode: el("div", {}, [
              el("div", { class:"note", text:"Choose a .json backup file. Import overwrites current data." }),
              el("div", { style:"height:10px" }),
              input,
              err,
              el("div", { style:"height:12px" }),
              el("div", { class:"btnrow" }, [
                el("button", {
                  class:"btn danger",
                  onClick: async () => {
                    err.style.display = "none";
                    try{
                      const f = input.files?.[0];
                      if(!f) throw new Error("Select a JSON file first.");
                      const txt = await f.text();
                      importBackupJSON(txt);
                      Modal.close();
                      navigate("home");
                    }catch(e){
                      err.textContent = e.message || "Import failed.";
                      err.style.display = "block";
                    }
                  }
                }, ["Import (overwrite)"]),
                el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
              ])
            ])
          });
        }

        return el("div", { class:"grid" }, [
          // Backup / Import card
          el("div", { class:"card" }, [
            el("h2", { text:"Backup / Import" }),
            el("div", { class:"note", text:"Export your full app data as JSON. Import will overwrite your current data in this browser." }),
            el("div", { style:"height:10px" }),

            el("div", { class:"btnrow" }, [
              el("button", {
                class:"btn primary",
                onClick: () => {
                  try{
                    const txt = exportBackupJSON();
                    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
                    downloadTextFile(`gym-dashboard-backup_${stamp}.json`, txt);
                  }catch(e){
                    Modal.open({
                      title:"Export failed",
                      bodyNode: el("div", {}, [
                        el("div", { class:"note", text: e.message || "Could not export backup." }),
                        el("div", { style:"height:12px" }),
                        el("button", { class:"btn primary", onClick: Modal.close }, ["OK"])
                      ])
                    });
                  }
                }
              }, ["Export JSON backup"]),

              el("button", {
                class:"btn",
                onClick: () => {
                  Modal.open({
                    title: "Copy backup JSON",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text:"Copy/paste this JSON anywhere safe." }),
                      el("div", { style:"height:10px" }),
                      el("textarea", {
                        style:"width:100%; min-height: 260px; border-radius: 14px; padding: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: rgba(255,255,255,.92); font-size: 12px; outline:none; resize: vertical;",
                      }, [exportBackupJSON()]),
                      el("div", { style:"height:12px" }),
                      el("button", { class:"btn primary", onClick: Modal.close }, ["Done"])
                    ])
                  });
                }
              }, ["View JSON"])
            ]),

            el("div", { style:"height:14px" }),
            el("div", { class:"note", text:"Import options:" }),
            el("div", { style:"height:8px" }),

            el("div", { class:"btnrow" }, [
              el("button", { class:"btn danger", onClick: openImportPasteModal }, ["Import (paste JSON)"]),
              el("button", { class:"btn danger", onClick: openImportFileModal }, ["Import (upload file)"])
            ]),

            el("div", { style:"height:10px" }),
            el("div", { class:"note", text:"Tip: Export a backup before you import." })
          ]),

          // Debug card (keep your existing debug tools)
          el("div", { class:"card" }, [
            el("h2", { text:"Debug" }),
            el("div", { class:"btnrow" }, [
              el("button", {
                class:"btn",
                onClick: () => Modal.open({
                  title: "Current State (JSON)",
                  bodyNode: el("pre", { style:"white-space:pre-wrap; font-size:12px; color: rgba(255,255,255,.85);" }, [
                    JSON.stringify(state, null, 2)
                  ])
                })
              }, ["View state JSON"]),
              el("button", {
                class:"btn danger",
                onClick: () => {
                  Modal.open({
                    title: "Reset local data",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text:"This clears everything saved in this browser for the app." }),
                      el("div", { style:"height:12px" }),
                      el("div", { class:"btnrow" }, [
                        el("button", {
                          class:"btn danger",
                          onClick: () => {
                            Storage.reset();
                            state = Storage.load();
                            Modal.close();
                            navigate("home");
                          }
                        }, ["Reset"]),
                        el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                      ])
                    ])
                  });
                }
              }, ["Reset local data"])
            ])
          ])
        ]);
      }
    }; // ✅ end Views object
    /********************
     * 8) Boot
     ********************/
    // If already onboarded and library is empty, seed it (won't overwrite non-empty)
    if(state.profile) ExerciseLibrary.ensureSeeded();
    // Step 6 safety: ensure logs arrays exist even if older saved state is missing fields
    LogEngine.ensure();
    renderNav();
    renderView();
  </script>
</body>
</html>
