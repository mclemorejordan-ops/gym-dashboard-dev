
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />

  <!-- iOS Add to Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Gym Dashboard" />

  <title>Gym Dashboard</title>

  <!-- Chart.js (used later in Progress/Weight) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
:root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --hair: rgba(255,255,255,.10);

      --accent: #7c5cff;
      --good: #37d67a;
      --warn: #ffd166;
      --bad: #ff5c7a;

      --r: 18px;
      --shadow: 0 18px 40px rgba(0,0,0,.45);

      /* Unified "glass" theme tokens (header + nav + modals match) */
      --glass: rgba(16,20,30,.72);
      --glass2: rgba(16,20,30,.55);
      --glassStrong: rgba(16,20,30,.88);
      --glassBorder: rgba(255,255,255,.10);
      --blur: 18px;

      --navH: 78px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.24), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(55,214,122,.14), transparent 55%),
        var(--bg);
      background-attachment: fixed; /* makes the theme feel like ONE canvas */
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      min-height: 100dvh; /* better than 100vh for iPhone/PWA */
    }
.app{
      min-height: 100%;
      /* IMPORTANT: remove safe-area top here so HEADER can own it (looks seamless on iPhone) */
      padding: 0 14px calc(var(--navH) + env(safe-area-inset-bottom)) 14px;
      max-width: 780px;
      margin: 0 auto;
    }
header{
      position: sticky;
      top: 0;
      z-index: 60;
      backdrop-filter: blur(var(--blur));
      /* Fade to transparent so it blends into the BODY canvas like one theme */
      background: linear-gradient(
        to bottom,
        var(--glassStrong) 0%,
        rgba(16,20,30,.62) 60%,
        rgba(16,20,30,0) 100%
      );
      /* Header owns the safe-area top so the theme covers the whole iPhone app */
      padding: calc(env(safe-area-inset-top) + 12px) 0 10px 0;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 4px 2px 6px 2px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .brand .title{
      font-weight: 720;
      letter-spacing: .2px;
      font-size: 18px;
      line-height: 1.15;
    }
    .brand .subtitle{
      font-size: 12px;
      color: var(--muted);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--hair);
      color: var(--text);
      font-size: 13px;
      user-select:none;
      max-width: 52vw;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    main{ padding-top: 10px; }

    .grid{
      display:grid;
      gap: 12px;
    }
    @media (min-width: 640px){
      .grid.cols2{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--hair);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px 0;
      font-size: 14px;
      letter-spacing: .3px;
      color: var(--muted);
      font-weight: 650;
      text-transform: uppercase;
    }

    .btnrow{ display:flex; gap: 10px; flex-wrap: wrap; }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 650;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid var(--hair);
      user-select:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.75));
      border-color: rgba(124,92,255,.35);
    }
    .btn.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }
    .btn:active{ transform: translateY(1px); }
.btn.sm{
  padding: 8px 10px;
  border-radius: 12px;
  font-size: 13px;
}

.btn.ghost{
  background: rgba(255,255,255,.05);
}

    .muted{ color: var(--muted); }
    .kpi{
      display:flex;
      flex-direction:column;
      gap: 4px;
      padding: 8px 0 0 0;
    }
    .kpi .big{
      font-size: 22px;
      font-weight: 760;
      letter-spacing: .2px;
    }
    .kpi .small{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    /* Progress Overview (stacked like screenshot) */
    .overviewList{
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      padding: 8px 0 0 0;
    }
    .overviewRow{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .overviewLabel{
      font-size: 12px;
      color: var(--muted);
      font-weight: 720;
      letter-spacing: .22px;
      text-transform: uppercase;
    }
    .overviewValue{
      font-size: 22px;
      font-weight: 820;
      letter-spacing: .2px;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (min-width: 640px){
      .overviewList{
        grid-template-columns: 1fr 1fr;
        gap: 18px;
      }
      .overviewValue{ font-size: 24px; }
    }

    .form{ display:grid; gap: 10px; }
    .row2{ display:grid; gap: 10px; }
    @media (min-width: 640px){ .row2{ grid-template-columns: 1fr 1fr; } }

    /* ─────────────────────────────
   Log Sets (Modal) — Compact + Sticky + Scroll
   ───────────────────────────── */

.logsetShell{
  display:flex;
  flex-direction:column;
  gap: 10px;
  min-height: 0; /* important for nested scrolling */
}

.logsetHead{
  position: sticky;
  top: 0;
  z-index: 2;
  padding: 10px;
  border-radius: 16px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
}

.logsetHead .note{ margin: 0; }

.logsetScroll{
  min-height: 0;
  max-height: 52vh;              /* keeps it compact inside the modal */
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 2px;
  padding-bottom: 12px;          /* prevents last row from hiding under sticky bar */
  -webkit-overflow-scrolling: touch; /* smooth scroll on iOS */
}

.logsetWLCard{
  padding: 10px;
  border-radius: 16px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.08);
}

.logsetGridHead{
  display:grid;
  grid-template-columns: 40px 1fr 1fr;
  gap: 10px;
  align-items:center;
  font-size: 12px;
  color: var(--muted);
  font-weight: 740;
  letter-spacing: .22px;
  text-transform: uppercase;
  margin-bottom: 8px;
  padding: 0 4px;
}

.logsetRow{
  display:grid;
  grid-template-columns: 40px 1fr 1fr;
  gap: 10px;
  align-items:center;
  padding: 8px 6px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.06);
  background: rgba(255,255,255,.03);
}

.logsetRow + .logsetRow{ margin-top: 8px; }

/* Active row highlight — Medium (background + border) */
.logsetRow.active{
  background: rgba(255,255,255,.08);
  border-color: rgba(124,92,255,.35);
  box-shadow: 0 0 0 1px rgba(124,92,255,.15) inset;
}

.logsetSetPill{
  display:flex;
  align-items:center;
  justify-content:center;
  height: 34px;
  border-radius: 12px;
  font-weight: 820;
  font-size: 12px;
  color: rgba(255,255,255,.85);
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
}

.logsetRow input{
  width: 100%;
}

/* Sticky bottom bar INSIDE the scroll area */
.logsetStickyBar{
  position: sticky;
  bottom: 0;
  z-index: 3;
  display:flex;
  gap: 10px;
  padding-top: 10px;
  margin-top: 10px;
  background: linear-gradient(180deg, rgba(16,20,30,0), rgba(16,20,30,.75) 30%, rgba(16,20,30,.92));
  backdrop-filter: blur(10px);
}

.logsetStickyBar .btn{
  flex: 1;
}

    label{
      display:flex;
      flex-direction:column;
      gap: 7px;
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 650;
      letter-spacing: .2px;
    }
input, select, textarea{
  appearance:none;
  border-radius: 14px;
  padding: 12px 12px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: var(--text);
  font-size: 16px; /* ✅ critical: prevents iOS focus zoom */
  outline: none;
}
    input::placeholder{ color: rgba(255,255,255,.35); }
    input:focus, select:focus{
      border-color: rgba(124,92,255,.40);
      box-shadow: 0 0 0 4px rgba(124,92,255,.14);
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 12px 12px;
    }
    .toggle .ttext{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .toggle .ttext .a{ color: var(--text); font-weight: 700; font-size: 14px; }
    .toggle .ttext .b{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    .switch{
      width: 52px;
      height: 30px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      position: relative;
      flex: 0 0 auto;
      cursor:pointer;
      user-select:none;
    }
    .switch::after{
      content:"";
      position:absolute;
      top: 50%;
      left: 3px;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.82);
      transition: left .16s ease, background .16s ease;
    }
    .switch.on{
      background: rgba(124,92,255,.30);
      border-color: rgba(124,92,255,.34);
    }
    .switch.on::after{
      left: 25px;
      background: rgba(255,255,255,.92);
    }

    .tplGrid{ display:grid; gap: 10px; }
    @media (min-width: 640px){ .tplGrid{ grid-template-columns: 1fr 1fr; } }
    .tpl{
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease;
    }
    .tpl:active{ transform: translateY(1px); }
    .tpl .name{ font-weight: 780; letter-spacing: .2px; margin-bottom: 4px; }
    .tpl .desc{ color: var(--muted); font-size: 12.5px; line-height: 1.35; }
    .tpl.selected{
      border-color: rgba(124,92,255,.34);
      background: rgba(124,92,255,.12);
      box-shadow: 0 0 0 4px rgba(124,92,255,.10);
    }

    .note{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }
    /* Home Dashboard */
    .homeRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .dots{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .dotDay{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    .dotDay.on{
      background: rgba(55,214,122,.55);
      border-color: rgba(55,214,122,.50);
    }
    .dotLabel{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .ringWrap{
      width: 120px;
      height: 120px;
      border-radius: 999px;
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      flex: 0 0 auto;
    }
    .ringWrap::before{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 999px;
      background: rgba(11,15,23,.95);
      border: 1px solid rgba(255,255,255,.08);
    }
    .ringText{
      position: relative;
      z-index: 2;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap: 2px;
    }
    .ringText .big{
      font-size: 18px;
      font-weight: 850;
      letter-spacing:.2px;
    }
    .ringText .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.2;
    }
        /* Log Sets */
    .logGrid{ display:grid; gap:12px; }
    .logRow2{ display:grid; gap:10px; }
    @media (min-width: 640px){
      .logRow2{ grid-template-columns: 1fr 1fr; }
    }
    .log3{ display:grid; gap:10px; }
    @media (min-width: 640px){
      .log3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .chiprow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip2{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-size: 12.5px;
      font-weight: 700;
      user-select:none;
    }

    .sets{
      display:grid;
      gap:10px;
    }
    .setCard{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .setTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .setTop .t{
      font-weight: 820;
      letter-spacing:.15px;
    }
    .mini2{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12px;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      user-select:none;
    }
    .mini2.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }

    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 10px 0;
    }
        /* Progress */
    .chartWrap{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px;
      overflow:hidden;
    }
    canvas{
      max-width: 100%;
      height: 280px;
    }
    @media (min-width: 640px){
      canvas{ height: 320px; }
    }
        /* Routine Editor */
    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-size: 12.5px;
      font-weight: 700;
      user-select:none;
      cursor:pointer;
    }
    .pill.active{
      background: rgba(124,92,255,.14);
      border-color: rgba(124,92,255,.22);
    }
/* Header: Synced/Offline + Version pills */
.subPills{
  display:flex;
  gap: 8px;
  align-items:center;
  flex-wrap: wrap;
  margin-top: 6px;
}
.subPill{
  appearance:none;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.86);
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .2px;
  cursor: pointer;
}
.subPill:active{ transform: scale(.98); }
.subPill.warn{
  border-color: rgba(255,180,0,.35);
  background: rgba(255,180,0,.14);
}
.subPill.ok{
  border-color: rgba(124,92,255,.40);
  background: rgba(124,92,255,.16);
}
.subPill.off{
  border-color: rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
}
    .dayGrid{
      display:grid;
      gap:10px;
    }
    @media (min-width: 640px){
      .dayGrid{ grid-template-columns: 1fr 1fr; }
    }
    .dayCard{
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dayTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .dayTitle{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .dayTitle .lbl{
      font-weight: 820;
      letter-spacing:.15px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 46vw;
    }
    .dayTitle .sub{
      font-size: 12.5px;
      color: var(--muted);
    }
    .exList{ display:grid; gap:8px; }
    .exRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .exRow .n{
      font-weight: 750;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 44vw;
    }

    /* Library UI */
    .seg{
      display:flex;
      gap: 8px;
      padding: 6px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
    }
    .segbtn{
      flex:1;
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12.5px;
      color: var(--muted);
      background: transparent;
      user-select:none;
    }
    .segbtn.active{
      color: var(--text);
      background: rgba(124,92,255,.16);
      border: 1px solid rgba(124,92,255,.22);
    }

    .list{
      display:grid;
      gap: 10px;
    }
    .item{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .item .left{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
    }
    .item .name{
      font-weight: 820;
      letter-spacing: .15px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 58vw;
    }
    .item .meta{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }
    .item .actions{
      display:flex;
      gap: 8px;
      flex: 0 0 auto;
    }
    .mini{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12px;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      user-select:none;
    }
    .mini.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }
    /* Attendance */
    .calWrap{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px;
    }
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      user-select:none;
    }
    .calCell{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding: 10px 8px;
      min-height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 750;
      cursor:pointer;
    }
    .calCell.header{
      cursor: default;
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.65);
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .2px;
      min-height: 36px;
    }
    .calCell.blank{
      cursor: default;
      background: transparent;
      border: 1px dashed rgba(255,255,255,.10);
      opacity: .55;
    }
    .calCell.on{
      background: rgba(55,214,122,.22);
      border-color: rgba(55,214,122,.35);
    }
    .calTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .calTitle{
      font-weight: 820;
      letter-spacing:.2px;
    }
    /* Bottom nav */
    .nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: calc(var(--navH) + env(safe-area-inset-bottom));
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px;
      display:flex;
      justify-content:center;
      z-index: 50;
      pointer-events:none;
    }
.navbar{
      width: min(780px, calc(100% - 18px));
      display:flex;
      justify-content:space-between;
      gap: 8px;
      background: var(--glass);
      border: 1px solid var(--glassBorder);
      border-radius: 22px;
      padding: 8px;
      backdrop-filter: blur(var(--blur));
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      pointer-events:auto;
    }
    .navbtn{
      flex: 1;
      appearance:none;
      border:none;
      background: transparent;
      color: var(--muted);
      padding: 10px 6px;
      border-radius: 16px;
      font-size: 11.5px;
      font-weight: 650;
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .navbtn .dot{
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .navbtn.active{
      color: var(--text);
      background: rgba(124,92,255,.14);
      border: 1px solid rgba(124,92,255,.22);
    }
    .navbtn.active .dot{
      background: rgba(124,92,255,.22);
      border-color: rgba(124,92,255,.30);
    }
/* Lock background scroll when any modal is open */
body.modalOpen{
  overflow: hidden;
  height: 100%;
  touch-action: none;
}
    /* Modal */
.modalHost{
      position: fixed;
      inset: 0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index: 80;
      /* safe areas so sheets never clash with notch/home indicator */
      padding: env(safe-area-inset-top) 10px calc(12px + env(safe-area-inset-bottom)) 10px;
    }
    .modalHost.show{ display:flex; }
    .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
.sheet{
      position:relative;
      width: min(780px, 100%);
      /* iPhone/PWA correct sizing: dvh tracks Safari bars correctly */
      max-height: calc(100dvh - 32px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      background: rgba(16,20,30,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px 22px 0 0;
      box-shadow: 0 22px 60px rgba(0,0,0,.65);
      padding: 14px;
      transform: translateY(10px);
    }
    /* Modal size variants */
.sheet.md{
  width: min(780px, 100%);
}

.sheet.sm{
  width: min(520px, 100%);
  max-height: min(520px, calc(100dvh - 32px));
}

    /* iOS: prevent input focus zoom inside modals (keep inputs at 16px on iPhone) */
@media (hover:none) and (pointer:coarse){
  .modalHost .sheet input,
  .modalHost .sheet select,
  .modalHost .sheet textarea{
    font-size: 16px !important;
  }
}
        .modalHost.center{
      align-items:center;          /* center vertically */
      padding: 14px 10px;          /* breathing room */
    }
    .modalHost.center .sheet{
      border-radius: 22px;         /* full rounded card (not bottom sheet) */
      transform: translateY(0);    /* remove bottom-sheet lift */
    }
    .sheetHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 10px;
    }
    .sheetHeader .h{
      font-weight: 760;
      letter-spacing: .2px;
    }
    .xbtn{
      appearance:none;
      border:none;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 700;
    }
    .pulse{
  animation: pulseAnim 1.2s ease;
}
@keyframes pulseAnim{
  0%{ box-shadow: 0 0 0 0 rgba(124,92,255,.6); }
  70%{ box-shadow: 0 0 0 10px rgba(124,92,255,0); }
  100%{ box-shadow: 0 0 0 0 rgba(124,92,255,0); }
}
    /* Glass dropdown (routine picker) */
.popHost{
  position: fixed;
  inset: 0;
  z-index: 95;
  display: none;
}
.popHost.show{ display:block; }

.popBackdrop{
  position:absolute;
  inset:0;
  background: rgba(0,0,0,.25);
  backdrop-filter: blur(6px);
}

.popPanel{
  position:absolute;
  width: min(420px, calc(100vw - 24px));

  /* UPDATED: allow the picker to grow taller so all templates are visible more often */
  max-height: min(620px, calc(100vh - 120px));
  overflow:auto;

  background: rgba(16,20,30,.72);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 18px;
  box-shadow: 0 22px 60px rgba(0,0,0,.65);
  backdrop-filter: blur(18px);

  padding: 10px;
}

.popTitle{
  font-size: 12px;
  color: rgba(255,255,255,.65);
  letter-spacing: .2px;
  font-weight: 700;
  padding: 6px 6px 10px 6px;
  border-bottom: 1px solid rgba(255,255,255,.10);
  margin-bottom: 10px;
}

.popItem{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;

  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  cursor:pointer;
  user-select:none;
}
.popItem:active{ transform: translateY(1px); }

.popItem .l{
  min-width:0;
  display:flex;
  flex-direction:column;
  gap: 3px;
}
.popItem .n{
  font-weight: 820;
  overflow:hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 52vw;
}
.popItem .m{
  font-size: 12px;
  color: rgba(255,255,255,.60);
}
.popBadge{
  font-size: 12px;
  font-weight: 800;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(124,92,255,.28);
  background: rgba(124,92,255,.16);
}
   /* Routine layout refinements (locked design) */
.rHdrRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
/* Routine: fixed header+carousel, scrollable content below */
.routinePage{
  display:flex;
  flex-direction:column;
  gap: 12px;
  height: calc(100dvh - var(--headerH, 72px) - var(--navH) - env(safe-area-inset-bottom));
}

.routineFixed{
  flex: 0 0 auto;
  display:grid;
  gap: 12px;
}
/* Compact exercise rows under Routine carousel */
.rxCard{
  padding: 10px 12px;
}

.rxTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.rxName{
  font-weight: 860;
  letter-spacing: .1px;
  font-size: 14px;
}

.rxChip{
  font-size: 12px;
  font-weight: 800;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.80);
  white-space: nowrap;
}

.rxChip.on{
  border-color: rgba(124,92,255,.30);
  background: rgba(124,92,255,.16);
  color: rgba(255,255,255,.92);
}

.rxMeta{
  font-size: 12px;
  color: rgba(255,255,255,.65);
  margin-top: 4px;
  line-height: 1.25;
}

.rxActions{
  display:flex;
  gap:10px;
  margin-top: 8px;
  flex-wrap: wrap;
}
.routineScroll{
  flex: 1 1 auto;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  display:grid;
  gap: 12px;
  padding-bottom: 6px;
}
.manageLink{
  margin-top: 10px;
  font-weight: 750;
  color: rgba(255,255,255,.72);
  cursor:pointer;
  user-select:none;
}
.manageLink:active{ transform: translateY(1px); }

/* ─────────────────────────────
   Routine — 3D Square Carousel + Day Strip (Option C - compact)
   (visual-only)
   ───────────────────────────── */

.carouselCard{
  padding: 12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* 3D stage (cards area) */
.c3d{
  position: relative;
  height: 160px;                 /* ✅ more compact */
  display:flex;
  align-items:center;
  justify-content:center;
  perspective: 1000px;
  transform-style: preserve-3d;
  touch-action: pan-y;
  user-select:none;
}

/* Square “3D” card */
/* Square “3D” card */
.c3dCard{
  position:absolute;
  width: min(58vw, 190px);       /* ✅ smaller cards */
  aspect-ratio: 1 / 1;
  border-radius: 18px;

  /* Base glass (non-selected) */
  background: linear-gradient(180deg,
    rgba(18,22,30,.35),
    rgba(12,14,20,.22)
  );
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 18px 55px rgba(0,0,0,.55);
  padding: 12px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  will-change: transform, opacity, filter;
  overflow: hidden; /* important for overlay */
}

/* Dim non-selected cards */
.c3dCard:not(.sel){
  filter: saturate(.70) brightness(.60);
}

/* Dark-glass active card that blocks anything behind it */
.c3dCard.sel{
  border-color: rgba(55,214,122,.45); /* subtle neon accent */

  /* ✅ opaque dark glass gradient (prevents seeing other cards through it) */
  background: linear-gradient(180deg,
    rgba(12,14,18,.92),
    rgba(10,12,16,.86)
  );

  box-shadow:
    0 22px 70px rgba(0,0,0,.70),
    0 0 0 1px rgba(55,214,122,.18) inset;

  filter: none;
  opacity: 1 !important;
}

/* Subtle glass sheen layer (keeps "glassy" feel without transparency) */
.c3dCard::before{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(135deg,
    rgba(255,255,255,.10),
    rgba(255,255,255,.02) 45%,
    rgba(255,255,255,0)
  );
  pointer-events:none;
}

.c3dCard.sel::before{
  /* Slightly stronger sheen on active card */
  background: linear-gradient(135deg,
    rgba(255,255,255,.12),
    rgba(255,255,255,.03) 45%,
    rgba(255,255,255,0)
  );
}
.c3dDay{
  font-size: 22px;
  font-weight: 950;
  letter-spacing: .8px;
}

.c3dLabel{
  font-size: 15px;
  font-weight: 850;
  color: rgba(255,255,255,.78);
  margin-top: 4px;
}

.c3dMeta{
  font-size: 12px;
  color: rgba(255,255,255,.60);
  font-weight: 750;
  margin-top: 8px;
}

.c3dChips{
  display:flex;
  gap: 8px;
  justify-content:flex-end;
}

.c3dChip{
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  color: rgba(255,255,255,.82);
  font-weight: 850;
  font-size: 12px;
  letter-spacing: .2px;
  white-space: nowrap;
}

.c3dChip.active{
  border-color: rgba(55,214,122,.45);
  box-shadow: 0 0 0 1px rgba(55,214,122,.18) inset;
}

/* Day strip (fixed under carousel) */
.routineDayStrip{
  display:flex;
  gap: 8px;
  justify-content:space-between;
  margin-top: 20px; 
}

.routineDayBtn{
  flex: 1 1 0;
  min-width: 0;
  height: 58px;                  /* ✅ more compact */
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.03);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap: 8px;
  color: rgba(255,255,255,.60);
  font-weight: 950;
  letter-spacing: .6px;
}

.routineDayBtn .dot{
  width: 8px; height: 8px; border-radius: 999px;
  background: rgba(255,255,255,.22);
}

.routineDayBtn.sel{
  border-color: rgba(55,214,122,.45);
  box-shadow: 0 0 0 1px rgba(55,214,122,.18) inset;
  color: rgba(255,255,255,.92);
}

.routineDayBtn.sel .dot{
  background: rgba(55,214,122,1);
  box-shadow: 0 0 0 3px rgba(55,214,122,.12);
}
  /* Add Multiple visual feedback */
.item.selected{
  border-color: rgba(124,92,255,.55);
  box-shadow: 0 0 0 2px rgba(124,92,255,.25);
}
    
/* Disabled (already added) look */
.item.disabledRow{
  opacity: .72;
  filter: saturate(.9);
}

button.mini.disabledBtn{
  opacity: .9;
  cursor: default;
}
button.mini.added{
  background: rgba(124,92,255,.2);
  border-color: rgba(124,92,255,.6);
  color: rgba(255,255,255,.95);
}
   /* Floating Next → nudge */
.floatNext{
  position: fixed;
  left: 0;
  right: 0;
  bottom: calc(72px + env(safe-area-inset-bottom));
  display: none;
  justify-content: center;
  z-index: 90;
  pointer-events: none;
}
.floatNext.show{ display:flex; }
.floatNext .btn{
  pointer-events: auto;
  box-shadow: 0 18px 48px rgba(0,0,0,.55);
} 
  /* Settings accordion + search */
.settingsWrap{ display:flex; flex-direction:column; gap: 10px; }
.settingsSearch{
  width: 100%;
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
}
.settingsSearch .ico{ opacity:.75; font-size: 14px; }
.settingsSearch input{
  flex:1;
  border: none !important;
  background: transparent !important;
  padding: 0 !important;
  outline: none !important;
  color: rgba(255,255,255,.92);
}
.settingsSearch input::placeholder{ color: rgba(255,255,255,.45); }

.accList{ display:flex; flex-direction:column; gap: 10px; }
.accItem{
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
  overflow: hidden;
}
.accHead{
  display:flex;
  gap: 12px;
  align-items:flex-start;
  justify-content: space-between;
  padding: 14px 14px;
  cursor: pointer;
  user-select: none;
}
.accHead:active{ transform: scale(.995); }
.accTitle{ font-weight: 900; letter-spacing:.1px; }
.accSub{ font-size: 12px; color: var(--muted); margin-top: 3px; }
.accCaret{ opacity:.8; font-weight: 900; }

.settingsWrap .accBody{
  display: block; /* overrides the global .accBody { display:none } */
  padding: 0 14px 14px;
  border-top: 1px solid rgba(255,255,255,.08);
}

.setRow{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 0;
}
.setRow .meta{ font-size:12px; color: var(--muted); }
.setRow input, .setRow select{
  width: 160px;
  max-width: 44vw;
}

.setLink{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
  cursor:pointer;
}
.setLink:active{ transform: scale(.995); }
.setLink .l{ display:flex; flex-direction:column; gap:2px; }
.setLink .a{ font-weight: 800; }
.setLink .b{ font-size: 12px; color: var(--muted); }
  
/* ✅ GLOBAL COMPACT: Routine + Progress + Settings (iPhone) */
@media (max-width: 500px){

  /* ---------- Routine (lists, segmented picker, toggles, mini buttons) ---------- */
  .seg{ gap: 6px; padding: 5px; border-radius: 14px; }               /* routine add-exercise modal uses this:contentReference[oaicite:5]{index=5} */
  .segbtn{ padding: 8px 8px; font-size: 11px; border-radius: 10px; } /* :contentReference[oaicite:6]{index=6} */

  .list{ gap: 8px; }                                                 /* routine uses list/items heavily:contentReference[oaicite:7]{index=7} */
  .item{ padding: 10px; border-radius: 14px; gap: 10px; }            /* :contentReference[oaicite:8]{index=8} */
  .item .name{ max-width: 64vw; }                                    /* prevents wrapping too early */

  .mini{ padding: 7px 9px; font-size: 11px; border-radius: 10px; }   /* :contentReference[oaicite:9]{index=9} */

  .toggle{ padding: 10px 10px; border-radius: 12px; }                /* toggle + switch appear in routine/settings flows:contentReference[oaicite:10]{index=10} */
  .toggle .ttext .a{ font-size: 12px; }                              /* :contentReference[oaicite:11]{index=11} */
  .toggle .ttext .b{ font-size: 11px; }

  .switch{ width: 46px; height: 26px; }                              /* :contentReference[oaicite:12]{index=12} */
  .switch::after{ width: 20px; height: 20px; }
  .switch.on::after{ left: 22px; }

  /* ---------- Progress (overview tiles, filters form, labels/inputs) ---------- */
  .overviewList{ gap: 10px; padding-top: 6px; }                      /*  */
  .overviewRow{ gap: 4px; }
  .overviewLabel{ font-size: 11px; letter-spacing: .18em; }
  .overviewValue{ font-size: 18px; }                                 /* big numbers in Progress overview */

  .form{ gap: 8px; }                                                 /*  */
  .row2{ gap: 8px; }

  label{ gap: 6px; font-size: 11.5px; }                              /*  */
  input, select, textarea{ padding: 10px 10px; font-size: 16px; border-radius: 12px; }

  /* Prevent iOS input zoom (GLOBAL — not just modals) */
@media (hover: none) and (pointer: coarse){
  input,
  select,
  textarea{
    font-size: 16px !important;
  }
}

  canvas{ height: 200px; }                                           /* progress/weight charts */

  /* ---------- Settings (search bar, accordion density, settings rows) ---------- */
  .settingsWrap{ gap: 8px; }                                         /* :contentReference[oaicite:18]{index=18} */
  .settingsSearch{ padding: 8px 10px; border-radius: 14px; gap: 8px; } /* :contentReference[oaicite:19]{index=19} */
  .settingsSearch .ico{ font-size: 13px; }                           /* :contentReference[oaicite:20]{index=20} */

  .accList{ gap: 8px; }                                              /* :contentReference[oaicite:21]{index=21} */
  .accItem{ border-radius: 16px; }
  .accHead{ padding: 12px 12px; gap: 10px; }                         /* :contentReference[oaicite:22]{index=22} */
  .accSub{ font-size: 11px; margin-top: 2px; }                       /* :contentReference[oaicite:23]{index=23} */
  .accBody{ padding: 0 12px 12px; }                                  /* :contentReference[oaicite:24]{index=24} */

  .setRow{ padding: 8px 0; }                                         /* :contentReference[oaicite:25]{index=25} */
  .setRow .meta{ font-size: 11px; }                                  /* :contentReference[oaicite:26]{index=26} */
  .setRow input, .setRow select{ width: 150px; max-width: 46vw; }     /* keeps rows compact */
}
    /* ✅ Protein: Compact iPhone sizing (tile + ring + modal) */
@media (max-width: 500px){

  /* Tighten the Protein tile row layout */
  .homeRow{ gap: 8px; }

  /* Card density (affects Protein tile + others, but in a good way) */
  .card{ padding: 10px; border-radius: 16px; }
  .card h2{ font-size: 11.5px; margin: 0 0 6px 0; }

  /* KPI text (Protein “___g left”) */
  .kpi .big{ font-size: 17px; }
  .kpi .small{ font-size: 11px; line-height: 1.2; }

  /* ✅ Protein ring: more compact */
  .ringWrap{ width: 92px; height: 92px; }
  .ringWrap::before{ inset: 7px; }  /* keeps ring thickness proportional */
  .ringText{ gap: 1px; }
  .ringText .big{ font-size: 14px; }
  .ringText .small{ font-size: 10px; line-height: 1.15; }

  /* Button density (Protein “Log meals” button + modal buttons) */
  .btn{ padding: 9px 11px; border-radius: 12px; }

  /* ✅ Protein modal density (meal list rows + mini buttons) */
  .list{ gap: 8px; }
  .item{ padding: 10px; border-radius: 14px; }
  .name{ font-size: 12px; }
  .meta{ font-size: 11px; }
  .mini{ padding: 7px 9px; font-size: 11px; }
}
   /* Weight page — Compact Card Stack (Option 1) */
.weightPage .weightTop{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
}
.weightPage .weightLogBtn{
  padding: 10px 12px;
  border-radius: 14px;
  font-size: 12px;
  font-weight: 750;
}
.weightSummaryKpi .big{
  font-size: 34px;
}
.weightChartHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
}
.segRow{
  display:flex;
  gap: 8px;
}
.seg{
  appearance:none;
  border:none;
  cursor:pointer;
  padding: 8px 10px;
  border-radius: 14px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  color: rgba(255,255,255,.78);
  font-size: 11.5px;
  font-weight: 750;
}
.seg.active{
  background: rgba(124,92,255,.18);
  border-color: rgba(124,92,255,.35);
  color: rgba(255,255,255,.95);
}
.weightChartWrap{
  height: 240px;
}
.accHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  cursor:pointer;
  user-select:none;
}
.accChevron{
  opacity: .75;
  font-weight: 800;
}
.accBody{
  display:none;
  padding-top: 8px;
}
 /* Progress — search + pills */
.progSearch{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 12px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
}
.progSearch .ico{ opacity:.75; font-size: 14px; }
.progSearch input{
  flex:1;
  border: none !important;
  background: transparent !important;
  padding: 0 !important;
  outline: none !important;
  color: rgba(255,255,255,.92);
}
.progSearch input::placeholder{ color: rgba(255,255,255,.45); }

.segRow{
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
}

.pillRow{ margin-top: 10px; }
.pill{
  display:inline-flex;
  align-items:center;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(124,92,255,.14);
}
.pill .t{ font-weight: 850; font-size: 12px; }
.pill .x{
  appearance:none;
  border:none;
  background: rgba(255,255,255,.10);
  color: rgba(255,255,255,.9);
  border-radius: 999px;
  padding: 2px 8px;
  cursor:pointer;
}
.pill .x:active{ transform: scale(.98); }

.progResults{ margin-top: 10px; }
    /* ✅ Prevent iOS Safari auto-zoom on focus (must be >= 16px computed) */
@media (hover: none) and (pointer: coarse){
  input, select, textarea,
  .settingsSearch input{
    font-size: 16px !important;
  }
}
  </style>
</head>

<body>
  <div class="app">
<header>
  <div class="topbar">
    <div class="brand">
      <div class="title" id="appTitle">Gym Dashboard</div>

      <div class="subtitle" id="appSubtitle">
        <div class="subPills">
          <button class="subPill" id="syncPill" type="button">Offline</button>
          <button class="subPill" id="verPill" type="button">v0.0.0</button>
        </div>
      </div>
    </div>

    <div class="chip" id="chipStatus">Not set up</div>
  </div>
</header>


    <main id="viewRoot"></main>
  </div>

  <div class="nav">
    <div class="navbar" id="navbar"></div>
  </div>

  <!-- Modal Host -->
  <div class="modalHost" id="modalHost" aria-hidden="true">
    <div class="backdrop" id="modalBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHeader">
        <div class="h" id="modalTitle">Modal</div>
        <button class="xbtn" id="modalClose">Close</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    /********************
     * 1) State + Storage
     ********************/
// ─────────────────────────────
// Storage + Versioning
// ─────────────────────────────
const STORAGE_KEY = "gymdash:v1";

// version.json is the single source of truth for version display + release notes
const REMOTE_VERSION_URL = "./version.json";

// Version metadata only (does NOT affect user profile/state)
const VERSION_LATEST_KEY   = "gymdash:latestVersion";     // last fetched version.json value
const VERSION_APPLIED_KEY  = "gymdash:appliedVersion";    // last version applied on this device
const VERSION_NOTES_KEY    = "gymdash:latestNotes";       // JSON stringified array of notes
const VERSION_BUILD_KEY    = "gymdash:latestBuildDate";   // optional build date string




    const DefaultState = () => ({
      schemaVersion: 1,
      createdAt: Date.now(),
      profile: null,
      routines: [],
      activeRoutineId: null,
      exerciseLibrary: {
        weightlifting: [],
        cardio: [],
        core: []
      },
      logs: {
        workouts: [],
        weight: [],
        protein: []
      },
      attendance: []
    });

    const Storage = {
      load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return DefaultState();
          const parsed = JSON.parse(raw);
          if(!parsed || typeof parsed !== "object") return DefaultState();
          if(!("schemaVersion" in parsed)) return DefaultState();
          return parsed;
        }catch(e){
          return DefaultState();
        }
      },
      save(state){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      },
      reset(){
        localStorage.removeItem(STORAGE_KEY);
      }
    };
    /********************
     * Backup / Import (Step 10)
     ********************/
    function downloadTextFile(filename, text, mime="application/json"){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 250);
    }

    function exportBackupJSON(){
      // Keep export simple: full state snapshot
      const payload = {
        exportedAt: new Date().toISOString(),
        app: "gym-dashboard-dev",
        data: state
      };
      return JSON.stringify(payload, null, 2);
    }

    function validateImportedState(obj){
      // Accept either raw state or wrapped { data: state }
      const imported = (obj && typeof obj === "object" && "data" in obj) ? obj.data : obj;

      if(!imported || typeof imported !== "object") throw new Error("Invalid JSON object.");
      if(typeof imported.schemaVersion !== "number") throw new Error("Invalid backup: missing schemaVersion.");

      // Must contain expected top-level fields (loose validation)
      if(!("profile" in imported)) throw new Error("Invalid backup: missing profile.");
      if(!("routines" in imported)) throw new Error("Invalid backup: missing routines.");
      if(!("exerciseLibrary" in imported)) throw new Error("Invalid backup: missing exerciseLibrary.");
      if(!("logs" in imported)) throw new Error("Invalid backup: missing logs.");
      if(!("attendance" in imported)) throw new Error("Invalid backup: missing attendance.");

      return imported;
    }

    function importBackupJSON(jsonText){
      let parsed;
      try{
        parsed = JSON.parse(jsonText);
      }catch(e){
        throw new Error("Could not parse JSON. Make sure it’s valid.");
      }

      const importedState = validateImportedState(parsed);

      // Overwrite local storage + live state
      state = importedState;
      Storage.save(state);
    }
    let state = Storage.load();
const UIState = window.__GymDashUIState || (window.__GymDashUIState = {
  settings: {
    q: "",
    open: { "profile": true, "library": false, "backup": false, "data": false, "debug": false }
  },
  libraryManage: {
    q: "",
    type: "weightlifting",
    equipment: "all"
  }
});
    /********************
     * 2) Helpers
     ********************/
    const $ = (sel, root=document) => root.querySelector(sel);

    const el = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if(k === "class") n.className = v;
        else if(k === "text") n.textContent = v;
        else if(k === "html") n.innerHTML = v;
        else if(k.startsWith("on") && typeof v === "function"){
          n.addEventListener(k.slice(2).toLowerCase(), v);
        } else {
          n.setAttribute(k, v);
        }
      }
      children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
      return n;
    };

    const uid = (prefix="id") => `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;

        const pad2 = (n) => String(n).padStart(2, "0");

    const Dates = {
      todayISO(){
        const d = new Date();
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      },
      // weekStartsOn: "mon" | "sun"
      startOfWeekISO(dateISO, weekStartsOn){
        const d = new Date(dateISO + "T00:00:00");
        const dow = d.getDay(); // 0=Sun..6=Sat
        const weekStart = (weekStartsOn === "sun") ? 0 : 1;
        // how many days to subtract to get week start
        let diff = dow - weekStart;
        if(diff < 0) diff += 7;
        d.setDate(d.getDate() - diff);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      },
      addDaysISO(dateISO, days){
        const d = new Date(dateISO + "T00:00:00");
        d.setDate(d.getDate() + days);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      },
      sameISO(a,b){ return String(a) === String(b); }
    };
        /********************
     * Settings helpers (added)
     ********************/
    function bytesToNice(bytes){
      const n = Number(bytes || 0);
      if(!isFinite(n) || n <= 0) return "0 B";
      const units = ["B","KB","MB","GB","TB"];
      let v = n;
      let i = 0;
      while(v >= 1024 && i < units.length-1){
        v /= 1024;
        i++;
      }
      const dp = (i === 0) ? 0 : (v >= 10 ? 1 : 2);
      return `${v.toFixed(dp)} ${units[i]}`;
    }

    function appStorageBytes(){
      // Approximate localStorage usage for this origin
      let total = 0;
      try{
        for(let i=0; i<localStorage.length; i++){
          const k = localStorage.key(i);
          const v = localStorage.getItem(k) || "";
          total += (k ? k.length : 0) + v.length;
        }
      }catch(e){
        // If storage is blocked, just report 0
        total = 0;
      }
      // JS strings are ~2 bytes/char in UTF-16
      return total * 2;
    }

    function confirmModal({ title="Confirm", message="Are you sure?", confirmText="Confirm", danger=false, onConfirm }){
      const btnClass = danger ? "btn danger" : "btn primary";
      Modal.open({
        title,
        bodyNode: el("div", {}, [
          el("div", { class:"note", text: message }),
          el("div", { style:"height:12px" }),
          el("div", { class:"btnrow" }, [
            el("button", { class:"btn", onClick: Modal.close }, ["Cancel"]),
            el("button", {
              class: btnClass,
              onClick: () => {
                try{ if(typeof onConfirm === "function") onConfirm(); }
                finally{ Modal.close(); }
              }
            }, [confirmText])
          ])
        ])
      });
    }

    function getTodayWorkout(){
      const routine = Routines.getActive();
      if(!routine || !(routine.days?.length)) return { routine: null, day: null, dayIndex: null };

      const today = new Date();
      const idx = today.getDay(); // 0=Sun..6=Sat
      // Our routine days are stored order 0..6 (Day 1..Day 7)
      const day = routine.days.find(d => d.order === idx) || routine.days[idx] || null;
      return { routine, day, dayIndex: idx };
    }

    function isTrained(dateISO){
      return (state.attendance || []).includes(dateISO);
    }

    function toggleTrained(dateISO){
      state.attendance = state.attendance || [];
      const i = state.attendance.indexOf(dateISO);
      if(i >= 0) state.attendance.splice(i, 1);
      else state.attendance.push(dateISO);
      Storage.save(state);
    }
    /********************
     * Attendance Helpers (Step 9)
     ********************/
    function ymFromISO(dateISO){
      const [y,m] = String(dateISO).split("-").map(x => parseInt(x,10));
      return { y, m }; // m = 1..12
    }

    function monthTitle(y, m){
      const d = new Date(y, m-1, 1);
      return d.toLocaleString(undefined, { month:"long", year:"numeric" });
    }

    function daysInMonth(y, m){
      return new Date(y, m, 0).getDate(); // m is 1..12
    }

    function firstDayDow(y, m){
      return new Date(y, m-1, 1).getDay(); // 0=Sun..6=Sat
    }

    function isoForYMD(y, m, d){
      return `${y}-${pad2(m)}-${pad2(d)}`;
    }

    const AttendanceEngine = {
      ensure(){
        state.attendance = state.attendance || [];
      },
      monthCount(y, m){
        this.ensure();
        const prefix = `${y}-${pad2(m)}-`;
        return state.attendance.filter(x => String(x).startsWith(prefix)).length;
      },
      clearMonth(y, m){
        this.ensure();
        const prefix = `${y}-${pad2(m)}-`;
        state.attendance = state.attendance.filter(x => !String(x).startsWith(prefix));
        Storage.save(state);
      }
    };

    const normName = (s) => (s || "").trim().replace(/\s+/g, " ").toLowerCase();

    /********************
     * 3) Routine templates
     ********************/
const RoutineTemplates = [
      // 🔥 PPL (Push / Pull / Legs) — 6 Days + Rest (Sunday)
      { key:"ppl", name:"PPL", desc:"Push / Pull / Legs • 6 days + Sunday rest",
        buildDays(){ return [
          { label:"Push", isRest:false },{ label:"Pull", isRest:false },{ label:"Legs", isRest:false },
          { label:"Push", isRest:false },{ label:"Pull", isRest:false },{ label:"Legs", isRest:false },
          { label:"Rest", isRest:true }
        ];},
        buildExerciseIndexMap(){ return ({
          0: [ // Push (Mon)
            { type:"weightlifting", name:"Barbell Bench Press", plan:{ sets:4, reps:"6–8", restSec:120 } },
            { type:"weightlifting", name:"Incline Dumbbell Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Shoulder Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Lateral Raise", plan:{ sets:3, reps:"12–15", restSec:60 } },
            { type:"weightlifting", name:"Cable Tricep Pushdown", plan:{ sets:3, reps:"10–12", restSec:60 } },
            { type:"weightlifting", name:"Overhead Tricep Extension", plan:{ sets:3, reps:"10–12", restSec:60 } }
          ],
          1: [ // Pull (Tue)
            { type:"weightlifting", name:"Barbell Deadlift", plan:{ sets:3, reps:"5", restSec:180 } },
            { type:"weightlifting", name:"Lat Pulldown", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Barbell Bent Over Row", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Face Pull", plan:{ sets:3, reps:"12–15", restSec:60 } },
            { type:"weightlifting", name:"Barbell Curl", plan:{ sets:3, reps:"8–10", restSec:60 } },
            { type:"weightlifting", name:"Hammer Curl", plan:{ sets:3, reps:"10–12", restSec:60 } }
          ],
          2: [ // Legs (Wed)
            { type:"weightlifting", name:"Back Squat", plan:{ sets:4, reps:"6–8", restSec:180 } },
            { type:"weightlifting", name:"Leg Press", plan:{ sets:3, reps:"8–10", restSec:120 } },
            { type:"weightlifting", name:"Romanian Deadlift", plan:{ sets:3, reps:"8–10", restSec:120 } },
            { type:"weightlifting", name:"Leg Curl", plan:{ sets:3, reps:"10–12", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Walking Lunge", plan:{ sets:3, reps:"10 each leg", restSec:90 } },
            { type:"weightlifting", name:"Seated Calf Raise", plan:{ sets:4, reps:"12–15", restSec:60 } }
          ],
          3: [ // Push (Thu) — repeat
            { type:"weightlifting", name:"Barbell Bench Press", plan:{ sets:4, reps:"6–8", restSec:120 } },
            { type:"weightlifting", name:"Incline Dumbbell Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Shoulder Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Lateral Raise", plan:{ sets:3, reps:"12–15", restSec:60 } },
            { type:"weightlifting", name:"Cable Tricep Pushdown", plan:{ sets:3, reps:"10–12", restSec:60 } },
            { type:"weightlifting", name:"Overhead Tricep Extension", plan:{ sets:3, reps:"10–12", restSec:60 } }
          ],
          4: [ // Pull (Fri) — repeat
            { type:"weightlifting", name:"Barbell Deadlift", plan:{ sets:3, reps:"5", restSec:180 } },
            { type:"weightlifting", name:"Lat Pulldown", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Barbell Bent Over Row", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Face Pull", plan:{ sets:3, reps:"12–15", restSec:60 } },
            { type:"weightlifting", name:"Barbell Curl", plan:{ sets:3, reps:"8–10", restSec:60 } },
            { type:"weightlifting", name:"Hammer Curl", plan:{ sets:3, reps:"10–12", restSec:60 } }
          ],
          5: [ // Legs (Sat) — repeat
            { type:"weightlifting", name:"Back Squat", plan:{ sets:4, reps:"6–8", restSec:180 } },
            { type:"weightlifting", name:"Leg Press", plan:{ sets:3, reps:"8–10", restSec:120 } },
            { type:"weightlifting", name:"Romanian Deadlift", plan:{ sets:3, reps:"8–10", restSec:120 } },
            { type:"weightlifting", name:"Leg Curl", plan:{ sets:3, reps:"10–12", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Walking Lunge", plan:{ sets:3, reps:"10 each leg", restSec:90 } },
            { type:"weightlifting", name:"Seated Calf Raise", plan:{ sets:4, reps:"12–15", restSec:60 } }
          ]
        });}
      },

      // 💪 Upper / Lower Split (4 Days)
      { key:"upper_lower", name:"Upper / Lower", desc:"4 days • Wed + weekend rest",
        buildDays(){ return [
          { label:"Upper", isRest:false },{ label:"Lower", isRest:false },{ label:"Rest", isRest:true },
          { label:"Upper", isRest:false },{ label:"Lower", isRest:false },{ label:"Rest", isRest:true },
          { label:"Rest", isRest:true }
        ];},
        buildExerciseIndexMap(){ return ({
          0: [ // Upper (Mon)
            { type:"weightlifting", name:"Barbell Bench Press", plan:{ sets:4, reps:"6–8", restSec:120 } },
            { type:"weightlifting", name:"Barbell Bent Over Row", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Shoulder Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Lat Pulldown", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Barbell Curl", plan:{ sets:3, reps:"10–12", restSec:60 } },
            { type:"weightlifting", name:"Cable Tricep Pushdown", plan:{ sets:3, reps:"10–12", restSec:60 } }
          ],
          1: [ // Lower (Tue)
            { type:"weightlifting", name:"Back Squat", plan:{ sets:4, reps:"6–8", restSec:180 } },
            { type:"weightlifting", name:"Romanian Deadlift", plan:{ sets:3, reps:"8–10", restSec:120 } },
            { type:"weightlifting", name:"Leg Press", plan:{ sets:3, reps:"10", restSec:120 } },
            { type:"weightlifting", name:"Dumbbell Step-Up", plan:{ sets:3, reps:"10 each leg", restSec:90 } },
            { type:"weightlifting", name:"Seated Calf Raise", plan:{ sets:4, reps:"12–15", restSec:60 } }
          ],
          3: [ // Upper (Thu) — repeat
            { type:"weightlifting", name:"Barbell Bench Press", plan:{ sets:4, reps:"6–8", restSec:120 } },
            { type:"weightlifting", name:"Barbell Bent Over Row", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Shoulder Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Lat Pulldown", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Barbell Curl", plan:{ sets:3, reps:"10–12", restSec:60 } },
            { type:"weightlifting", name:"Cable Tricep Pushdown", plan:{ sets:3, reps:"10–12", restSec:60 } }
          ],
          4: [ // Lower (Fri) — repeat
            { type:"weightlifting", name:"Back Squat", plan:{ sets:4, reps:"6–8", restSec:180 } },
            { type:"weightlifting", name:"Romanian Deadlift", plan:{ sets:3, reps:"8–10", restSec:120 } },
            { type:"weightlifting", name:"Leg Press", plan:{ sets:3, reps:"10", restSec:120 } },
            { type:"weightlifting", name:"Dumbbell Step-Up", plan:{ sets:3, reps:"10 each leg", restSec:90 } },
            { type:"weightlifting", name:"Seated Calf Raise", plan:{ sets:4, reps:"12–15", restSec:60 } }
          ]
        });}
      },

      // 🏋️ Full Body (3 Days)
      { key:"full_body_3", name:"Full Body (3-day)", desc:"3 days • A/B/C • Wed + weekend rest",
        buildDays(){ return [
          { label:"Full Body A", isRest:false },{ label:"Rest", isRest:true },
          { label:"Full Body B", isRest:false },{ label:"Rest", isRest:true },
          { label:"Full Body C", isRest:false },{ label:"Rest", isRest:true },{ label:"Rest", isRest:true }
        ];},
        buildExerciseIndexMap(){ return ({
          0: [ // A (Mon)
            { type:"weightlifting", name:"Back Squat", plan:{ sets:4, reps:"5", restSec:180 } },
            { type:"weightlifting", name:"Barbell Bench Press", plan:{ sets:4, reps:"6–8", restSec:120 } },
            { type:"weightlifting", name:"Barbell Bent Over Row", plan:{ sets:3, reps:"8", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Lateral Raise", plan:{ sets:3, reps:"12–15", restSec:60 } },
            { type:"core", name:"Plank", plan:{ sets:3, reps:"30–45 sec", restSec:45 } }
          ],
          2: [ // B (Wed)
            { type:"weightlifting", name:"Barbell Deadlift", plan:{ sets:3, reps:"5", restSec:180 } },
            { type:"weightlifting", name:"Incline Dumbbell Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Lat Pulldown", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Walking Lunge", plan:{ sets:3, reps:"10 each leg", restSec:90 } },
            { type:"core", name:"Hanging Leg Raise", plan:{ sets:3, reps:"12", restSec:45 } }
          ],
          4: [ // C (Fri)
            { type:"weightlifting", name:"Front Squat", plan:{ sets:4, reps:"6", restSec:180 } },
            { type:"weightlifting", name:"Dumbbell Shoulder Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Cable Row", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Leg Curl", plan:{ sets:3, reps:"10–12", restSec:90 } },
            { type:"core", name:"Russian Twist", plan:{ sets:3, reps:"20 total", restSec:45 } }
          ]
        });}
      },

      // 🧱 Body Part Split (Classic Bro Split – 5 Days)
      { key:"body_part_split", name:"Body Part Split", desc:"Chest/Back/Legs/Shoulders/Arms • weekend rest",
        buildDays(){ return [
          { label:"Chest", isRest:false },{ label:"Back", isRest:false },{ label:"Legs", isRest:false },
          { label:"Shoulders", isRest:false },{ label:"Arms", isRest:false },
          { label:"Rest", isRest:true },{ label:"Rest", isRest:true }
        ];},
        buildExerciseIndexMap(){ return ({
          0: [ // Chest
            { type:"weightlifting", name:"Barbell Bench Press", plan:{ sets:4, reps:"6–8", restSec:120 } },
            { type:"weightlifting", name:"Incline Dumbbell Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Cable Chest Fly", plan:{ sets:3, reps:"12", restSec:60 } },
            { type:"weightlifting", name:"Pec Deck", plan:{ sets:3, reps:"12", restSec:60 } }
          ],
          1: [ // Back
            { type:"weightlifting", name:"Barbell Deadlift", plan:{ sets:3, reps:"5", restSec:180 } },
            { type:"weightlifting", name:"Lat Pulldown", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Barbell Bent Over Row", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Seated Row", plan:{ sets:3, reps:"10", restSec:90 } }
          ],
          2: [ // Legs
            { type:"weightlifting", name:"Back Squat", plan:{ sets:4, reps:"6–8", restSec:180 } },
            { type:"weightlifting", name:"Leg Press", plan:{ sets:3, reps:"10", restSec:120 } },
            { type:"weightlifting", name:"Romanian Deadlift", plan:{ sets:3, reps:"8–10", restSec:120 } },
            { type:"weightlifting", name:"Leg Curl", plan:{ sets:3, reps:"12", restSec:90 } },
            { type:"weightlifting", name:"Seated Calf Raise", plan:{ sets:4, reps:"15", restSec:60 } }
          ],
          3: [ // Shoulders
            { type:"weightlifting", name:"Barbell Overhead Press", plan:{ sets:4, reps:"6–8", restSec:120 } },
            { type:"weightlifting", name:"Arnold Press", plan:{ sets:3, reps:"8–10", restSec:90 } },
            { type:"weightlifting", name:"Dumbbell Lateral Raise", plan:{ sets:3, reps:"15", restSec:60 } },
            { type:"weightlifting", name:"Face Pull", plan:{ sets:3, reps:"15", restSec:60 } }
          ],
          4: [ // Arms
            { type:"weightlifting", name:"Barbell Curl", plan:{ sets:3, reps:"8–10", restSec:60 } },
            { type:"weightlifting", name:"Incline Dumbbell Curl", plan:{ sets:3, reps:"10–12", restSec:60 } },
            { type:"weightlifting", name:"Cable Tricep Pushdown", plan:{ sets:3, reps:"10–12", restSec:60 } },
            { type:"weightlifting", name:"Overhead Tricep Extension", plan:{ sets:3, reps:"10–12", restSec:60 } },
            { type:"weightlifting", name:"Hammer Curl", plan:{ sets:3, reps:"12", restSec:60 } }
          ]
        });}
      },

      { key:"blank", name:"Blank", desc:"Start from scratch (you’ll edit days + exercises)",
        buildDays(){ return [
          { label:"Day 1", isRest:false },{ label:"Day 2", isRest:false },{ label:"Day 3", isRest:false },
          { label:"Day 4", isRest:false },{ label:"Day 5", isRest:false },{ label:"Day 6", isRest:false },
          { label:"Day 7", isRest:false }
        ];}}
    ];
      function createRoutineFromTemplate(templateKey, routineName){
      const tpl = RoutineTemplates.find(t => t.key === templateKey);
      if(!tpl) throw new Error("Invalid template key");

      // Ensure library exists so we can resolve IDs by name
      try{ ExerciseLibrary.ensureSeeded(); }catch(e){ /* safe */ }

      const routineId = uid("rt");
      const days = tpl.buildDays().map((d, idx) => ({
        id: uid("day"),
        order: idx,
        label: d.label,
        isRest: !!d.isRest,
        exercises: []
      }));

      // Helper: resolve exercise by name in library (by type)
      function findLibItem(type, name){
        const arr = (state.exerciseLibrary?.[type] || []);
        const n = normName(name);
        return arr.find(x => normName(x.name) === n) || null;
      }

      // Seed exercises if provided by template
      if(typeof tpl.buildExerciseIndexMap === "function"){
        const map = tpl.buildExerciseIndexMap() || {};
        Object.keys(map).forEach(k => {
          const idx = Number(k);
          const day = days[idx];
          if(!day || day.isRest) return;

          const items = map[k] || [];
          day.exercises = items.map(item => {
            const libItem = findLibItem(item.type, item.name);
            return {
              id: uid("rx"),
              exerciseId: libItem?.id || null,
              type: item.type,
              nameSnap: libItem?.name || item.name,
              plan: item.plan || null,        // { sets, reps, restSec }
              createdAt: Date.now()
            };
          });
        });
      }

      return {
        id: routineId,
        name: routineName || tpl.name,
        templateKey: tpl.key,
        createdAt: Date.now(),
        days
      };
    }
    /********************
     * 4) Exercise Library Module (Step 3)
     ********************/
    const ExerciseLibrary = {
      typeKeys: ["weightlifting","cardio","core"],
      typeLabel(type){
        if(type === "weightlifting") return "Weightlifting";
        if(type === "cardio") return "Cardio";
        return "Core";
      },
      ensureSeeded(){
        // Only seed if ALL empty
        const lib = state.exerciseLibrary || (state.exerciseLibrary = { weightlifting:[], cardio:[], core:[] });
        const empty = (lib.weightlifting?.length||0) === 0 && (lib.cardio?.length||0) === 0 && (lib.core?.length||0) === 0;
        if(!empty) return;

               lib.weightlifting = [
          // --- Barbell (Chest/Shoulders/Back/Legs) ---
          { id: uid("ex"), type:"weightlifting", name:"Barbell Bench Press", equipment:"Barbell", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Incline Barbell Bench Press", equipment:"Barbell", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Decline Barbell Bench Press", equipment:"Barbell", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Close-Grip Bench Press", equipment:"Barbell", primaryMuscle:"Chest / Triceps", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Barbell Overhead Press", equipment:"Barbell", primaryMuscle:"Shoulders", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Upright Row", equipment:"Barbell", primaryMuscle:"Shoulders", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Barbell Bent Over Row", equipment:"Barbell", primaryMuscle:"Back", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Pendlay Row", equipment:"Barbell", primaryMuscle:"Back", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Barbell Deadlift", equipment:"Barbell", primaryMuscle:"Back / Glutes", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Romanian Deadlift", equipment:"Barbell", primaryMuscle:"Hamstrings", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Rack Pull", equipment:"Barbell", primaryMuscle:"Back", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Back Squat", equipment:"Barbell", primaryMuscle:"Legs (Quads)", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Front Squat", equipment:"Barbell", primaryMuscle:"Legs (Quads)", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Sumo Deadlift", equipment:"Barbell", primaryMuscle:"Glutes / Hamstrings", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Barbell Hip Thrust", equipment:"Barbell", primaryMuscle:"Glutes", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Barbell Lunge", equipment:"Barbell", primaryMuscle:"Legs", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Barbell Calf Raise", equipment:"Barbell", primaryMuscle:"Calves", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Barbell Curl", equipment:"Barbell", primaryMuscle:"Biceps", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Reverse Curl", equipment:"Barbell", primaryMuscle:"Forearms", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Barbell Skull Crusher", equipment:"Barbell", primaryMuscle:"Triceps", createdAt:Date.now() },

          // --- Dumbbell (Chest/Shoulders/Back/Legs/Arms) ---
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Bench Press", equipment:"Dumbbell", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Incline Dumbbell Press", equipment:"Dumbbell", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Decline Dumbbell Press", equipment:"Dumbbell", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Fly", equipment:"Dumbbell", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Pullover", equipment:"Dumbbell", primaryMuscle:"Chest / Back", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Shoulder Press", equipment:"Dumbbell", primaryMuscle:"Shoulders", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Arnold Press", equipment:"Dumbbell", primaryMuscle:"Shoulders", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Lateral Raise", equipment:"Dumbbell", primaryMuscle:"Shoulders", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Front Raise", equipment:"Dumbbell", primaryMuscle:"Shoulders", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Rear Delt Fly", equipment:"Dumbbell", primaryMuscle:"Shoulders", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Single-Arm Dumbbell Row", equipment:"Dumbbell", primaryMuscle:"Back", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Shrug", equipment:"Dumbbell", primaryMuscle:"Traps", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Goblet Squat", equipment:"Dumbbell", primaryMuscle:"Legs", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Lunge", equipment:"Dumbbell", primaryMuscle:"Legs", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Walking Lunge", equipment:"Dumbbell", primaryMuscle:"Legs", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Bulgarian Split Squat", equipment:"Dumbbell", primaryMuscle:"Legs", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Step-Up", equipment:"Dumbbell", primaryMuscle:"Legs", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Romanian Deadlift", equipment:"Dumbbell", primaryMuscle:"Hamstrings", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Sumo Squat", equipment:"Dumbbell", primaryMuscle:"Glutes", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Hip Thrust", equipment:"Dumbbell", primaryMuscle:"Glutes", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Calf Raise", equipment:"Dumbbell", primaryMuscle:"Calves", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Curl", equipment:"Dumbbell", primaryMuscle:"Biceps", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Incline Dumbbell Curl", equipment:"Dumbbell", primaryMuscle:"Biceps", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Hammer Curl", equipment:"Dumbbell", primaryMuscle:"Biceps", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Concentration Curl", equipment:"Dumbbell", primaryMuscle:"Biceps", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Overhead Tricep Extension", equipment:"Dumbbell", primaryMuscle:"Triceps", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Skull Crusher", equipment:"Dumbbell", primaryMuscle:"Triceps", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Tricep Kickback", equipment:"Dumbbell", primaryMuscle:"Triceps", createdAt:Date.now() },

          // --- Machines & Cable (Commercial Gym Essentials) ---
          { id: uid("ex"), type:"weightlifting", name:"Chest Press", equipment:"Machine", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Pec Deck", equipment:"Machine", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Lat Pulldown", equipment:"Machine", primaryMuscle:"Back", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Seated Row", equipment:"Machine", primaryMuscle:"Back", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Assisted Pull-Up", equipment:"Machine", primaryMuscle:"Back", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Leg Press", equipment:"Machine", primaryMuscle:"Legs", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Leg Extension", equipment:"Machine", primaryMuscle:"Quads", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Leg Curl", equipment:"Machine", primaryMuscle:"Hamstrings", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Seated Calf Raise", equipment:"Machine", primaryMuscle:"Calves", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Smith Machine Squat", equipment:"Machine", primaryMuscle:"Legs", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Cable Chest Fly", equipment:"Cable", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Cable Crossover", equipment:"Cable", primaryMuscle:"Chest", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Cable Row", equipment:"Cable", primaryMuscle:"Back", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Face Pull", equipment:"Cable", primaryMuscle:"Shoulders", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Cable Lateral Raise", equipment:"Cable", primaryMuscle:"Shoulders", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Cable Tricep Pushdown", equipment:"Cable", primaryMuscle:"Triceps", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Cable Overhead Tricep Extension", equipment:"Cable", primaryMuscle:"Triceps", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Cable Bicep Curl", equipment:"Cable", primaryMuscle:"Biceps", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Cable Woodchopper", equipment:"Cable", primaryMuscle:"Core", createdAt:Date.now() },

          // --- Conditioning / Full Body (moved from cardio) ---
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Thruster", equipment:"Dumbbell", primaryMuscle:"Full Body", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Snatch", equipment:"Dumbbell", primaryMuscle:"Full Body", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Clean and Press", equipment:"Dumbbell", primaryMuscle:"Full Body", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Swings", equipment:"Dumbbell", primaryMuscle:"Full Body", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Farmers Carry", equipment:"Dumbbell", primaryMuscle:"Full Body", createdAt:Date.now() },

          { id: uid("ex"), type:"weightlifting", name:"Barbell Thruster", equipment:"Barbell", primaryMuscle:"Full Body", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Power Clean", equipment:"Barbell", primaryMuscle:"Full Body", createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Hang Clean", equipment:"Barbell", primaryMuscle:"Full Body", createdAt:Date.now() }
        ];

        lib.cardio = [
          { id: uid("ex"), type:"cardio", name:"Treadmill Run", equipment:"Treadmill", modality:"run", supportsIncline:true, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Incline Walk", equipment:"Treadmill", modality:"walk", supportsIncline:true, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Stairmaster", equipment:"Machine", modality:"stairs", supportsIncline:false, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Stationary Bike", equipment:"Bike", modality:"bike", supportsIncline:false, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Row Machine", equipment:"Rower", modality:"row", supportsIncline:false, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Elliptical", equipment:"Machine", modality:"elliptical", supportsIncline:false, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Jump Rope", equipment:"Bodyweight", modality:"rope", supportsIncline:false, createdAt:Date.now() }
        ];

        lib.core = [
          { id: uid("ex"), type:"core", name:"Plank", equipment:"Bodyweight", primaryMuscle:"Core (Abs)", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Side Plank", equipment:"Bodyweight", primaryMuscle:"Core (Obliques)", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Weighted Sit-Up", equipment:"Dumbbell", primaryMuscle:"Core (Abs)", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Russian Twist", equipment:"Dumbbell", primaryMuscle:"Core (Obliques)", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Dumbbell Side Bend", equipment:"Dumbbell", primaryMuscle:"Core (Obliques)", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Renegade Row", equipment:"Dumbbell", primaryMuscle:"Core", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Plank Pull-Through", equipment:"Dumbbell", primaryMuscle:"Core", createdAt:Date.now() },

          { id: uid("ex"), type:"core", name:"Hanging Leg Raise", equipment:"Bar", primaryMuscle:"Core (Lower Abs)", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Weighted Leg Raise", equipment:"Dumbbell", primaryMuscle:"Core (Lower Abs)", createdAt:Date.now() },

          { id: uid("ex"), type:"core", name:"Bicycle Crunch", equipment:"Bodyweight", primaryMuscle:"Core", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Decline Sit-Up", equipment:"Bench", primaryMuscle:"Core", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Ab Wheel Rollout", equipment:"Ab Wheel", primaryMuscle:"Core", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Barbell Rollout", equipment:"Barbell", primaryMuscle:"Core", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Barbell Overhead Hold", equipment:"Barbell", primaryMuscle:"Core", createdAt:Date.now() }
        ];

        Storage.save(state);
      },
      list(type){
        return (state.exerciseLibrary?.[type] || []);
      },
      existsByName(type, name, excludeId=null){
        const n = normName(name);
        return this.list(type).some(x => normName(x.name) === n && x.id !== excludeId);
      },
      add(type, data){
        if(this.existsByName(type, data.name)) throw new Error("Exercise already exists in this category.");
        const ex = { id: uid("ex"), type, createdAt: Date.now(), ...data };
        state.exerciseLibrary[type].push(ex);
        Storage.save(state);
        return ex;
      },
      update(type, id, patch){
        const arr = this.list(type);
        const idx = arr.findIndex(x => x.id === id);
        if(idx < 0) throw new Error("Exercise not found.");
        const nextName = patch.name ?? arr[idx].name;
        if(this.existsByName(type, nextName, id)) throw new Error("Another exercise with that name already exists.");
        arr[idx] = { ...arr[idx], ...patch };
        Storage.save(state);
        return arr[idx];
      },
      remove(type, id){
        const arr = this.list(type);
        const idx = arr.findIndex(x => x.id === id);
        if(idx < 0) return;
        arr.splice(idx, 1);
        Storage.save(state);
      }
    };

        /********************
     * 4b) Routine Engine (Step 4)
     ********************/
    const Routines = {
      getAll(){ return state.routines || (state.routines = []); },
      getActive(){
        const id = state.activeRoutineId;
        return this.getAll().find(r => r.id === id) || null;
      },
      setActive(id){
        state.activeRoutineId = id;
        Storage.save(state);
      },
      addFromTemplate(templateKey, nameOverride=null){
        ExerciseLibrary.ensureSeeded();
        const tplName = RoutineTemplates.find(t => t.key === templateKey)?.name || "Routine";
        const routine = createRoutineFromTemplate(templateKey, nameOverride || tplName);
        this.getAll().push(routine);
        state.activeRoutineId = routine.id;
        Storage.save(state);
        return routine;
      },
      duplicate(routineId){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) throw new Error("Routine not found.");
        const copy = {
          ...r,
          id: uid("rt"),
          name: `${r.name} (Copy)`,
          createdAt: Date.now(),
          days: (r.days || []).map(d => ({
            ...d,
            id: uid("day"),
            exercises: (d.exercises || []).map(ex => ({ ...ex, id: uid("rx") }))
          }))
        };
        this.getAll().push(copy);
        state.activeRoutineId = copy.id;
        Storage.save(state);
        return copy;
      },
      remove(routineId){
        const arr = this.getAll();
        const idx = arr.findIndex(x => x.id === routineId);
        if(idx < 0) return;
        arr.splice(idx, 1);

        // If deleted active routine, pick next best
        if(state.activeRoutineId === routineId){
          state.activeRoutineId = arr[0]?.id || null;
        }
        Storage.save(state);
      },
      rename(routineId, newName){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) throw new Error("Routine not found.");
        r.name = (newName || "").trim() || r.name;
        Storage.save(state);
      },

      getDay(routineId, dayId){
        const r = this.getAll().find(x => x.id === routineId);
        if(!r) return null;
        return (r.days || []).find(d => d.id === dayId) || null;
      },

      setRestDay(routineId, dayId, isRest){
        const day = this.getDay(routineId, dayId);
        if(!day) throw new Error("Day not found.");
        day.isRest = !!isRest;
        Storage.save(state);
      },

      setDayLabel(routineId, dayId, label){
        const day = this.getDay(routineId, dayId);
        if(!day) throw new Error("Day not found.");
        day.label = (label || "").trim() || day.label;
        Storage.save(state);
      },

      addExerciseToDay(routineId, dayId, exType, exerciseId){
        const day = this.getDay(routineId, dayId);
        if(!day) throw new Error("Day not found.");
        const libItem = (state.exerciseLibrary?.[exType] || []).find(x => x.id === exerciseId);
        if(!libItem) throw new Error("Exercise not found in library.");
        day.exercises = day.exercises || [];
        day.exercises.push({
          id: uid("rx"),
          exerciseId,
          type: exType,
          nameSnap: libItem.name,
          createdAt: Date.now()
        });
        Storage.save(state);
      },

      removeExerciseFromDay(routineId, dayId, routineExerciseId){
        const day = this.getDay(routineId, dayId);
        if(!day) throw new Error("Day not found.");
        day.exercises = day.exercises || [];
        const idx = day.exercises.findIndex(x => x.id === routineExerciseId);
        if(idx >= 0) day.exercises.splice(idx, 1);
        Storage.save(state);
      }
    };

    // Shared helper for "Pick exercise" modals
    function resolveExerciseName(type, exerciseId, fallback){
      const found = (state.exerciseLibrary?.[type] || []).find(x => x.id === exerciseId);
      return found?.name || fallback || "Unknown exercise";
    }
    /********************
     * 4c) Protein (Today) Helpers (Step 5)
     ********************/
    function getProteinForDate(dateISO){
      state.logs = state.logs || { workouts: [], weight: [], protein: [] };
      state.logs.protein = state.logs.protein || [];
      let entry = state.logs.protein.find(x => x.dateISO === dateISO);
      if(!entry){
        entry = { dateISO, meals: [] }; // meals: [{ id, label, grams }]
        state.logs.protein.push(entry);
        Storage.save(state);
      }
      return entry;
    }

    function upsertMeal(dateISO, mealId, label, grams){
      const p = getProteinForDate(dateISO);
      p.meals = p.meals || [];
      const idx = p.meals.findIndex(m => m.id === mealId);
      const clean = {
        id: mealId || uid("meal"),
        label: (label || "").trim() || "Meal",
        grams: Math.max(0, Math.round(Number(grams) || 0))
      };
      if(idx >= 0) p.meals[idx] = clean;
      else p.meals.push(clean);
      Storage.save(state);
      return clean.id;
    }

    function deleteMeal(dateISO, mealId){
      const p = getProteinForDate(dateISO);
      p.meals = p.meals || [];
      const idx = p.meals.findIndex(m => m.id === mealId);
      if(idx >= 0) p.meals.splice(idx, 1);
      Storage.save(state);
    }

    function totalProtein(dateISO){
      const p = getProteinForDate(dateISO);
      return (p.meals || []).reduce((sum,m) => sum + (Number(m.grams)||0), 0);
    }
    /********************
     * 4d) Log Engine + PR Engine (Step 6)  ✅ FIXED
     ********************/
    const LogEngine = {
      ensure(){
        state.logs = state.logs || { workouts: [], weight: [], protein: [] };
        state.logs.workouts = state.logs.workouts || [];
      },

      addEntry(entry){
        this.ensure();
        state.logs.workouts.push(entry);
        Storage.save(state);
      },

      entriesForExercise(type, exerciseId){
        this.ensure();
        return state.logs.workouts
          .filter(e => e.type === type && e.exerciseId === exerciseId)
          .sort((a,b) => (b.dateISO || "").localeCompare(a.dateISO || "") || (b.createdAt||0)-(a.createdAt||0));
      },

      lifetimeBests(type, exerciseId){
        const entries = this.entriesForExercise(type, exerciseId);
        const bests = {
          bestWeight: null,
          best1RM: null,
          bestVolume: null,
          bestPace: null
        };

        for(const e of entries){
          if(e?.summary){
            if(type === "weightlifting"){
              if(Number.isFinite(e.summary.bestWeight)) bests.bestWeight = Math.max(bests.bestWeight ?? -Infinity, e.summary.bestWeight);
              if(Number.isFinite(e.summary.best1RM)) bests.best1RM = Math.max(bests.best1RM ?? -Infinity, e.summary.best1RM);
              if(Number.isFinite(e.summary.totalVolume)) bests.bestVolume = Math.max(bests.bestVolume ?? -Infinity, e.summary.totalVolume);
            } else if(type === "cardio"){
              if(Number.isFinite(e.summary.paceSecPerUnit)){
                bests.bestPace = Math.min(bests.bestPace ?? Infinity, e.summary.paceSecPerUnit);
              }
            } else if(type === "core"){
              if(Number.isFinite(e.summary.totalVolume)) bests.bestVolume = Math.max(bests.bestVolume ?? -Infinity, e.summary.totalVolume);
            }
          }
        }

        if(bests.bestWeight === -Infinity) bests.bestWeight = null;
        if(bests.best1RM === -Infinity) bests.best1RM = null;
        if(bests.bestVolume === -Infinity) bests.bestVolume = null;
        if(bests.bestPace === Infinity) bests.bestPace = null;

        return bests;
      },

      computeWeightliftingSummary(sets){
        const cleanSets = (sets || []).map(s => ({
          weight: Number(s.weight) || 0,
          reps: Math.max(0, Math.floor(Number(s.reps) || 0))
        }));

        let totalVolume = 0;
        let bestWeight = 0;
        let best1RM = 0;

        for(const s of cleanSets){
          totalVolume += (s.weight * s.reps);
          bestWeight = Math.max(bestWeight, s.weight);
          const epley = (s.reps > 0) ? (s.weight * (1 + (s.reps / 30))) : 0;
          best1RM = Math.max(best1RM, epley);
        }

        return {
          totalVolume: round2(totalVolume),
          bestWeight: round2(bestWeight),
          best1RM: round2(best1RM)
        };
      },

      computeCardioSummary(sets){
        const clean = (sets || []).map(s => ({
          timeSec: Math.max(0, Math.floor(Number(s.timeSec) || 0)),
          distance: Number(s.distance) || 0,
          incline: Number.isFinite(Number(s.incline)) ? Number(s.incline) : null
        }));

        const s = clean[0] || { timeSec:0, distance:0, incline:null };
        const pace = (s.distance > 0) ? (s.timeSec / s.distance) : null;

        return {
          timeSec: s.timeSec,
          distance: round2(s.distance),
          incline: s.incline,
          paceSecPerUnit: (pace === null) ? null : round2(pace)
        };
      },

      computeCoreSummary(sets){
        const clean = (sets || []).map(s => ({
          sets: Math.max(0, Math.floor(Number(s.sets) || 0)),
          reps: Math.max(0, Math.floor(Number(s.reps) || 0)),
          timeSec: Math.max(0, Math.floor(Number(s.timeSec) || 0)),
          weight: Number(s.weight) || 0
        }));

        let totalVolume = 0;
        for(const s of clean){
          if(s.reps > 0){
            const w = (s.weight > 0) ? s.weight : 1;
            totalVolume += (s.reps * s.sets * w);
          }else{
            totalVolume += s.timeSec;
          }
        }

        return { totalVolume: round2(totalVolume) };
      },

      computePRFlags(type, exerciseId, summary){
        const prev = this.lifetimeBests(type, exerciseId);

        const pr = {
          isPRWeight: false,
          isPR1RM: false,
          isPRVolume: false,
          isPRPace: false
        };

        if(type === "weightlifting"){
          if(Number.isFinite(summary.bestWeight)){
            pr.isPRWeight = (prev.bestWeight === null) ? (summary.bestWeight > 0) : (summary.bestWeight > prev.bestWeight);
          }
          if(Number.isFinite(summary.best1RM)){
            pr.isPR1RM = (prev.best1RM === null) ? (summary.best1RM > 0) : (summary.best1RM > prev.best1RM);
          }
          if(Number.isFinite(summary.totalVolume)){
            pr.isPRVolume = (prev.bestVolume === null) ? (summary.totalVolume > 0) : (summary.totalVolume > prev.bestVolume);
          }
        } else if(type === "cardio"){
          if(summary.paceSecPerUnit !== null && Number.isFinite(summary.paceSecPerUnit)){
            pr.isPRPace = (prev.bestPace === null) ? (summary.paceSecPerUnit > 0) : (summary.paceSecPerUnit < prev.bestPace);
          }
        } else if(type === "core"){
          if(Number.isFinite(summary.totalVolume)){
            pr.isPRVolume = (prev.bestVolume === null) ? (summary.totalVolume > 0) : (summary.totalVolume > prev.bestVolume);
          }
        }

        return pr;
      }
    };

    function round2(n){
      return Math.round((Number(n) || 0) * 100) / 100;
    }

    function formatTime(sec){
      const s = Math.max(0, Math.floor(Number(sec) || 0));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    function formatPace(paceSecPerUnit){
      if(paceSecPerUnit === null || !Number.isFinite(paceSecPerUnit)) return "—";
      return `${formatTime(paceSecPerUnit)} / unit`;
    }
        /********************
     * 4e) Progress Helpers (Step 7)
     ********************/
    let __progressChart = null;

    function destroyProgressChart(){
      try{
        if(__progressChart){
          __progressChart.destroy();
          __progressChart = null;
        }
      }catch(e){
        __progressChart = null;
      }
    }

    function downloadCanvasPNG(canvas, filename){
      try{
        const url = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = url;
        a.download = filename || "progress.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){
        Modal.open({
          title: "Download failed",
          bodyNode: el("div", {}, [
            el("div", { class:"note", text:"Could not export image. Try again or use a different browser." }),
            el("div", { style:"height:12px" }),
            el("button", { class:"btn primary", onClick: Modal.close }, ["OK"])
          ])
        });
      }
    }

    function buildSeries(type, entries){
      // entries expected ascending by date
      const labels = entries.map(e => e.dateISO);

      if(type === "weightlifting"){
        const topWeight = entries.map(e => Number(e.summary?.bestWeight) || 0);
        const est1RM = entries.map(e => Number(e.summary?.best1RM) || 0);
        const volume = entries.map(e => Number(e.summary?.totalVolume) || 0);
        return { labels, datasets: { topWeight, est1RM, volume } };
      }

      if(type === "cardio"){
        const pace = entries.map(e => (e.summary?.paceSecPerUnit == null ? null : Number(e.summary.paceSecPerUnit)));
        const distance = entries.map(e => Number(e.summary?.distance) || 0);
        const timeSec = entries.map(e => Number(e.summary?.timeSec) || 0);
        return { labels, datasets: { pace, distance, timeSec } };
      }

      // core
      const volume = entries.map(e => Number(e.summary?.totalVolume) || 0);
      return { labels, datasets: { volume } };
    }

    function renderProgressChart(canvas, type, metricKey, series){
      destroyProgressChart();

      // Build chart dataset (no custom colors per your standards — Chart.js defaults)
      let data = [];
      let label = "";

      if(type === "weightlifting"){
        if(metricKey === "topWeight"){ data = series.datasets.topWeight; label = "Top Weight"; }
        else if(metricKey === "est1RM"){ data = series.datasets.est1RM; label = "Estimated 1RM (Epley)"; }
        else { data = series.datasets.volume; label = "Volume"; }
      } else if(type === "cardio"){
        if(metricKey === "pace"){ data = series.datasets.pace; label = "Pace (sec/unit) (lower is better)"; }
        else if(metricKey === "distance"){ data = series.datasets.distance; label = "Distance"; }
        else { data = series.datasets.timeSec; label = "Time (sec)"; }
      } else {
        data = series.datasets.volume;
        label = "Core Volume";
      }

      const ctx = canvas.getContext("2d");
      __progressChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: series.labels,
          datasets: [{
            label,
            data,
            tension: 0.25,
            spanGaps: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      return __progressChart;
    }
        /********************
     * 4f) Weight Engine + Chart Helpers (Step 8)
     ********************/
    const WeightEngine = {
      ensure(){
        state.logs = state.logs || { workouts: [], weight: [], protein: [] };
        state.logs.weight = state.logs.weight || [];
      },

      add(dateISO, weight){
        this.ensure();
        const d = String(dateISO || Dates.todayISO());
        const w = Number(weight);
        if(!Number.isFinite(w) || w <= 0) throw new Error("Enter a valid weight.");

        // Upsert by date (one entry per day)
        const idx = state.logs.weight.findIndex(x => x.dateISO === d);
        const entry = { id: uid("wt"), dateISO: d, weight: round2(w), createdAt: Date.now() };
        if(idx >= 0) state.logs.weight[idx] = { ...state.logs.weight[idx], ...entry };
        else state.logs.weight.push(entry);

        Storage.save(state);
        return entry;
      },

      remove(id){
        this.ensure();
        const idx = state.logs.weight.findIndex(x => x.id === id);
        if(idx >= 0){
          state.logs.weight.splice(idx, 1);
          Storage.save(state);
        }
      },

      listDesc(){
        this.ensure();
        const arr = [...state.logs.weight];
        arr.sort((a,b) => (b.dateISO || "").localeCompare(a.dateISO || "") || (b.createdAt||0)-(a.createdAt||0));
        return arr;
      },

      listAsc(){
        return this.listDesc().reverse();
      },

      latest(){
        const d = this.listDesc();
        return d[0] || null;
      },

      previous(){
        const d = this.listDesc();
        return d[1] || null;
      },

      delta(){
        const a = this.latest();
        const b = this.previous();
        if(!a || !b) return null;
        return round2((a.weight || 0) - (b.weight || 0));
      },

      avg7(dateISO){
        // 7-day window ending at dateISO (inclusive)
        this.ensure();
        const end = new Date(String(dateISO || Dates.todayISO()) + "T00:00:00");
        const start = new Date(end);
        start.setDate(start.getDate() - 6);

        const items = state.logs.weight.filter(x => {
          const d = new Date(x.dateISO + "T00:00:00");
          return d >= start && d <= end;
        });

        if(items.length === 0) return null;
        const avg = items.reduce((sum,x) => sum + (Number(x.weight)||0), 0) / items.length;
        return round2(avg);
      }
    };

    let __weightChart = null;

    function destroyWeightChart(){
      try{
        if(__weightChart){
          __weightChart.destroy();
          __weightChart = null;
        }
      }catch(e){
        __weightChart = null;
      }
    }

    function renderWeightChart(canvas, entriesAsc){
      destroyWeightChart();
      const labels = entriesAsc.map(e => e.dateISO);
      const data = entriesAsc.map(e => Number(e.weight) || 0);

      const ctx = canvas.getContext("2d");
      __weightChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Bodyweight",
            data,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: false } }
        }
      });

      return __weightChart;
    }
    /********************
 * 4f) Routine/Attendance Helpers (NEW)
 ********************/

// Attendance helpers (explicit add/remove for manual override scenarios)
function attendanceHas(dateISO){
  state.attendance = state.attendance || [];
  return state.attendance.includes(dateISO);
}
function attendanceAdd(dateISO){
  state.attendance = state.attendance || [];
  if(!state.attendance.includes(dateISO)){
    state.attendance.push(dateISO);
    Storage.save(state);
  }
}
function attendanceRemove(dateISO){
  state.attendance = state.attendance || [];
  const i = state.attendance.indexOf(dateISO);
  if(i >= 0){
    state.attendance.splice(i, 1);
    Storage.save(state);
  }
}

// Routine logging helpers (per-routine-exercise instance)
function hasRoutineExerciseLog(dateISO, routineExerciseId){
  LogEngine.ensure();
  return state.logs.workouts.some(e => e.dateISO === dateISO && e.routineExerciseId === routineExerciseId);
}

function lifetimeMaxSet(type, exerciseId){
  if(type !== "weightlifting") return null;
  const entries = LogEngine.entriesForExercise(type, exerciseId);
  let best = null;
  for(const e of entries){
    for(const s of (e.sets || [])){
      const w = Number(s.weight) || 0;
      const r = Math.max(0, Math.floor(Number(s.reps) || 0));
      if(w <= 0 || r <= 0) continue;
      if(!best) best = { weight: w, reps: r };
      else if(w > best.weight) best = { weight: w, reps: r };
      else if(w === best.weight && r > best.reps) best = { weight: w, reps: r };
    }
  }
  return best;
}

// Floating "Next →" nudge (transient UI only)
let __nextNudge = null; // { dateISO, dayOrder, nextRoutineExerciseId }
function setNextNudge(n){ __nextNudge = n; }

function ensureFloatNext(){
  if(document.getElementById("floatNext")) return;
  const host = el("div", { class:"floatNext", id:"floatNext" }, [
    el("button", { class:"btn", id:"floatNextBtn" }, ["Next →"])
  ]);
  document.body.appendChild(host);
}

function maybeShowNextNudge(dateISO, day){
  const host = document.getElementById("floatNext");
  const btn = document.getElementById("floatNextBtn");
  if(!host || !btn) return;

  const shouldShow = __nextNudge &&
    __nextNudge.dateISO === dateISO &&
    __nextNudge.dayOrder === day.order &&
    __nextNudge.nextRoutineExerciseId;

  host.classList.toggle("show", !!shouldShow);

  if(shouldShow){
    btn.onclick = () => {
      const rxId = __nextNudge.nextRoutineExerciseId;
      const node = document.getElementById(`rx_${rxId}`);
      if(node){
        node.scrollIntoView({ behavior:"smooth", block:"center" });
        node.classList.remove("pulse");
        void node.offsetWidth;
        node.classList.add("pulse");
      }
      __nextNudge = null;
      host.classList.remove("show");
    };
  }else{
    btn.onclick = null;
  }
}

function showToast(message){
  try{
    const existing = document.getElementById("toastTemp");
    if(existing) existing.remove();
    const t = el("div", {
      id:"toastTemp",
      style:"position:fixed; top: 14px; left: 50%; transform: translateX(-50%); z-index: 90; padding: 10px 12px; border-radius: 999px; background: rgba(16,20,30,.92); border: 1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.92); font-size: 12.5px; box-shadow: 0 18px 44px rgba(0,0,0,.55);"
    }, [message]);
    document.body.appendChild(t);
    setTimeout(() => { try{ t.remove(); }catch(e){} }, 1100);
  }catch(e){}
}
    /********************
 * 🔥 Crash Failsafe (prevents blank UI)
 ********************/
function __formatErr(err){
  try{
    if(!err) return "Unknown error";
    if(typeof err === "string") return err;
    if(err instanceof Error) return `${err.name}: ${err.message}\n${err.stack || ""}`.trim();
    return JSON.stringify(err, null, 2);
  }catch(e){
    return "Unrenderable error";
  }
}

function __showFatalOverlay(title, detail){
  try{
    // avoid duplicates
    const existing = document.getElementById("fatalOverlay");
    if(existing) existing.remove();

    const overlay = document.createElement("div");
    overlay.id = "fatalOverlay";
    overlay.style.cssText = [
      "position:fixed",
      "inset:0",
      "z-index:9999",
      "background:rgba(11,15,23,.94)",
      "backdrop-filter: blur(12px)",
      "color:rgba(255,255,255,.92)",
      "padding:18px",
      "display:flex",
      "align-items:center",
      "justify-content:center"
    ].join(";");

    const card = document.createElement("div");
    card.style.cssText = [
      "width:min(720px, 92vw)",
      "border:1px solid rgba(255,255,255,.14)",
      "background:rgba(255,255,255,.06)",
      "border-radius:18px",
      "box-shadow:0 22px 70px rgba(0,0,0,.65)",
      "padding:16px"
    ].join(";");

    const h = document.createElement("div");
    h.textContent = title || "App error";
    h.style.cssText = "font-weight:900; font-size:16px; letter-spacing:.2px; margin-bottom:10px;";

    const p = document.createElement("div");
    p.textContent = "The app hit an error and stopped rendering. Copy the details below and send it to yourself.";
    p.style.cssText = "color:rgba(255,255,255,.68); font-size:13px; line-height:1.35; margin-bottom:12px;";

    const pre = document.createElement("pre");
    pre.textContent = detail || "No details available";
    pre.style.cssText = [
      "white-space:pre-wrap",
      "word-break:break-word",
      "margin:0",
      "padding:12px",
      "border-radius:14px",
      "border:1px solid rgba(255,255,255,.12)",
      "background:rgba(0,0,0,.22)",
      "color:rgba(255,255,255,.86)",
      "font-size:12px",
      "line-height:1.35",
      "max-height:52vh",
      "overflow:auto"
    ].join(";");

    const row = document.createElement("div");
    row.style.cssText = "display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;";

    const btnReload = document.createElement("button");
    btnReload.className = "btn primary";
    btnReload.textContent = "Reload app";
    btnReload.onclick = () => location.reload();

    const btnClose = document.createElement("button");
    btnClose.className = "btn";
    btnClose.textContent = "Dismiss";
    btnClose.onclick = () => overlay.remove();

    row.appendChild(btnReload);
    row.appendChild(btnClose);

    card.appendChild(h);
    card.appendChild(p);
    card.appendChild(pre);
    card.appendChild(row);

    overlay.appendChild(card);
    document.body.appendChild(overlay);
  }catch(e){
    // last resort: at least log
    console.error("Fatal overlay failed:", e);
  }
}

function __fatal(err, context){
  const detail = `[${context || "runtime"}]\n` + __formatErr(err);
  console.error("FATAL:", detail);

  // Best-effort: render a fallback inside the app root so users never see a blank UI.
  // This complements the overlay (which can fail in rare DOM/CSS edge cases).
  try{
    const root = document.getElementById("viewRoot");
    if(root){
      root.innerHTML = "";
      root.appendChild(el("div", { class:"card" }, [
        el("h2", { text:"Something went wrong" }),
        el("div", { class:"note", text:"The app hit an unexpected error. Your data is still stored locally." }),
        el("pre", {
          style:"white-space:pre-wrap; font-size:12px; color: rgba(255,255,255,.85); background: rgba(0,0,0,.25); border:1px solid var(--hair); padding:10px; border-radius:12px; overflow:auto; max-height: 40vh;"
        }, [detail]),
        el("div", { class:"btnrow" }, [
          el("button", {
            class:"btn",
            onClick: async () => {
              try{
                if(navigator.clipboard?.writeText){
                  await navigator.clipboard.writeText(detail);
                }else{
                  window.prompt("Copy error details:", detail);
                }
              }catch(_){
                window.prompt("Copy error details:", detail);
              }
            }
          }, ["Copy error"]),
          el("button", {
            class:"btn",
            onClick: () => location.reload()
          }, ["Reload"]),
          el("button", {
            class:"btn danger",
            onClick: () => {
              if(confirm("This will reset local app data on this device. Continue?")){
                try{ Storage.reset(); }catch(_){ localStorage.removeItem("gymdash:v1"); }
                location.reload();
              }
            }
          }, ["Reset local data"])
        ])
      ]));
    }
  }catch(e){
    console.error("Fatal in-app fallback failed:", e);
  }

  // Overlay as a secondary, always-on-top fallback
  __showFatalOverlay("Gym Dashboard crashed", detail);
}

// Catch synchronous runtime errors
window.addEventListener("error", (ev) => {
  __fatal(ev?.error || ev?.message || ev, "window.error");
});

// Catch async errors (Promise rejections)
window.addEventListener("unhandledrejection", (ev) => {
  __fatal(ev?.reason || ev, "unhandledrejection");
});
/********************
 * 4g) Glass Dropdown (Popover) UI
 ********************/
let __pop = null;

// Tracks whether THIS popover session locked scroll (so we only unlock when appropriate)
let __popoverLockedScroll = false;

function PopoverEnsure(){
  if(__pop) return __pop;

  const host = el("div", { class:"popHost", id:"popHost" }, []);
  const backdrop = el("div", { class:"popBackdrop", id:"popBackdrop" }, []);
  const panel = el("div", { class:"popPanel", id:"popPanel" }, []);

  backdrop.addEventListener("click", PopoverClose);

  host.appendChild(backdrop);
  host.appendChild(panel);
  document.body.appendChild(host);

  __pop = { host, panel };
  return __pop;
}

function PopoverOpen(anchorEl, bodyNode){
  const { host, panel } = PopoverEnsure();

  panel.innerHTML = "";
  if(bodyNode) panel.appendChild(bodyNode);

  // Show first so we can compute panel size accurately
  host.classList.add("show");
  host.style.display = "block";

  // ✅ Lock background scroll while popover is open (uses your existing iOS-safe lock)
  // Only lock if nothing else already locked it.
  if(!document.body.classList.contains("modalOpen")){
    lockBodyScroll();
    __popoverLockedScroll = true;
  }else{
    __popoverLockedScroll = false;
  }

  // Position under anchor, keep within viewport
  const r = anchorEl.getBoundingClientRect();
  const pad = 12;

  const pw = panel.offsetWidth || Math.min(420, window.innerWidth - 24);

  // default: left aligned to anchor, clamped to viewport
  let left = r.left;
  left = Math.max(pad, Math.min(left, window.innerWidth - pw - pad));

  let top = r.bottom + 10;
  const ph = panel.offsetHeight || 320;

  // if it would go below, flip above anchor
  if(top + ph > window.innerHeight - pad){
    top = Math.max(pad, r.top - ph - 10);
  }

  panel.style.left = `${Math.round(left)}px`;
  panel.style.top  = `${Math.round(top)}px`;
}

function PopoverClose(){
  const p = PopoverEnsure();
  p.host.classList.remove("show");
  p.host.style.display = "none";   // ✅ actually hide it
  p.panel.innerHTML = "";          // ✅ clear list so it doesn't linger

  // ✅ Restore background scroll ONLY if this popover was the thing that locked it
  if(__popoverLockedScroll){
    __popoverLockedScroll = false;

    // If a modal is open for any reason, don't unlock yet
    const modalHost = document.getElementById("modalHost");
    const modalIsOpen = !!(modalHost && modalHost.classList.contains("show"));

    if(!modalIsOpen){
      unlockBodyScroll();
    }
  }
}

    /********************
     * 5) Modal
     ********************/
      let __modalScrollY = 0;

function lockBodyScroll(){
  __modalScrollY = window.scrollY || 0;

  // iOS-safe lock: freeze body position
  document.body.classList.add("modalOpen");
  document.body.style.position = "fixed";
  document.body.style.top = `-${__modalScrollY}px`;
  document.body.style.left = "0";
  document.body.style.right = "0";
  document.body.style.width = "100%";
}

function unlockBodyScroll(){
  document.body.classList.remove("modalOpen");

  // restore body scrolling
  document.body.style.position = "";
  document.body.style.top = "";
  document.body.style.left = "";
  document.body.style.right = "";
  document.body.style.width = "";

  window.scrollTo(0, __modalScrollY);
}

const Modal = {
  open({ title, bodyNode, center = true, size = "md" }){
    const host = $("#modalHost");
    const body = $("#modalBody");
    const sheet = host.querySelector(".sheet");

    $("#modalTitle").textContent = title || "Modal";

    // Position mode
    host.classList.toggle("center", !!center);

    // Size mode
    if(sheet){
      sheet.classList.remove("sm", "md", "lg");
      sheet.classList.add(size);
    }

    body.innerHTML = "";
    if(bodyNode) body.appendChild(bodyNode);

    host.classList.add("show");
    host.setAttribute("aria-hidden", "false");

    lockBodyScroll();
  },

  close(){
    const host = $("#modalHost");
    const sheet = host.querySelector(".sheet");

    host.classList.remove("show");
    host.classList.remove("center");
    host.setAttribute("aria-hidden", "true");

    $("#modalBody").innerHTML = "";

    // Reset size classes
    if(sheet){
      sheet.classList.remove("sm", "md", "lg");
    }

    unlockBodyScroll();
  }
};
    (function bindModalControls(){
  const closeBtn = $("#modalClose");
  const backdrop = $("#modalBackdrop");

  if(closeBtn){
    closeBtn.addEventListener("click", (e) => {
      e.preventDefault();
      Modal.close();
    });
  }

  if(backdrop){
    backdrop.addEventListener("click", (e) => {
      e.preventDefault();
      Modal.close();
    });
  }

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      const host = $("#modalHost");
      if(host && host.classList.contains("show")){
        Modal.close();
      }
    }
  });
})();

    /********************
     * 6) Router + Views
     ********************/
const Routes = {
  // Bottom nav (mobile-first)
  home: { label: "Home", nav:true },
  routine: { label: "Routine", nav:true },
  progress: { label: "Progress", nav:true },
  settings: { label: "Settings", nav:true },

  // Non-nav routes (opened via buttons/links)
  weight: { label: "Weight", nav:false },
  attendance: { label: "Attendance", nav:false },
  routine_editor: { label: "Routine Editor", nav:false },
  exercise_library: { label: "Exercise Library", nav:false }
};


const NAV_KEYS = Object.entries(Routes)
  .filter(([,v]) => v.nav)
  .map(([k]) => k);

function renderNav(){
  const nav = $("#navbar");
  nav.innerHTML = "";

  const disabled = !state.profile;

  NAV_KEYS.forEach((key) => {
    const r = Routes[key];
    nav.appendChild(el("button", {
      class: "navbtn" + (key === currentRoute ? " active" : ""),
      onClick: () => {
        if(disabled){ navigate("home"); return; }
        navigate(key);
      }
    }, [
      el("div", { class:"dot" }),
      el("div", { text: r.label })
    ]));
  });
}


    let currentRoute = "home";

function setChip(){
  const chip = $("#chipStatus");
  if(!chip) return;

  if(state.profile?.name) chip.textContent = `Hi, ${state.profile.name}`;
  else chip.textContent = "Not set up";
}
// ─────────────────────────────
// Version + Sync Pills (Service Worker powered updates)
// Goals:
// - vX pill comes ONLY from version.json
// - Release notes ("What's New") are read from version.json
// - "Update Available" is TRUE when a new Service Worker is waiting (real, ready-to-apply update)
// - "Downloading…" shows while the Service Worker is installing
// - Reload to update activates the waiting SW and reloads WITHOUT clearing user profile/localStorage
// ─────────────────────────────
let __latestVersion  = (localStorage.getItem(VERSION_LATEST_KEY)  || "").trim() || null;
let __appliedVersion = (localStorage.getItem(VERSION_APPLIED_KEY) || "").trim() || null;

let __latestNotes = (() => {
  try { return JSON.parse(localStorage.getItem(VERSION_NOTES_KEY) || "[]"); }
  catch(e){ return []; }
})();
let __latestBuildDate = (localStorage.getItem(VERSION_BUILD_KEY) || "").trim() || null;

let __swReg = null;
let __swUpdateReady = false;
let __swInstalling = false;

function __hasSwUpdateWaiting(){
  return !!(__swReg && __swReg.waiting) || __swUpdateReady;
}

function setHeaderPills(){
  const syncPill = $("#syncPill");
  const verPill  = $("#verPill");
  if(!syncPill || !verPill) return;

  // Version pill comes ONLY from version.json (fallback to applied/offline)
  const shown = __latestVersion || __appliedVersion || "—";
  verPill.textContent = `v${shown}`;

  // Connectivity
  if(!navigator.onLine){
    syncPill.textContent = "Offline";
    syncPill.classList.remove("ok","warn");
    syncPill.classList.add("off");
    return;
  }

  // Downloading/Installing state (SW is fetching the new build)
  if(__swInstalling){
    syncPill.textContent = "Downloading…";
    syncPill.classList.remove("ok","off");
    syncPill.classList.add("warn");
    return;
  }

  // Update ready-to-apply state
  if(__hasSwUpdateWaiting()){
    syncPill.textContent = "Update Available";
    syncPill.classList.remove("ok","off");
    syncPill.classList.add("warn");
  }else{
    syncPill.textContent = "Synced";
    syncPill.classList.remove("warn","off");
    syncPill.classList.add("ok");
  }
}

async function checkForUpdates(){
  // Fetch version.json (single source of truth for version + notes)
  if(!navigator.onLine){
    setHeaderPills();
    return { ok:false, reason:"offline" };
  }
  try{
    const url = `${REMOTE_VERSION_URL}?t=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const latest = String(data?.version || "").trim() || null;
    const notesRaw = Array.isArray(data?.notes) ? data.notes : [];
    const notes = notesRaw
      .map(x => String(x || "").trim())
      .filter(Boolean)
      .slice(0, 12); // keep it tight in UI

    const buildDate = String(data?.buildDate || data?.build || data?.date || "").trim() || null;

    if(latest){
      __latestVersion = latest;
      localStorage.setItem(VERSION_LATEST_KEY, latest);

      // First run: initialize applied version so modal has a baseline
      if(!__appliedVersion){
        __appliedVersion = latest;
        localStorage.setItem(VERSION_APPLIED_KEY, latest);
      }
    }

    __latestNotes = notes;
    localStorage.setItem(VERSION_NOTES_KEY, JSON.stringify(notes));

    __latestBuildDate = buildDate;
    if(buildDate) localStorage.setItem(VERSION_BUILD_KEY, buildDate);

    setHeaderPills();
    return {
      ok:true,
      latestVersion: __latestVersion,
      appliedVersion: __appliedVersion,
      notes: __latestNotes,
      buildDate: __latestBuildDate,
      swUpdateWaiting: __hasSwUpdateWaiting(),
      swInstalling: __swInstalling
    };
  }catch(e){
    setHeaderPills();
    return { ok:false, reason:"fetch_failed" };
  }
}

async function registerServiceWorker(){
  if(!("serviceWorker" in navigator)) return;

  try{
    __swReg = await navigator.serviceWorker.register("./sw.js");

    // If an update is already waiting
    if(__swReg.waiting){
      __swUpdateReady = true;
      __swInstalling = false;
      setHeaderPills();
    }

    __swReg.addEventListener("updatefound", () => {
      const installing = __swReg.installing;
      if(!installing) return;

      __swInstalling = true;
      setHeaderPills();

      installing.addEventListener("statechange", () => {
        // installed + existing controller => update is ready and waiting
        if(installing.state === "installed" && navigator.serviceWorker.controller){
          __swInstalling = false;
          __swUpdateReady = true;
          setHeaderPills();
        }

        // If it becomes redundant/failed, stop showing "Downloading…"
        if(installing.state === "redundant"){
          __swInstalling = false;
          setHeaderPills();
        }
      });
    });

    // When new SW takes control, mark applied version (metadata only) and reload once
    let reloaded = false;
    navigator.serviceWorker.addEventListener("controllerchange", () => {
      if(reloaded) return;
      reloaded = true;

      if(__latestVersion){
        __appliedVersion = __latestVersion;
        localStorage.setItem(VERSION_APPLIED_KEY, __latestVersion);
      }

      // Reload under the new build; does NOT clear user profile/localStorage
      location.reload();
    });

  }catch(e){
    console.warn("Service worker registration failed:", e);
  }
}

function applyUpdateNow(){
  // If an update is waiting, activate it (skip waiting). Otherwise, just reload.
  if(__swReg && __swReg.waiting){
    __swReg.waiting.postMessage({ type:"SKIP_WAITING" });
    return;
  }
  location.reload();
}

function openVersionModal(){
  const status = !navigator.onLine
    ? "You’re offline. Updates can’t be checked right now."
    : (__swInstalling
        ? "Downloading the update in the background…"
        : (__hasSwUpdateWaiting()
            ? "A newer version is ready. Reload to apply the update."
            : "You’re up to date."));

  const notesNode = (__latestNotes && __latestNotes.length)
    ? el("div", {}, [
        el("div", { class:"note", text:"What’s new" }),
        el("div", { style:"height:8px" }),
        el("ul", {
          style:"margin:0; padding-left:18px; color: rgba(255,255,255,.78); font-size: 13px; line-height: 1.35;"
        }, __latestNotes.map(n => el("li", { text: n }))),
        el("div", { style:"height:10px" })
      ])
    : el("div", { style:"height:0" });

  Modal.open({
    title: "About",
    bodyNode: el("div", { class:"grid" }, [
      el("div", { class:"note", text:`Version (version.json): ${__latestVersion ? "v"+__latestVersion : "—"}` }),
      el("div", { class:"note", text:`Applied on device: ${__appliedVersion ? "v"+__appliedVersion : "—"}` }),
      (__latestBuildDate ? el("div", { class:"note", text:`Build: ${__latestBuildDate}` }) : el("div", { style:"display:none" })),
      el("div", { style:"height:10px" }),
      el("div", { class:"note", text: status }),
      el("div", { style:"height:12px" }),
      notesNode,
      el("div", { class:"btnrow" }, [
        el("button", {
          class:"btn",
          onClick: async () => {
            const r = await checkForUpdates();
            showToast(r.ok ? "Checked version.json" : "Couldn’t check updates");
          }
        }, ["Check for updates"]),
        el("button", {
          class:"btn primary",
          onClick: () => applyUpdateNow()
        }, [__hasSwUpdateWaiting() ? "Reload to update" : "Reload"])
      ])
    ])
  });
}

let __headerPillsBound = false;
function bindHeaderPills(){
  if(__headerPillsBound) return;
  __headerPillsBound = true;

  const syncPill = $("#syncPill");
  const verPill  = $("#verPill");

  if(syncPill){
    syncPill.addEventListener("click", async () => {
      await checkForUpdates();
      openVersionModal();
    });
  }

  if(verPill){
    verPill.addEventListener("click", () => openVersionModal());
  }

  window.addEventListener("online",  () => { setHeaderPills(); checkForUpdates(); });
  window.addEventListener("offline", () => { setHeaderPills(); });
}



    function navigate(routeKey){
      destroyProgressChart();
      destroyWeightChart();
      currentRoute = routeKey;
      renderNav();
      renderView();
      bindHeaderPills();
      checkForUpdates();

    }


    function renderView(){
setChip();
setHeaderPills();
      const root = $("#viewRoot");
      root.innerHTML = "";

      if(!state.profile){
        root.appendChild(Views.Onboarding());
        return;
      }

         if(currentRoute === "home") root.appendChild(Views.Home());
else if(currentRoute === "routine") root.appendChild(Views.Routine());
else if(currentRoute === "progress") root.appendChild(Views.Progress());
else if(currentRoute === "settings") root.appendChild(Views.Settings());
else if(currentRoute === "weight") root.appendChild(Views.Weight());
else if(currentRoute === "attendance") root.appendChild(Views.Attendance());
else if(currentRoute === "routine_editor") root.appendChild(Views.RoutineEditor());
else if(currentRoute === "exercise_library") root.appendChild(Views.ExerciseLibraryManager());
else root.appendChild(el("div", { class:"card" }, [
  el("h2", { text:"Not found" }),
  el("div", { class:"note", text:`Unknown route: ${currentRoute}` })
]));
    }

    /********************
     * 7) Views
     ********************/
    throw new Error("test");
    const Views = {
      Onboarding(){
        let hideRestDays = true;
        let selectedTpl = "ppl";

        const errorBox = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

        const switchNode = el("div", { class:"switch on" });
        switchNode.addEventListener("click", () => {
          hideRestDays = !hideRestDays;
          switchNode.classList.toggle("on", hideRestDays);
        });

        const tplCardsHost = el("div", { class:"tplGrid" });
        const renderTplCards = () => {
          tplCardsHost.innerHTML = "";
          RoutineTemplates.forEach(t => {
            tplCardsHost.appendChild(el("div", {
              class: "tpl" + (t.key === selectedTpl ? " selected" : ""),
              onClick: () => { selectedTpl = t.key; renderTplCards(); }
            }, [
              el("div", { class:"name", text: t.name }),
              el("div", { class:"desc", text: t.desc })
            ]));
          });
        };
        renderTplCards();

        const nameInput = el("input", { type:"text", placeholder:"Jordan" });
        const proteinInput = el("input", { type:"number", inputmode:"numeric", placeholder:"180", min:"0" });

        const weekSelect = el("select", {});
        weekSelect.appendChild(el("option", { value:"mon", text:"Monday" }));
        weekSelect.appendChild(el("option", { value:"sun", text:"Sunday" }));
        weekSelect.value = "mon";

        const finish = () => {
          errorBox.style.display = "none";
          errorBox.textContent = "";

          const cleanName = (nameInput.value || "").trim();
          const cleanProtein = Number(proteinInput.value);
          const weekStartsOn = weekSelect.value === "sun" ? "sun" : "mon";

          if(!cleanName){
            errorBox.textContent = "Please enter your name.";
            errorBox.style.display = "block";
            return;
          }
          if(!Number.isFinite(cleanProtein) || cleanProtein <= 0){
            errorBox.textContent = "Please enter a valid daily protein goal (grams).";
            errorBox.style.display = "block";
            return;
          }

          const profile = {
            name: cleanName,
            proteinGoal: Math.round(cleanProtein),
            weekStartsOn,
            hideRestDays: !!hideRestDays
          };

          const routineName = RoutineTemplates.find(t => t.key === selectedTpl)?.name || "Routine";
          const routine = createRoutineFromTemplate(selectedTpl, routineName);

          state.profile = profile;
          state.routines = [routine];
          state.activeRoutineId = routine.id;

          // Seed library if empty
          ExerciseLibrary.ensureSeeded();

          Storage.save(state);
          navigate("home");
          bindHeaderPills();
          setHeaderPills();
          checkForUpdates();

        };

        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Welcome" }),
            el("div", { class:"kpi" }, [
              el("div", { class:"big", text:"Let’s set up your dashboard" }),
              el("div", { class:"small", text:"Create your profile and choose a routine template. You can edit everything later." })
            ])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Create profile" }),
            el("div", { class:"form" }, [
              el("div", { class:"row2" }, [
                el("label", {}, [ el("span", { text:"Name" }), nameInput ]),
                el("label", {}, [ el("span", { text:"Protein goal (grams/day)" }), proteinInput ])
              ]),
              el("div", { class:"row2" }, [
                el("label", {}, [ el("span", { text:"Week starts on" }), weekSelect ]),
                el("div", { class:"toggle" }, [
                  el("div", { class:"ttext" }, [
                    el("div", { class:"a", text:"Hide rest days" }),
                    el("div", { class:"b", text:"Rest days won’t appear on Home (Routine can still show them later)" })
                  ]),
                  switchNode
                ])
              ]),
              errorBox
            ])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Choose a routine template" }),
            tplCardsHost,
            el("div", { style:"height:10px" }),
            el("div", { class:"btnrow" }, [
              el("button", { class:"btn primary", onClick: finish }, ["Finish setup"]),
              el("button", {
                class:"btn danger",
                onClick: () => {
                  Modal.open({
                    title: "Reset local data",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text:"This clears everything saved in this browser for the app." }),
                      el("div", { style:"height:12px" }),
                      el("div", { class:"btnrow" }, [
                        el("button", {
                          class:"btn danger",
                          onClick: () => {
                            Storage.reset();
                            state = Storage.load();
                            Modal.close();
                            navigate("home");
                          }
                        }, ["Reset"]),
                        el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                      ])
                    ])
                  });
                }
              }, ["Reset"])
            ])
          ])
        ]);
      },

        Home(){
        ExerciseLibrary.ensureSeeded();
        WeightEngine.ensure();


        const todayISO = Dates.todayISO();
        const weekStartsOn = state.profile?.weekStartsOn || "mon";
        const weekStartISO = Dates.startOfWeekISO(todayISO, weekStartsOn);

        const { routine, day } = getTodayWorkout();

        const trainedThisWeek = [];
        for(let i=0;i<7;i++){
          const dISO = Dates.addDaysISO(weekStartISO, i);
          trainedThisWeek.push({ dateISO: dISO, trained: isTrained(dISO) });
        }

        // Protein
        const goal = Number(state.profile?.proteinGoal) || 0;
        const done = totalProtein(todayISO);
        const left = Math.max(0, goal - done);
        const pct = goal > 0 ? Math.max(0, Math.min(1, done / goal)) : 0;
        const deg = Math.round(pct * 360);

        const openProteinModal = () => {
          Modal.open({
            title: "Today’s protein",
            bodyNode: buildProteinTodayModal(todayISO, goal)
          });
        };

        const openCheckIn = () => {
          toggleTrained(todayISO);
          renderView();
        };

        const workoutTitle = !routine ? "No routine selected"
          : (!day ? "No day found"
          : (day.isRest ? "Rest Day" : day.label));

        const workoutSub = !routine ? "Go to Routine → create/select a routine."
          : (!day ? "Open Routine Editor to fix day mapping."
          : (day.isRest ? "Recovery day. Hydrate + mobility."
          : `${(day.exercises || []).length} exercises planned`));

        const workoutExercises = (day?.isRest || !day) ? []
          : (day.exercises || []).map(rx => resolveExerciseName(rx.type, rx.exerciseId, rx.nameSnap));

        const ring = el("div", {
          class:"ringWrap",
          style: `background: conic-gradient(rgba(124,92,255,.95) 0deg ${deg}deg, rgba(255,255,255,.10) ${deg}deg 360deg);`
        }, [
          el("div", { class:"ringText" }, [
            el("div", { class:"big", text: `${left}g` }),
            el("div", { class:"small", text: "left" }),
            el("div", { class:"small", text: `${done} / ${goal}g` })
          ])
        ]);

        const dots = el("div", { class:"dots" });
        trainedThisWeek.forEach((d, idx) => {
          const dot = el("div", { class:"dotDay" + (d.trained ? " on" : "") });
          dots.appendChild(dot);
        });

        const weekLabel = weekStartsOn === "sun" ? "Week (Sun–Sat)" : "Week (Mon–Sun)";

        const wLatest = WeightEngine.latest();
        const wPrev = WeightEngine.previous();
        const wDelta = (wLatest && wPrev)
          ? (Number(wLatest.weight) - Number(wPrev.weight))
          : null;

        const wDeltaText = (wDelta === null || !Number.isFinite(wDelta))
          ? "—"
          : `${wDelta > 0 ? "+" : ""}${wDelta.toFixed(1)}`;

        return el("div", { class:"grid cols2" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Today’s workout" }),

// ✅ KPI + action (Edit routine) on the same row
el("div", { class:"homeRow" }, [
  el("div", { class:"kpi" }, [
    el("div", { class:"big", text: workoutTitle }),
    el("div", { class:"small", text: workoutSub })
  ]),
  el("button", {
    class:"btn",
    onClick: () => navigate("routine")
  }, ["Edit routine"])
]),


el("div", { style:"height:10px" }),

/* Planned exercises (unchanged) */
(workoutExercises.length === 0)
  ? el("div", {
      class:"note",
      text: day?.isRest ? "Rest day is enabled." : "Add exercises in Routine Editor."
    })
  : el("div", { class:"list" }, workoutExercises.slice(0,6).map(n =>
      el("div", { class:"item" }, [
        el("div", { class:"left" }, [ el("div", { class:"name", text: n }) ]),
        el("div", { class:"actions" }, [ el("div", { class:"meta", text:"Planned" }) ])
      ])
    ))
]),

// ✅ Removed from Today's Workout card:
// el("div", { style:"height:10px" }),
// el("div", { class:"btnrow" }, [
//   el("button", { class:"btn primary", onClick: openCheckIn }, [isTrained(todayISO) ? "Undo check-in" : "Check in"]),
//   el("button", { class:"btn", onClick: () => navigate("routine") }, ["Edit routine"])
// ])

el("div", { class:"card" }, [
  el("h2", { text:"Protein" }),
  el("div", { class:"homeRow" }, [
    el("div", { class:"kpi" }, [
      el("div", { class:"big", text: `${left}g left` }),
      el("div", { class:"small", text:"Tap to log meals for today." })
    ]),
    el("div", { onClick: openProteinModal }, [ ring ])
  ]),
  el("div", { style:"height:10px" }),
  el("div", { class:"btnrow" }, [
    el("button", { class:"btn primary", onClick: openProteinModal }, ["Log meals"])
  ])
]),

el("div", { class:"card" }, [
  // Header row + action buttons
  el("div", { class:"homeRow" }, [
    el("div", {}, [
      el("h2", { text:"Attendance" }),
      el("div", { class:"note", text: weekLabel })
    ]),

    // ✅ Stack actions: Check in ABOVE View calendar
    el("div", {
      style:"display:flex; flex-direction:column; gap:8px; align-items:flex-end;"
    }, [
      el("button", {
        class:"btn primary",
        onClick: openCheckIn
      }, [isTrained(todayISO) ? "Undo check-in" : "Check in"]),

      el("button", {
        class:"btn",
        onClick: () => navigate("attendance")
      }, ["View calendar"])
    ])
  ]),


  el("div", { style:"height:10px" }),

  // Make the dots preview clickable too
  el("div", {
    onClick: () => navigate("attendance"),
    style:"cursor:pointer;"
  }, [ dots ]),

  el("div", { style:"height:10px" }),
  el("div", { class:"note", text:`This week: ${trainedThisWeek.filter(x => x.trained).length} sessions` })
]),

// ✅ NEW: Weight card (Weight tab replacement)
          el("div", { class:"card" }, [
            el("h2", { text:"Weight" }),
            el("div", { class:"kpi" }, [
              el("div", { class:"big", text: wLatest ? `${Number(wLatest.weight).toFixed(1)}` : "—" }),
              el("div", { class:"small", text: wLatest ? `Latest • ${wLatest.dateISO}` : "No weight entries yet." }),
              el("div", { class:"small", text: `Delta vs previous: ${wDeltaText}` })
            ]),
            el("div", { style:"height:10px" }),
            el("div", { class:"btnrow" }, [
              el("button", { class:"btn primary", onClick: () => navigate("weight") }, ["Log weight"])
            ])
          ])
        ]);
        function buildProteinTodayModal(dateISO, goal){
          const container = el("div", { class:"grid" });

          const listHost = el("div", { class:"list" });
          const footer = el("div", { class:"note" });

          function repaint(){
            listHost.innerHTML = "";

            const p = getProteinForDate(dateISO);
            const meals = p.meals || [];

            if(meals.length === 0){
              listHost.appendChild(el("div", { class:"note", text:"No meals logged yet. Add one below." }));
            }else{
              meals.forEach(m => {
                listHost.appendChild(el("div", { class:"item" }, [
                  el("div", { class:"left" }, [
                    el("div", { class:"name", text: m.label }),
                    el("div", { class:"meta", text: `${m.grams}g` })
                  ]),
                  el("div", { class:"actions" }, [
                    el("button", { class:"mini", onClick: () => openMealEditor(m) }, ["Edit"]),
                    el("button", { class:"mini danger", onClick: () => { deleteMeal(dateISO, m.id); repaint(); renderView(); } }, ["Delete"])
                  ])
                ]));
              });
            }

            const done = totalProtein(dateISO);
            const left = Math.max(0, goal - done);
            footer.textContent = `Today: ${done}g • Left: ${left}g • Goal: ${goal}g`;
          }

          function openMealEditor(meal){
            const labelInput = el("input", { type:"text", placeholder:"Meal name", value: meal?.label || "" });
            const gramsInput = el("input", { type:"number", inputmode:"numeric", placeholder:"Protein grams", min:"0", value: meal?.grams ?? "" });
            const err = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

      Modal.open({
  title: meal ? "Edit meal" : "Add meal",
  size: "sm",
  center: true,
  bodyNode: el("div", {}, [
    el("label", {}, [ el("span", { text:"Label" }), labelInput ]),
    el("label", {}, [ el("span", { text:"Protein (grams)" }), gramsInput ]),
    err,
    el("div", { style:"height:12px" }),
    el("div", { class:"btnrow" }, [
      el("button", {
        class:"btn primary",
        onClick: () => {
          err.style.display = "none";
          const label = (labelInput.value || "").trim();
          const grams = Number(gramsInput.value);
          if(!label){ err.textContent="Label required."; err.style.display="block"; return; }
          if(!Number.isFinite(grams) || grams < 0){ err.textContent="Enter valid grams."; err.style.display="block"; return; }
          upsertMeal(dateISO, meal?.id || null, label, grams);
          Modal.close();
          repaint();
          renderView(); // update ring live
        }
      }, ["Save"]),
      el("button", { class:"btn", onClick: () => { Modal.close(); } }, ["Cancel"])
    ])
  ])
});

          }

          const addBtn = el("button", { class:"btn primary", onClick: () => openMealEditor(null) }, ["Add meal"]);

          container.appendChild(el("div", { class:"note", text:`Date: ${dateISO}` }));
          container.appendChild(listHost);
          container.appendChild(el("div", { class:"btnrow" }, [ addBtn ]));
          container.appendChild(footer);

          repaint();
          return container;
        }
      },

Routine(){
const root = el("div", { class:"routinePage" });

  let routine = Routines.getActive();
  if(!routine){
    root.appendChild(el("div", { class:"card" }, [
      el("h2", { text:"Routine" }),
      el("div", { class:"note", text:"No active routine found. Create one in Settings." })
    ]));
    return root;
  }

  const today = new Date();
  const todayIndex = today.getDay();               // 0=Sun..6=Sat
  const todayISO = Dates.todayISO(); // local date (fixes Feb 14 UTC bug)

  let selectedIndex = todayIndex;

    const weekStartsOn = state.profile?.weekStartsOn || "mon";
  const weekStartISO = Dates.startOfWeekISO(todayISO, weekStartsOn);

  // Map selected weekday index (0=Sun..6=Sat) to an actual calendar date in the current week
  function getSelectedDateISO(index){
    const offset = (weekStartsOn === "sun")
      ? index
      : ((index - 1 + 7) % 7); // Mon=0 ... Sun=6
    return Dates.addDaysISO(weekStartISO, offset);
  }
  // Label date as Today / Tomorrow / "Feb 15"
  function prettyDayTag(dateISO){
    if(dateISO === todayISO) return "Today";
    if(dateISO === Dates.addDaysISO(todayISO, 1)) return "Tomorrow";

    const d = new Date(dateISO + "T00:00:00");
    return d.toLocaleDateString("en-US", { month:"short", day:"numeric" }); // e.g., "Feb 15"
  }

  function getDay(index){
    routine = Routines.getActive(); // ✅ always refresh active routine
    return (routine?.days || []).find(d => d.order === index) || null;
  }
function openRoutinePicker(anchorBtn){
  let all = Routines.getAll() || [];
  const activeId = Routines.getActive()?.id || null;

  // Find an existing routine that was created from a template (preferred),
  // otherwise fall back to name match (for older saved data).
  function findRoutineForTemplate(tpl){
    const byKey = all.find(r => String(r.templateKey || "") === String(tpl.key || ""));
    if(byKey) return byKey;

    const byName = all.find(r => normName(r.name) === normName(tpl.name));
    return byName || null;
  }

// ────────────────────────────
// Visual-only layout upgrade
// Active pinned, rest scrollable
// ────────────────────────────

// Outer shell (column layout)
const shell = el("div", {
  style: "display:flex; flex-direction:column; max-height:70vh;"
});

// Title (fixed)
shell.appendChild(
  el("div", { class:"popTitle", text:"Select routine" })
);

// Identify active routine (visual only)
const activeRoutine = all.find(r => r.id === activeId);

// Fixed Active Section
if(activeRoutine){
  shell.appendChild(
    el("div", { style:"margin-top:8px;" }, [
      el("div", { class:"popItem" }, [
        el("div", { class:"l" }, [
          el("div", { class:"n", text: activeRoutine.name }),
          el("div", { class:"m", text:"Currently active" })
        ]),
        el("div", { class:"popBadge", text:"Active" })
      ])
    ])
  );

  shell.appendChild(el("div", {
    style:"height:1px; background:rgba(255,255,255,.08); margin:12px 0;"
  }));
}

// Scrollable area (existing + templates)
const scrollHost = el("div", {
  style:"overflow:auto; padding-right:4px; display:grid; gap:10px;"
});

// ────────────────────────────
// Existing routines (UNCHANGED LOGIC)
// ────────────────────────────

if(all.length === 0){
  scrollHost.appendChild(
    el("div", { class:"note", text:"No routines yet. Choose a template below to create one." })
  );
}else{
  all.forEach(r => {
    const isActive = (r.id === activeId);

    scrollHost.appendChild(
      el("div", {
        class:"popItem",
        onClick: () => {
          Routines.setActive(r.id);
          routine = Routines.getActive();
          selectedIndex = todayIndex;
          PopoverClose();
          repaint();
        }
      }, [
        el("div", { class:"l" }, [
          el("div", { class:"n", text:r.name }),
          el("div", { class:"m", text: isActive ? "Currently active" : "Tap to activate" })
        ]),
        isActive
          ? el("div", { class:"popBadge", text:"Active" })
          : el("div", { class:"m", text:"" })
      ])
    );
  });
}

// Spacer before templates
scrollHost.appendChild(el("div", { style:"height:12px" }));

// Templates title
scrollHost.appendChild(
  el("div", { class:"popTitle", text:"Default templates" })
);

// ────────────────────────────
// Default templates (UNCHANGED LOGIC)
// ────────────────────────────

(RoutineTemplates || []).forEach(tpl => {

  const existingAtRender = findRoutineForTemplate(tpl);
  const labelRight = existingAtRender ? "Activate" : "Add";

  scrollHost.appendChild(
    el("div", {
      class:"popItem",
      onClick: () => {

        all = Routines.getAll() || [];
        const existingNow = findRoutineForTemplate(tpl);

        if(existingNow){
          Routines.setActive(existingNow.id);
          routine = Routines.getActive();
          selectedIndex = todayIndex;

          PopoverClose();
          repaint();
          showToast(`Active: ${existingNow.name}`);
          return;
        }

        Routines.addFromTemplate(tpl.key, tpl.name);

        routine = Routines.getActive();
        selectedIndex = todayIndex;

        PopoverClose();
        repaint();
        showToast(`Created: ${tpl.name}`);
      }
    }, [
      el("div", { class:"l" }, [
        el("div", { class:"n", text: tpl.name }),
        el("div", { class:"m", text: tpl.desc || "Template" })
      ]),
      el("div", { class:"m", text: labelRight })
    ])
  );
});

// Attach scroll area
shell.appendChild(scrollHost);

// Open popover (same behavior)
PopoverOpen(anchorBtn, shell);
}

  // Phase 3: Per-exercise Workout Execution (logger)
function openExerciseLogger(rx, day, defaultDateISO){
  ExerciseLibrary.ensureSeeded();
  LogEngine.ensure();

  const type = rx.type;
  const exerciseId = rx.exerciseId;
  const exName = resolveExerciseName(type, exerciseId, rx.nameSnap);

  const initialDateISO = String(defaultDateISO || Dates.todayISO());

  // Manual override date (defaults to the day you're viewing in the carousel)
  const dateInput = el("input", { type:"date", value: initialDateISO });

  // Existing log for this routine-exercise on the selected date (so inputs persist)
  const existingEntry = (state.logs?.workouts || []).find(e =>
    e.dateISO === initialDateISO && e.routineExerciseId === rx.id
  ) || null;

const headerText = el("div", { class:"note" }, [
  `${exName} • ${ExerciseLibrary.typeLabel(type)} • `,
  dateInput
]);

const hint = el("div", { class:"note", text:"Tip: Change the date above to log for a different day (manual override)." });

// Show plan snapshot (optional)
const plan = rx.plan || null;
const planLine = el("div", { class:"note" }, [
  plan
    ? `Plan: ${String(plan.sets ?? "—")} × ${String(plan.reps ?? "—")}${plan.restSec ? ` • Rest ${plan.restSec}s` : ""}`
    : "Plan: —"
]);

// Show last entry snapshot (optional)
const last = LogEngine.entriesForExercise(type, exerciseId)[0] || null;
const lastLine = el("div", { class:"note" }, [
  last ? `Last: ${formatEntryOneLine(type, last)}` : "Last: —"
]);

const err = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

/* NEW layout shell:
   - header stays fixed (sticky)
   - form area scrolls
*/
const head = el("div", { class:"logsetHead" }, [ headerText, hint, planLine, lastLine, err ]);
const scroll = el("div", { class:"logsetScroll" }, []);
const body = el("div", { class:"logsetShell" }, [ head, scroll ]);



if(type === "weightlifting"){
  scroll.appendChild(buildWeightliftingForm());
}else if(type === "cardio"){
  scroll.appendChild(buildCardioForm());
}else{
  scroll.appendChild(buildCoreForm());
}


  Modal.open({
    title: "Log Sets",
    center: true,
    bodyNode: body
  });

  function showErr(msg){
    err.textContent = msg;
    err.style.display = "block";
  }

  function clearErr(){
    err.style.display = "none";
    err.textContent = "";
  }

  function afterSave(savedDateISO){
    Modal.close();

    // If the whole day is now logged, auto-complete + attendance
    if(isDayComplete(savedDateISO, day)){
      attendanceAdd(savedDateISO);
      showToast("Day completed ✅");
    }

    // Set Next → nudge for next unlogged (same day)
    const list = (day.exercises || []);
    const curIdx = list.findIndex(x => x.id === rx.id);

    // next unlogged AFTER current
    let next = null;
    for(let i = curIdx + 1; i < list.length; i++){
      if(!hasRoutineExerciseLog(savedDateISO, list[i].id)){ next = list[i]; break; }
    }
    // if none after, fallback to first unlogged anywhere
    if(!next){
      next = list.find(x => !hasRoutineExerciseLog(savedDateISO, x.id)) || null;
    }

    setNextNudge(next ? {
      dateISO: savedDateISO,
      dayOrder: day.order,
      nextRoutineExerciseId: next.id
    } : null);

    repaint();
  }

function buildWeightliftingForm(){
  const rowsHost = el("div", { class:"logsetWLCard" }, []);
  const setInputs = [];

  const head = el("div", { class:"logsetGridHead" }, [
    el("div", { text:"Set" }),
    el("div", { text:"Weight" }),
    el("div", { text:"Reps" })
  ]);

  const rows = el("div", {}, []);

  function clearActive(){
    rows.querySelectorAll(".logsetRow.active").forEach(n => n.classList.remove("active"));
  }
  function setActiveRow(rowEl){
    clearActive();
    rowEl.classList.add("active");
  }
  function refreshSetNumbers(){
    const pills = rows.querySelectorAll(".logsetSetPill");
    pills.forEach((p, i) => p.textContent = String(i + 1));
  }

  const addRow = (w="", r="") => {
    const wInput = el("input", { type:"number", inputmode:"decimal", placeholder:"", value: w });
    const rInput = el("input", { type:"number", inputmode:"numeric", placeholder:"", value: r });

    setInputs.push({ wInput, rInput });

    const setPill = el("div", { class:"logsetSetPill", text: String(setInputs.length) });

    const row = el("div", { class:"logsetRow" }, [
      setPill,
      wInput,
      rInput
    ]);

    // Active row highlight when editing (focus/click)
    row.addEventListener("click", () => setActiveRow(row));
    row.addEventListener("focusin", () => setActiveRow(row));

    rows.appendChild(row);
    refreshSetNumbers();
  };

  // ✅ KEEP EXISTING FUNCTIONALITY:
  // planned sets still drive the defaults exactly like before
  const existingSets = (existingEntry?.sets || []);
  const plannedSets = Math.max(1, Math.min(12, Math.floor(Number(rx.plan?.sets) || 0))) || 0;
  const baseRows = plannedSets || 4;
  const rowsToShow = Math.max(baseRows, existingSets.length || 0);

  for(let i=0; i<rowsToShow; i++){
    const s = existingSets[i] || {};
    addRow(
      (s.weight ?? "") === 0 ? "" : String(s.weight ?? ""),
      (s.reps ?? "") === 0 ? "" : String(s.reps ?? "")
    );
  }

  // Buttons
  const addBtn = el("button", { class:"btn", onClick: () => {
    addRow();
    // focus weight input of the new row
    const last = setInputs[setInputs.length - 1];
    if(last?.wInput) last.wInput.focus();
  }}, ["+ Add Set"]);

  const saveBtn = el("button", {
    class:"btn primary",
    onClick: () => {
      clearErr();

      const dateISO = String(dateInput.value || initialDateISO);

      const sets = setInputs.map(s => ({
        weight: Number(s.wInput.value) || 0,
        reps: Math.max(0, Math.floor(Number(s.rInput.value) || 0))
      })).filter(s => s.weight > 0 || s.reps > 0);

      if(sets.length === 0){
        showErr("Enter at least one set.");
        return;
      }

      const summary = LogEngine.computeWeightliftingSummary(sets);
      const pr = LogEngine.computePRFlags(type, exerciseId, summary);

      // Upsert: replace existing entry for this date + routineExerciseId
      LogEngine.ensure();
      state.logs.workouts = (state.logs.workouts || []).filter(e =>
        !(e.dateISO === dateISO && e.routineExerciseId === rx.id)
      );
      Storage.save(state);

      LogEngine.addEntry({
        id: uid("w"),
        createdAt: Date.now(),
        dateISO,
        type,
        exerciseId,
        routineExerciseId: rx.id,
        routineId: routine.id,
        dayId: day.id,
        dayOrder: day.order,
        sets,
        summary,
        pr
      });

      afterSave(dateISO);
    }
  }, ["Save"]);

  // Sticky bar (two buttons only)
  const sticky = el("div", { class:"logsetStickyBar" }, [ addBtn, saveBtn ]);

  rowsHost.appendChild(head);
  rowsHost.appendChild(rows);
  rowsHost.appendChild(sticky);

  // Make the first row “active” by default (if any)
  setTimeout(() => {
    const firstRow = rows.querySelector(".logsetRow");
    if(firstRow) firstRow.classList.add("active");
  }, 0);

  return rowsHost;
}

  function buildCardioForm(){
    const minInput = el("input", { type:"number", inputmode:"numeric", placeholder:"Min", value:"" });
    const secInput = el("input", { type:"number", inputmode:"numeric", placeholder:"Sec", value:"" });
    const distInput = el("input", { type:"number", inputmode:"decimal", placeholder:"Distance", value:"" });
    const inclInput = el("input", { type:"number", inputmode:"decimal", placeholder:"Incline (optional)", value:"" });

    // Prefill if already logged on initial date
    if(existingEntry?.sets?.[0]){
      const s = existingEntry.sets[0];
      const t = Math.max(0, Math.floor(Number(s.timeSec) || 0));
      minInput.value = String(Math.floor(t / 60) || "");
      secInput.value = String((t % 60) || "");
      distInput.value = (s.distance != null && Number(s.distance) !== 0) ? String(s.distance) : "";
      inclInput.value = (s.incline != null && String(s.incline) !== "0") ? String(s.incline) : "";
    }

    const saveBtn = el("button", {
      class:"btn primary",
      onClick: () => {
        clearErr();

        const dateISO = String(dateInput.value || initialDateISO);

        const min = Math.max(0, Math.floor(Number(minInput.value) || 0));
        const sec = Math.max(0, Math.floor(Number(secInput.value) || 0));
        const timeSec = (min * 60) + sec;
        const distance = Number(distInput.value) || 0;
        const incline = (inclInput.value === "") ? null :
          (Number.isFinite(Number(inclInput.value)) ? Number(inclInput.value) : null);

        if(timeSec <= 0 && distance <= 0){
          showErr("Enter time and/or distance.");
          return;
        }

        const sets = [{ timeSec, distance, incline }];
        const summary = LogEngine.computeCardioSummary(sets);
        const pr = LogEngine.computePRFlags(type, exerciseId, summary);

        // Upsert: replace existing entry for this date + routineExerciseId
        LogEngine.ensure();
        state.logs.workouts = (state.logs.workouts || []).filter(e =>
          !(e.dateISO === dateISO && e.routineExerciseId === rx.id)
        );
        Storage.save(state);

        LogEngine.addEntry({
          id: uid("c"),
          createdAt: Date.now(),
          dateISO,
          type,
          exerciseId,
          routineExerciseId: rx.id,
          routineId: routine.id,
          dayId: day.id,
          dayOrder: day.order,
          sets,
          summary,
          pr
        });

        afterSave(dateISO);
      }
    }, ["Save"]);

const cancelBtn = el("button", { class:"btn", onClick: Modal.close }, ["Cancel"]);

const sticky = el("div", { class:"logsetStickyBar" }, [ cancelBtn, saveBtn ]);

return el("div", { class:"card" }, [
  el("h2", { text:"Session" }),
  el("div", { class:"row2" }, [
    el("label", {}, [ el("span", { text:"Minutes" }), minInput ]),
    el("label", {}, [ el("span", { text:"Seconds" }), secInput ])
  ]),
  el("div", { class:"row2" }, [
    el("label", {}, [ el("span", { text:"Distance" }), distInput ]),
    el("label", {}, [ el("span", { text:"Incline" }), inclInput ])
  ]),
  sticky
]);
  }

  function buildCoreForm(){
    const setsInput = el("input", { type:"number", inputmode:"numeric", placeholder:"Sets", value:"" });
    const repsInput = el("input", { type:"number", inputmode:"numeric", placeholder:"Reps", value:"" });
    const timeMinInput = el("input", { type:"number", inputmode:"numeric", placeholder:"Min", value:"" });
    const timeSecInput = el("input", { type:"number", inputmode:"numeric", placeholder:"Sec", value:"" });
    const weightInput = el("input", { type:"number", inputmode:"decimal", placeholder:"Weight (optional)", value:"" });

    // Prefill if already logged on initial date
    if(existingEntry?.sets?.[0]){
      const s = existingEntry.sets[0];
      setsInput.value = (s.sets != null && Number(s.sets) !== 0) ? String(s.sets) : "";
      repsInput.value = (s.reps != null && Number(s.reps) !== 0) ? String(s.reps) : "";
      const t = Math.max(0, Math.floor(Number(s.timeSec) || 0));
      timeMinInput.value = String(Math.floor(t / 60) || "");
      timeSecInput.value = String((t % 60) || "");
      weightInput.value = (s.weight != null && Number(s.weight) !== 0) ? String(s.weight) : "";
    }

    const saveBtn = el("button", {
      class:"btn primary",
      onClick: () => {
        clearErr();

        const dateISO = String(dateInput.value || initialDateISO);

        const setsN = Math.max(0, Math.floor(Number(setsInput.value) || 0));
        const repsN = Math.max(0, Math.floor(Number(repsInput.value) || 0));
        const tmin = Math.max(0, Math.floor(Number(timeMinInput.value) || 0));
        const tsec = Math.max(0, Math.floor(Number(timeSecInput.value) || 0));
        const timeSec = (tmin * 60) + tsec;
        const weight = Number(weightInput.value) || 0;

        if((setsN <= 0 || repsN <= 0) && timeSec <= 0){
          showErr("Enter sets+reps or a time.");
          return;
        }

        const sets = [{ sets: setsN, reps: repsN, timeSec, weight }];
        const summary = LogEngine.computeCoreSummary(sets);
        const pr = LogEngine.computePRFlags(type, exerciseId, summary);

        // Upsert: replace existing entry for this date + routineExerciseId
        LogEngine.ensure();
        state.logs.workouts = (state.logs.workouts || []).filter(e =>
          !(e.dateISO === dateISO && e.routineExerciseId === rx.id)
        );
        Storage.save(state);

        LogEngine.addEntry({
          id: uid("k"),
          createdAt: Date.now(),
          dateISO,
          type,
          exerciseId,
          routineExerciseId: rx.id,
          routineId: routine.id,
          dayId: day.id,
          dayOrder: day.order,
          sets,
          summary,
          pr
        });

        afterSave(dateISO);
      }
    }, ["Save"]);

const cancelBtn = el("button", { class:"btn", onClick: Modal.close }, ["Cancel"]);

const sticky = el("div", { class:"logsetStickyBar" }, [ cancelBtn, saveBtn ]);

return el("div", { class:"card" }, [
  el("h2", { text:"Core" }),
  el("div", { class:"row2" }, [
    el("label", {}, [ el("span", { text:"Sets" }), setsInput ]),
    el("label", {}, [ el("span", { text:"Reps" }), repsInput ])
  ]),
  el("div", { class:"row2" }, [
    el("label", {}, [ el("span", { text:"Time (min)" }), timeMinInput ]),
    el("label", {}, [ el("span", { text:"Time (sec)" }), timeSecInput ])
  ]),
  el("label", {}, [ el("span", { text:"Weight" }), weightInput ]),
  sticky
]);

  }

  function formatEntryOneLine(type, entry){
    try{
      if(type === "weightlifting"){
        const bw = entry?.summary?.bestWeight;
        const vol = entry?.summary?.totalVolume;
        return `Top ${bw ?? "—"} • Vol ${vol ?? "—"}`;
      }
      if(type === "cardio"){
        const d = entry?.summary?.distance;
        const t = entry?.summary?.timeSec;
        const p = entry?.summary?.paceSecPerUnit;
        return `${d ?? "—"} units • ${formatTime(t ?? 0)} • Pace ${formatPace(p)}`;
      }
      const v = entry?.summary?.totalVolume;
      return `Volume ${v ?? "—"}`;
    }catch(e){
      return "—";
    }
  }
}

function isDayComplete(dateISO, day){
  const ex = (day?.exercises || []);
  if(ex.length === 0) return false;
  return ex.every(rx => hasRoutineExerciseLog(dateISO, rx.id));
}
  function repaint(){
  routine = Routines.getActive();
  root.innerHTML = "";

  // Fixed (top) vs scrollable (below carousel)
  const fixedHost = el("div", { class:"routineFixed" });
  const scrollHost = el("div", { class:"routineScroll" });
  root.appendChild(fixedHost);
  root.appendChild(scrollHost);

  const day = getDay(selectedIndex);
  const selectedDateISO = getSelectedDateISO(selectedIndex);

function openExerciseHistoryModal(type, exerciseId, exNameOverride=null){
  LogEngine.ensure();

  const exName = exNameOverride || resolveExerciseName(type, exerciseId, "Exercise");
  const entries = LogEngine.entriesForExercise(type, exerciseId); // desc (most recent first)

  const head = el("div", { class:"note" }, [
    `${exName} • ${ExerciseLibrary.typeLabel(type)}`
  ]);

  const list = el("div", { class:"list" });

  if(entries.length === 0){
    list.appendChild(el("div", { class:"note", text:"No history yet for this exercise." }));
  }else{
    // Show last entry + recent history (top 12)
    entries.slice(0, 12).forEach(e => {
      list.appendChild(el("div", { class:"item" }, [
        el("div", { class:"left" }, [
          el("div", { class:"name", text: e.dateISO }),
          el("div", { class:"meta", text: formatEntryDetail(type, e) })
        ]),
        el("div", { class:"actions" }, [
          el("div", { class:"meta", text: prBadges(e.pr) })
        ])
      ]));
    });
  }

   Modal.open({
    title: "History",
    center: true,
    bodyNode: el("div", { class:"grid" }, [
      head,
      list,
      el("div", { style:"height:10px" }),
      el("button", { class:"btn", onClick: Modal.close }, ["Close"])
    ])
  });

  function prBadges(pr){
    if(!pr) return "";
    const b = [];
    if(pr.isPRWeight) b.push("PR W");
    if(pr.isPR1RM) b.push("PR 1RM");
    if(pr.isPRVolume) b.push("PR Vol");
    if(pr.isPRPace) b.push("PR Pace");
    return b.join(" • ");
  }

  function formatEntryDetail(type, entry){
    try{
      if(type === "weightlifting"){
        const sets = (entry.sets || []).map(s => `${s.weight || 0}×${s.reps || 0}`).join(" • ");
        const top = entry.summary?.bestWeight ?? "—";
        const vol = entry.summary?.totalVolume ?? "—";
        return `Sets: ${sets || "—"} | Top: ${top} | Vol: ${vol}`;
      }
      if(type === "cardio"){
        const d = entry.summary?.distance ?? "—";
        const t = formatTime(entry.summary?.timeSec ?? 0);
        const p = formatPace(entry.summary?.paceSecPerUnit);
        const inc = (entry.summary?.incline == null) ? "" : ` | Incline: ${entry.summary.incline}`;
        return `Dist: ${d} | Time: ${t} | Pace: ${p}${inc}`;
      }
      // core
      const s0 = (entry.sets || [])[0] || {};
      const vol = entry.summary?.totalVolume ?? "—";
      const repPart = (s0.sets && s0.reps) ? `${s0.sets}×${s0.reps}` : "";
      const timePart = (s0.timeSec && s0.timeSec > 0) ? formatTime(s0.timeSec) : "";
      const wPart = (s0.weight && s0.weight > 0) ? ` @ ${s0.weight}` : "";
      const detail = [repPart, timePart].filter(Boolean).join(" • ");
      return `${detail || "—"}${wPart} | Vol: ${vol}`;
    }catch(e){
      return "—";
    }
  }
}

    // ────────────────────────────
    // Header Card (locked layout)
    // ────────────────────────────
fixedHost.appendChild(el("div", { class:"card" }, [
      el("h2", { text:"Routine" }),
      el("div", { class:"note", text:`${routine.name} • ${weekStartsOn === "sun" ? "Sun–Sat" : "Mon–Sun"}` }),

      el("div", { style:"height:10px" }),

      el("div", { class:"rHdrRow" }, [
        el("button", {
          class:"btn ghost",
          onClick: (e) => openRoutinePicker(e.currentTarget)
        }, [`${routine.name} ▼`]),

        el("button", {
          class:"btn primary",
          onClick: () => {
            selectedIndex = todayIndex;
            repaint();
            setTimeout(()=>{
              const first = scrollHost.querySelector("[data-unlogged='true']");
              if(first){
                first.scrollIntoView({ behavior:"smooth", block:"center" });
                first.classList.add("pulse");
                setTimeout(()=>first.classList.remove("pulse"),1200);
              }
            },0);
          }
        }, ["▶ Start Today"])
      ]),

      el("div", {
        class:"manageLink",
        onClick: () => navigate("routine_editor")
      }, ["Manage Routine ▾"])
    ]));

    if(!day){
      scrollHost.appendChild(el("div", { class:"card note" }, ["No day found."]));
      return;
    }

    // ────────────────────────────
    // 3D Card Carousel (visual container)
    // ────────────────────────────
fixedHost.appendChild(el("div", { class:"card carouselCard" }, [
  (() => {
    let down = false;
    let startX = 0;
    let dx = 0;
    const THRESH = 55;

    function onDown(e){
      down = true;
      startX = e.clientX;
      dx = 0;
      try{ e.currentTarget.setPointerCapture(e.pointerId); }catch(_){}
    }
    function onMove(e){
      if(!down) return;
      dx = e.clientX - startX;
      // (visual-only: we keep drag simple; snap happens on release)
    }
    function onEnd(){
      if(!down) return;
      down = false;

      if(dx <= -THRESH) selectedIndex = (selectedIndex + 1) % 7;
      else if(dx >= THRESH) selectedIndex = (selectedIndex + 6) % 7;

      repaint();
    }

    const names = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

    const c3d = el("div", {
      class:"c3d",
      onPointerDown: onDown,
      onPointerMove: onMove,
      onPointerUp: onEnd,
      onPointerCancel: onEnd,
      onLostPointerCapture: onEnd
    }, []);

    // Show selected ±2
    const offsets = [-2,-1,0,1,2];
    offsets.forEach(off => {
      const idx = (selectedIndex + off + 7) % 7;
      const d = getDay(idx) || { label:"Day", isRest:false, exercises:[] };

      const abs = Math.abs(off);
      const scale = (off === 0) ? 1 : (1 - abs * 0.10);
      const x = off * 92;              // ✅ tighter spacing (more compact)
      const z = -(abs * 95);           // ✅ less depth than before
      const y = abs * 6;
      const rot = off * -22;           // ✅ slightly tighter rotation
      const op = (off === 0) ? 1 : (abs === 1 ? .65 : .30);

      const chips = [];
      chips.push(el("div", { class:"c3dChip", text: d.isRest ? "Rest Day" : "Training Day" }));
      if(idx === selectedIndex) chips.push(el("div", { class:"c3dChip active", text:"Active" }));

      const card = el("div", {
        class: "c3dCard" + (idx === selectedIndex ? " sel" : ""),
        style: `transform: translateX(${x}px) translateY(${y}px) translateZ(${z}px) rotateY(${rot}deg) scale(${scale}); opacity:${op};`
      }, [
        el("div", {}, [
          el("div", { class:"c3dDay", text: names[idx].toUpperCase() }),
          el("div", { class:"c3dLabel", text: d.label || "Day" }),
          el("div", { class:"c3dMeta", text: d.isRest ? "Rest" : `${(d.exercises||[]).length} exercises` })
        ]),
        el("div", { class:"c3dChips" }, chips)
      ]);

      // Tap any card to jump (visual-only)
      card.addEventListener("click", () => {
        selectedIndex = idx;
        repaint();
      });

      c3d.appendChild(card);
    });

    return c3d;
  })(),

  // Fixed day strip under carousel (tap to jump)
  el("div", { class:"routineDayStrip" }, [
    ...(weekStartsOn === "sun" ? [0,1,2,3,4,5,6] : [1,2,3,4,5,6,0]).map(i => {
      const label = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][i].toUpperCase();
      return el("button", {
        class: "routineDayBtn" + (i === selectedIndex ? " sel" : ""),
        onClick: () => { selectedIndex = i; repaint(); }
      }, [
        el("div", { text: label }),
        el("div", { class:"dot" })
      ]);
    })
  ])
]));


    // Rest Day
    if(day.isRest){
scrollHost.appendChild(el("div", { class:"card restCard" }, [
        el("h2", { text:"Rest" }),
        el("div", { class:"note", text:`Rest day scheduled for ${selectedDateISO}.` })
      ]));
      return;
    }
    // Day completion banner
    if(isDayComplete(selectedDateISO, day)){
scrollHost.appendChild(el("div", { class:"card" }, [
        el("h2", { text:"Completed" }),
        el("div", { class:"note", text:`All exercises logged for ${selectedDateISO}.` }),
        el("div", { style:"height:10px" }),
        el("div", { class:"btnrow" }, [
          el("button", {
            class:"btn danger",
            onClick: () => {
              removeWorkoutEntriesForRoutineDay(selectedDateISO, routine.id, day.id);
              attendanceRemove(selectedDateISO);
              setNextNudge(null);
              repaint();
              showToast("Marked incomplete");
            }
          }, ["Mark incomplete"])
        ])
      ]));
    }


// ────────────────────────────
// Exercise Cards (compact)
// ────────────────────────────
(day.exercises || []).forEach(rx => {
  const exName = resolveExerciseName(rx.type, rx.exerciseId, rx.nameSnap);
  const logged = hasRoutineExerciseLog(selectedDateISO, rx.id);

  const max = lifetimeMaxSet(rx.type, rx.exerciseId);
  const maxText = max ? `${max.weight} × ${max.reps}` : "—";

  scrollHost.appendChild(el("div", {
    class:"card rxCard",
    id:`rx_${rx.id}`,
    "data-unlogged": logged ? "false" : "true"
  }, [
    el("div", { class:"rxTop" }, [
      el("div", { class:"rxName", text: exName }),
      el("div", {
        class:"rxChip" + (logged ? " on" : ""),
        text: logged ? "Logged" : "Not logged"
      })
    ]),

    el("div", { class:"rxMeta", text:`🏆 Lifetime Max: ${maxText}` }),

    el("div", { class:"rxActions" }, [
      el("button", {
        class:"btn primary sm",
        onClick: () => openExerciseLogger(rx, day, selectedDateISO)
      }, ["Log Sets"]),

      el("button", {
        class:"btn ghost sm",
        onClick: () => openExerciseHistoryModal(rx.type, rx.exerciseId, exName)
      }, ["History →"])
    ])
  ]));
});

  }

  repaint();
  return root;
},

Progress(){
  ExerciseLibrary.ensureSeeded();
  LogEngine.ensure();

  // Defaults
  let type = "weightlifting";
  let exerciseId = (state.exerciseLibrary?.weightlifting?.[0]?.id) || null;

  // Filters
  let routineId = ""; // "" = All routines
  const todayISO = Dates.todayISO();
  let fromISO = Dates.addDaysISO(todayISO, -30);
  let toISO = todayISO;

  // Metric default per type
  let metric = defaultMetricForType(type);

  // Search state
  let query = "";

  const root = el("div", { class:"grid" });

  // Header
  root.appendChild(el("div", { class:"card" }, [
    el("h2", { text:"Progress" }),
    el("div", { class:"note", text:"Search an exercise, then view trends + history. Keep the graph front-and-center." })
  ]));

  // ────────────────────────────
  // Compact Controls + Overview (single card)
  // ────────────────────────────
  const topCard = el("div", { class:"card" }, [
    el("h2", { text:"Find exercise" })
  ]);

  // Type segmented
  const typeRow = el("div", { class:"segRow" });
  const typeBtns = {
    weightlifting: el("button", { class:"seg", onClick: () => setType("weightlifting") }, ["Weightlifting"]),
    cardio:        el("button", { class:"seg", onClick: () => setType("cardio") }, ["Cardio"]),
    core:          el("button", { class:"seg", onClick: () => setType("core") }, ["Core"])
  };
  typeRow.appendChild(typeBtns.weightlifting);
  typeRow.appendChild(typeBtns.cardio);
  typeRow.appendChild(typeBtns.core);

  // Search bar + selected pill
  const searchWrap = el("div", { class:"progSearch" }, [
    el("div", { class:"ico", text:"🔎" }),
    el("input", {
      type:"text",
      value:"",
      placeholder:"Search exercise (e.g., Bench, Squat, Treadmill)…",
      onInput: (e) => {
        query = String(e.target.value || "");
        repaint(false);
      }
    })
  ]);

  const selectedRow = el("div", { class:"pillRow" });
  const resultsHost = el("div", { class:"progResults" });

  // Routine select (kept, but compact)
  const routineSelect = el("select", {});
  routineSelect.appendChild(el("option", { value:"", text:"All routines" }));
  routineSelect.addEventListener("change", () => {
    routineId = routineSelect.value || "";
    repaint(true);
  });

  // Date range chips
  const rangeRow = el("div", { class:"segRow" });
  const r7  = el("button", { class:"seg", onClick: () => { setRange(7); } }, ["7D"]);
  const r30 = el("button", { class:"seg", onClick: () => { setRange(30); } }, ["30D"]);
  const r90 = el("button", { class:"seg", onClick: () => { setRange(90); } }, ["90D"]);
  const r1y = el("button", { class:"seg", onClick: () => { setRange(365); } }, ["1Y"]);
  rangeRow.appendChild(r7); rangeRow.appendChild(r30); rangeRow.appendChild(r90); rangeRow.appendChild(r1y);

  // Custom date inputs (still available, compact)
  const fromInput = el("input", { type:"date", value: fromISO });
  const toInput   = el("input", { type:"date", value: toISO });

  fromInput.addEventListener("change", () => {
    fromISO = fromInput.value || fromISO;
    if(fromISO > toISO){
      toISO = fromISO;
      toInput.value = toISO;
    }
    repaint(true);
  });

  toInput.addEventListener("change", () => {
    toISO = toInput.value || toISO;
    if(toISO < fromISO){
      fromISO = toISO;
      fromInput.value = fromISO;
    }
    repaint(true);
  });

  // Metric segmented
  const metricRow = el("div", { class:"segRow" });

  // Overview host (compact KPIs)
const statsHost = el("div", { class:"pillRow", style:"margin-top:8px;" });

  topCard.appendChild(el("div", { class:"note", text:"Type + search to select an exercise." }));
  topCard.appendChild(typeRow);
  topCard.appendChild(el("div", { style:"height:10px" }));
  topCard.appendChild(searchWrap);
  topCard.appendChild(selectedRow);
  topCard.appendChild(resultsHost);

  topCard.appendChild(el("div", { style:"height:10px" }));

// Dates (single-line)
topCard.appendChild(el("div", {
  style:"display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:2px;"
}, [
  el("div", { class:"note", text:"From:" }),
  fromInput,
  el("div", { class:"note", text:"|" }),
  el("div", { class:"note", text:"To:" }),
  toInput
]));

  topCard.appendChild(el("div", { style:"height:8px" }));
  topCard.appendChild(el("div", { class:"note", text:"Metric" }));
  topCard.appendChild(metricRow);

  topCard.appendChild(el("div", { style:"height:10px" }));
  topCard.appendChild(el("div", { class:"note", text:"Overview" }));
  topCard.appendChild(statsHost);

  root.appendChild(topCard);

  // ────────────────────────────
  // Graph (primary focus)
  // ────────────────────────────
  const chartCard = el("div", { class:"card" }, [
    el("h2", { text:"Trend" })
  ]);
  const chartWrap = el("div", { class:"chartWrap" });
  const canvas = el("canvas", {});
  chartWrap.appendChild(canvas);
  const chartNote = el("div", { class:"note", style:"margin-top:10px;" });

  chartCard.appendChild(chartWrap);
  chartCard.appendChild(chartNote);
  root.appendChild(chartCard);

  // ────────────────────────────
  // History (collapsible)
  // ────────────────────────────
  const tableCard = el("div", { class:"card" }, [
    el("div", { class:"accItem" }, [
      el("div", {
        class:"accHead",
        onClick: () => {
          const body = tableCard.querySelector(".accBody");
          const caret = tableCard.querySelector(".accCaret");
          const isOpen = body.style.display === "block";
          body.style.display = isOpen ? "none" : "block";
          caret.textContent = isOpen ? "▾" : "▴";
        }
      }, [
        el("div", { class:"accTitle", text:"History" }),
        el("div", { class:"accCaret", text:"▾" })
      ]),
      el("div", { class:"accBody" }, [
        el("div", { class:"note", text:"Most recent logs for the selected exercise." }),
        el("div", { style:"height:8px" }),
        el("div", { class:"list", id:"progressHistoryHost" })
      ])
    ])
  ]);
  const tableHost = tableCard.querySelector("#progressHistoryHost");
  root.appendChild(tableCard);

  // Populate routine dropdown
  repaintRoutineSelect();

  // Initial paint
  repaint(true);
  return root;

  // ---- helpers ----
  function defaultMetricForType(t){
    if(t === "weightlifting") return "topWeight";
    if(t === "cardio") return "pace";
    return "volume";
  }

  function setType(next){
    type = next;
    query = "";
    searchWrap.querySelector("input").value = "";
    exerciseId = (state.exerciseLibrary?.[type]?.[0]?.id) || null;
    metric = defaultMetricForType(type);
    repaint(true);
  }

  function setRange(days){
    fromISO = Dates.addDaysISO(todayISO, -Math.max(1, Number(days) || 30));
    toISO = todayISO;
    fromInput.value = fromISO;
    toInput.value = toISO;
    repaint(true);
  }

  function repaintRoutineSelect(){
    routineSelect.innerHTML = "";
    routineSelect.appendChild(el("option", { value:"", text:"All routines" }));
    const all = Routines.getAll?.() || [];
    all.forEach(r => routineSelect.appendChild(el("option", { value:r.id, text:r.name })));
    routineSelect.value = routineId || "";
  }

  function setMetric(next){
    metric = next;
    repaint(true);
  }

  function repaintMetricRow(){
    metricRow.innerHTML = "";

    if(type === "weightlifting"){
      metricRow.appendChild(el("button", { class:"seg", onClick: () => setMetric("topWeight") }, ["Top Weight"]));
      metricRow.appendChild(el("button", { class:"seg", onClick: () => setMetric("est1RM") }, ["Est 1RM"]));
      metricRow.appendChild(el("button", { class:"seg", onClick: () => setMetric("volume") }, ["Volume"]));
    } else if(type === "cardio"){
      metricRow.appendChild(el("button", { class:"seg", onClick: () => setMetric("pace") }, ["Pace"]));
      metricRow.appendChild(el("button", { class:"seg", onClick: () => setMetric("distance") }, ["Distance"]));
      metricRow.appendChild(el("button", { class:"seg", onClick: () => setMetric("timeSec") }, ["Time"]));
    } else {
      metricRow.appendChild(el("button", { class:"seg", onClick: () => setMetric("volume") }, ["Volume"]));
    }

    // active styles
    [...metricRow.querySelectorAll(".seg")].forEach(btn => {
      const v = (btn.textContent || "").toLowerCase();
      const isActive =
        (metric === "topWeight" && v.includes("top")) ||
        (metric === "est1RM" && v.includes("1rm")) ||
        (metric === "volume" && v.includes("volume")) ||
        (metric === "pace" && v.includes("pace")) ||
        (metric === "distance" && v.includes("distance")) ||
        (metric === "timeSec" && v.includes("time"));
      btn.classList.toggle("active", isActive);
    });
  }

  function repaintTypeRow(){
    Object.entries(typeBtns).forEach(([k,btn]) => btn.classList.toggle("active", k === type));
  }

  function confirmDeleteLog(entry){
    Modal.open({
      title: "Delete log?",
      bodyNode: el("div", { class:"grid" }, [
        el("div", { class:"note", text:`This will permanently delete this log entry:` }),
        el("div", { class:"note", text:`${entry.dateISO} • ${tableLine(entry)}` }),
        el("div", { style:"height:10px" }),
        el("div", { class:"btnrow" }, [
          el("button", {
            class:"btn danger",
            onClick: () => {
              removeWorkoutEntryById(entry.id);
              Modal.close();
              repaint(true);
              showToast("Deleted");
            }
          }, ["Delete"]),
          el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
        ])
      ]),
      size: "sm"
    });
  }

  function repaint(forceChart){
    repaintTypeRow();
    repaintMetricRow();

    // Exercise library for current type
    const lib = (state.exerciseLibrary?.[type] || []).slice()
      .sort((a,b) => (a.name||"").localeCompare(b.name||""));

    // Ensure exerciseId is valid
    if(lib.length === 0){
      exerciseId = null;
    }else{
      if(!exerciseId || !lib.some(x => x.id === exerciseId)) exerciseId = lib[0].id;
    }

    // Search results
    resultsHost.innerHTML = "";
    selectedRow.innerHTML = "";

    const selectedName = exerciseId ? resolveExerciseName(type, exerciseId, "Exercise") : null;

    if(selectedName){
      selectedRow.appendChild(el("div", { class:"pill" }, [
        el("div", { class:"t", text:selectedName }),
        el("button", {
          class:"x",
          onClick: () => {
            exerciseId = null;
            repaint(true);
          }
        }, ["×"])
      ]));
    } else {
      selectedRow.appendChild(el("div", { class:"note", text:"No exercise selected." }));
    }

    const q = normName(query);
    if(query && lib.length){
      const hits = lib.filter(x => normName(x.name).includes(q)).slice(0, 10);
      if(hits.length){
        const list = el("div", { class:"list", style:"margin-top:8px;" }, hits.map(x => {
          return el("div", {
            class:"item",
            onClick: () => {
              exerciseId = x.id;
              query = "";
              searchWrap.querySelector("input").value = "";
              repaint(true);
            }
          }, [
            el("div", { class:"left" }, [
              el("div", { class:"name", text:x.name }),
              el("div", { class:"meta", text: typeLabel(type) })
            ])
          ]);
        }));
        resultsHost.appendChild(list);
      } else {
        resultsHost.appendChild(el("div", { class:"note", text:"No matches. Try a different keyword." }));
      }
    }

    // Stats + chart + table only if exercise selected
    statsHost.innerHTML = "";
    tableHost.innerHTML = "";
    chartNote.textContent = "";

    if(!exerciseId){
      destroyProgressChart();
      chartNote.textContent = "Select an exercise to see your trend.";
      tableHost.appendChild(el("div", { class:"note", text:"Select an exercise to see history." }));
      return;
    }

    // Filter entries for selected exercise
const all = (state.logs?.workouts || []).filter(e =>
  e.type === type &&
  e.exerciseId === exerciseId &&
  (e.dateISO >= fromISO && e.dateISO <= toISO)
);


    // Overview KPIs
    const desc = all.slice().sort((a,b) => (b.dateISO||"").localeCompare(a.dateISO||"") || (b.createdAt||0)-(a.createdAt||0));
    const latest = desc[0] || null;

    const bests = LogEngine.lifetimeBests(type, exerciseId);
    const bestText = bestsText(type, bests);

    // Overview (single pill): { PR: xxx | Last: xxx }
const prVal = formatMetricValue(type, metric, prForMetric(type, metric, bests));
const lastVal = latest ? formatMetricValue(type, metric, metricValue(type, metric, latest)) : "—";

statsHost.appendChild(el("div", { class:"pill" }, [
  el("div", { class:"t", text:`{ PR: ${prVal} | Last: ${lastVal} }` })
]));

    // Chart (ascending for series builder)
    const asc = all.slice().sort((a,b) => (a.dateISO||"").localeCompare(b.dateISO||"") || (a.createdAt||0)-(b.createdAt||0));
    if(asc.length < 2){
      destroyProgressChart();
      chartNote.textContent = `Not enough data in this range (${fromISO} to ${toISO}). Log at least 2 sessions.`;
    }else{
      const series = buildSeries(type, asc);
      renderProgressChart(canvas, type, metric, series);
      chartNote.textContent = `${asc.length} points • ${fromISO} → ${toISO}`;
    }

    // History table
    if(desc.length === 0){
      tableHost.appendChild(el("div", { class:"note", text:"No logs in this range." }));
    }else{
      desc.slice(0, 40).forEach(entry => {
        tableHost.appendChild(el("div", { class:"item" }, [
          el("div", { class:"left" }, [
            el("div", { class:"name", text: entry.dateISO }),
            el("div", { class:"meta", text: tableLine(entry) })
          ]),
          el("div", { class:"actions" }, [
            el("button", { class:"mini danger", onClick: () => confirmDeleteLog(entry) }, ["Delete"])
          ])
        ]));
      });
    }
  }

  function typeLabel(t){
    if(t === "weightlifting") return "Weightlifting";
    if(t === "cardio") return "Cardio";
    return "Core";
  }

  function bestsText(t, bests){
    if(!bests) return "";
    if(t === "weightlifting"){
      const bw = bests.bestWeight != null ? `${Math.round(bests.bestWeight*10)/10} top` : "";
      const brm = bests.best1RM != null ? `${Math.round(bests.best1RM*10)/10} est 1RM` : "";
      const bv = bests.bestVolume != null ? `${Math.round(bests.bestVolume)} vol` : "";
      return [bw, brm, bv].filter(Boolean)[0] || "";
    }
    if(t === "cardio"){
      const bp = bests.bestPace != null ? `${formatTime(Math.round(bests.bestPace))} pace` : "";
      return bp || "";
    }
    const bv = bests.bestVolume != null ? `${Math.round(bests.bestVolume)} vol` : "";
    return bv || "";
  }

  // ✅ helpers must stay INSIDE Progress() (not inside Views object root)
  function metricValue(type, metric, entry){
    try{
      if(!entry) return null;

      if(type === "weightlifting"){
        if(metric === "topWeight") return entry.summary?.bestWeight ?? entry.summary?.topWeight ?? null;
        if(metric === "est1RM")    return entry.summary?.est1RM ?? null;
        if(metric === "volume")    return entry.summary?.totalVolume ?? null;
        return entry.summary?.bestWeight ?? null;
      }

      if(type === "cardio"){
        if(metric === "pace")     return entry.summary?.paceSecPerUnit ?? null;
        if(metric === "distance") return entry.summary?.distance ?? null;
        if(metric === "timeSec")  return entry.summary?.timeSec ?? null;
        return entry.summary?.paceSecPerUnit ?? null;
      }

      // core
      if(metric === "volume") return entry.summary?.totalVolume ?? null;
      return entry.summary?.totalVolume ?? null;
    }catch(e){
      return null;
    }
  }

  function prForMetric(type, metric, bests){
    try{
      if(!bests) return null;

      if(type === "weightlifting"){
        if(metric === "topWeight") return bests.bestWeight ?? null;
        if(metric === "est1RM")    return bests.best1RM ?? null;
        if(metric === "volume")    return bests.bestVolume ?? null;
        return bests.bestWeight ?? null;
      }

      if(type === "cardio"){
        if(metric === "pace")     return bests.bestPace ?? null;
        if(metric === "distance") return bests.bestDistance ?? null;
        if(metric === "timeSec")  return bests.bestTime ?? null;
        return bests.bestPace ?? null;
      }

      // core
      if(metric === "volume") return bests.bestVolume ?? null;
      return bests.bestVolume ?? null;
    }catch(e){
      return null;
    }
  }

  function formatMetricValue(type, metric, v){
    if(v == null) return "—";

    // cardio formatting
    if(type === "cardio" && metric === "pace") return formatPace(v);
    if(type === "cardio" && metric === "timeSec") return formatTime(v);

    // numeric formatting
    if(typeof v === "number"){
      const n = Math.round(v * 10) / 10;
      return String(n);
    }
    return String(v);
  }

},  // ✅ end Progress()
  Weight(){
  WeightEngine.ensure();

  const root = el("div", { class:"grid weightPage" });

  const todayISO = Dates.todayISO();

  // Local UI state
  let rangeDays = 30;      // 7, 30, 90, 365
  let historyOpen = false;

  // ---- UI: Summary (Top) ----
  const summaryCard = el("div", { class:"card" }, [
    el("div", { class:"weightTop" }, [
      el("div", {}, [
        el("h2", { text:"Weight" }),
        el("div", { class:"note", text:"Quick view + trend. Tap History to see past entries." })
      ]),
      el("button", {
        class:"btn primary weightLogBtn",
        onClick: () => openLogModal()
      }, ["+ Log"])
    ])
  ]);

  const summaryKpi = el("div", { class:"kpi weightSummaryKpi" });
  summaryCard.appendChild(summaryKpi);

  // ---- UI: Graph (Middle) ----
  const chartCard = el("div", { class:"card" }, [
    el("div", { class:"weightChartHead" }, [
      el("h2", { text:"Trend" }),
      el("div", { class:"segRow" }, [
        segBtn("7D", 7),
        segBtn("30D", 30),
        segBtn("90D", 90),
        segBtn("1Y", 365)
      ])
    ])
  ]);

  const chartWrap = el("div", { class:"chartWrap weightChartWrap" });
  const canvas = el("canvas", {});
  chartWrap.appendChild(canvas);
  const chartNote = el("div", { class:"note" });

  chartCard.appendChild(chartWrap);
  chartCard.appendChild(el("div", { style:"height:10px" }));
  chartCard.appendChild(chartNote);

  // ---- UI: History (Bottom - collapsible) ----
  const historyCard = el("div", { class:"card" }, [
    el("div", {
      class:"accHeader",
      onClick: () => {
        historyOpen = !historyOpen;
        repaintHistory();
      }
    }, [
      el("h2", { text:"History" }),
      el("div", { class:"accChevron", text:"▾" })
    ])
  ]);

  const historyBody = el("div", { class:"accBody" });
  const tableHost = el("div", { class:"list" });
  historyBody.appendChild(tableHost);
  historyCard.appendChild(historyBody);

  root.appendChild(summaryCard);
  root.appendChild(chartCard);
  root.appendChild(historyCard);

  repaintAll();
  return root;

  // -----------------------------
  // Helpers
  // -----------------------------
  function segBtn(label, days){
    const b = el("button", {
      class:"seg" + (days === rangeDays ? " active" : ""),
      onClick: () => {
        rangeDays = days;
        repaintChart();
        // update active styles
        const all = chartCard.querySelectorAll(".seg");
        all.forEach(x => x.classList.remove("active"));
        b.classList.add("active");
      }
    }, [label]);
    return b;
  }

  function openLogModal(){
    const dateInput = el("input", { type:"date", value: todayISO });
    const weightInput = el("input", { type:"number", inputmode:"decimal", placeholder:"e.g., 185.4", min:"0", step:"0.1" });
    const err = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

    Modal.open({
      title: "Log weight",
      center: true,
      size: "sm",
      bodyNode: el("div", {}, [
        el("label", {}, [ el("span", { text:"Date" }), dateInput ]),
        el("label", {}, [ el("span", { text:"Weight (lb)" }), weightInput ]),
        err,
        el("div", { style:"height:12px" }),
        el("div", { class:"btnrow" }, [
          el("button", {
            class:"btn primary",
            onClick: () => {
              try{
                err.style.display = "none";
                WeightEngine.add(dateInput.value || todayISO, weightInput.value);
                Modal.close();
                repaintAll();
              }catch(e){
                err.textContent = e.message || "Unable to save weight.";
                err.style.display = "block";
              }
            }
          }, ["Save"]),
          el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
        ])
      ])
    });
  }

  function repaintAll(){
    repaintSummary();
    repaintChart();
    repaintHistory(); // keeps collapsed by default
  }

  function repaintSummary(){
    const latest = WeightEngine.latest();
    const avg7 = WeightEngine.avg7(latest?.dateISO || todayISO);

    summaryKpi.innerHTML = "";

    const main = latest ? `${latest.weight}` : "—";
    const sub = latest
      ? ((latest.dateISO === todayISO) ? "Today" : `Latest • ${latest.dateISO}`)
      : "No weight entries yet.";

    // Change vs 7D avg (matches your mock)
    let change7 = null;
    if(latest && avg7 != null) change7 = round2((Number(latest.weight)||0) - (Number(avg7)||0));
    const change7Text = (change7 == null) ? "—" : (change7 > 0 ? `+${change7}` : `${change7}`);

    summaryKpi.appendChild(el("div", { class:"big", text: `${main} lb` }));
    summaryKpi.appendChild(el("div", { class:"small", text: sub }));
    summaryKpi.appendChild(el("div", { class:"small", text: `Change: ${change7Text} lb (7d)` }));
  }

  function repaintChart(){
    const ascAll = WeightEngine.listAsc();
    const asc = ascAll.slice(-rangeDays);

    if(asc.length < 2){
      destroyWeightChart();
      chartNote.textContent = "Add at least 2 entries to see the trend line.";
      return;
    }

    renderWeightChart(canvas, asc);
    chartNote.textContent = `Showing last ${asc.length} entries`;
  }

  function repaintHistory(){
    // collapsed by default
    historyCard.classList.toggle("open", !!historyOpen);
    historyBody.style.display = historyOpen ? "block" : "none";

    const chevron = historyCard.querySelector(".accChevron");
    if(chevron) chevron.textContent = historyOpen ? "▴" : "▾";

    if(!historyOpen) return;

    const desc = WeightEngine.listDesc();
    tableHost.innerHTML = "";

    if(desc.length === 0){
      tableHost.appendChild(el("div", { class:"note", text:"No entries yet. Tap + Log to add your first one." }));
      return;
    }

    desc.slice(0, 60).forEach(row => {
      tableHost.appendChild(el("div", { class:"item" }, [
        el("div", { class:"left" }, [
          el("div", { class:"name", text: row.dateISO }),
          el("div", { class:"meta", text: `${row.weight} lb` })
        ]),
        el("div", { class:"actions" }, [
          el("button", {
            class:"mini danger",
            onClick: () => {
              Modal.open({
                title: "Delete entry?",
                center: true,
                size: "sm",
                bodyNode: el("div", {}, [
                  el("div", { class:"note", text:`Delete ${row.weight} lb on ${row.dateISO}?` }),
                  el("div", { style:"height:12px" }),
                  el("div", { class:"btnrow" }, [
                    el("button", {
                      class:"btn danger",
                      onClick: () => {
                        WeightEngine.remove(row.id);
                        Modal.close();
                        repaintAll();
                      }
                    }, ["Delete"]),
                    el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                  ])
                ])
              });
            }
          }, ["Delete"])
        ])
      ]));
    });
  }
},
  Attendance(){

        AttendanceEngine.ensure();

        // default month = current
        const today = Dates.todayISO();
        let { y, m } = ymFromISO(today);

        const weekStartsOn = state.profile?.weekStartsOn || "mon"; // affects calendar header order
        const weekStart = (weekStartsOn === "sun") ? 0 : 1;

        const root = el("div", { class:"grid" });

        const header = el("div", { class:"card" }, [
          el("h2", { text:"Attendance" }),
          el("div", { class:"note", text:"Tap a day to mark it trained. Shows monthly count + clear month." })
        ]);

        const card = el("div", { class:"card" }, [
          el("h2", { text:"Calendar" })
        ]);

        const wrap = el("div", { class:"calWrap" });
        const top = el("div", { class:"calTop" });

        const title = el("div", { class:"calTitle" });
        const monthKpi = el("div", { class:"note" });

        const prevBtn = el("button", { class:"btn", onClick: () => { stepMonth(-1); } }, ["Prev"]);
        const nextBtn = el("button", { class:"btn", onClick: () => { stepMonth(1); } }, ["Next"]);

        const clearBtn = el("button", {
          class:"btn danger",
          onClick: () => {
            Modal.open({
              title: "Clear this month?",
              bodyNode: el("div", {}, [
                el("div", { class:"note", text:`This removes all trained days for ${monthTitle(y,m)}.` }),
                el("div", { style:"height:12px" }),
                el("div", { class:"btnrow" }, [
                  el("button", {
                    class:"btn danger",
                    onClick: () => {
                      AttendanceEngine.clearMonth(y, m);
                      Modal.close();
                      repaint();
                      renderView(); // Home dots update too
                    }
                  }, ["Clear month"]),
                  el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                ])
              ])
            });
          }
        }, ["Clear month"]);

        top.appendChild(el("div", { class:"btnrow" }, [prevBtn, nextBtn]));
        top.appendChild(el("div", { style:"flex:1" }));
        top.appendChild(clearBtn);

        const grid = el("div", { class:"calGrid" });

        wrap.appendChild(top);
        wrap.appendChild(el("div", { style:"height:10px" }));
        wrap.appendChild(title);
        wrap.appendChild(el("div", { style:"height:6px" }));
        wrap.appendChild(monthKpi);
        wrap.appendChild(el("div", { style:"height:12px" }));
        wrap.appendChild(grid);

        card.appendChild(wrap);
        root.appendChild(header);
        root.appendChild(card);

        repaint();
        return root;

        function stepMonth(delta){
          m += delta;
          if(m <= 0){ m = 12; y -= 1; }
          if(m >= 13){ m = 1; y += 1; }
          repaint();
        }

        function weekdayLabels(){
          const sun = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
          if(weekStart === 0) return sun;
          return ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
        }

        function repaint(){
          AttendanceEngine.ensure();
          title.textContent = monthTitle(y, m);

          const count = AttendanceEngine.monthCount(y, m);
          monthKpi.textContent = `This month: ${count} sessions`;

          grid.innerHTML = "";

          // headers
          weekdayLabels().forEach(lbl => {
            grid.appendChild(el("div", { class:"calCell header", text: lbl }));
          });

          const dim = daysInMonth(y, m);
          const firstDow = firstDayDow(y, m); // 0=Sun..6=Sat

          // convert firstDow to our grid index based on weekStart
          let leading = firstDow - weekStart;
          if(leading < 0) leading += 7;

          for(let i=0;i<leading;i++){
            grid.appendChild(el("div", { class:"calCell blank", text:"" }));
          }

          for(let d=1; d<=dim; d++){
            const dateISO = isoForYMD(y, m, d);
            const on = isTrained(dateISO);

            const cell = el("div", {
              class: "calCell" + (on ? " on" : ""),
              text: String(d),
              onClick: () => {
                toggleTrained(dateISO);
                repaint();
                renderView(); // updates Home dots too
              }
            });

            grid.appendChild(cell);
          }

          // pad to full weeks for cleaner bottom edge (optional)
          const totalCells = 7 + leading + dim; // +7 for header row
          const remainder = totalCells % 7;
          if(remainder !== 0){
            const pads = 7 - remainder;
            for(let i=0;i<pads;i++){
              grid.appendChild(el("div", { class:"calCell blank", text:"" }));
            }
          }
        }
      },
         Settings(){
        // Persist across renders (not saved to Storage)
const ui = UIState.settings || (UIState.settings = {});

// ✅ ensure accordion state exists so taps don’t crash
if(!ui.open || typeof ui.open !== "object") ui.open = {};

// ✅ default: open Profile the first time Settings is visited
if(Object.keys(ui.open).length === 0) ui.open.profile = true;

        const normalize = (s) => (s||"").toString().trim().toLowerCase();

        // Accordion builder
        const makeSection = ({ key, title, subtitle, keywords, bodyNode }) => {
          const q = normalize(ui.q);
          const hay = normalize([title, subtitle, ...(keywords||[])].join(" "));
          const match = !q || hay.includes(q);

          // Auto-open if searching and matched
          const isOpen = !!ui.open?.[key] || (q && match);

          const item = el("div", { class:"accItem", style: match ? "" : "display:none;" });

          const head = el("div", {
            class:"accHead",
          onClick: () => {
  ui.open = ui.open || {};
  ui.open[key] = !ui.open[key];
  renderView();
}
          }, [
            el("div", {}, [
              el("div", { class:"accTitle", text: title }),
              el("div", { class:"accSub", text: subtitle })
            ]),
            el("div", { class:"accCaret", text: isOpen ? "−" : "+" })
          ]);

          const body = el("div", { class:"accBody", style: isOpen ? "" : "display:none;" }, [ bodyNode ]);

          item.appendChild(head);
          item.appendChild(body);
          return item;
        };

        // --- Profile controls ---
        const nameInput = el("input", { type:"text", value: state.profile?.name || "" });
        const proteinInput = el("input", { type:"number", min:"0", step:"1", value: state.profile?.proteinGoal || 150 });

               const weekSelect = el("select", {});
        weekSelect.appendChild(el("option", { value:"sun", text:"Sunday" }));
        weekSelect.appendChild(el("option", { value:"mon", text:"Monday" }));

        // Backward compatible: accept older numeric values (0/1) if they exist
        const ws = state.profile?.weekStartsOn;
        const normalized =
          (ws === 0 || ws === "0" || ws === "sun") ? "sun" :
          (ws === 1 || ws === "1" || ws === "mon") ? "mon" :
          "mon";
        weekSelect.value = normalized;


        let hideRestDays = !!state.profile?.hideRestDays;

const hideRestSwitch = el("div", {
  class: "switch" + (hideRestDays ? " on" : ""),
  onClick: () => {
    hideRestDays = !hideRestDays;
    hideRestSwitch.classList.toggle("on", hideRestDays);
  }
});


        function saveProfile(){
          state.profile = state.profile || {};
          state.profile.name = (nameInput.value || "").trim();
          state.profile.proteinGoal = Math.max(0, Number(proteinInput.value || 0));
          state.profile.weekStartsOn = (weekSelect.value === "sun") ? "sun" : "mon";
state.profile.hideRestDays = !!hideRestDays;
          Storage.save(state);
          showToast("Saved");
          renderView();
        }

        // --- Existing import/export helpers (reuse your current functions) ---
        function openImportPasteModal(){
          const ta = el("textarea", {
            style:"width:100%; min-height: 260px; border-radius: 14px; padding: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: rgba(255,255,255,.92); font-size: 12px; outline:none; resize: vertical;",
            placeholder:"Paste your backup JSON here…"
          });

          const err = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

          Modal.open({
            title: "Import from paste",
            bodyNode: el("div", {}, [
              el("div", { class:"note", text:"This will overwrite your current data in this browser." }),
              el("div", { style:"height:10px" }),
              ta,
              err,
              el("div", { style:"height:12px" }),
              el("div", { class:"btnrow" }, [
                el("button", {
                  class:"btn danger",
                  onClick: () => {
                    err.style.display = "none";
                    try{
                      importBackupJSON(ta.value || "");
                      Modal.close();
                      navigate("home");
                    }catch(e){
                      err.textContent = e.message || "Import failed.";
                      err.style.display = "block";
                    }
                  }
                }, ["Import (overwrite)"]),
                el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
              ])
            ])
          });
        }

        function openImportFileModal(){
          const input = el("input", { type:"file", accept:"application/json,.json" });
          const err = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

          Modal.open({
            title: "Import from file",
            bodyNode: el("div", {}, [
              el("div", { class:"note", text:"Choose a .json backup file. Import overwrites current data." }),
              el("div", { style:"height:10px" }),
              input,
              err,
              el("div", { style:"height:12px" }),
              el("div", { class:"btnrow" }, [
                el("button", {
                  class:"btn danger",
                  onClick: async () => {
                    err.style.display = "none";
                    try{
                      const f = input.files?.[0];
                      if(!f) throw new Error("Select a JSON file first.");
                      const txt = await f.text();
                      importBackupJSON(txt);
                      Modal.close();
                      navigate("home");
                    }catch(e){
                      err.textContent = e.message || "Import failed.";
                      err.style.display = "block";
                    }
                  }
                }, ["Import (overwrite)"]),
                el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
              ])
            ])
          });
        }

        // --- Section bodies ---
        const profileBody = el("div", {}, [
          el("div", { class:"setRow" }, [
            el("div", {}, [
              el("div", { style:"font-weight:820;", text:"Name" }),
              el("div", { class:"meta", text:"Shown on Home" })
            ]),
            nameInput
          ]),
          el("div", { class:"setRow" }, [
            el("div", {}, [
              el("div", { style:"font-weight:820;", text:"Daily protein goal" }),
              el("div", { class:"meta", text:"grams/day" })
            ]),
            proteinInput
          ]),
          el("div", { class:"setRow" }, [
            el("div", {}, [
              el("div", { style:"font-weight:820;", text:"Week starts on" }),
              el("div", { class:"meta", text:"Affects Home week view" })
            ]),
            weekSelect
          ]),
          el("div", { class:"setRow" }, [
            el("div", {}, [
              el("div", { style:"font-weight:820;", text:"Hide rest days" }),
              el("div", { class:"meta", text:"Keep Home focused on training days" })
            ]),
            hideRestSwitch
          ]),
          el("div", { style:"height:12px" }),
          el("div", { class:"btnrow" }, [
            el("button", { class:"btn primary", onClick: () => {
              try{ saveProfile(); }
              catch(e){
                Modal.open({
                  title:"Save failed",
                  bodyNode: el("div", {}, [
                    el("div", { class:"note", text: e?.message || "Could not save settings." }),
                    el("div", { style:"height:12px" }),
                    el("button", { class:"btn primary", onClick: Modal.close }, ["OK"])
                  ])
                });
              }
            }}, ["Save changes"])
          ])
        ]);

        const libraryBody = el("div", {}, [
          el("div", { class:"setLink", onClick: () => navigate("exercise_library") }, [
            el("div", { class:"l" }, [
              el("div", { class:"a", text:"Open Exercise Library Manager" }),
              el("div", { class:"b", text:"Add, edit, and delete exercises" })
            ]),
            el("div", { style:"opacity:.8", text:"→" })
          ]),
          el("div", { style:"height:10px" }),
          el("div", { class:"note", text:"Tip: Exercises removed from the library will still display in old logs using the saved name snapshot." })
        ]);

        const backupBody = el("div", {}, [
          el("div", { class:"note", text:"Export your full app data as JSON. Import will overwrite your current data in this browser." }),
          el("div", { style:"height:10px" }),
          el("div", { class:"btnrow" }, [
            el("button", {
              class:"btn primary",
              onClick: () => {
                try{
                  const txt = exportBackupJSON();
                  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
                  downloadTextFile(`gym-dashboard-backup_${stamp}.json`, txt);
                }catch(e){
                  Modal.open({
                    title:"Export failed",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text: e.message || "Could not export backup." }),
                      el("div", { style:"height:12px" }),
                      el("button", { class:"btn primary", onClick: Modal.close }, ["OK"])
                    ])
                  });
                }
              }
            }, ["Export JSON backup"]),
            el("button", {
              class:"btn",
              onClick: () => {
                Modal.open({
                  title: "Copy backup JSON",
                  bodyNode: el("div", {}, [
                    el("div", { class:"note", text:"Copy/paste this JSON anywhere safe." }),
                    el("div", { style:"height:10px" }),
                    el("textarea", {
                      style:"width:100%; min-height: 260px; border-radius: 14px; padding: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: rgba(255,255,255,.92); font-size: 12px; outline:none; resize: vertical;",
                    }, [exportBackupJSON()]),
                    el("div", { style:"height:12px" }),
                    el("button", { class:"btn primary", onClick: Modal.close }, ["Done"])
                  ])
                });
              }
            }, ["View JSON"])
          ]),
          el("div", { style:"height:14px" }),
          el("div", { class:"note", text:"Import options:" }),
          el("div", { style:"height:8px" }),
          el("div", { class:"btnrow" }, [
            el("button", { class:"btn danger", onClick: openImportPasteModal }, ["Import (paste JSON)"]),
            el("button", { class:"btn danger", onClick: openImportFileModal }, ["Import (upload file)"])
          ]),
          el("div", { style:"height:10px" }),
          el("div", { class:"note", text:"Tip: Export a backup before you import." })
        ]);

        const dataBody = el("div", {}, [
          el("div", { class:"note", text:"Repair tools and targeted clears." }),
          el("div", { style:"height:10px" }),

          el("div", { class:"setLink", onClick: () => {
            confirmModal({
              title: "Repair workout logs",
              note: "Removes duplicate log entries (same date + routine exercise). Keeps the most recent.",
              confirmText: "Repair logs",
              danger: true,
              onConfirm: () => {
                const seen = new Map();
                const cleaned = [];
                (state.logs?.workouts || [])
                  .slice()
                  .sort((a,b)=> (b.createdAt||0) - (a.createdAt||0))
                  .forEach(e => {
                    const key = `${e.dateISO}_${e.routineExerciseId}`;
                    if(!seen.has(key)){
                      seen.set(key,true);
                      cleaned.push(e);
                    }
                  });
                state.logs.workouts = cleaned;
                Storage.save(state);
                showToast("Duplicates removed");
              }
            });
          }}, [
            el("div", { class:"l" }, [
              el("div", { class:"a", text:"Repair workout logs" }),
              el("div", { class:"b", text:"Remove duplicates (keeps most recent)" })
            ]),
            el("div", { style:"opacity:.8", text:"→" })
          ]),

          el("div", { style:"height:10px" }),
          el("div", { class:"note", text:"Clear specific data:" }),
          el("div", { style:"height:8px" }),

          el("div", { class:"btnrow" }, [
            el("button", {
              class:"btn danger",
              onClick: () => confirmModal({
                title: "Clear workout logs",
                note: "Deletes all workout logs. This cannot be undone.",
                confirmText: "Clear workouts",
                danger: true,
                onConfirm: () => { state.logs.workouts = []; Storage.save(state); showToast("Workout logs cleared"); }
              })
            }, ["Clear workouts"]),
            el("button", {
              class:"btn danger",
              onClick: () => confirmModal({
                title: "Clear weight logs",
                note: "Deletes all weigh-ins. This cannot be undone.",
                confirmText: "Clear weight",
                danger: true,
                onConfirm: () => { state.logs.weight = []; Storage.save(state); showToast("Weight logs cleared"); }
              })
            }, ["Clear weight"])
          ]),
          el("div", { style:"height:10px" }),
          el("div", { class:"btnrow" }, [
            el("button", {
              class:"btn danger",
              onClick: () => confirmModal({
                title: "Clear protein logs",
                note: "Deletes all protein entries. This cannot be undone.",
                confirmText: "Clear protein",
                danger: true,
                onConfirm: () => { state.logs.protein = []; Storage.save(state); showToast("Protein logs cleared"); }
              })
            }, ["Clear protein"]),
            el("button", {
              class:"btn danger",
              onClick: () => confirmModal({
                title: "Clear attendance",
                note: "Deletes attendance history. This cannot be undone.",
                confirmText: "Clear attendance",
                danger: true,
                onConfirm: () => { state.attendance = []; Storage.save(state); showToast("Attendance cleared"); }
              })
            }, ["Clear attendance"])
          ])
        ]);

        const debugBody = el("div", {}, [
          el("div", { class:"note", text:`Schema v${state.schemaVersion} • Approx storage: ${bytesToNice(appStorageBytes())}` }),
          el("div", { style:"height:10px" }),
          el("div", { class:"btnrow" }, [
            el("button", {
              class:"btn",
              onClick: () => Modal.open({
                title: "Current State (JSON)",
                bodyNode: el("pre", { style:"white-space:pre-wrap; font-size:12px; color: rgba(255,255,255,.85);" }, [
                  JSON.stringify(state, null, 2)
                ])
              })
            }, ["View state JSON"]),
            el("button", {
              class:"btn danger",
              onClick: () => {
                Modal.open({
                  title: "Reset local data",
                  bodyNode: el("div", {}, [
                    el("div", { class:"note", text:"This clears everything saved in this browser for the app." }),
                    el("div", { style:"height:12px" }),
                    el("div", { class:"btnrow" }, [
                      el("button", {
                        class:"btn danger",
                        onClick: () => {
                          Storage.reset();
                          state = Storage.load();
                          Modal.close();
                          navigate("home");
                        }
                      }, ["Reset"]),
                      el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                    ])
                  ])
                });
              }
            }, ["Reset local data"])
          ])
        ]);

        // --- Search Bar ---
        const searchInput = el("input", {
          type:"text",
          placeholder:"Search settings…",
          value: ui.q || ""
        });
        searchInput.addEventListener("input", (e) => {
          ui.q = e.target.value || "";
          renderView();
        });

        const root = el("div", { class:"settingsWrap" }, [
          el("div", { class:"settingsSearch" }, [
            el("div", { class:"ico", text:"🔎" }),
            searchInput
          ]),
          el("div", { class:"accList" }, [
            makeSection({
              key:"profile",
              title:"Profile & Preferences",
              subtitle:"Name, protein goal, week start, rest days",
              keywords:["name","protein","week","rest","goal"],
              bodyNode: profileBody
            }),
            makeSection({
              key:"library",
              title:"Exercise Library",
              subtitle:"Manage exercises (add/edit/delete)",
              keywords:["exercise","library","weightlifting","cardio","core"],
              bodyNode: libraryBody
            }),
            makeSection({
              key:"backup",
              title:"Backup & Restore",
              subtitle:"Export/import JSON backups",
              keywords:["backup","import","export","json","restore"],
              bodyNode: backupBody
            }),
            makeSection({
              key:"data",
              title:"Data Tools",
              subtitle:"Repair duplicates + clear specific data",
              keywords:["repair","duplicates","clear","logs","attendance"],
              bodyNode: dataBody
            }),
            makeSection({
              key:"debug",
              title:"Debug / About",
              subtitle:"View raw state + reset local data",
              keywords:["debug","reset","state","storage"],
              bodyNode: debugBody
            })
          ])
        ]);

        return root;
      }
    }; // ✅ end Views object
    Views.ExerciseLibraryManager = function(){
  ExerciseLibrary.ensureSeeded();

  const ui = UIState.libraryManage;
  const root = el("div", { class:"grid" });

  // Header
  root.appendChild(el("div", { class:"card" }, [
    el("div", { class:"kpi" }, [
      el("div", { class:"big", text:"Exercise Library" }),
      el("div", { class:"small", text:"Search, add, edit, or delete exercises." })
    ]),
    el("div", { style:"height:10px" }),
    el("div", { class:"btnrow" }, [
      el("button", { class:"btn", onClick: () => navigate("settings") }, ["← Settings"]),
      el("button", { class:"btn primary", onClick: () => openAddEditModal(null) }, ["+ Add Exercise"])
    ])
  ]));

  // Controls
  const controls = el("div", { class:"card" }, [ el("h2", { text:"Filters" }) ]);

  const typeChips = el("div", { class:"chips" });
  ExerciseLibrary.typeKeys.forEach(t => {
    typeChips.appendChild(el("div", {
      class:"chip" + (ui.type === t ? " on" : ""),
      onClick: () => { ui.type = t; ui.equipment = "all"; renderView(); }
    }, [ExerciseLibrary.typeLabel(t)]));
  });

  const search = el("input", { type:"text", placeholder:"Search exercises…", value: ui.q || "" });
  search.addEventListener("input", (e) => { ui.q = e.target.value || ""; renderView(); });

  const equipSelect = el("select", {});
  equipSelect.appendChild(el("option", { value:"all", text:"All equipment" }));
  const equipSet = new Set();
  ExerciseLibrary.list(ui.type).forEach(x => { if(x.equipment) equipSet.add(x.equipment); });
  Array.from(equipSet).sort().forEach(eq => equipSelect.appendChild(el("option", { value:eq, text:eq })));
  equipSelect.value = ui.equipment || "all";
  equipSelect.addEventListener("change", (e) => { ui.equipment = e.target.value || "all"; renderView(); });

  controls.appendChild(el("div", { class:"note", text:"Type" }));
  controls.appendChild(typeChips);
  controls.appendChild(el("div", { style:"height:10px" }));
  controls.appendChild(el("div", { class:"row2" }, [
    el("label", {}, [ el("span", { text:"Search" }), search ]),
    el("label", {}, [ el("span", { text:"Equipment" }), equipSelect ])
  ]));

  root.appendChild(controls);

  // List
  const listCard = el("div", { class:"card" }, [
    el("h2", { text:"Exercises" }),
    el("div", { class:"note", text:"Tip: Deleting an exercise will not erase old logs (they use the saved name snapshot)." })
  ]);

  const listHost = el("div", { style:"display:flex; flex-direction:column; gap:10px; margin-top:10px;" });

  const q = (ui.q || "").trim().toLowerCase();
  const eq = ui.equipment || "all";

  const items = ExerciseLibrary.list(ui.type)
    .filter(x => !q || (x.name || "").toLowerCase().includes(q))
    .filter(x => eq === "all" || (x.equipment || "") === eq)
    .sort((a,b) => (a.name || "").localeCompare(b.name || ""));

  if(items.length === 0){
    listHost.appendChild(el("div", { class:"note", text:"No exercises match your filters." }));
  } else {
    items.forEach(ex => {
      const sub = (() => {
        if(ui.type === "weightlifting"){
          const parts = [];
          if(ex.primaryMuscle) parts.push(ex.primaryMuscle);
          if(ex.equipment) parts.push(ex.equipment);
          if(typeof ex.isCompound === "boolean") parts.push(ex.isCompound ? "compound" : "isolation");
          return parts.join(" • ") || "—";
        }
        if(ui.type === "cardio"){
          const parts = [];
          if(ex.modality) parts.push(ex.modality);
          if(ex.supportsIncline) parts.push("incline");
          return parts.join(" • ") || "—";
        }
        const parts = [];
        if(ex.equipment) parts.push(ex.equipment);
        return parts.join(" • ") || "—";
      })();

      listHost.appendChild(el("div", { class:"item" }, [
        el("div", { style:"font-weight:860; letter-spacing:.1px;", text: ex.name }),
        el("div", { class:"meta", text: sub }),
        el("div", { style:"height:10px" }),
        el("div", { class:"btnrow" }, [
          el("button", { class:"btn", onClick: () => openAddEditModal(ex) }, ["Edit"]),
          el("button", { class:"btn danger", onClick: () => attemptDelete(ex) }, ["Delete"])
        ])
      ]));
    });
  }

  listCard.appendChild(listHost);
  root.appendChild(listCard);

  function countRoutineRefs(type, exerciseId){
    let count = 0;
    (state.routines || []).forEach(r => {
      (r.days || []).forEach(d => {
        (d.exercises || []).forEach(rx => {
          if(rx.type === type && rx.exerciseId === exerciseId) count++;
        });
      });
    });
    return count;
  }

  function attemptDelete(ex){
    const refs = countRoutineRefs(ui.type, ex.id);
    const note = refs
      ? `This exercise is currently used in ${refs} routine slot(s). Deleting it will remove it from those routines.`
      : "Delete this exercise from your library?";

    confirmModal({
      title: "Delete exercise",
      note,
      confirmText: "Delete",
      danger: true,
      onConfirm: () => {
        ExerciseLibrary.remove(ui.type, ex.id);
        Storage.save(state);
        showToast("Deleted");
        renderView();
      }
    });
  }

  function openAddEditModal(existing){
    const isEdit = !!existing;
    const name = el("input", { type:"text", value: existing?.name || "", placeholder:"Exercise name" });

    // Lightweight per-type optional fields
    const equip = el("input", { type:"text", value: existing?.equipment || "", placeholder:"e.g., Dumbbell, Barbell, Machine" });
    const primary = el("input", { type:"text", value: existing?.primaryMuscle || "", placeholder:"e.g., Chest, Back, Legs" });

    Modal.open({
      title: isEdit ? "Edit exercise" : "Add exercise",
      bodyNode: el("div", {}, [
        el("div", { class:"note", text:`Type: ${ExerciseLibrary.typeLabel(ui.type)}` }),
        el("div", { style:"height:10px" }),
        el("div", { class:"row2" }, [
          el("label", {}, [ el("span", { text:"Name" }), name ]),
          el("label", {}, [ el("span", { text:"Equipment" }), equip ])
        ]),
        ui.type === "weightlifting"
          ? el("div", { style:"margin-top:10px" }, [
              el("label", {}, [ el("span", { text:"Primary muscle" }), primary ])
            ])
          : el("div", { style:"height:0px" }),
        el("div", { style:"height:12px" }),
        el("div", { class:"btnrow" }, [
          el("button", {
            class:"btn primary",
            onClick: () => {
              const nm = (name.value || "").trim();
              if(!nm) return showToast("Name is required");
              const payload = {
                id: existing?.id || uid("ex"),
                name: nm,
                equipment: (equip.value || "").trim()
              };
              if(ui.type === "weightlifting"){
                payload.primaryMuscle = (primary.value || "").trim();
              }
              if(isEdit) ExerciseLibrary.update(ui.type, payload);
              else ExerciseLibrary.add(ui.type, payload);
              Storage.save(state);
              Modal.close();
              showToast(isEdit ? "Updated" : "Added");
              renderView();
            }
          }, [isEdit ? "Save" : "Add"]),
          el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
        ])
      ])
    });
  }

  return root;
};
Views.RoutineEditor = function(){
  ExerciseLibrary.ensureSeeded();

  const root = el("div", { class:"grid" });
  const active = Routines.getActive();

  if(!active){
    root.appendChild(el("div", { class:"card" }, [
      el("h2", { text:"Routine Editor" }),
      el("div", { class:"note", text:"No active routine found. Go back and select a routine." }),
      el("div", { style:"height:12px" }),
      el("button", { class:"btn primary", onClick: () => navigate("routine") }, ["Back to Routine"])
    ]));
    return root;
  }

  const header = el("div", { class:"card" }, [
    el("h2", { text:"Routine Editor" }),
    el("div", { class:"note", text:`Editing: ${active.name}` }),
    el("div", { style:"height:10px" }),
    el("div", { class:"btnrow" }, [
      el("button", {
        class:"btn",
        onClick: () => navigate("routine")
      }, ["Back to Routine"]),
      el("button", {
        class:"btn",
        onClick: (e) => renameRoutine(e.currentTarget, active.id)
      }, ["Rename"]),
      el("button", {
        class:"btn",
        onClick: () => { Routines.duplicate(active.id); renderView(); }
      }, ["Duplicate"]),
      el("button", {
        class:"btn danger",
        onClick: (e) => confirmDelete(e.currentTarget, active.id)
      }, ["Delete"])
    ])
  ]);
  // ────────────────────────────
  // Templates (same 5 as Onboarding)
  // ────────────────────────────
  const templatesCard = el("div", { class:"card" }, [
    el("h2", { text:"Templates" }),
    el("div", { class:"note", text:"Choose a template to switch your active routine. If it already exists, it will activate (no duplicates)." }),
    el("div", { style:"height:10px" })
  ]);

  const tplList = el("div", { class:"list" });

  function findExistingRoutineForTemplate(tpl){
    const all = Routines.getAll() || [];
    // Prefer templateKey match
    const byKey = all.find(r => String(r.templateKey || "") === String(tpl.key || ""));
    if(byKey) return byKey;
    // Fallback to name match (older saves)
    const byName = all.find(r => normName(r.name) === normName(tpl.name));
    return byName || null;
  }

  (RoutineTemplates || []).forEach(tpl => {
    const existing = findExistingRoutineForTemplate(tpl);

    tplList.appendChild(el("div", {
      class:"item",
      onClick: () => {
        // If it exists, activate it (no recreation)
        const existingNow = findExistingRoutineForTemplate(tpl);
        if(existingNow){
          Routines.setActive(existingNow.id);
          showToast(`Active: ${existingNow.name}`);
          renderView(); // re-render editor on the newly active routine
          return;
        }

        // Otherwise create ONE routine for that template (exact template name)
        Routines.addFromTemplate(tpl.key, tpl.name);
        showToast(`Created: ${tpl.name}`);
        renderView();
      }
    }, [
      el("div", { class:"left" }, [
        el("div", { class:"name", text: tpl.name }),
        el("div", { class:"meta", text: tpl.desc || "Template" })
      ]),
      el("div", { class:"actions" }, [
        el("div", { class:"meta", text: existing ? "Activate" : "Add" })
      ])
    ]));
  });

  templatesCard.appendChild(tplList);

  const daysCard = el("div", { class:"card" }, [
    el("h2", { text:"Days" }),
    el("div", { class:"note", text:"Tap a day to edit label, rest day, or exercises." })
  ]);

  const daysGrid = el("div", { class:"dayGrid" });
  daysCard.appendChild(el("div", { style:"height:10px" }));
  daysCard.appendChild(daysGrid);

  root.appendChild(header);
  root.appendChild(templatesCard);
  root.appendChild(daysCard);

  repaintDays();
  return root;

  function repaintDays(){
    const r = Routines.getActive();
    daysGrid.innerHTML = "";

    (r.days || []).forEach(day => {
      const exCount = (day.exercises || []).length;

      const card = el("div", { class:"dayCard" }, [
        el("div", { class:"dayTop" }, [
          el("div", { class:"dayTitle" }, [
            el("div", { class:"lbl", text: `${["SUN","MON","TUE","WED","THU","FRI","SAT"][day.order]} — ${day.label}` }),
            el("div", { class:"sub", text: day.isRest ? "Rest day" : `${exCount} exercises` })
          ]),
          el("button", {
            class:"mini",
            onClick: () => editDay(day)
          }, ["Edit"])
        ])
      ]);

      const list = el("div", { class:"exList" });

      if(day.isRest){
        list.appendChild(el("div", { class:"note", text:"No exercises on rest days." }));
      }else if(exCount === 0){
        list.appendChild(el("div", { class:"note", text:"No exercises yet. Tap Edit → Add exercise." }));
      }else{
        (day.exercises || []).forEach(rx => {
          const name = resolveExerciseName(rx.type, rx.exerciseId, rx.nameSnap);
          list.appendChild(el("div", { class:"exRow" }, [
            el("div", { class:"n", text:name }),
            el("button", {
              class:"mini danger",
              onClick: () => { Routines.removeExerciseFromDay(r.id, day.id, rx.id); repaintDays(); }
            }, ["Remove"])
          ]));
        });
      }

      card.appendChild(list);
      daysGrid.appendChild(card);
    });
  }

function renameRoutine(anchorEl, routineId){
  const current = Routines.getActive();
  const input = el("input", {
    type:"text",
    value: current?.name || "",
    style:"width:100%;"
  });

  const err = el("div", {
    class:"note",
    style:"display:none; color: rgba(255,92,122,.95); margin-top:8px;"
  });

  const body = el("div", {}, [
    el("div", { class:"popTitle", text:"Rename routine" }),
    el("div", { style:"display:grid; gap:10px;" }, [
      input,
      err,
      el("div", { class:"btnrow" }, [
        el("button", {
          class:"btn primary",
          onClick: () => {
            err.style.display = "none";
            const name = (input.value || "").trim();
            if(!name){
              err.textContent = "Enter a name.";
              err.style.display = "block";
              return;
            }
            Routines.rename(routineId, name);
            PopoverClose();
            renderView();
          }
        }, ["Save"]),
        el("button", { class:"btn", onClick: PopoverClose }, ["Cancel"])
      ])
    ])
  ]);

  PopoverOpen(anchorEl, body);
  setTimeout(() => input.focus(), 0);
}

function confirmDelete(anchorEl, routineId){
  const body = el("div", {}, [
    el("div", { class:"popTitle", text:"Delete routine?" }),
    el("div", { class:"note", text:"This deletes the routine. Logs stay, but the routine schedule will be removed." }),
    el("div", { style:"height:10px" }),
    el("div", { class:"btnrow" }, [
      el("button", {
        class:"btn danger",
        onClick: () => {
          Routines.remove(routineId);
          PopoverClose();
          navigate("routine");
        }
      }, ["Delete"]),
      el("button", { class:"btn", onClick: PopoverClose }, ["Cancel"])
    ])
  ]);

  PopoverOpen(anchorEl, body);
}

  function editDay(day){
    const r = Routines.getActive();

    const labelInput = el("input", { type:"text", value: day.label || "" });

    const restSwitch = el("div", { class:"switch" + (day.isRest ? " on" : "") });
    restSwitch.addEventListener("click", () => {
      const next = !restSwitch.classList.contains("on");
      restSwitch.classList.toggle("on", next);
    });

const addBtn = el("button", {
  class:"btn primary",
  onClick: () => openAddExercise(r.id, day.id, { keepOpen:false })
}, ["Add exercise"]);

const addMultiBtn = el("button", {
  class:"btn",
  onClick: () => openAddExercise(r.id, day.id, { keepOpen:true })
}, ["Add multiple"]);


    Modal.open({
      title: "Edit day",
      bodyNode: el("div", {}, [
        el("label", {}, [ el("span", { text:"Label" }), labelInput ]),
        el("div", { style:"height:10px" }),
        el("div", { class:"toggle" }, [
          el("div", { class:"ttext" }, [
            el("div", { class:"a", text:"Rest day" }),
            el("div", { class:"b", text:"If enabled, exercises are hidden on Routine." })
          ]),
          restSwitch
        ]),
        el("div", { style:"height:12px" }),
        el("div", { class:"btnrow" }, [ addBtn, addMultiBtn ]),
        el("div", { style:"height:12px" }),
        el("div", { class:"btnrow" }, [
          el("button", {
            class:"btn",
            onClick: () => {
              const nextLabel = (labelInput.value || "").trim() || day.label;
              const isRest = restSwitch.classList.contains("on");
              Routines.setDayLabel(r.id, day.id, nextLabel);
              Routines.setRestDay(r.id, day.id, isRest);
              Modal.close();
              repaintDays();
            }
          }, ["Save"]),
          el("button", { class:"btn", onClick: Modal.close }, ["Close"])
        ])
      ])
    });
  }

  function openAddExercise(routineId, dayId, opts={}){
    let type = "weightlifting";

    const seg = el("div", { class:"seg" }, [
      el("button", { class:"segbtn active", onClick: () => setType("weightlifting") }, ["Weightlifting"]),
      el("button", { class:"segbtn", onClick: () => setType("cardio") }, ["Cardio"]),
      el("button", { class:"segbtn", onClick: () => setType("core") }, ["Core"])
    ]);

    const list = el("div", { class:"list" });

    function setType(t){
      type = t;
      [...seg.querySelectorAll(".segbtn")].forEach(b => b.classList.remove("active"));
      if(t === "weightlifting") seg.children[0].classList.add("active");
      if(t === "cardio") seg.children[1].classList.add("active");
      if(t === "core") seg.children[2].classList.add("active");
      repaint();
      updateLiveCount();
    }

// Tracks what the user adds during THIS open session (for live count)
const addedThisSession = new Set();

// Live count UI (only shown in keepOpen mode)
const liveCount = el("div", {
  class:"note",
  style:"margin-top:8px; margin-bottom:10px; display:none;"
}, ["0 exercises added"]);

function updateLiveCount(){
  if(!opts.keepOpen){
    liveCount.style.display = "none";
    return;
  }
  liveCount.style.display = "block";
  liveCount.textContent =
    `${addedThisSession.size} exercise${addedThisSession.size === 1 ? "" : "s"} added`;
}

function getExistingSetForDay(){
  const r = Routines.getActive();
  const day = (r?.days || []).find(d => d.id === dayId);
  const s = new Set();
  (day?.exercises || []).forEach(rx => {
    // store by type+id to avoid collisions across categories
    s.add(`${rx.type}:${rx.exerciseId}`);
  });
  return s;
}

function repaint(){
  list.innerHTML = "";

  const existing = getExistingSetForDay();

  const items = (state.exerciseLibrary?.[type] || []).slice()
    .sort((a,b) => (a.name||"").localeCompare(b.name||""));

  if(items.length === 0){
    list.appendChild(el("div", {
      class:"note",
      text:"No exercises in this category yet. Add them in Settings later."
    }));
    updateLiveCount();
    return;
  }

  items.forEach(x => {
    const key = `${type}:${x.id}`;
    const alreadyInDay = existing.has(key);

    const row = el("div", { class:"item" });
    const btn = el("button", { class:"mini" }, ["Add"]);

    row.appendChild(
      el("div", { class:"left" }, [
        el("div", { class:"name", text:x.name }),
        el("div", { class:"meta", text: ExerciseLibrary.typeLabel(type) })
      ])
    );

    row.appendChild(el("div", { class:"actions" }, [ btn ]));

    // Disable if already in the day (persist across reopen)
    if(alreadyInDay){
      row.classList.add("selected", "disabledRow");
      btn.classList.add("added", "disabledBtn");
      btn.textContent = "Added ✓";
      btn.disabled = true;
    }

    btn.addEventListener("click", () => {
      if(btn.disabled) return; // guard: no duplicates

      Routines.addExerciseToDay(routineId, dayId, type, x.id);
      repaintDays();

      if(opts.keepOpen){
        addedThisSession.add(key);
        row.classList.add("selected");
        btn.classList.add("added", "disabledBtn");
        btn.textContent = "Added ✓";
        btn.disabled = true;

        updateLiveCount();
      }else{
        Modal.close();
      }
    });

    list.appendChild(row);
  });

  updateLiveCount();
}

repaint();
updateLiveCount();

Modal.open({
  title: "Add exercise",
  bodyNode: el("div", {}, [
    seg,
    liveCount,
    list,
    el("div", { style:"height:12px" }),
    el("button", { class:"btn", onClick: Modal.close }, ["Close"])
  ])
});
  } // ✅ closes openAddExercise
};   // ✅ closes Views.RoutineEditor function
/********************
 * 8) Boot (guarded)
 ********************/
try{
  // If already onboarded and library is empty, seed it (won't overwrite non-empty)
  if(state.profile) ExerciseLibrary.ensureSeeded();

  // Step 6 safety: ensure logs arrays exist even if older saved state is missing fields
  LogEngine.ensure();

  // Keep an accurate header height for internal fixed/scroll layouts
  function updateLayoutVars(){
    const h = document.querySelector("header");
    if(h) document.documentElement.style.setProperty("--headerH", `${h.offsetHeight}px`);
  }
  updateLayoutVars();
  window.addEventListener("resize", updateLayoutVars);

  ensureFloatNext(); // Phase 3: enable Floating Next → nudge container

  // Render baseline UI first (so user never sees a blank app)
  renderNav();
  renderView();
  bindHeaderPills();
  setHeaderPills();

  // True "Reload to update" support
  registerServiceWorker();

  // Fetch version.json so the version pill + What's New reflect the latest release
  checkForUpdates();

}catch(e){
  __fatal(e, "boot");
}
  </script>
</body>
</html>
