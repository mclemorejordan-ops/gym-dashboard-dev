<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />

  <!-- iOS Add to Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Gym Dashboard" />

  <title>Gym Dashboard</title>

  <!-- Chart.js (used later in Progress/Weight) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --hair: rgba(255,255,255,.10);

      --accent: #7c5cff;
      --good: #37d67a;
      --warn: #ffd166;
      --bad: #ff5c7a;

      --r: 18px;
      --shadow: 0 18px 40px rgba(0,0,0,.45);

      --navH: 78px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.24), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(55,214,122,.14), transparent 55%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    .app{
      min-height: 100%;
      padding: env(safe-area-inset-top) 14px calc(var(--navH) + env(safe-area-inset-bottom)) 14px;
      max-width: 780px;
      margin: 0 auto;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(11,15,23,.88), rgba(11,15,23,.55));
      padding: 14px 0 10px 0;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 4px 2px 6px 2px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .brand .title{
      font-weight: 720;
      letter-spacing: .2px;
      font-size: 18px;
      line-height: 1.15;
    }
    .brand .subtitle{
      font-size: 12px;
      color: var(--muted);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--hair);
      color: var(--text);
      font-size: 13px;
      user-select:none;
      max-width: 52vw;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    main{ padding-top: 10px; }

    .grid{
      display:grid;
      gap: 12px;
    }
    @media (min-width: 640px){
      .grid.cols2{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--hair);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px 0;
      font-size: 14px;
      letter-spacing: .3px;
      color: var(--muted);
      font-weight: 650;
      text-transform: uppercase;
    }

    .btnrow{ display:flex; gap: 10px; flex-wrap: wrap; }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 650;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid var(--hair);
      user-select:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.75));
      border-color: rgba(124,92,255,.35);
    }
    .btn.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }
    .btn:active{ transform: translateY(1px); }

    .muted{ color: var(--muted); }
    .kpi{
      display:flex;
      flex-direction:column;
      gap: 4px;
      padding: 8px 0 0 0;
    }
    .kpi .big{
      font-size: 22px;
      font-weight: 760;
      letter-spacing: .2px;
    }
    .kpi .small{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }

    .form{ display:grid; gap: 10px; }
    .row2{ display:grid; gap: 10px; }
    @media (min-width: 640px){ .row2{ grid-template-columns: 1fr 1fr; } }

    label{
      display:flex;
      flex-direction:column;
      gap: 7px;
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 650;
      letter-spacing: .2px;
    }
    input, select{
      appearance:none;
      border-radius: 14px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    input::placeholder{ color: rgba(255,255,255,.35); }
    input:focus, select:focus{
      border-color: rgba(124,92,255,.40);
      box-shadow: 0 0 0 4px rgba(124,92,255,.14);
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 12px 12px;
    }
    .toggle .ttext{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .toggle .ttext .a{ color: var(--text); font-weight: 700; font-size: 14px; }
    .toggle .ttext .b{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    .switch{
      width: 52px;
      height: 30px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      position: relative;
      flex: 0 0 auto;
      cursor:pointer;
      user-select:none;
    }
    .switch::after{
      content:"";
      position:absolute;
      top: 50%;
      left: 3px;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.82);
      transition: left .16s ease, background .16s ease;
    }
    .switch.on{
      background: rgba(124,92,255,.30);
      border-color: rgba(124,92,255,.34);
    }
    .switch.on::after{
      left: 25px;
      background: rgba(255,255,255,.92);
    }

    .tplGrid{ display:grid; gap: 10px; }
    @media (min-width: 640px){ .tplGrid{ grid-template-columns: 1fr 1fr; } }
    .tpl{
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease;
    }
    .tpl:active{ transform: translateY(1px); }
    .tpl .name{ font-weight: 780; letter-spacing: .2px; margin-bottom: 4px; }
    .tpl .desc{ color: var(--muted); font-size: 12.5px; line-height: 1.35; }
    .tpl.selected{
      border-color: rgba(124,92,255,.34);
      background: rgba(124,92,255,.12);
      box-shadow: 0 0 0 4px rgba(124,92,255,.10);
    }

    .note{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* Library UI */
    .seg{
      display:flex;
      gap: 8px;
      padding: 6px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
    }
    .segbtn{
      flex:1;
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12.5px;
      color: var(--muted);
      background: transparent;
      user-select:none;
    }
    .segbtn.active{
      color: var(--text);
      background: rgba(124,92,255,.16);
      border: 1px solid rgba(124,92,255,.22);
    }

    .list{
      display:grid;
      gap: 10px;
    }
    .item{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .item .left{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
    }
    .item .name{
      font-weight: 820;
      letter-spacing: .15px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 58vw;
    }
    .item .meta{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }
    .item .actions{
      display:flex;
      gap: 8px;
      flex: 0 0 auto;
    }
    .mini{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 750;
      font-size: 12px;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      user-select:none;
    }
    .mini.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.28);
    }

    /* Bottom nav */
    .nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: calc(var(--navH) + env(safe-area-inset-bottom));
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px;
      display:flex;
      justify-content:center;
      z-index: 50;
      pointer-events:none;
    }
    .navbar{
      width: min(780px, calc(100% - 18px));
      display:flex;
      justify-content:space-between;
      gap: 8px;
      background: rgba(16,20,30,.72);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 8px;
      backdrop-filter: blur(18px);
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      pointer-events:auto;
    }
    .navbtn{
      flex: 1;
      appearance:none;
      border:none;
      background: transparent;
      color: var(--muted);
      padding: 10px 6px;
      border-radius: 16px;
      font-size: 11.5px;
      font-weight: 650;
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .navbtn .dot{
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .navbtn.active{
      color: var(--text);
      background: rgba(124,92,255,.14);
      border: 1px solid rgba(124,92,255,.22);
    }
    .navbtn.active .dot{
      background: rgba(124,92,255,.22);
      border-color: rgba(124,92,255,.30);
    }

    /* Modal */
    .modalHost{
      position: fixed;
      inset: 0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index: 80;
      padding: 0 10px;
    }
    .modalHost.show{ display:flex; }
    .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    .sheet{
      position:relative;
      width: min(780px, 100%);
      max-height: 82vh;
      overflow:auto;
      background: rgba(16,20,30,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px 22px 0 0;
      box-shadow: 0 22px 60px rgba(0,0,0,.65);
      padding: 14px;
      transform: translateY(10px);
    }
    .sheetHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 10px;
    }
    .sheetHeader .h{
      font-weight: 760;
      letter-spacing: .2px;
    }
    .xbtn{
      appearance:none;
      border:none;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="title" id="appTitle">Gym Dashboard</div>
          <div class="subtitle" id="appSubtitle">Offline • Add to Home Screen • Local data</div>
        </div>
        <div class="chip" id="chipStatus">Not set up</div>
      </div>
    </header>

    <main id="viewRoot"></main>
  </div>

  <div class="nav">
    <div class="navbar" id="navbar"></div>
  </div>

  <!-- Modal Host -->
  <div class="modalHost" id="modalHost" aria-hidden="true">
    <div class="backdrop" id="modalBackdrop"></div>
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHeader">
        <div class="h" id="modalTitle">Modal</div>
        <button class="xbtn" id="modalClose">Close</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    /********************
     * 1) State + Storage
     ********************/
    const STORAGE_KEY = "gymdash:v1";

    const DefaultState = () => ({
      schemaVersion: 1,
      createdAt: Date.now(),
      profile: null,
      routines: [],
      activeRoutineId: null,
      exerciseLibrary: {
        weightlifting: [],
        cardio: [],
        core: []
      },
      logs: {
        workouts: [],
        weight: [],
        protein: []
      },
      attendance: []
    });

    const Storage = {
      load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return DefaultState();
          const parsed = JSON.parse(raw);
          if(!parsed || typeof parsed !== "object") return DefaultState();
          if(!("schemaVersion" in parsed)) return DefaultState();
          return parsed;
        }catch(e){
          return DefaultState();
        }
      },
      save(state){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      },
      reset(){
        localStorage.removeItem(STORAGE_KEY);
      }
    };

    let state = Storage.load();

    /********************
     * 2) Helpers
     ********************/
    const $ = (sel, root=document) => root.querySelector(sel);

    const el = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if(k === "class") n.className = v;
        else if(k === "text") n.textContent = v;
        else if(k === "html") n.innerHTML = v;
        else if(k.startsWith("on") && typeof v === "function"){
          n.addEventListener(k.slice(2).toLowerCase(), v);
        } else {
          n.setAttribute(k, v);
        }
      }
      children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
      return n;
    };

    const uid = (prefix="id") => `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;

    const normName = (s) => (s || "").trim().replace(/\s+/g, " ").toLowerCase();

    /********************
     * 3) Routine templates
     ********************/
    const RoutineTemplates = [
      { key:"ppl", name:"PPL", desc:"Push / Pull / Legs • 6 days + 1 rest",
        buildDays(){ return [
          { label:"Push", isRest:false },{ label:"Pull", isRest:false },{ label:"Legs", isRest:false },
          { label:"Push", isRest:false },{ label:"Pull", isRest:false },{ label:"Legs", isRest:false },
          { label:"Rest", isRest:true }
        ];}},
      { key:"upper_lower", name:"Upper / Lower", desc:"4 training days • balanced • strength + size",
        buildDays(){ return [
          { label:"Upper", isRest:false },{ label:"Lower", isRest:false },{ label:"Rest", isRest:true },
          { label:"Upper", isRest:false },{ label:"Lower", isRest:false },{ label:"Rest", isRest:true },
          { label:"Rest", isRest:true }
        ];}},
      { key:"full_body_3", name:"Full Body (3-day)", desc:"3 training days • simple and effective",
        buildDays(){ return [
          { label:"Full Body", isRest:false },{ label:"Rest", isRest:true },
          { label:"Full Body", isRest:false },{ label:"Rest", isRest:true },
          { label:"Full Body", isRest:false },{ label:"Rest", isRest:true },{ label:"Rest", isRest:true }
        ];}},
      { key:"body_part_split", name:"Body Part Split", desc:"Chest/Back/Legs/Shoulders/Arms + rest",
        buildDays(){ return [
          { label:"Chest", isRest:false },{ label:"Back", isRest:false },{ label:"Legs", isRest:false },
          { label:"Shoulders", isRest:false },{ label:"Arms", isRest:false },
          { label:"Rest", isRest:true },{ label:"Rest", isRest:true }
        ];}},
      { key:"blank", name:"Blank", desc:"Start from scratch (you’ll edit days + exercises)",
        buildDays(){ return [
          { label:"Day 1", isRest:false },{ label:"Day 2", isRest:false },{ label:"Day 3", isRest:false },
          { label:"Day 4", isRest:false },{ label:"Day 5", isRest:false },{ label:"Day 6", isRest:false },
          { label:"Day 7", isRest:false }
        ];}}
    ];

    function createRoutineFromTemplate(templateKey, routineName){
      const tpl = RoutineTemplates.find(t => t.key === templateKey);
      if(!tpl) throw new Error("Invalid template key");

      const routineId = uid("rt");
      const days = tpl.buildDays().map((d, idx) => ({
        id: uid("day"),
        order: idx,
        label: d.label,
        isRest: !!d.isRest,
        exercises: []
      }));

      return {
        id: routineId,
        name: routineName || tpl.name,
        templateKey: tpl.key,
        createdAt: Date.now(),
        days
      };
    }

    /********************
     * 4) Exercise Library Module (Step 3)
     ********************/
    const ExerciseLibrary = {
      typeKeys: ["weightlifting","cardio","core"],
      typeLabel(type){
        if(type === "weightlifting") return "Weightlifting";
        if(type === "cardio") return "Cardio";
        return "Core";
      },
      ensureSeeded(){
        // Only seed if ALL empty
        const lib = state.exerciseLibrary || (state.exerciseLibrary = { weightlifting:[], cardio:[], core:[] });
        const empty = (lib.weightlifting?.length||0) === 0 && (lib.cardio?.length||0) === 0 && (lib.core?.length||0) === 0;
        if(!empty) return;

        lib.weightlifting = [
          { id: uid("ex"), type:"weightlifting", name:"Bench Press", equipment:"barbell", primaryMuscle:"chest", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Incline Dumbbell Press", equipment:"dumbbell", primaryMuscle:"chest", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Lat Pulldown", equipment:"cable", primaryMuscle:"back", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Barbell Squat", equipment:"barbell", primaryMuscle:"legs", isCompound:true, createdAt:Date.now() },
          { id: uid("ex"), type:"weightlifting", name:"Dumbbell Curl", equipment:"dumbbell", primaryMuscle:"biceps", isCompound:false, createdAt:Date.now() }
        ];

        lib.cardio = [
          { id: uid("ex"), type:"cardio", name:"Treadmill Run", modality:"run", supportsIncline:true, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Stationary Bike", modality:"bike", supportsIncline:false, createdAt:Date.now() },
          { id: uid("ex"), type:"cardio", name:"Rowing Machine", modality:"row", supportsIncline:false, createdAt:Date.now() }
        ];

        lib.core = [
          { id: uid("ex"), type:"core", name:"Plank", equipment:"bodyweight", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Hanging Knee Raise", equipment:"bodyweight", createdAt:Date.now() },
          { id: uid("ex"), type:"core", name:"Cable Crunch", equipment:"cable", createdAt:Date.now() }
        ];

        Storage.save(state);
      },
      list(type){
        return (state.exerciseLibrary?.[type] || []);
      },
      existsByName(type, name, excludeId=null){
        const n = normName(name);
        return this.list(type).some(x => normName(x.name) === n && x.id !== excludeId);
      },
      add(type, data){
        if(this.existsByName(type, data.name)) throw new Error("Exercise already exists in this category.");
        const ex = { id: uid("ex"), type, createdAt: Date.now(), ...data };
        state.exerciseLibrary[type].push(ex);
        Storage.save(state);
        return ex;
      },
      update(type, id, patch){
        const arr = this.list(type);
        const idx = arr.findIndex(x => x.id === id);
        if(idx < 0) throw new Error("Exercise not found.");
        const nextName = patch.name ?? arr[idx].name;
        if(this.existsByName(type, nextName, id)) throw new Error("Another exercise with that name already exists.");
        arr[idx] = { ...arr[idx], ...patch };
        Storage.save(state);
        return arr[idx];
      },
      remove(type, id){
        const arr = this.list(type);
        const idx = arr.findIndex(x => x.id === id);
        if(idx < 0) return;
        arr.splice(idx, 1);
        Storage.save(state);
      }
    };

    /********************
     * 5) Modal
     ********************/
    const Modal = {
      open({ title, bodyNode }){
        $("#modalTitle").textContent = title || "Modal";
        const host = $("#modalHost");
        const body = $("#modalBody");
        body.innerHTML = "";
        if(bodyNode) body.appendChild(bodyNode);
        host.classList.add("show");
        host.setAttribute("aria-hidden","false");
      },
      close(){
        const host = $("#modalHost");
        host.classList.remove("show");
        host.setAttribute("aria-hidden","true");
        $("#modalBody").innerHTML = "";
      }
    };

    $("#modalClose").addEventListener("click", Modal.close);
    $("#modalBackdrop").addEventListener("click", Modal.close);

    /********************
     * 6) Router + Views
     ********************/
    const Routes = {
      home: { label: "Home" },
      routine: { label: "Routine" },
      log: { label: "Log" },
      progress: { label: "Progress" },
      more: { label: "More" }
    };

    let currentRoute = "home";

    function setChip(){
      const chip = $("#chipStatus");
      if(state.profile?.name) chip.textContent = `Hi, ${state.profile.name}`;
      else chip.textContent = "Not set up";
    }

    function renderNav(){
      const nav = $("#navbar");
      nav.innerHTML = "";

      const disabled = !state.profile;

      Object.entries(Routes).forEach(([key, r]) => {
        nav.appendChild(el("button", {
          class: "navbtn" + (key === currentRoute ? " active" : ""),
          onClick: () => {
            if(disabled){ navigate("home"); return; }
            navigate(key);
          }
        }, [
          el("div", { class:"dot" }),
          el("div", { text: r.label })
        ]));
      });
    }

    function navigate(routeKey){
      currentRoute = routeKey;
      renderNav();
      renderView();
    }

    function renderView(){
      setChip();
      const root = $("#viewRoot");
      root.innerHTML = "";

      if(!state.profile){
        root.appendChild(Views.Onboarding());
        return;
      }

      if(currentRoute === "home") root.appendChild(Views.Home());
      else if(currentRoute === "routine") root.appendChild(Views.Routine());
      else if(currentRoute === "log") root.appendChild(Views.Log());
      else if(currentRoute === "progress") root.appendChild(Views.Progress());
      else if(currentRoute === "more") root.appendChild(Views.More());
    }

    /********************
     * 7) Views
     ********************/
    const Views = {
      Onboarding(){
        let hideRestDays = true;
        let selectedTpl = "ppl";

        const errorBox = el("div", { class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

        const switchNode = el("div", { class:"switch on" });
        switchNode.addEventListener("click", () => {
          hideRestDays = !hideRestDays;
          switchNode.classList.toggle("on", hideRestDays);
        });

        const tplCardsHost = el("div", { class:"tplGrid" });
        const renderTplCards = () => {
          tplCardsHost.innerHTML = "";
          RoutineTemplates.forEach(t => {
            tplCardsHost.appendChild(el("div", {
              class: "tpl" + (t.key === selectedTpl ? " selected" : ""),
              onClick: () => { selectedTpl = t.key; renderTplCards(); }
            }, [
              el("div", { class:"name", text: t.name }),
              el("div", { class:"desc", text: t.desc })
            ]));
          });
        };
        renderTplCards();

        const nameInput = el("input", { type:"text", placeholder:"Jordan" });
        const proteinInput = el("input", { type:"number", inputmode:"numeric", placeholder:"180", min:"0" });

        const weekSelect = el("select", {});
        weekSelect.appendChild(el("option", { value:"mon", text:"Monday" }));
        weekSelect.appendChild(el("option", { value:"sun", text:"Sunday" }));
        weekSelect.value = "mon";

        const finish = () => {
          errorBox.style.display = "none";
          errorBox.textContent = "";

          const cleanName = (nameInput.value || "").trim();
          const cleanProtein = Number(proteinInput.value);
          const weekStartsOn = weekSelect.value === "sun" ? "sun" : "mon";

          if(!cleanName){
            errorBox.textContent = "Please enter your name.";
            errorBox.style.display = "block";
            return;
          }
          if(!Number.isFinite(cleanProtein) || cleanProtein <= 0){
            errorBox.textContent = "Please enter a valid daily protein goal (grams).";
            errorBox.style.display = "block";
            return;
          }

          const profile = {
            name: cleanName,
            proteinGoal: Math.round(cleanProtein),
            weekStartsOn,
            hideRestDays: !!hideRestDays
          };

          const routineName = RoutineTemplates.find(t => t.key === selectedTpl)?.name || "Routine";
          const routine = createRoutineFromTemplate(selectedTpl, routineName);

          state.profile = profile;
          state.routines = [routine];
          state.activeRoutineId = routine.id;

          // Seed library if empty
          ExerciseLibrary.ensureSeeded();

          Storage.save(state);
          navigate("home");
        };

        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Welcome" }),
            el("div", { class:"kpi" }, [
              el("div", { class:"big", text:"Let’s set up your dashboard" }),
              el("div", { class:"small", text:"Create your profile and choose a routine template. You can edit everything later." })
            ])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Create profile" }),
            el("div", { class:"form" }, [
              el("div", { class:"row2" }, [
                el("label", {}, [ el("span", { text:"Name" }), nameInput ]),
                el("label", {}, [ el("span", { text:"Protein goal (grams/day)" }), proteinInput ])
              ]),
              el("div", { class:"row2" }, [
                el("label", {}, [ el("span", { text:"Week starts on" }), weekSelect ]),
                el("div", { class:"toggle" }, [
                  el("div", { class:"ttext" }, [
                    el("div", { class:"a", text:"Hide rest days" }),
                    el("div", { class:"b", text:"Rest days won’t appear on Home (Routine can still show them later)" })
                  ]),
                  switchNode
                ])
              ]),
              errorBox
            ])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Choose a routine template" }),
            tplCardsHost,
            el("div", { style:"height:10px" }),
            el("div", { class:"btnrow" }, [
              el("button", { class:"btn primary", onClick: finish }, ["Finish setup"]),
              el("button", {
                class:"btn danger",
                onClick: () => {
                  Modal.open({
                    title: "Reset local data",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text:"This clears everything saved in this browser for the app." }),
                      el("div", { style:"height:12px" }),
                      el("div", { class:"btnrow" }, [
                        el("button", {
                          class:"btn danger",
                          onClick: () => {
                            Storage.reset();
                            state = Storage.load();
                            Modal.close();
                            navigate("home");
                          }
                        }, ["Reset"]),
                        el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                      ])
                    ])
                  });
                }
              }, ["Reset"])
            ])
          ])
        ]);
      },

      Home(){
        return el("div", { class:"grid cols2" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Today" }),
            el("div", { class:"kpi" }, [
              el("div", { class:"big", text:"Today’s workout" }),
              el("div", { class:"small", text:"Next step: auto-select workout from your routine + day-of-week." })
            ]),
            el("div", { style:"height:12px" }),
            el("button", { class:"btn primary" }, ["Quick Check-In (coming)"])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Protein" }),
            el("div", { class:"kpi" }, [
              el("div", { class:"big", text:"Ring + grams left" }),
              el("div", { class:"small", text:`Goal: ${state.profile?.proteinGoal ?? 0}g/day (live updates coming)` })
            ]),
            el("div", { style:"height:12px" }),
            el("button", { class:"btn" }, ["Add meals (coming)"])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Attendance" }),
            el("div", { class:"muted", text:"Weekly dots + tap check-in. Calendar view later." })
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Library" }),
            el("div", { class:"muted", text:`Exercises saved: ${
              (state.exerciseLibrary.weightlifting?.length||0) +
              (state.exerciseLibrary.cardio?.length||0) +
              (state.exerciseLibrary.core?.length||0)
            }` })
          ])
        ]);
      },

      Routine(){
        ExerciseLibrary.ensureSeeded();

        let tab = "weightlifting";
        let query = "";

        const listHost = el("div", { class:"list" });

        const searchInput = el("input", { type:"text", placeholder:"Search exercises…" });
        searchInput.addEventListener("input", () => {
          query = searchInput.value || "";
          renderList();
        });

        const seg = el("div", { class:"seg" });
        const segButtons = {};
        ExerciseLibrary.typeKeys.forEach(t => {
          const b = el("button", {
            class:"segbtn" + (t === tab ? " active" : ""),
            onClick: () => {
              tab = t;
              Object.entries(segButtons).forEach(([k, btn]) => btn.classList.toggle("active", k === tab));
              renderList();
            }
          }, [ExerciseLibrary.typeLabel(t)]);
          segButtons[t] = b;
          seg.appendChild(b);
        });

        const metaText = () => {
          const total = ExerciseLibrary.list(tab).length;
          const shown = getFiltered().length;
          return shown === total ? `${total} exercises` : `${shown} of ${total} shown`;
        };

        const getFiltered = () => {
          const q = normName(query);
          const items = [...ExerciseLibrary.list(tab)];
          items.sort((a,b) => (a.name||"").localeCompare(b.name||""));
          if(!q) return items;
          return items.filter(x => normName(x.name).includes(q));
        };

        const openAddModal = () => {
          Modal.open({
            title: `Add ${ExerciseLibrary.typeLabel(tab)} exercise`,
            bodyNode: buildExerciseForm({
              mode: "add",
              type: tab,
              initial: null,
              onSave: (data) => {
                try{
                  ExerciseLibrary.add(tab, data);
                  Modal.close();
                  renderView(); // refresh Routine tab UI
                }catch(e){
                  showFormError(e.message || "Unable to add exercise.");
                }
              }
            })
          });
        };

        const openEditModal = (ex) => {
          Modal.open({
            title: `Edit: ${ex.name}`,
            bodyNode: buildExerciseForm({
              mode: "edit",
              type: tab,
              initial: ex,
              onSave: (data) => {
                try{
                  ExerciseLibrary.update(tab, ex.id, data);
                  Modal.close();
                  renderView();
                }catch(e){
                  showFormError(e.message || "Unable to save changes.");
                }
              }
            })
          });
        };

        const showFormError = (msg) => {
          const box = $("#formError");
          if(box){
            box.textContent = msg;
            box.style.display = "block";
          }
        };

        function renderList(){
          listHost.innerHTML = "";

          const items = getFiltered();
          const headerLine = el("div", { class:"note", text: metaText() });
          listHost.appendChild(headerLine);

          if(items.length === 0){
            listHost.appendChild(el("div", { class:"note", text:"No exercises found. Try a different search or add one." }));
            return;
          }

          items.forEach(ex => {
            const meta = formatExerciseMeta(ex);
            const row = el("div", { class:"item" }, [
              el("div", { class:"left" }, [
                el("div", { class:"name", text: ex.name }),
                el("div", { class:"meta", text: meta })
              ]),
              el("div", { class:"actions" }, [
                el("button", { class:"mini", onClick: () => openEditModal(ex) }, ["Edit"]),
                el("button", {
                  class:"mini danger",
                  onClick: () => {
                    Modal.open({
                      title: "Delete exercise?",
                      bodyNode: el("div", {}, [
                        el("div", { class:"note", text:`This removes "${ex.name}" from your ${ExerciseLibrary.typeLabel(tab)} library.` }),
                        el("div", { style:"height:12px" }),
                        el("div", { class:"btnrow" }, [
                          el("button", {
                            class:"btn danger",
                            onClick: () => {
                              ExerciseLibrary.remove(tab, ex.id);
                              Modal.close();
                              renderView();
                            }
                          }, ["Delete"]),
                          el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                        ])
                      ])
                    });
                  }
                }, ["Delete"])
              ])
            ]);
            listHost.appendChild(row);
          });
        }

        function formatExerciseMeta(ex){
          if(ex.type === "weightlifting"){
            const a = ex.equipment ? `Equipment: ${titleCase(ex.equipment)}` : "Equipment: —";
            const b = ex.primaryMuscle ? `Muscle: ${titleCase(ex.primaryMuscle)}` : "Muscle: —";
            const c = typeof ex.isCompound === "boolean" ? (ex.isCompound ? "Compound" : "Isolation") : "—";
            return `${a} • ${b} • ${c}`;
          }
          if(ex.type === "cardio"){
            const a = ex.modality ? `Mode: ${titleCase(ex.modality)}` : "Mode: —";
            const b = ex.supportsIncline ? "Incline: Yes" : "Incline: No";
            return `${a} • ${b}`;
          }
          // core
          const a = ex.equipment ? `Equipment: ${titleCase(ex.equipment)}` : "Equipment: —";
          return `${a}`;
        }

        function titleCase(s){
          return (s||"").toString().replace(/_/g," ").replace(/\b\w/g, m => m.toUpperCase());
        }

        function buildExerciseForm({ mode, type, initial, onSave }){
          const err = el("div", { id:"formError", class:"note", style:"display:none; color: rgba(255,92,122,.95);" });

          const nameInput = el("input", { type:"text", placeholder:"Exercise name" });
          nameInput.value = initial?.name || "";

          const form = el("div", { class:"form" });

          // Common
          form.appendChild(el("label", {}, [
            el("span", { text:"Name" }),
            nameInput
          ]));

          if(type === "weightlifting"){
            const equipment = el("select", {});
            ["dumbbell","barbell","machine","cable","bodyweight","other"].forEach(v => {
              equipment.appendChild(el("option", { value:v, text: v.replace(/\b\w/g, m => m.toUpperCase()) }));
            });
            equipment.value = initial?.equipment || "dumbbell";

            const muscle = el("select", {});
            ["chest","back","legs","shoulders","biceps","triceps","glutes","hamstrings","quads","calves","full body","other"].forEach(v => {
              muscle.appendChild(el("option", { value:v, text: v.replace(/\b\w/g, m => m.toUpperCase()) }));
            });
            muscle.value = initial?.primaryMuscle || "chest";

            let isCompound = (typeof initial?.isCompound === "boolean") ? initial.isCompound : true;
            const compoundSwitch = el("div", { class:"switch " + (isCompound ? "on" : "") });
            compoundSwitch.addEventListener("click", () => {
              isCompound = !isCompound;
              compoundSwitch.classList.toggle("on", isCompound);
            });

            form.appendChild(el("div", { class:"row2" }, [
              el("label", {}, [ el("span", { text:"Equipment" }), equipment ]),
              el("label", {}, [ el("span", { text:"Primary muscle" }), muscle ])
            ]));

            form.appendChild(el("div", { class:"toggle" }, [
              el("div", { class:"ttext" }, [
                el("div", { class:"a", text:"Compound lift" }),
                el("div", { class:"b material", text:"Used later for volume/PR logic and routine templates." })
              ]),
              compoundSwitch
            ]));

            form.appendChild(err);

            const saveBtn = el("button", {
              class:"btn primary",
              onClick: () => {
                err.style.display = "none";
                const name = (nameInput.value || "").trim();
                if(!name){ err.textContent = "Name is required."; err.style.display="block"; return; }
                onSave({
                  name,
                  equipment: equipment.value,
                  primaryMuscle: muscle.value,
                  isCompound
                });
              }
            }, [mode === "add" ? "Add exercise" : "Save changes"]);

            return el("div", {}, [
              form,
              el("div", { style:"height:12px" }),
              el("div", { class:"btnrow" }, [
                saveBtn,
                el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
              ])
            ]);
          }

          if(type === "cardio"){
            const modality = el("select", {});
            ["run","bike","row","stairmaster","elliptical","walk","other"].forEach(v => {
              modality.appendChild(el("option", { value:v, text: v.replace(/\b\w/g, m => m.toUpperCase()) }));
            });
            modality.value = initial?.modality || "run";

            let supportsIncline = !!initial?.supportsIncline;
            const inclineSwitch = el("div", { class:"switch " + (supportsIncline ? "on" : "") });
            inclineSwitch.addEventListener("click", () => {
              supportsIncline = !supportsIncline;
              inclineSwitch.classList.toggle("on", supportsIncline);
            });

            form.appendChild(el("label", {}, [ el("span", { text:"Modality" }), modality ]));
            form.appendChild(el("div", { class:"toggle" }, [
              el("div", { class:"ttext" }, [
                el("div", { class:"a", text:"Supports incline" }),
                el("div", { class:"b", text:"If enabled, cardio logs can include incline." })
              ]),
              inclineSwitch
            ]));

            form.appendChild(err);

            const saveBtn = el("button", {
              class:"btn primary",
              onClick: () => {
                err.style.display = "none";
                const name = (nameInput.value || "").trim();
                if(!name){ err.textContent = "Name is required."; err.style.display="block"; return; }
                onSave({
                  name,
                  modality: modality.value,
                  supportsIncline
                });
              }
            }, [mode === "add" ? "Add exercise" : "Save changes"]);

            return el("div", {}, [
              form,
              el("div", { style:"height:12px" }),
              el("div", { class:"btnrow" }, [
                saveBtn,
                el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
              ])
            ]);
          }

          // core
          const equipment = el("select", {});
          ["bodyweight","weighted","cable","other"].forEach(v => {
            equipment.appendChild(el("option", { value:v, text: v.replace(/\b\w/g, m => m.toUpperCase()) }));
          });
          equipment.value = initial?.equipment || "bodyweight";

          form.appendChild(el("label", {}, [ el("span", { text:"Equipment" }), equipment ]));
          form.appendChild(err);

          const saveBtn = el("button", {
            class:"btn primary",
            onClick: () => {
              err.style.display = "none";
              const name = (nameInput.value || "").trim();
              if(!name){ err.textContent = "Name is required."; err.style.display="block"; return; }
              onSave({
                name,
                equipment: equipment.value
              });
            }
          }, [mode === "add" ? "Add exercise" : "Save changes"]);

          return el("div", {}, [
            form,
            el("div", { style:"height:12px" }),
            el("div", { class:"btnrow" }, [
              saveBtn,
              el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
            ])
          ]);
        }

        // initial render
        renderList();

        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Exercise Library" }),
            el("div", { class:"note", text:"This is your saved exercise list used by Routine + Log Sets. Add anything you don’t see here." }),
            el("div", { style:"height:10px" }),
            seg,
            el("div", { style:"height:10px" }),
            el("div", { class:"row2" }, [
              el("label", {}, [
                el("span", { text:"Search" }),
                searchInput
              ]),
              el("div", { style:"display:flex; align-items:end;" }, [
                el("button", { class:"btn primary", onClick: openAddModal }, ["Add exercise"])
              ])
            ])
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Results" }),
            listHost
          ])
        ]);
      },

      Log(){
        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Log Sets" }),
            el("div", { class:"muted", text:"Next step: Weightlifting/Cardio/Core logging flows + PR tracking + history modal." })
          ])
        ]);
      },

      Progress(){
        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"Progress" }),
            el("div", { class:"muted", text:"Next step: Table + Graph (Chart.js) + export PNG." })
          ])
        ]);
      },

      More(){
        return el("div", { class:"grid" }, [
          el("div", { class:"card" }, [
            el("h2", { text:"More" }),
            el("div", { class:"muted", text:"Next: Weight, Attendance calendar, Backup/Import JSON, Settings." })
          ]),
          el("div", { class:"card" }, [
            el("h2", { text:"Debug" }),
            el("div", { class:"btnrow" }, [
              el("button", {
                class:"btn",
                onClick: () => Modal.open({
                  title: "Current State (JSON)",
                  bodyNode: el("pre", { style:"white-space:pre-wrap; font-size:12px; color: rgba(255,255,255,.85);" }, [
                    JSON.stringify(state, null, 2)
                  ])
                })
              }, ["View state JSON"]),
              el("button", {
                class:"btn danger",
                onClick: () => {
                  Modal.open({
                    title: "Reset local data",
                    bodyNode: el("div", {}, [
                      el("div", { class:"note", text:"This clears everything saved in this browser for the app." }),
                      el("div", { style:"height:12px" }),
                      el("div", { class:"btnrow" }, [
                        el("button", {
                          class:"btn danger",
                          onClick: () => {
                            Storage.reset();
                            state = Storage.load();
                            Modal.close();
                            navigate("home");
                          }
                        }, ["Reset"]),
                        el("button", { class:"btn", onClick: Modal.close }, ["Cancel"])
                      ])
                    ])
                  });
                }
              }, ["Reset local data"])
            ])
          ])
        ]);
      }
    };

    /********************
     * 8) Boot
     ********************/
    // If already onboarded and library is empty, seed it (won't overwrite non-empty)
    if(state.profile) ExerciseLibrary.ensureSeeded();

    renderNav();
    renderView();
  </script>
</body>
</html>
